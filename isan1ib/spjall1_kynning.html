<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spjall me√∞ Sari - √çSAN1√çA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .feedback {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }

        .feedback.ai-feedback {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        .question-block {
            opacity: 0.5;
            pointer-events: none;
        }

        .question-block.active {
            opacity: 1;
            pointer-events: auto;
        }

        .play-btn {
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-btn {
            transition: all 0.2s ease;
        }

        .input-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto max-w-4xl px-4 py-8">
        
        <!-- Profile Section -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8 text-center">
            <div class="mb-6">
                <img src="media/sari.png" alt="Sari" class="w-48 h-48 rounded-full mx-auto object-cover border-4 border-blue-500 shadow-lg">
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">H√¶! √âg heiti Sari</h1>
            <p class="text-lg text-gray-600 mb-4">√âg er fr√° Ind√≥nes√≠u og b√Ω √° V√∂llum √≠ Hafnarfir√∞i. √âg er a√∞ l√¶ra √≠slensku eins og √æ√∫!</p>
            <p class="text-md text-gray-500 italic">üéß Hlusta√∞u √° spurningarnar og svara√∞u me√∞ r√∂dd e√∞a texta</p>
        </div>

        <!-- Part 1: Sari asks questions -->
        <div id="part1" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üó£Ô∏è Sari spyr √æig</h2>

            <!-- Question 1: Nafn -->
            <div class="question-block active bg-white rounded-lg shadow-md p-6" data-question="1">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(1)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 1</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(1)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(1)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput1" class="hidden">
                        <input type="text" id="answer1" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(1)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording1" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(1)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback1" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 2: Aldur -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="2">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(2)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 2</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(2)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(2)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput2" class="hidden">
                        <input type="text" id="answer2" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(2)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording2" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(2)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback2" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 3: Hva√∞an -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="3">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(3)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 3</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(3)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(3)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput3" class="hidden">
                        <input type="text" id="answer3" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(3)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording3" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(3)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback3" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 4: B√∫seta -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="4">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(4)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 4</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(4)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(4)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput4" class="hidden">
                        <input type="text" id="answer4" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(4)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording4" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(4)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback4" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 5: Hven√¶r komst til √çslands -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="5">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(5)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 5</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(5)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(5)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput5" class="hidden">
                        <input type="text" id="answer5" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(5)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording5" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(5)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback5" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 6: Fj√∂lskylda -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="6">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(6)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 6</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(6)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(6)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput6" class="hidden">
                        <input type="text" id="answer6" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(6)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording6" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(6)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback6" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 7: Hva√∞a dagur er √≠ dag -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="7">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(7)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 7</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(7)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(7)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput7" class="hidden">
                        <input type="text" id="answer7" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(7)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording7" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(7)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback7" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 8: Afm√¶lism√°nu√∞ur -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="8">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(8)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 8</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(8)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(8)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput8" class="hidden">
                        <input type="text" id="answer8" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(8)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording8" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(8)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback8" class="feedback ai-feedback hidden"></div>
            </div>

            <!-- Question 9: √Åhugam√°l -->
            <div class="question-block bg-white rounded-lg shadow-md p-6" data-question="9">
                <div class="flex items-center gap-4 mb-4">
                    <button class="play-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-full text-2xl" onclick="playQuestion(9)">
                        ‚ñ∂Ô∏è
                    </button>
                    <p class="text-lg font-semibold text-gray-700">Spurning 9</p>
                </div>
                
                <div class="mt-4">
                    <div class="flex gap-2 mb-3">
                        <button onclick="startRecording(9)" class="input-btn flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold">
                            üé§ Tala
                        </button>
                        <button onclick="showTextInput(9)" class="input-btn flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚å®Ô∏è Skrifa
                        </button>
                    </div>
                    
                    <div id="textInput9" class="hidden">
                        <input type="text" id="answer9" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" placeholder="Skrifa svar √æitt h√©r...">
                        <button onclick="submitAnswer(9)" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold">
                            Senda svar
                        </button>
                    </div>
                    
                    <div id="recording9" class="hidden text-center py-4">
                        <p class="text-red-600 font-semibold mb-2">üî¥ Upptaka √≠ gangi...</p>
                        <button onclick="stopRecording(9)" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                            ‚èπÔ∏è St√∂√∞va uppt√∂ku
                        </button>
                    </div>
                </div>

                <div id="feedback9" class="feedback ai-feedback hidden"></div>
            </div>
        </div>

        <!-- Part 2: Student asks Sari -->
        <div id="part2" class="hidden space-y-6 mt-12">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow-lg p-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-4">üîÑ N√∫ er √æitt a√∞ spyrja!</h2>
                <button class="play-btn bg-white text-purple-600 px-8 py-4 rounded-full text-xl font-bold hover:bg-gray-100" onclick="playFlipIntro()">
                    ‚ñ∂Ô∏è Heyra √≠ Sari
                </button>
            </div>

            <!-- Student questions to Sari -->
            <div id="flipQuestions" class="hidden space-y-6">
                <p class="text-lg text-gray-700 text-center mb-6">Spyr√∞u Sari s√∂mu spurninga og h√∫n spur√∞i √æig. H√∫n mun svara √æ√©r! üòä</p>
                
                <!-- Placeholder for student questions - will be dynamic -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-600 italic text-center">Nota√∞u radduppt√∂ku til a√∞ spyrja Sari spurningar...</p>
                    <div class="mt-4 text-center">
                        <button onclick="startStudentQuestion()" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-8 rounded-lg font-semibold">
                            üé§ Spyrja Sari
                        </button>
                    </div>
                    <div id="studentQuestionFeedback" class="feedback ai-feedback hidden mt-4"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_ENDPOINT = 'https://api.anthropic.com/v1/messages';
        
        // Questions and Azure TTS texts
        const questions = {
            1: {
                text: "H√¶! Hva√∞ heitir √æ√∫?",
                azureText: "H√¶! Hva√∞ heitir √æ√∫?"
            },
            2: {
                text: "Hva√∞ ert √æ√∫ g√∂mul e√∞a gamall?",
                azureText: "Hva√∞ ert √æ√∫ g√∂mul e√∞a gamall?"
            },
            3: {
                text: "Hva√∞an ert √æ√∫? Fr√° hva√∞a landi ert √æ√∫?",
                azureText: "Hva√∞an ert √æ√∫? Fr√° hva√∞a landi ert √æ√∫?"
            },
            4: {
                text: "Hvar b√Ωr√∞ √æ√∫ n√∫na?",
                azureText: "Hvar b√Ωr√∞ √æ√∫ n√∫na?"
            },
            5: {
                text: "Hven√¶r komst √æ√∫ til √çslands?",
                azureText: "Hven√¶r komst √æ√∫ til √çslands?"
            },
            6: {
                text: "Hva√∞ heitir mamma √æ√≠n og pabbi √æinn?",
                azureText: "Hva√∞ heitir mamma √æ√≠n og pabbi √æinn?"
            },
            7: {
                text: "Hva√∞a dagur er √≠ dag?",
                azureText: "Hva√∞a dagur er √≠ dag?"
            },
            8: {
                text: "√ç hva√∞a m√°nu√∞i √°tt √æ√∫ afm√¶li?",
                azureText: "√ç hva√∞a m√°nu√∞i √°tt √æ√∫ afm√¶li?"
            },
            9: {
                text: "Finnst √æ√©r gaman a√∞ hlusta √° t√≥nlist?",
                azureText: "Finnst √æ√©r gaman a√∞ hlusta √° t√≥nlist?"
            }
        };

        const flipIntroText = "Fr√°b√¶rt! N√∫na vilt √æ√∫ spyrja mig?";

        // Speech recognition setup
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'is-IS';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        let currentRecordingQuestion = null;

        // Play Azure TTS audio
        async function playQuestion(questionNum) {
            const question = questions[questionNum];
            const playBtn = event.target;
            playBtn.disabled = true;
            
            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: question.azureText }),
                });

                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa √≠ hlj√≥√∞kalli:", data.error);
                    playBtn.disabled = false;
                    return;
                }

                const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    playBtn.disabled = false;
                };
                audio.onerror = () => {
                    playBtn.disabled = false;
                };
                
                await audio.play();
                
            } catch (e) {
                console.error("Tenging mist√≥kst:", e);
                playBtn.disabled = false;
            }
        }

        // Play flip intro
        async function playFlipIntro() {
            const playBtn = event.target;
            playBtn.disabled = true;
            
            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: flipIntroText }),
                });

                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa √≠ hlj√≥√∞kalli:", data.error);
                    playBtn.disabled = false;
                    return;
                }

                const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                const audio = new Audio(audioUrl);
                
                audio.onended = () => {
                    playBtn.disabled = false;
                    document.getElementById('flipQuestions').classList.remove('hidden');
                };
                audio.onerror = () => {
                    playBtn.disabled = false;
                };
                
                await audio.play();
                
            } catch (e) {
                console.error("Tenging mist√≥kst:", e);
                playBtn.disabled = false;
            }
        }

        // Show text input
        function showTextInput(questionNum) {
            document.getElementById(`textInput${questionNum}`).classList.remove('hidden');
        }

        // Start recording
        function startRecording(questionNum) {
            if (!recognition) {
                alert('Raddupptaka er ekki studd √≠ √æessum vafra. Nota√∞u Chrome e√∞a Edge.');
                return;
            }

            currentRecordingQuestion = questionNum;
            document.getElementById(`recording${questionNum}`).classList.remove('hidden');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById(`recording${questionNum}`).classList.add('hidden');
                submitAnswerText(questionNum, transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                document.getElementById(`recording${questionNum}`).classList.add('hidden');
                alert('Villa kom upp √≠ radduppt√∂ku. Reyndu aftur.');
            };

            recognition.start();
        }

        // Stop recording
        function stopRecording(questionNum) {
            if (recognition) {
                recognition.stop();
            }
            document.getElementById(`recording${questionNum}`).classList.add('hidden');
        }

        // Submit answer from text input
        function submitAnswer(questionNum) {
            const answer = document.getElementById(`answer${questionNum}`).value.trim();
            if (!answer) {
                alert('Vinsamlegast skrifa√∞u svar!');
                return;
            }
            submitAnswerText(questionNum, answer);
        }

        // Submit answer text (from either typing or speech)
        async function submitAnswerText(questionNum, answerText) {
            const feedbackDiv = document.getElementById(`feedback${questionNum}`);
            feedbackDiv.innerHTML = '<p class="text-gray-600">‚è≥ Sari er a√∞ hugsa...</p>';
            feedbackDiv.classList.remove('hidden');

            try {
                const feedback = await getAIFeedback(answerText, questionNum);
                feedbackDiv.innerHTML = `<p>${feedback}</p>`;
                
                // Activate next question
                setTimeout(() => {
                    if (questionNum < 9) {
                        activateNextQuestion(questionNum + 1);
                    } else {
                        // All questions done, show part 2
                        showPart2();
                    }
                }, 2000);
            } catch (error) {
                console.error('Error getting feedback:', error);
                feedbackDiv.innerHTML = '<p>Fr√°b√¶rt! Haltu √°fram! üòä</p>';
            }
        }

        // Get AI feedback from Claude
        async function getAIFeedback(userAnswer, questionNum) {
            const questionText = questions[questionNum].text;
            
            const prompt = `√û√∫ ert Sari, 18 √°ra stelpa fr√° Ind√≥nes√≠u sem er a√∞ l√¶ra √≠slensku. √û√∫ ert vingjarnleg og feimin en mj√∂g hl√Ω √≠ hugsun.

√û√∫ spur√∞ir: "${questionText}"

Nemandinn svara√∞i: "${userAnswer}"

Gef√∞u stutta, n√°tt√∫rulega og hvetjandi endurgj√∂f √° √≠slensku (2-3 setningar):
- Vi√∞urkenndu svar nemandans
- Commenta√∞u √° √æa√∞ sem hann/h√∫n sag√∞i (ekki bara "r√©tt" e√∞a "rangt")
- Vertu vingjarnleg og hvetjandi
- Ef m√°lfr√¶√∞ivilla er, benda √° √æa√∞ √° mj√∫kan h√°tt
- Ef svari√∞ er mj√∂g stutt, hvettu til a√∞ segja meira

D√¶mi um g√≥√∞a endurgj√∂f:
- "Fr√°b√¶rt! √û√∫ heitir [nafn]. √ûa√∞ er fallegt nafn! M√©r finnst gaman a√∞ kynnast √æ√©r."
- "Gott! √û√∫ ert [aldur] √°ra, vi√∞ erum n√¶stum √æv√≠ jafngamlar! √âg er 18 √°ra."
- "√Åhugavert! √û√∫ ert fr√° [land]. √âg er fr√° Ind√≥nes√≠u. Er langt a√∞ fer√∞ast √æa√∞an?"

MIKILV√ÜGT: Svara√∞u A√êEINS me√∞ endurgj√∂finni √° √≠slensku. Engin √∫tsk√Ωring e√∞a meta-commentary.`;

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [
                        { role: 'user', content: prompt }
                    ]
                })
            });

            const data = await response.json();
            return data.content[0].text;
        }

        // Activate next question
        function activateNextQuestion(questionNum) {
            const nextBlock = document.querySelector(`[data-question="${questionNum}"]`);
            if (nextBlock) {
                nextBlock.classList.add('active');
                nextBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Show part 2 (flip section)
        function showPart2() {
            document.getElementById('part1').style.opacity = '0.5';
            document.getElementById('part2').classList.remove('hidden');
            document.getElementById('part2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Student asks Sari
        function startStudentQuestion() {
            if (!recognition) {
                alert('Raddupptaka er ekki studd √≠ √æessum vafra. Nota√∞u Chrome e√∞a Edge.');
                return;
            }

            const feedbackDiv = document.getElementById('studentQuestionFeedback');
            feedbackDiv.innerHTML = '<p class="text-red-600">üî¥ Upptaka √≠ gangi... Spur√∞u Sari!</p>';
            feedbackDiv.classList.remove('hidden');

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                feedbackDiv.innerHTML = '<p class="text-gray-600">‚è≥ Sari er a√∞ svara...</p>';
                
                try {
                    const response = await getSariResponse(transcript);
                    feedbackDiv.innerHTML = `<p><strong>√û√∫ spur√∞ir:</strong> "${transcript}"</p><p class="mt-2"><strong>Sari svarar:</strong> ${response}</p>`;
                    
                    // Read Sari's response aloud with Azure TTS
                    try {
                        const r = await fetch('/.netlify/functions/speak', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text_to_speak: response }),
                        });

                        const data = await r.json();
                        
                        if (r.ok && !data.error && data.audio_base64) {
                            const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                            const audio = new Audio(audioUrl);
                            await audio.play();
                        }
                    } catch (audioError) {
                        console.error("Villa vi√∞ hlj√≥√∞:", audioError);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    feedbackDiv.innerHTML = '<p>Sari gat ekki svara√∞. Reyndu aftur!</p>';
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                feedbackDiv.innerHTML = '<p class="text-red-600">Villa √≠ uppt√∂ku. Reyndu aftur!</p>';
            };

            recognition.start();
        }

        // Get Sari's response to student question
        async function getSariResponse(studentQuestion) {
            const prompt = `√û√∫ ert Sari, 18 √°ra stelpa fr√° Ind√≥nes√≠u. √û√∫ b√Ωr√∞ √° V√∂llum √≠ Hafnarfir√∞i og hefur b√∫i√∞ √æar √≠ 8 m√°nu√∞i. √û√∫ ert a√∞ l√¶ra √≠slensku.

Nemandinn spur√∞i √æig: "${studentQuestion}"

Svara√∞u spurningunni √° √≠slensku eins og Sari myndi gera:
- Ef spurningin er um nafn √æitt: "√âg heiti Sari."
- Ef um aldur: "√âg er √°tj√°n √°ra."
- Ef um hva√∞an √æ√∫ ert: "√âg er fr√° Ind√≥nes√≠u."
- Ef um b√∫setu: "√âg b√Ω √° V√∂llum √≠ Hafnarfir√∞i."
- Ef um hven√¶r komst til √çslands: "√âg kom til √çslands fyrir √°tta m√°nu√∞um."
- Ef um foreldra: "Mamma m√≠n heitir Dewi og pabbi minn heitir Budi."
- Ef um daginn √≠ dag: Svara√∞u me√∞ r√©ttum vikudegi
- Ef um afm√¶li: "√âg √° afm√¶li √≠ j√∫l√≠."
- Ef um √°hugam√°l: "J√°, m√©r finnst mj√∂g gaman a√∞ hlusta √° t√≥nlist. √âg elska l√≠ka a√∞ lesa og fara √≠ sund."

Svara√∞u n√°tt√∫rulega og stuttlega (1-2 setningar). A√êEINS svari√∞, ekkert anna√∞.`;

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 500,
                    messages: [
                        { role: 'user', content: prompt }
                    ]
                })
            });

            const data = await response.json();
            return data.content[0].text;
        }
    </script>
</body>
</html>
