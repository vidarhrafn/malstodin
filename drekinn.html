<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üêâ Drekinn - Skyndibitasta√∞ur</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------------- Icons ----------------
    const SendIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );
    const CreditCardIcon = () => (
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
        <line x1="1" y1="10" x2="23" y2="10"></line>
      </svg>
    );

    // -------------- Helpers ---------------
    function menuToText(menu) {
      const cat = (title, items) =>
        `${title}:\n` + items.map(i => `- ${i.name}: ${i.price} kr`).join('\n');

      return [
        "MATSE√êILL DREKANS:",
        cat("Hamborgarar", menu.hamborgarar),
        cat("Me√∞l√¶ti", menu.medlaeti),
        cat("Drykkir", menu.drykkir),
        cat("Tilbo√∞", menu.tilbod),
      ].join("\n\n");
    }

    function parseActionFromAssistant(text) {
      // les s√≠√∞ustu l√≠nu og reynir JSON-parse
      const lines = text.trim().split('\n');
      const last = lines[lines.length - 1].trim();
      try {
        const obj = JSON.parse(last);
        return obj?.action || "none";
      } catch {
        return "none";
      }
    }

    // -------------- App ----------------
    const Drekinn = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [stage, setStage] = useState('ordering');  // ordering | payment | complete
      const [orderNumber, setOrderNumber] = useState(null);
      const [paymentStep, setPaymentStep] = useState('idle'); // idle | inserting | processing | success
      const messagesEndRef = useRef(null);

      const menu = {
        hamborgarar: [
          { name: 'Drekaborgarinn',     price: 1590 },
          { name: 'Ostaborgarinn',      price: 1690 },
          { name: 'Bacon Deluxe',       price: 1890 },
          { name: 'Kj√∫klingaborgarinn', price: 1790 },
        ],
        medlaeti: [
          { name: 'Franskar litlar', price: 490 },
          { name: 'Franskar st√≥rar', price: 690 },
          { name: 'Laukhringir',     price: 590 },
          { name: 'Kj√∫klinganaggar', price: 890 },
        ],
        drykkir: [
          { name: 'Gos st√≥rt',         price: 390 },
          { name: 'Gos l√≠ti√∞',         price: 290 },
          { name: 'Mj√≥lkurhristingur', price: 690 },
          { name: 'Kaffi',             price: 390 },
        ],
        tilbod: [
          { name: 'Hamborgaratilbo√∞', price: 2290 },
          { name: 'St√≥ra tilbo√∞i√∞',   price: 3990 },
        ],
      };

      // Fyrsta kve√∞ja
      useEffect(() => {
        setMessages([{ role: 'assistant', content: 'H√¶ og velkomin √° Drekann! Hva√∞ m√° bj√≥√∞a √æ√©r √≠ dag? üòä' }]);
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, loading]);

      async function callOpenAI(payload) {
        const r = await fetch('/.netlify/functions/openai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        // Function skilar alltaf { content } e√∞a { error }
        const data = await r.json();
        if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
        return data.content; // strengur
      }

      const sendMessage = async () => {
        const trimmed = input.trim();
        if (!trimmed || loading) return;

        const userMessage = { role: 'user', content: trimmed };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);

        // 1) Stutt m√°lfarsendurgj√∂f (A2‚ÄìB1, 1‚Äì2 setn.)
        try {
          const feedbackMessages = [
            {
              role: 'system',
              content: `
√û√∫ ert √≠slenskukennari sem gefur √∂rstutta, hl√Ωja og hvetjandi endurgj√∂f √° √≠slensku (A2‚ÄìB1).
REGLUR:
- 1‚Äì2 stuttar setningar, aldrei lengra.
- Lei√∞r√©ttu a√∞eins √æegar √æ√∫ ert >80% viss.
- For√∞astu of formlegt/b√≥klegt m√°l.
- Ekki nota ensku. Ekki √∫tsk√Ωra nema nau√∞synlegt s√© fyrir skilning.
`.trim()
            },
            {
              role: 'user',
              content: `Skilabo√∞ nemanda: "${trimmed}". Gef√∞u a√∞eins endurgj√∂farl√≠nuna, ekkert anna√∞.`
            }
          ];

          const feedback = await callOpenAI({
            model: 'gpt-4o-mini',
            temperature: 0.2,
            max_tokens: 60,
            messages: feedbackMessages,
          });

          if (feedback && typeof feedback === 'string') {
            setMessages(prev => [...prev, { role: 'feedback', content: feedback }]);
            // sm√° "mannleg" t√∂f
            await new Promise(res => setTimeout(res, 500));
          }
        } catch (e) {
          console.error('Feedback error:', e);
          // l√°tum √æetta falla hlj√≥√∞lega; ekki trufla samtali√∞
        }

        // 2) A√∞al-svar fr√° "starfsmanni"
        try {
          const sys = `
√û√∫ ert vingjarnlegur starfsma√∞ur √° Drekanum, vins√¶lum √≠slenskum skyndibitasta√∞.

${menuToText(menu)}

VERKEFNI:
1. Hj√°lpa vi√∞skiptavinum a√∞ velja af matse√∞linum (bara ef be√∞i√∞ er um √æa√∞)
2. Reikna heildarver√∞ (bara ef be√∞i√∞ er um √æa√∞)
3. Sta√∞festa p√∂ntun √æegar vi√∞skiptavinur er tilb√∫inn
4. Skila JSON-a√∞ger√∞ √≠ s√≠√∞ustu l√≠nu svars: {"action":"none"} e√∞a {"action":"confirm_order"}

ST√çLL:
- Stuttar, e√∞lilegar og kurteisar setningar √° n√∫t√≠malegri √≠slensku.
- Ekki lei√∞r√©tta m√°lfar. Ekki kennslum√°l. Engin bullet points nema be√∞i√∞ s√© um √æa√∞.
- Emoji m√° nota sparlega.

√öTT√ÅK:
- Fyrst svartexti (n√°tt√∫rulegt samtal).
- **S√≠√∞asta l√≠na**: JSON me√∞ a√∞ger√∞inni √° einni l√≠nu (√°n fork√≥√∞a og √°n sk√Ωringa).
D√ÜMI:
‚ÄûFr√°b√¶rt ‚Äì √æa√∞ ver√∞ur ostaborgari, st√≥rar franskar og l√≠ti√∞ gos. Viltu sta√∞festa?
{"action":"none"}‚Äú
`.trim();

          // S√≠a samtalss√∂gu: a√∞eins user/assistant (ekkert feedback)
          const conversationHistory = messages
            .filter(m => m.role === 'assistant' || m.role === 'user')
            .map(m => ({ role: m.role, content: m.content }));

          const assistantReply = await callOpenAI({
            model: 'gpt-4o-mini',
            temperature: 0.3,
            max_tokens: 220,
            messages: [
              { role: 'system', content: sys },
              ...conversationHistory,
              userMessage,
            ],
          });

          if (assistantReply) {
            setMessages(prev => [...prev, { role: 'assistant', content: assistantReply }]);
            const action = parseActionFromAssistant(assistantReply);
            if (action === 'confirm_order') {
              setTimeout(() => setStage('payment'), 600);
            }
          }
        } catch (e) {
          console.error('Assistant error:', e);
          setMessages(prev => [
            ...prev,
            { role: 'assistant', content: '√öps, eitthva√∞ f√≥r √∫rskei√∞is. Pr√≥fum aftur √° eftir.' }
          ]);
        } finally {
          setLoading(false);
        }
      };

      const handlePayment = () => {
        setPaymentStep('inserting');
        setTimeout(() => {
          setPaymentStep('processing');
          setTimeout(() => {
            setPaymentStep('success');
            const randomOrderNum = Math.floor(Math.random() * 900) + 100;
            setOrderNumber(randomOrderNum);
            setTimeout(() => setStage('complete'), 1500);
          }, 1800);
        }, 1200);
      };

      return (
        <div className="min-h-screen">
          <header className="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 shadow-lg">
            <h1 className="text-4xl font-bold text-center">üêâ Drekinn</h1>
            <p className="text-center text-orange-100 mt-2">Besti skyndibitasta√∞urinn √° √çslandi</p>
          </header>

          <main className="max-w-7xl mx-auto p-4">
            <div className="grid md:grid-cols-3 gap-6">
              {/* Matse√∞ill */}
              <aside className="md:col-span-1 bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-2xl font-bold text-orange-600 mb-4">Matse√∞ill</h2>

                <section className="space-y-6">
                  <div>
                    <h3 className="font-bold text-lg text-gray-700 mb-2">üçî Hamborgarar</h3>
                    {menu.hamborgarar.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm">
                        <span>{item.name}</span>
                        <span className="font-semibold">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-bold text-lg text-gray-700 mb-2">üçü Me√∞l√¶ti</h3>
                    {menu.medlaeti.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm">
                        <span>{item.name}</span>
                        <span className="font-semibold">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-bold text-lg text-gray-700 mb-2">ü•§ Drykkir</h3>
                    {menu.drykkir.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm">
                        <span>{item.name}</span>
                        <span className="font-semibold">{item.price} kr</span>
                      </div>
                    ))}
                  </div>

                  <div>
                    <h3 className="font-bold text-lg text-orange-600 mb-2">‚≠ê Tilbo√∞</h3>
                    {menu.tilbod.map((item, idx) => (
                      <div key={idx} className="flex justify-between py-1 text-sm">
                        <span>{item.name}</span>
                        <span className="font-bold text-orange-600">{item.price} kr</span>
                      </div>
                    ))}
                  </div>
                </section>
              </aside>

              {/* Spjall + grei√∞sla */}
              <section className="md:col-span-2 bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-[600px]">
                {stage === 'ordering' && (
                  <>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                      {messages.map((msg, idx) => (
                        <div
                          key={idx}
                          className={`flex ${
                            msg.role === 'user'
                              ? 'justify-end'
                              : msg.role === 'feedback'
                              ? 'justify-center'
                              : 'justify-start'
                          }`}
                        >
                          <div
                            className={`max-w-lg px-4 py-2 rounded-lg ${
                              msg.role === 'user'
                                ? 'bg-orange-500 text-white'
                                : msg.role === 'feedback'
                                ? 'bg-blue-50 text-blue-800 border border-blue-200 text-sm italic'
                                : 'bg-gray-100 text-gray-800'
                            }`}
                          >
                            {msg.role === 'feedback' && <span className="font-semibold">üìö M√°lfar: </span>}
                            {msg.content}
                          </div>
                        </div>
                      ))}

                      {loading && (
                        <div className="flex justify-start">
                          <div className="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg">
                            <div className="flex space-x-2">
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <div className="border-t p-4">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={input}
                          onChange={(e) => setInput(e.target.value)}
                          onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                          placeholder="Skrifa√∞u p√∂ntunina √æ√≠na..."
                          className="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                          disabled={loading}
                        />
                        <button
                          onClick={sendMessage}
                          disabled={loading || !input.trim()}
                          className="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                          aria-label="Senda skilabo√∞"
                          title="Senda"
                        >
                          <SendIcon />
                        </button>
                      </div>
                    </div>
                  </>
                )}

                {stage === 'payment' && (
                  <div className="flex-1 flex items-center justify-center p-6">
                    <div className="text-center">
                      <h2 className="text-3xl font-bold text-gray-800 mb-8">Grei√∞sla</h2>

                      <div className="bg-gray-800 rounded-lg p-8 mb-6 relative overflow-hidden">
                        <div className="w-64 h-40 bg-gradient-to-br from-gray-700 to-gray-900 rounded-lg flex items-center justify-center">
                          {paymentStep === 'idle' && (
                            <div className="text-gray-400">
                              <CreditCardIcon />
                            </div>
                          )}
                          {paymentStep === 'inserting' && (
                            <div className="text-yellow-400 animate-pulse">
                              <CreditCardIcon />
                              <p className="mt-2 text-sm">Setji√∞ korti√∞ √° posa...</p>
                            </div>
                          )}
                          {paymentStep === 'processing' && (
                            <div className="text-blue-400">
                              <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400 mx-auto"></div>
                              <p className="mt-4 text-sm">Vinnsla...</p>
                            </div>
                          )}
                          {paymentStep === 'success' && (
                            <div className="text-green-400">
                              <div className="text-6xl mb-2">‚úì</div>
                              <p className="text-lg font-bold">BIP! üéâ</p>
                              <p className="text-sm">Greitt!</p>
                            </div>
                          )}
                        </div>
                      </div>

                      {paymentStep === 'idle' && (
                        <button
                          onClick={handlePayment}
                          className="bg-orange-500 text-white px-8 py-4 rounded-lg text-xl font-bold hover:bg-orange-600 transition-colors shadow-lg"
                        >
                          Setja kort √° posa
                        </button>
                      )}
                    </div>
                  </div>
                )}

                {stage === 'complete' && (
                  <div className="flex-1 flex items-center justify-center p-6">
                    <div className="text-center">
                      <div className="text-6xl mb-4">üéâ</div>
                      <h2 className="text-3xl font-bold text-gray-800 mb-4">Takk fyrir!</h2>
                      <div className="bg-orange-100 rounded-lg p-6 mb-6">
                        <p className="text-gray-600 mb-2">P√∂ntunarn√∫mer:</p>
                        <p className="text-5xl font-bold text-orange-600">#{orderNumber}</p>
                      </div>
                      <p className="text-xl text-gray-600 mb-8">
                        Vi√∞ l√°tum √æig vita √æegar p√∂ntunin er tilb√∫in!
                      </p>
                      <button
                        onClick={() => {
                          setStage('ordering');
                          setMessages([{ role: 'assistant', content: 'H√¶ og velkomin aftur √° Drekann! Hva√∞ m√° bj√≥√∞a √æ√©r √≠ dag? üòä' }]);
                          setPaymentStep('idle');
                          setOrderNumber(null);
                        }}
                        className="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors"
                      >
                        N√Ω p√∂ntun
                      </button>
                    </div>
                  </div>
                )}
              </section>
            </div>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Drekinn />);
  </script>
</body>
</html>
