<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé® √Åhugam√°l ‚Äì M√°lst√∂√∞in</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.4s ease both; }

    .answer-option {
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
      cursor: pointer;
    }
    .answer-option:hover:not(.disabled) { border-color: #3b82f6; background: #eff6ff; }
    .answer-option.selected  { border-color: #3b82f6; background: #eff6ff; }
    .answer-option.correct   { border-color: #22c55e; background: #f0fdf4; }
    .answer-option.incorrect { border-color: #ef4444; background: #fef2f2; }
    .answer-option.disabled  { cursor: default; }

    .tab-btn { transition: all 0.2s; position: relative; }
    .tab-btn:not(.active):hover { background: #f3f4f6; }
    .tab-btn.active { background: white; color: #2563eb; font-weight: 500; }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
      height: 3px; background: #2563eb; border-radius: 2px 2px 0 0;
    }

    .chat-box {
      max-height: 380px;
      overflow-y: auto;
    }
    .chat-box::-webkit-scrollbar { width: 5px; }
    .chat-box::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .chat-box::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }

    .text-panel {
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.3s ease;
    }
    .text-panel.open  { max-height: 800px; opacity: 1; }
    .text-panel.closed { max-height: 0; opacity: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    /* ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ */
    async function callOpenAI(messages, max_tokens = 300) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, max_tokens, model: 'gpt-4o-mini', temperature: 0.5 })
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    /* ‚îÄ‚îÄ‚îÄ EFNI ‚îÄ‚îÄ‚îÄ */
    const READING_TEXT = [
      { type: 'intro', text: '√Åhugam√°l geta veri√∞ m√∂rg og √≥l√≠k. Sumir hafa eitt √°hugam√°l en a√∞rir m√∂rg. Og stundum breytast √°hugam√°lin okkar e√∞a vi√∞ f√°um n√Ω √°hugam√°l. Margir hafa √°huga √° √≠√ær√≥ttum en a√∞rir lesa b√¶kur e√∞a hlusta √° t√≥nlist. √Åhugam√°l geta hj√°lpa√∞ okkur a√∞ slappa af en l√≠ka a√∞ gera eitthva√∞ spennandi.' },
      { type: 'heading', text: '1. Sund' },
      { type: 'para', text: 'Sund er mj√∂g vins√¶lt √° √çslandi. Flestir synda √≠ sundlaugum en sumir synda √≠ sj√≥num og jafnvel √° veturna! Sund er gott fyrir heilsuna √æv√≠ √æa√∞ er au√∞velt a√∞ hreyfa sig √≠ vatni. Margir fara √≠ sund tvisvar e√∞a √ærisvar sinnum √≠ viku. Eftir sund er vins√¶lt a√∞ fara √≠ heitan pott til a√∞ slappa af. F√≥lk spjallar oft miki√∞ saman √≠ heitum pottum.' },
      { type: 'heading', text: '2. F√≥tbolti' },
      { type: 'para', text: 'F√≥tbolti er vins√¶lasta √≠√ær√≥ttin √≠ heimi. Tv√∂ li√∞ reyna a√∞ skora mark. Oft eru ellefu leikmenn √≠ li√∞i og einn er markv√∂r√∞ur. Hann m√° taka boltann me√∞ h√∂ndum. √ûa√∞ er mikilv√¶gt a√∞ hlaupa hratt og sparka fast √≠ boltann. Margir √¶fa me√∞ li√∞i, kannski 4‚Äì5 sinnum √≠ viku en sumir vilja bara leika s√©r √≠ f√≥tbolta me√∞ vinum s√≠num. Mj√∂g margir horfa √° f√≥tbolta √≠ sj√≥nvarpinu og sty√∞ja sitt li√∞.' },
      { type: 'heading', text: '3. T√≥nlist' },
      { type: 'para', text: 'T√≥nlist er fallegt √°hugam√°l. F√≥lk spilar √° hlj√≥√∞f√¶ri eins og til d√¶mis g√≠tar, p√≠an√≥ e√∞a fi√∞lu. A√∞rir syngja e√∞a hlusta √° t√≥nlist. T√≥nlist getur veri√∞ r√≥leg e√∞a hr√∂√∞, gla√∞leg e√∞a sorgleg. Margir fara √° t√≥nleika e√∞a dansa vi√∞ t√≥nlist. Sumir semja l√∂g og texta og spila √° t√≥nleikum, jafnvel me√∞ hlj√≥msveit. Margir hlusta √° t√≥nlist √æegar √æeir vinna e√∞a l√¶ra.' },
      { type: 'heading', text: '4. Lesa b√¶kur' },
      { type: 'para', text: 'A√∞ lesa b√¶kur er gott √°hugam√°l. Sumar b√¶kur eru spennandi, a√∞rar eru fyndnar e√∞a sorglegar. Margir lesa √° kv√∂ldin √°√∞ur en √æeir fara a√∞ sofa. Vi√∞ l√¶rum n√Ω or√∞ og f√°um n√Ωjar hugmyndir √æegar vi√∞ lesum b√¶kur.' },
      { type: 'outro', text: 'Sumir hafa m√∂rg √°hugam√°l, a√∞rir hafa f√°. Sumir elska a√∞ vera virkir og √¶fa sig, en a√∞rir nj√≥ta √æess a√∞ slaka √° og lesa e√∞a hlusta √° t√≥nlist.' }
    ];

    const MC_QUESTIONS = [
      {
        question: 'Hvers vegna er gott fyrir heilsuna a√∞ fara √≠ sund?',
        options: ['Vegna √æess a√∞ vatni√∞ er kalt.', 'Vegna √æess a√∞ √æa√∞ er au√∞velt a√∞ hreyfa sig √≠ vatni.', 'Vegna √æess a√∞ √æa√∞ er erfitt a√∞ synda.'],
        correct: 1
      },
      {
        question: 'Hva√∞ gera margir √≠ heitum pottum eftir sund?',
        options: ['√ûeir sofa.', '√ûeir bor√∞a mat.', '√ûeir slappa af og spjalla saman.'],
        correct: 2
      },
      {
        question: 'Hva√∞ m√° markv√∂r√∞ur √≠ f√≥tbolta gera sem a√∞rir leikmenn mega ekki?',
        options: ['Hann m√° hlaupa hra√∞ar.', 'Hann m√° taka boltann me√∞ h√∂ndum.', 'Hann m√° skora m√∂rg m√∂rk.'],
        correct: 1
      },
      {
        question: 'Hva√∞a hlj√≥√∞f√¶ri eru nefnd sem d√¶mi √≠ textanum?',
        options: ['Trommur og flauta.', 'G√≠tar, p√≠an√≥ og fi√∞la.', 'Orgel og l√∫√∞ur.'],
        correct: 1
      },
      {
        question: 'Hven√¶r finnst m√∂rgum gott a√∞ lesa b√¶kur?',
        options: ['√Å morgnana √æegar √æeir vakna.', '√Å kv√∂ldin √°√∞ur en √æeir fara a√∞ sofa.', '√ûegar √æeir eru a√∞ bor√∞a h√°degismat.'],
        correct: 1
      },
      {
        question: 'Hva√∞ gerist √æegar vi√∞ lesum b√¶kur samkv√¶mt textanum?',
        options: ['Vi√∞ gleymum √∂llu.', 'Vi√∞ l√¶rum n√Ω or√∞ og f√°um n√Ωjar hugmyndir.', 'Vi√∞ ver√∞um mj√∂g √æreytt.'],
        correct: 1
      }
    ];

    const OPEN_QUESTIONS = [
      'L√Ωstu √æv√≠ hvernig f√≥tboltaleikur virkar samkv√¶mt textanum (li√∞, leikmenn og markmi√∞).',
      'Hva√∞a mismunandi tilfinningar getur t√≥nlist kalla√∞ fram og hven√¶r hlustar f√≥lk oft √° hana?',
      'Af hverju heldur √æ√∫ a√∞ sund s√© svona vins√¶lt √° √çslandi mi√∞a√∞ vi√∞ √æa√∞ sem fram kemur √≠ textanum?'
    ];

    const DISCUSSION_QUESTIONS = [
      'Hvert er √æitt upp√°halds √°hugam√°l og af hverju l√≠√∞ur √æ√©r vel √æegar √æ√∫ stundar √æa√∞?',
      'Finnst √æ√©r skemmtilegara a√∞ stunda √°hugam√°l einn e√∞a me√∞ √∂√∞rum? Af hverju?',
      'Ef √æ√∫ g√¶tir pr√≥fa√∞ eitt n√Ωtt √°hugam√°l, hva√∞ myndir √æ√∫ velja og hvers vegna?'
    ];

    const TABS = [
      { id: 'krossar', label: 'Krossaspurningar', icon: '‚úì' },
      { id: 'stuttar', label: 'Stuttar spurningar', icon: 'üìù' },
      { id: 'umraeda', label: 'Umr√¶√∞uspurningar', icon: 'üí¨' }
    ];

    /* ‚îÄ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ‚îÄ */
    const FeedbackBadge = ({ score, message }) => {
      const color = score >= 4 ? 'green' : score >= 2 ? 'amber' : 'red';
      const cls = {
        green: 'bg-green-50 border-green-200 text-green-700',
        amber: 'bg-amber-50 border-amber-200 text-amber-700',
        red:   'bg-red-50 border-red-200 text-red-700'
      }[color];
      return (
        <div className={`p-3 rounded-lg border ${cls}`}>
          <div className="font-medium text-xs mb-1">Stig: {score}/5</div>
          <p className="text-sm font-light">{message}</p>
        </div>
      );
    };

    /* ‚îÄ‚îÄ‚îÄ TEXT PANEL ‚îÄ‚îÄ‚îÄ */
    const TextPanel = ({ open, onToggle }) => (
      <div className="bg-white border-b border-gray-200 sticky top-0 z-20 shadow-sm">
        <div className="max-w-4xl mx-auto px-6">
          <button onClick={onToggle}
            className="w-full flex items-center justify-between py-4 text-left group">
            <span className="flex items-center gap-2 text-gray-700 font-light group-hover:text-blue-600 transition-colors">
              <span className="text-lg">üìñ</span>
              <span>Textinn ‚Äì <em className="font-light text-gray-500">√Åhugam√°l</em></span>
            </span>
            <span className={`text-gray-400 transition-transform duration-300 ${open ? 'rotate-180' : ''}`}>‚ñº</span>
          </button>
          <div className={`text-panel ${open ? 'open' : 'closed'}`}>
            <div className="pb-6 space-y-3">
              {READING_TEXT.map((block, i) => {
                if (block.type === 'heading')
                  return <h3 key={i} className="text-base font-medium text-gray-800 mt-4">{block.text}</h3>;
                return <p key={i} className="text-gray-700 leading-relaxed font-light text-sm">{block.text}</p>;
              })}
            </div>
          </div>
        </div>
      </div>
    );

    /* ‚îÄ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ‚îÄ */
    const TabBar = ({ active, done, onSelect }) => (
      <div className="bg-white border-b border-gray-200 sticky top-[57px] z-10">
        <div className="max-w-4xl mx-auto px-6">
          <div className="flex gap-1">
            {TABS.map(t => (
              <button key={t.id} onClick={() => onSelect(t.id)}
                className={`tab-btn px-4 py-4 text-sm flex items-center gap-1.5 ${active === t.id ? 'active' : 'text-gray-500'}`}>
                <span>{t.icon}</span>
                <span className="hidden sm:inline">{t.label}</span>
                {done[t.id] && <span className="text-green-500 text-xs ml-1">‚úî</span>}
              </button>
            ))}
          </div>
        </div>
      </div>
    );

    /* ‚îÄ‚îÄ‚îÄ TAB 1: KROSSASPURNINGAR ‚îÄ‚îÄ‚îÄ */
    const KrossarTab = ({ onDone }) => {
      const [answers, setAnswers] = useState({});
      const [checked, setChecked] = useState(false);

      const pick = (qi, oi) => { if (!checked) setAnswers(a => ({ ...a, [qi]: oi })); };

      const check = () => {
        if (Object.keys(answers).length < MC_QUESTIONS.length) {
          alert('Vinsamlegast svara√∞u √∂llum spurningum!'); return;
        }
        setChecked(true);
        onDone();
      };

      const score = checked ? MC_QUESTIONS.filter((q, i) => answers[i] === q.correct).length : null;

      return (
        <div className="space-y-5 fade-in">
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div className="text-5xl mb-3">‚úì</div>
            <h2 className="text-xl font-light text-gray-800 mb-1">Krossaspurningar</h2>
            <p className="text-gray-500 text-sm font-light">Veldu r√©ttan valm√∂guleika fyrir hverja spurningu.</p>
          </div>

          {MC_QUESTIONS.map((q, qi) => (
            <div key={qi} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <p className="font-medium text-gray-800 mb-4">{qi + 1}. {q.question}</p>
              <div className="space-y-3">
                {q.options.map((opt, oi) => {
                  const sel = answers[qi] === oi;
                  const isCorrect = oi === q.correct;
                  let cls = 'answer-option p-4 rounded-lg font-light text-sm';
                  if (checked) {
                    cls += ' disabled';
                    if (sel && isCorrect) cls += ' correct';
                    else if (sel && !isCorrect) cls += ' incorrect';
                    else if (isCorrect) cls += ' correct';
                  } else if (sel) cls += ' selected';
                  return (
                    <div key={oi} className={cls} onClick={() => pick(qi, oi)}>
                      <div className="flex items-start gap-3">
                        <span className="font-medium text-gray-500">{String.fromCharCode(65 + oi)}.</span>
                        <span>{opt}</span>
                        {checked && isCorrect && <span className="ml-auto text-green-600">‚úì</span>}
                        {checked && sel && !isCorrect && <span className="ml-auto text-red-500">‚úó</span>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}

          {!checked ? (
            <div className="text-center">
              <button onClick={check}
                className="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-light">
                Athuga sv√∂r
              </button>
            </div>
          ) : (
            <div className="bg-white rounded-xl shadow-sm border border-green-100 p-6 text-center fade-in">
              <div className="text-4xl mb-2">
                {score === MC_QUESTIONS.length ? 'üéâ' : score >= 4 ? 'üëç' : 'üí™'}
              </div>
              <p className="text-gray-700 font-light">
                √û√∫ f√©kkst <strong className="font-medium">{score}</strong> af{' '}
                <strong className="font-medium">{MC_QUESTIONS.length}</strong> r√©tt
                {' '}({Math.round(score / MC_QUESTIONS.length * 100)}%)
              </p>
            </div>
          )}
        </div>
      );
    };

    /* ‚îÄ‚îÄ‚îÄ TAB 2: STUTTAR SPURNINGAR ‚îÄ‚îÄ‚îÄ */
    const StuttarTab = ({ onDone }) => {
      const [convos, setConvos] = useState([[], [], []]);
      const [inputs, setInputs] = useState(['', '', '']);
      const [loading, setLoading] = useState([false, false, false]);
      const [feedback, setFeedback] = useState([null, null, null]);
      const chatRefs = [useRef(null), useRef(null), useRef(null)];

      const scroll = (i) => setTimeout(() => {
        if (chatRefs[i].current) chatRefs[i].current.scrollTop = chatRefs[i].current.scrollHeight;
      }, 100);

      const send = async (i) => {
        const msg = inputs[i].trim();
        if (!msg) return;

        setLoading(l => { const n=[...l]; n[i]=true; return n; });
        setConvos(c => { const n=[...c]; n[i]=[...n[i], {role:'user', text:msg}]; return n; });
        setInputs(inp => { const n=[...inp]; n[i]=''; return n; });
        scroll(i);

        try {
          const result = await callOpenAI([
            { role: 'system', content: '√û√∫ ert hl√Ωr og hvetjandi √≠slenskukennari.' },
            { role: 'user', content: `Spurning: "${OPEN_QUESTIONS[i]}"\nSvar: "${msg}"\n\nSvara√∞u EINUNGIS:\nSTIG: [0-5]\nENDURGJ√ñF: [ein til tv√¶r setningar, vinsamlegar og hvetjandi]` }
          ], 200);

          const stigMatch = result.match(/STIG:\s*(\d)/);
          const endMatch  = result.match(/ENDURGJ√ñF:\s*(.+)/s);
          const score = stigMatch ? parseInt(stigMatch[1]) : 3;
          const text  = endMatch ? endMatch[1].trim() : result.trim();

          const newFeedback = [...feedback]; newFeedback[i] = {score, text};
          setFeedback(newFeedback);
          setConvos(c => { const n=[...c]; n[i]=[...n[i], {role:'assistant', score, text}]; return n; });
          if (newFeedback.every(f => f !== null)) onDone();
          scroll(i);
        } catch (e) {
          alert('Villa. Reyndu aftur.');
          setConvos(c => { const n=[...c]; n[i]=n[i].slice(0,-1); return n; });
        }
        setLoading(l => { const n=[...l]; n[i]=false; return n; });
      };

      return (
        <div className="space-y-5 fade-in">
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div className="text-5xl mb-3">üìù</div>
            <h2 className="text-xl font-light text-gray-800 mb-1">Stuttar spurningar</h2>
            <p className="text-gray-500 text-sm font-light">Svara√∞u spurningunum me√∞ heilum setningum.</p>
          </div>

          {OPEN_QUESTIONS.map((q, i) => (
            <div key={i} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <p className="font-medium text-gray-800 mb-4">{i + 1}. {q}</p>
              <div ref={chatRefs[i]} className="chat-box mb-4 space-y-3 min-h-[40px]">
                {convos[i].map((msg, mi) => (
                  <div key={mi}>
                    {msg.role === 'user' ? (
                      <div className="flex justify-end">
                        <div className="bg-blue-50 rounded-xl rounded-tr-sm px-4 py-3 max-w-[85%]">
                          <p className="text-gray-800 font-light text-sm">{msg.text}</p>
                        </div>
                      </div>
                    ) : (
                      <div className="flex justify-start">
                        <div className="max-w-[90%]">
                          <FeedbackBadge score={msg.score} message={msg.text} />
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                {loading[i] && (
                  <div className="flex justify-start">
                    <div className="bg-gray-100 rounded-lg px-4 py-3">
                      <p className="text-gray-400 text-sm font-light">‚Ä¶</p>
                    </div>
                  </div>
                )}
              </div>

              {!feedback[i] ? (
                <div className="flex gap-2">
                  <textarea
                    value={inputs[i]}
                    onChange={e => setInputs(inp => { const n=[...inp]; n[i]=e.target.value; return n; })}
                    onKeyDown={e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(i); } }}
                    disabled={loading[i]} rows={2}
                    placeholder="Skrifa√∞u svari√∞ √æitt h√©r‚Ä¶"
                    className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-400 font-light text-sm resize-none disabled:bg-gray-50"
                  />
                  <button onClick={() => send(i)}
                    disabled={loading[i] || !inputs[i].trim()}
                    className="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light text-sm self-end">
                    F√° endurgj√∂f
                  </button>
                </div>
              ) : (
                <div className="flex items-center gap-2 text-green-600 text-sm font-light">
                  <span>‚úî</span><span>Loki√∞</span>
                </div>
              )}
            </div>
          ))}
        </div>
      );
    };

    /* ‚îÄ‚îÄ‚îÄ TAB 3: UMR√Ü√êUSPURNINGAR (AI spjall) ‚îÄ‚îÄ‚îÄ */
    const Umrae√∞aTab = ({ onDone }) => {
      const [convos, setConvos] = useState(
        DISCUSSION_QUESTIONS.map(q => [{ role: 'assistant', text: q }])
      );
      const [inputs, setInputs] = useState(['', '', '']);
      const [loading, setLoading] = useState([false, false, false]);
      const [turnCount, setTurnCount] = useState([0, 0, 0]);
      const [closed, setClosed] = useState([false, false, false]);
      const chatRefs = [useRef(null), useRef(null), useRef(null)];

      const scroll = (i) => setTimeout(() => {
        if (chatRefs[i].current) chatRefs[i].current.scrollTop = chatRefs[i].current.scrollHeight;
      }, 100);

      const send = async (i) => {
        const msg = inputs[i].trim();
        if (!msg || closed[i]) return;

        const newTurn = turnCount[i] + 1;
        const isLast = newTurn >= 4;

        setLoading(l => { const n=[...l]; n[i]=true; return n; });
        setConvos(c => { const n=[...c]; n[i]=[...n[i], {role:'user', text:msg}]; return n; });
        setInputs(inp => { const n=[...inp]; n[i]=''; return n; });
        setTurnCount(t => { const n=[...t]; n[i]=newTurn; return n; });
        scroll(i);

        try {
          const history = convos[i].map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.role === 'grammar' ? '' : m.text
          })).filter(m => m.content);

          const systemPrompt = isLast
            ? `√û√∫ ert vingjarnlegur √≠slenskukennari. √ûetta er s√≠√∞asta svar √æitt √≠ √æessu samtali.
Svara√∞u hl√Ωlega og stuttlega (1-2 setningar) og lj√∫ktu samtalinu √° n√°tt√∫rulegan og hl√Ω m√°ta ‚Äì
eins og "√ûetta er fr√°b√¶rt a√∞ heyra!" e√∞a "J√°, √æa√∞ hl√Ωtur a√∞ vera gaman!".
Engar spurningar. √Å √≠slensku.`
            : `√û√∫ ert vingjarnlegur √≠slenskukennari sem r√¶√∞ir vi√∞ nemanda um √°hugam√°l.
Svara√∞u stuttlega (1-2 setningar) vi√∞ √æv√≠ sem nemandinn sag√∞i og settu fram eina n√°tt√∫rulega eftirspurningu til a√∞ halda samtalinu √°fram.
Vertu hl√Ωr og √°hugasamur. √Å √≠slensku.`;

          // Run conversation reply and grammar check in parallel
          const [result, grammarResult] = await Promise.all([
            callOpenAI([
              { role: 'system', content: systemPrompt },
              ...history,
              { role: 'user', content: msg }
            ], 150),
            callOpenAI([
              { role: 'system', content: `√û√∫ ert √≠slenskukennari sem gefur MJ√ñG stuttar og hl√Ωjar m√°lfars√°bendingar til nemenda √° A1-A2 stigi.
Sko√∞a√∞u setninguna og athuga√∞u hvort √æa√∞ s√© ein auglj√≥s villa (stafsetning, kyn or√∞a, eint√∂lu/fleirt√∂lu e√∞a beygingu).
Ef √æa√∞ er villa: Svara√∞u me√∞ einni stuttri setningu sem byrjar √° "Mundu a√∞..." og lagar villuna hl√Ωlega, t.d. "Mundu a√∞ 'gaman' er hvorugkyn, svo vi√∞ segjum '√æa√∞ er gaman' üòä" e√∞a "Mundu a√∞ √æa√∞ er bara eitt n √≠ 'kenna' üòä".
Ef engin villa e√∞a ef √æa√∞ er of fl√≥ki√∞: Svara√∞u EINUNGIS me√∞ "ENGIN".
Vera MJ√ñG hvetjandi. Aldrei nefna fleiri en eina villu.` },
              { role: 'user', content: msg }
            ], 80)
          ]);

          const msgs = [];
          // Add grammar tip if there is one
          const grammarClean = grammarResult.trim();
          if (grammarClean && grammarClean !== 'ENGIN' && !grammarClean.toUpperCase().startsWith('ENGIN')) {
            msgs.push({ role: 'grammar', text: grammarClean });
          }
          msgs.push({ role: 'assistant', text: result });

          setConvos(c => { const n=[...c]; n[i]=[...n[i], ...msgs]; return n; });

          if (isLast) {
            setClosed(cl => {
              const n = [...cl]; n[i] = true;
              if (n.every(Boolean)) onDone();
              return n;
            });
          }
          scroll(i);
        } catch (e) {
          alert('Villa. Reyndu aftur.');
          setConvos(c => { const n=[...c]; n[i]=n[i].slice(0,-1); return n; });
          setTurnCount(t => { const n=[...t]; n[i]=newTurn-1; return n; });
        }
        setLoading(l => { const n=[...l]; n[i]=false; return n; });
      };

      const allDone = closed.every(Boolean);

      return (
        <div className="space-y-5 fade-in">
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div className="text-5xl mb-3">üí¨</div>
            <h2 className="text-xl font-light text-gray-800 mb-1">Umr√¶√∞uspurningar</h2>
            <p className="text-gray-500 text-sm font-light">
              Spjalla√∞u vi√∞ AI um √°hugam√°l √æ√≠n ‚Äì 3 tilsv√∂r √≠ hverju samtali.
            </p>
          </div>

          {DISCUSSION_QUESTIONS.map((_, i) => (
            <div key={i} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
              <div className="flex items-center justify-between mb-3">
                <p className="text-xs text-gray-400 font-light uppercase tracking-wide">Samtal {i + 1}</p>
                {closed[i] && (
                  <span className="text-xs text-green-600 font-light flex items-center gap-1">
                    <span>‚úî</span> Loki√∞
                  </span>
                )}
              </div>

              <div ref={chatRefs[i]} className="chat-box mb-4 space-y-3">
                {convos[i].map((msg, mi) => (
                  <div key={mi}>
                    {msg.role === 'user' ? (
                      <div className="flex justify-end">
                        <div className="bg-blue-50 rounded-xl rounded-tr-sm px-4 py-3 max-w-[80%]">
                          <p className="text-gray-800 font-light text-sm">{msg.text}</p>
                        </div>
                      </div>
                    ) : msg.role === 'grammar' ? (
                      <div className="flex justify-center">
                        <div className="bg-amber-50 border border-amber-200 rounded-lg px-4 py-2 max-w-[90%] flex items-start gap-2">
                          <span className="text-amber-500 text-xs mt-0.5 flex-shrink-0">üìå</span>
                          <p className="text-amber-800 font-light text-xs">{msg.text}</p>
                        </div>
                      </div>
                    ) : (
                      <div className="flex items-start gap-2">
                        <div className="w-7 h-7 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0 mt-0.5 text-xs">ü§ñ</div>
                        <div className="bg-gray-50 border border-gray-100 rounded-xl rounded-tl-sm px-4 py-3 max-w-[80%]">
                          <p className="text-gray-700 font-light text-sm">{msg.text}</p>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                {loading[i] && (
                  <div className="flex items-start gap-2">
                    <div className="w-7 h-7 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0 text-xs">ü§ñ</div>
                    <div className="bg-gray-50 border border-gray-100 rounded-xl px-4 py-3">
                      <p className="text-gray-400 text-sm">‚Ä¶</p>
                    </div>
                  </div>
                )}
              </div>

              {!closed[i] && (
                <div className="flex gap-2">
                  <textarea
                    value={inputs[i]}
                    onChange={e => setInputs(inp => { const n=[...inp]; n[i]=e.target.value; return n; })}
                    onKeyDown={e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(i); } }}
                    disabled={loading[i]} rows={2}
                    placeholder="Svara√∞u h√©r‚Ä¶"
                    className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-400 font-light text-sm resize-none disabled:bg-gray-50"
                  />
                  <button onClick={() => send(i)}
                    disabled={loading[i] || !inputs[i].trim()}
                    className="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light text-sm self-end">
                    Senda
                  </button>
                </div>
              )}
            </div>
          ))}

          {allDone && (
            <div className="bg-green-50 border border-green-200 rounded-xl p-5 text-center fade-in">
              <p className="text-green-700 font-light">üéâ Fr√°b√¶rt! √û√∫ kl√°ra√∞ir √∂ll √ærj√∫ samt√∂lin.</p>
            </div>
          )}
        </div>
      );
    };

    /* ‚îÄ‚îÄ‚îÄ BOTTOM PROGRESS ‚îÄ‚îÄ‚îÄ */
    const BottomProgress = ({ done }) => {
      const count = Object.values(done).filter(Boolean).length;
      return (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 z-30">
          <div className="max-w-4xl mx-auto flex items-center gap-4">
            <span className="text-xs text-gray-500 font-light whitespace-nowrap">Framvinda</span>
            <div className="flex gap-1.5 flex-1">
              {TABS.map(t => (
                <div key={t.id} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${done[t.id] ? 'bg-green-500' : 'bg-gray-200'}`} />
              ))}
            </div>
            <span className="text-xs text-gray-500 font-light whitespace-nowrap">{count}/{TABS.length}</span>
          </div>
        </div>
      );
    };

    /* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
    const App = () => {
      const [textOpen, setTextOpen] = useState(true);
      const [activeTab, setActiveTab] = useState('krossar');
      const [done, setDone] = useState({ krossar: false, stuttar: false, umraeda: false });

      const markDone = (tab) => setDone(d => ({ ...d, [tab]: true }));

      return (
        <div className="min-h-screen pb-16">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-6">
              <button onClick={() => window.history.back()}
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light">
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-1">√Åhugam√°l</h1>
              <p className="text-gray-500 text-sm font-light">Lesskilningur og umr√¶√∞a ¬∑ A1‚ÄìA2</p>
            </div>
          </header>

          <TextPanel open={textOpen} onToggle={() => setTextOpen(o => !o)} />
          <TabBar active={activeTab} done={done} onSelect={setActiveTab} />

          <main className="max-w-4xl mx-auto px-6 mt-6">
            {activeTab === 'krossar' && <KrossarTab onDone={() => markDone('krossar')} />}
            {activeTab === 'stuttar' && <StuttarTab onDone={() => markDone('stuttar')} />}
            {activeTab === 'umraeda' && <Umrae√∞aTab onDone={() => markDone('umraeda')} />}
          </main>

          <BottomProgress done={done} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
