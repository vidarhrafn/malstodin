<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîç Finndu or√∞i√∞ ‚Äì √Åhugam√°l og l√≠kamsr√¶kt</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%); min-height: 100vh; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SpeakerIcon = ({ active = false }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`w-5 h-5 ${active ? 'text-red-500 animate-pulse' : 'text-white'}`}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    );

    const SendIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    );

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    async function speak(text) {
      try {
        const r = await fetch('/.netlify/functions/speak', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text_to_speak: text }) });
        const data = await r.json();
        if (!r.ok || data.error || !data.audio_base64) throw new Error(data.error || 'No audio');
        const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
        await audio.play();
      } catch (e) { console.error('speak error:', e); }
    }

    // Or√∞alisti ‚Äì √Åhugam√°l, L√≠kamsr√¶kt, Bj√∂rgunarsveitir (A1‚ÄìB1)
    const DEFAULT_WORDS = [
      // √Åhugam√°l
      { word: 'sundlaug', def: 'st√≥r p√Ωram√≠dalaga pottur me√∞ vatni √æar sem f√≥lk syndar', topic: '√Åhugam√°l' },
      { word: 'markv√∂r√∞ur', def: 'leikma√∞ur √≠ f√≥tbolta sem verndar marki√∞ og m√° taka boltann me√∞ h√∂ndum', topic: '√Åhugam√°l' },
      { word: 'heitur pottur', def: 'l√≠til laug me√∞ mj√∂g heitu vatni √æar sem f√≥lk slappir af eftir sund', topic: '√Åhugam√°l' },
      { word: 'g√≠tar', def: 'hlj√≥√∞f√¶ri me√∞ sex strengi sem ma√∞ur spilar √° me√∞ fingurna', topic: '√Åhugam√°l' },
      { word: 'fi√∞la', def: 'hlj√≥√∞f√¶ri me√∞ strengi sem ma√∞ur spilar √° me√∞ boga', topic: '√Åhugam√°l' },
      { word: 'hlj√≥msveit', def: 'h√≥pur t√≥nlistarmanna sem spilar saman √° t√≥nleikum', topic: '√Åhugam√°l' },
      { word: 't√≥nleik–∞—Ä', def: 'vi√∞bur√∞ur √æar sem hlj√≥msveit e√∞a s√∂ngvari syngur og spilar fyrir √°horfendur', topic: '√Åhugam√°l' },
      { word: 'f√≥tbolti', def: 'vins√¶l √≠√ær√≥tt √æar sem tv√∂ li√∞ reyna a√∞ sparka bolta √≠ mark', topic: '√Åhugam√°l' },
      { word: '√°hugam√°l', def: 'eitthva√∞ sem √æ√©r l√≠√∞ur vel a√∞ gera √≠ fr√≠t√≠ma √æ√≠num', topic: '√Åhugam√°l' },

      // L√≠kamsr√¶kt
      { word: 'hlaupabretti', def: 't√¶ki √≠ r√¶ktinni √æar sem ma√∞ur hleypur en er alltaf √° sama sta√∞', topic: 'L√≠kamsr√¶kt' },
      { word: 'l√≥√∞', def: '√æungt j√°rn sem ma√∞ur lyftur til a√∞ byggja upp v√∂√∞va', topic: 'L√≠kamsr√¶kt' },
      { word: 'j√≥ga', def: 'hreyfing √æar sem ma√∞ur teygir l√≠kamann og slappir af me√∞ andardr√¶tti', topic: 'L√≠kamsr√¶kt' },
      { word: 'gufuba√∞', def: 'l√≠ti√∞ herbergi fullt af heitu gufu √æar sem ma√∞ur svitnar', topic: 'L√≠kamsr√¶kt' },
      { word: '√ærek', def: 'geta til a√∞ hreyfa sig lengi √°n √æess a√∞ ver√∞a √æreyttur', topic: 'L√≠kamsr√¶kt' },
      { word: 'l√≠kamsr√¶kt', def: '√æa√∞ a√∞ hreyfa sig reglulega til a√∞ halda l√≠kamanum heilbrig√∞um og sterkum', topic: 'L√≠kamsr√¶kt' },
      { word: 'teygju√¶fingar', def: '√¶fingar √æar sem ma√∞ur teygir v√∂√∞vana til a√∞ ver√∞a sveigjanlegur', topic: 'L√≠kamsr√¶kt' },
      { word: '√°rskort', def: 'mi√∞i sem gefur √æ√©r a√∞gang √≠ r√¶ktina √≠ heilt √°r', topic: 'L√≠kamsr√¶kt' },
      { word: 'fjallganga', def: '√æa√∞ a√∞ ganga langar lei√∞ir upp √≠ fj√∂ll √≠ n√°tt√∫runni', topic: 'L√≠kamsr√¶kt' },

      // Bj√∂rgunarsveitir
      { word: '√æyrla', def: 'flugv√©l sem getur flogi√∞ upp og ni√∞ur og stillt hra√∞a √° lofti ‚Äì notu√∞ vi√∞ bj√∂rgun', topic: 'Bj√∂rgunarsveitir' },
      { word: 'jeppi', def: 'sterk og h√° bifrei√∞ sem getur eki√∞ um erfitt landslag og snj√≥', topic: 'Bj√∂rgunarsveitir' },
      { word: 'v√©lsle√∞i', def: 'farart√¶ki √° snj√≥num sem keyrist me√∞ v√©l og fer hratt', topic: 'Bj√∂rgunarsveitir' },
      { word: 'sj√°lfbo√∞ali√∞i', def: 'einstaklingur sem vinnur √°n √æess a√∞ f√° greitt vegna √æess a√∞ hann vill hj√°lpa', topic: 'Bj√∂rgunarsveitir' },
      { word: 'skyndihj√°lp', def: 'fyrsta a√∞sto√∞ sem ma√∞ur veitir √æegar einhver slasast √°√∞ur en l√¶knir kemur', topic: 'Bj√∂rgunarsveitir' },
      { word: 'talst√∂√∞', def: 't√¶ki sem f√≥lk notar til a√∞ tala saman √æegar √æa√∞ er langt fr√° hvert √∂√∞ru', topic: 'Bj√∂rgunarsveitir' },
      { word: '√∫tkall', def: '√æegar bj√∂rgunarsveit er k√∂llu√∞ √∫t til a√∞ hj√°lpa f√≥lki √≠ h√¶ttu', topic: 'Bj√∂rgunarsveitir' },
      { word: 'samvinna', def: '√æegar f√≥lk vinnur vel saman og hj√°lpar hvert √∂√∞ru a√∞ n√° markmi√∞um', topic: 'Bj√∂rgunarsveitir' },
    ];

    const TOPIC_COLORS = {
      '√Åhugam√°l': 'bg-blue-100 text-blue-800 border-blue-300',
      'L√≠kamsr√¶kt': 'bg-green-100 text-green-800 border-green-300',
      'Bj√∂rgunarsveitir': 'bg-purple-100 text-purple-800 border-purple-300',
    };

    const Game = () => {
      const [words] = useState(DEFAULT_WORDS);
      const [usedWords, setUsedWords] = useState([]);
      const [target, setTarget] = useState(null);
      const [desc, setDesc] = useState('');
      const [input, setInput] = useState('');
      const [messages, setMessages] = useState([]);
      const [wrong, setWrong] = useState(0);
      const [round, setRound] = useState(1);
      const [correctCount, setCorrectCount] = useState(0);
      const [speakingDesc, setSpeakingDesc] = useState(false);
      const [loading, setLoading] = useState(false);
      const [gameOver, setGameOver] = useState(false);
      const messagesEndRef = useRef(null);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const newRound = async (prevUsed = usedWords, prevTarget = null) => {
        const newUsed = prevTarget ? [...prevUsed, prevTarget.word] : prevUsed;
        const available = words.filter(w => !newUsed.includes(w.word));
        if (available.length === 0) { setGameOver(true); return; }

        setUsedWords(newUsed);
        setLoading(true);
        setMessages([]);
        setInput('');
        setWrong(0);
        setDesc('');

        const pick = available[Math.floor(Math.random() * available.length)];
        setTarget(pick);

        const sys = `√û√∫ hj√°lpar √≠slenskunema √° A1‚ÄìB1 stigi. L√Ωstu hlut e√∞a hugtaki √°n √æess a√∞ nefna or√∞i√∞ sj√°lft. Nota√∞u 1‚Äì3 einfaldar setningar √° √≠slensku. Ekki nota fl√≥kin or√∞. Lj√∫ktu me√∞ spurningu: "Hva√∞ er √æetta?".`;
        const user = `Or√∞: "${pick.word}". Einf√∂ld √∫tsk√Ωring: "${pick.def}". B√∫√∞u til A1‚ÄìB1 l√Ωsingu.`;

        try {
          const content = await callOpenAI({ model: 'gpt-4o-mini', temperature: 0.3, max_tokens: 120, messages: [{ role: 'system', content: sys }, { role: 'user', content: user }] });
          setDesc(content);
        } catch (e) {
          setDesc(`√ûetta er ${pick.def}. Hva√∞ er √æetta?`);
        }
        setLoading(false);
      };

      useEffect(() => { newRound([], null); }, []);

      const submitGuess = async () => {
        const guess = input.trim();
        if (!guess || !target) return;
        setMessages(prev => [...prev, { role: 'user', content: guess }]);
        setInput('');

        const checkSys = `√û√∫ ert a√∞ meta hvort nemandi giska√∞i r√©tt √° or√∞. R√©tta or√∞i√∞ er "${target.word}". Nemandinn giska√∞i: "${guess}".
SAM√ûYKKJA: n√°kv√¶mlega r√©tt, sagnir me√∞/√°n "a√∞", sm√°v√¶gilegar stafsetningarvillur, eint√∂lu/fleirt√∂lu.
HAFNA: alveg rangt or√∞.
Svara√∞u A√êEINS me√∞ "R√âTT" e√∞a "RANGT".`;

        try {
          const aiDecision = await callOpenAI({ model: 'gpt-4o-mini', temperature: 0.1, max_tokens: 10, messages: [{ role: 'system', content: checkSys }] });
          const isCorrect = aiDecision.trim().toUpperCase().includes('R√âTT');

          if (isCorrect) {
            const ok = `‚úÖ R√©tt! Or√∞i√∞ var ‚Äû${target.word}".`;
            setMessages(prev => [...prev, { role: 'system', content: ok }]);
            await speak(ok);
            setCorrectCount(c => c + 1);
            setTimeout(() => { setRound(r => r + 1); newRound(usedWords, target); }, 900);
            return;
          }
        } catch (e) {
          if (guess.toLowerCase() === target.word.toLowerCase()) {
            const ok = `‚úÖ R√©tt! Or√∞i√∞ var ‚Äû${target.word}".`;
            setMessages(prev => [...prev, { role: 'system', content: ok }]);
            await speak(ok); setCorrectCount(c => c + 1);
            setTimeout(() => { setRound(r => r + 1); newRound(usedWords, target); }, 900);
            return;
          }
        }

        const wrongMsg = `‚ùå Ekki r√©tt. Pr√≥fa√∞u aftur.`;
        setMessages(prev => [...prev, { role: 'system', content: wrongMsg }]);
        await speak(wrongMsg);

        const n = wrong + 1;
        setWrong(n);

        if (n === 2) {
          const first = target.word[0];
          const pron = getLetterPronunciation(first);
          setMessages(prev => [...prev, { role: 'hint', content: 'üí° V√≠sbending 1', hintText: `V√≠sbending: Or√∞i√∞ byrjar √° ${pron}.` }]);
        } else if (n === 4) {
          setMessages(prev => [...prev, { role: 'hint', content: 'üí° V√≠sbending 2', hintText: `√ñnnur v√≠sbending: Or√∞i√∞ hefur ${target.word.length} stafi.` }]);
        } else if (n === 6) {
          const ending = target.word.slice(-3);
          setMessages(prev => [...prev, { role: 'hint', content: 'üí° V√≠sbending 3', hintText: `S√≠√∞asta v√≠sbending: Or√∞i√∞ endar √° ‚Äû${ending}".` }]);
        } else if (n >= 7) {
          await speak(`R√©tt svar er: ${target.word}. Pr√≥fum n√Ωtt or√∞!`);
          setMessages(prev => [...prev, { role: 'system', content: `R√©tt svar var: ‚Äû${target.word}"` }]);
          setTimeout(() => { setRound(r => r + 1); newRound(usedWords, target); }, 700);
        }
      };

      const replayDesc = async () => {
        if (desc) { setSpeakingDesc(true); await speak(desc); setSpeakingDesc(false); }
      };

      const resetGame = () => {
        setUsedWords([]); setRound(1); setCorrectCount(false); setGameOver(false);
        setCorrectCount(0);
        newRound([], null);
      };

      function getLetterPronunciation(letter) {
        const p = { a:'a', √°:'√°', b:'b√©', d:'d√©', √∞:'e√∞', e:'e', f:'eff', g:'g√©', h:'h√°', i:'i', √≠:'√≠', j:'jo√∞', k:'k√°', l:'ell', m:'emm', n:'enn', o:'o', √≥:'√≥', p:'p√©', r:'err', s:'ess', t:'t√©', u:'u', √∫:'√∫', v:'vaff', x:'ex', y:'ufsilon y', √Ω:'ufsilon √Ω', √æ:'√æoddn', √¶:'√¶', √∂:'√∂' };
        return p[letter.toLowerCase()] || letter;
      }

      const currentTopic = target?.topic;
      const topicColor = currentTopic ? TOPIC_COLORS[currentTopic] : 'bg-gray-100 text-gray-700 border-gray-200';

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-3xl mx-auto px-6 py-8">
              <button onClick={() => window.history.back()} className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light">‚Üê Til baka</button>
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div>
                  <h1 className="text-3xl font-light text-gray-800 mb-1">üîç Finndu or√∞i√∞</h1>
                  <p className="text-gray-500 text-sm font-light">√Åhugam√°l ¬∑ L√≠kamsr√¶kt ¬∑ Bj√∂rgunarsveitir ¬∑ A1‚ÄìB1</p>
                  <p className="text-gray-400 text-xs font-light mt-1">
                    Umfer√∞ {round} ¬∑ R√©tt: {correctCount} ¬∑ Or√∞ eftir: {words.length - usedWords.length}
                  </p>
                </div>
                <button onClick={resetGame} className="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-50 font-light">üîÑ Byrja aftur</button>
              </div>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-6 mt-8">

            {/* Litak√≥√∞ar */}
            <div className="flex gap-2 mb-4 flex-wrap">
              {Object.entries(TOPIC_COLORS).map(([topic, cls]) => (
                <span key={topic} className={`px-3 py-1 rounded-full text-xs font-light border ${cls}`}>{topic}</span>
              ))}
            </div>

            {/* Leikur loki√∞ */}
            {gameOver && (
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                <div className="text-6xl mb-4">üéâ</div>
                <h2 className="text-2xl font-light text-gray-800 mb-2">Vel gert!</h2>
                <p className="text-gray-600 font-light mb-6">√û√∫ f√≥rst √≠ gegnum √∂ll {words.length} or√∞in.<br />R√©tt: {correctCount} / {words.length}</p>
                <button onClick={resetGame} className="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-light transition-colors">üîÑ Spila aftur</button>
              </div>
            )}

            {!gameOver && (
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">

                {/* Efnisflokkur */}
                {currentTopic && !loading && (
                  <div className={`px-6 py-2 border-b flex items-center gap-2 ${TOPIC_COLORS[currentTopic]}`}>
                    <span className="text-xs font-light">Efnisflokkur:</span>
                    <span className="text-xs font-medium">{currentTopic}</span>
                  </div>
                )}

                {/* Hlj√≥√∞takki */}
                <div className="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center justify-between">
                  <span className="text-sm text-gray-600 font-light">üéß Hlusta√∞u √° l√Ωsinguna og giska√∞u √° or√∞i√∞</span>
                  {loading && <span className="text-xs font-light text-blue-600 animate-pulse">‚è≥ Gervigreind er a√∞ hugsa...</span>}
                </div>

                {!loading && desc && (
                  <div className="bg-blue-50 border-b border-blue-100 px-6 py-4">
                    <button onClick={replayDesc} disabled={speakingDesc}
                      className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-light disabled:bg-gray-300 disabled:cursor-not-allowed">
                      <SpeakerIcon active={speakingDesc} />
                      <span>{speakingDesc ? 'üîä Spilar...' : 'üéß Spila l√Ωsingu'}</span>
                    </button>
                  </div>
                )}

                {/* Spjallsv√¶√∞i */}
                <div className="p-6 space-y-3 min-h-[260px]">
                  {messages.map((m, i) => (
                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                      {m.role === 'hint' ? (
                        <button onClick={() => speak(m.hintText)}
                          className="bg-amber-50 border border-amber-200 text-amber-800 px-4 py-2 rounded-lg font-light hover:bg-amber-100 transition-colors flex items-center gap-2">
                          <span>üîä</span>
                          <span>{m.content}</span>
                        </button>
                      ) : (
                        <div className={`max-w-lg px-4 py-2 rounded-lg font-light shadow-sm text-sm ${
                          m.role === 'user' ? 'bg-gray-800 text-white' : 'bg-blue-50 text-blue-800 border border-blue-100'
                        }`}>
                          {m.content}
                        </div>
                      )}
                    </div>
                  ))}
                  {messages.length === 0 && !loading && (
                    <p className="text-center text-gray-400 font-light py-8">Smelltu √° hlj√≥√∞hnappinn til a√∞ byrja üëÜ</p>
                  )}
                  <div ref={messagesEndRef} />
                </div>

                {/* Innsl√°ttur */}
                <div className="border-t p-4 bg-white">
                  <div className="flex gap-2">
                    <input type="text" value={input} onChange={e => setInput(e.target.value)}
                      onKeyDown={e => e.key === 'Enter' && submitGuess()}
                      placeholder="Skrifa√∞u gisk‚Ä¶"
                      className="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-light"
                      disabled={loading || !desc} />
                    <button onClick={submitGuess}
                      className="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors font-light disabled:bg-gray-300 disabled:cursor-not-allowed"
                      disabled={loading || !desc}>
                      <SendIcon />
                    </button>
                  </div>
                </div>

              </div>
            )}

            {/* Notu√∞ or√∞ */}
            {usedWords.length > 0 && !gameOver && (
              <div className="mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <p className="text-sm text-gray-500 font-light mb-2">‚úÖ Or√∞ sem komu fyrir:</p>
                <div className="flex flex-wrap gap-2">
                  {usedWords.map((w, i) => {
                    const found = DEFAULT_WORDS.find(x => x.word === w);
                    const cls = found ? TOPIC_COLORS[found.topic] : 'bg-gray-100 text-gray-600 border-gray-200';
                    return <span key={i} className={`px-3 py-1 rounded-full text-xs font-light border ${cls}`}>{w}</span>;
                  })}
                </div>
              </div>
            )}

          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Game />);
  </script>
</body>
</html>
