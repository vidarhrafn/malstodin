<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üí¨ Myndaspjall - √Åhugam√°l</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
            min-height: 100vh;
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SendIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const MicIcon = ({ isRecording }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill={isRecording ? "currentColor" : "none"}
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 ${isRecording ? 'recording text-red-500' : ''}`}
            >
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const SpeakerIcon = ({ isSpeaking }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 transition-colors ${
                    isSpeaking ? 'text-red-500 animate-pulse' : 'text-green-600'
                }`}
            >
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        );

        async function callOpenAI(messages, max_tokens = 400, model = 'gpt-4o-mini', temperature = 0.3) {
            const r = await fetch('/.netlify/functions/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    max_tokens: max_tokens,
                    temperature: temperature
                }),
            });
            const data = await r.json();
            if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
            return data.content;
        }

        async function playAudio(text, setSpeakingCallback) {
            setSpeakingCallback(true);

            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: text }),
                });

                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa √≠ hlj√≥√∞kalli:", data.error);
                    setSpeakingCallback(false);
                    return;
                }

                const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                const audio = new Audio(audioUrl);
                
                audio.onended = () => setSpeakingCallback(false);
                audio.onerror = () => setSpeakingCallback(false);
                
                audio.play().catch(e => {
                    console.error("Villa vi√∞ spilun:", e);
                    setSpeakingCallback(false);
                });
                
            } catch (e) {
                console.error("Tenging mist√≥kst:", e);
                setSpeakingCallback(false);
            }
        }

        const Myndaspjall = () => {
            const initialMessage = { 
                role: 'assistant', 
                content: 'H√¶! Sj√°√∞u √æessa mynd me√∞ fj√≥rum r√∂mmum. Hver rammi s√Ωnir √°hugam√°l. Byrjum √° efri vinstra rammanum - hva√∞ s√©r√∞u √æar? Svara√∞u √≠ heilum setningum. üòä'
            };
            
            const [messages, setMessages] = useState([initialMessage]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [speakingIndex, setSpeakingIndex] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [recognition, setRecognition] = useState(null);
            const [finished, setFinished] = useState(false);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            
            const ASSISTANT_SYSTEM_PROMPT = `
√û√∫ ert √≠slenskukennari √° A1-A2 stigi.

Nemandinn sko√∞ar mynd me√∞ FJ√ìRUM ROMMUM sem s√Ωnir mismunandi √°hugam√°l:

EFRI VINSTRI RAMMI (1): Ma√∞ur √≠ sundlaug. Hann er me√∞ bl√°an sundhettu og er a√∞ synda. Hann er √≠ sundlauginni og l√≠tur hamingjusamur √∫t. Vatni√∞ er bl√°tt.

EFRI H√ÜGRI RAMMI (2): Tv√∂ ungmenni a√∞ spila f√≥tbolta √° gr√¶nu grasi. St√∫lka me√∞ d√∂kkt s√≠tt h√°r √≠ bl√°um gallabuxum og hv√≠tri bol er a√∞ sparka f√≥tbolta. Str√°kur √≠ gr√¶nu stuttermabol og stuttbuxum er me√∞ hana. √ûau eru a√∞ hlaupa og l√≠ta gl√∂√∞ √∫t. Markmi√∞ s√©st √≠ bakgrunni.

NE√êRI VINSTRI RAMMI (3): Fj√∂lskylda a√∞ ganga saman √∫ti √≠ gar√∞i e√∞a √≠ almenningsgar√∞i. Ma√∞ur √≠ hj√≥last√≥l, tv√¶r konur og st√∫lka. √ûau eru me√∞ tvo hunda - einn gylltan retriever og einn hv√≠tan l√≠tinn hund. Tr√© sj√°st √≠ bakgrunni. Allir l√≠ta hamingjusamir √∫t.

NE√êRI H√ÜGRI RAMMI (4): √ûr√≠r einstaklingar sitja √≠ s√≥fa a√∞ lesa b√¶kur. Kona me√∞ blondu h√°ri til vinstri, ungur str√°kur √≠ mi√∞junni, og unglingur me√∞ gr√¶nt h√°r til h√¶gri. Allir eru me√∞ opnar b√¶kur og l√≠ta einbeittir √∫t. Gluggi s√©st √≠ bakgrunni.

VERKEFNI:
1. Leiddu nemandann √≠ gegnum alla fj√≥ra rammana - einn √≠ einu
2. Byrja√∞u √° rammi 1 (sundlaug)
3. Spyr√∞u hva√∞ nemandinn s√©r
4. Hr√≥sa√∞u nemandanum fyrir allt sem hann s√©r r√©tt
5. Ef nemandinn gleymir einhverju mikilv√¶gu, minntu hann √° √æa√∞ me√∞ spurningum eins og "S√©r√∞u eitthva√∞ meira?" e√∞a "Hva√∞a lit er..."
6. √ûegar b√∫i√∞ a√∞ tala um ramm 1, f√¶r√∞u √æig √° ramm 2, s√≠√∞an 3, s√≠√∞an 4
7. Eftir a√∞ hafa fari√∞ yfir alla fj√≥ra rammana, spyr√∞u nemandann um hva√∞ hann sj√°lfur hafi √°huga √°
8. √ûegar √æ√∫ ert b√∫in/n a√∞ tala um √∂ll √°hugam√°lin og spurt nemandann um hans/hennar √°hugam√°l, seg√∞u: "Fr√°b√¶rt spjall! √û√∫ getur n√∫ loka√∞ √æessari s√≠√∞u."

REGLUR:
- Nota√∞u alltaf einfalda √≠slensku (A1-A2)
- Vertu hvetjandi og j√°kv√¶√∞/j√°kv√¶√∞ur
- ALDREI segja "gott starf" - seg√∞u frekar "vel gert", "fr√°b√¶rt", "mj√∂g gott"
- Spyr√∞u einfaldar spurningar
- Lei√∞r√©tta√∞u bl√≠√∞lega ef nemandinn segir eitthva√∞ rangt
- Byrja√∞u √° rammi 1, s√≠√∞an 2, 3, og loks 4
- Loka√∞u samtali eftir a√∞ hafa fari√∞ yfir alla rammana
- Hvetur nemendur a√∞ svara √≠ heilum setningum, ekki bara st√∂kum or√∞um

MIKILV√ÜGT: √ûegar √æ√∫ s√©r√∞ a√∞ nemandinn hefur l√Ωst √∂llum fj√≥rum rommum og √æi√∞ hafi√∞ spjalla√∞ um √°hugam√°l nemandans, seg√∞u N√ÅKV√ÜMLEGA: "Fr√°b√¶rt spjall! √û√∫ getur n√∫ loka√∞ √æessari s√≠√∞u."
`.trim();

            useEffect(() => {
                if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
                    const recognitionInstance = new window.webkitSpeechRecognition();
                    recognitionInstance.lang = 'is-IS';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;

                    recognitionInstance.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInput(transcript);
                        setIsRecording(false);
                    };

                    recognitionInstance.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsRecording(false);
                    };

                    recognitionInstance.onend = () => {
                        setIsRecording(false);
                    };

                    setRecognition(recognitionInstance);
                }
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const toggleRecording = () => {
                if (!recognition) {
                    alert('Talgreining er ekki studd √≠ √æessum vafra. Pr√≥fa√∞u Chrome.');
                    return;
                }

                if (isRecording) {
                    recognition.stop();
                    setIsRecording(false);
                } else {
                    setInput('');
                    recognition.start();
                    setIsRecording(true);
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || loading) return;

                const userMessage = { role: 'user', content: input.trim() };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setLoading(true);

                try {
                    const conversationForAPI = [
                        { role: 'system', content: ASSISTANT_SYSTEM_PROMPT },
                        ...updatedMessages.filter(m => m.role === 'user' || m.role === 'assistant')
                    ];

                    const assistantReply = await callOpenAI(conversationForAPI);
                    
                    const newMessages = [...updatedMessages, { role: 'assistant', content: assistantReply }];
                    setMessages(newMessages);

                    if (assistantReply.includes('Fr√°b√¶rt spjall! √û√∫ getur n√∫ loka√∞ √æessari s√≠√∞u.')) {
                        setFinished(true);
                    }

                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...updatedMessages, { 
                        role: 'assistant', 
                        content: '√öps! Eitthva√∞ f√≥r √∫rskei√∞is. Reyndu aftur.' 
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white shadow-sm py-4 px-6">
                        <div className="max-w-4xl mx-auto">
                            <button 
                                onClick={() => window.history.back()} 
                                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
                            >
                                ‚Üê Til baka
                            </button>
                            <h1 className="text-2xl font-light text-gray-800">üí¨ Myndaspjall - √Åhugam√°l</h1>
                            <p className="text-sm text-gray-600 font-light mt-1">Tala√∞ samtal ¬∑ A1-A2</p>
                        </div>
                    </header>

                    <main className="flex-1 max-w-4xl w-full mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-sm mb-4 overflow-hidden" style={{ maxWidth: '600px', margin: '0 auto' }}>
                            <img 
                                src="./media/ahugamal.jpg" 
                                alt="Fj√≥rir rammar me√∞ mismunandi √°hugam√°lum" 
                                className="w-full h-auto"
                            />
                        </div>

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-4" style={{ minHeight: '400px', maxHeight: '500px', overflowY: 'auto' }}>
                            <div className="space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className="flex items-start gap-2 max-w-[80%]">
                                            {msg.role === 'assistant' ? (
                                                <button
                                                    onClick={() => {
                                                        if (speakingIndex === idx) return;
                                                        playAudio(msg.content, (speaking) => {
                                                            setSpeakingIndex(speaking ? idx : null);
                                                        });
                                                    }}
                                                    disabled={speakingIndex !== null}
                                                    className="mt-1 p-3 rounded-full bg-green-100 hover:bg-green-200 transition-colors disabled:opacity-50"
                                                    title="Smelltu til a√∞ hlusta"
                                                >
                                                    <SpeakerIcon isSpeaking={speakingIndex === idx} />
                                                </button>
                                            ) : (
                                                <div className="px-4 py-3 rounded-2xl font-light bg-blue-500 text-white">
                                                    {msg.content}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="bg-gray-100 px-4 py-3 rounded-2xl">
                                            <div className="flex gap-1">
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {!finished && (
                            <div className="bg-white rounded-lg shadow-sm p-4">
                                <div className="flex gap-2">
                                    <button
                                        onClick={toggleRecording}
                                        disabled={loading}
                                        className={`p-3 rounded-lg transition-colors ${
                                            isRecording 
                                                ? 'bg-red-500 text-white' 
                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                        } disabled:opacity-50`}
                                    >
                                        <MicIcon isRecording={isRecording} />
                                    </button>
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        disabled={loading}
                                        placeholder={isRecording ? "Hlustar..." : "Skrifa√∞u skilabo√∞..."}
                                        className="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 font-light disabled:bg-gray-50"
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!input.trim() || loading}
                                        className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <SendIcon />
                                    </button>
                                </div>
                                {isRecording && (
                                    <p className="text-sm text-red-500 mt-2 font-light">üî¥ A√∞ hlusta... tala√∞u n√∫na!</p>
                                )}
                            </div>
                        )}

                        {finished && (
                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-center">
                                <p className="text-2xl mb-2">üéâ</p>
                                <p className="text-gray-800 font-light text-lg">Fr√°b√¶rt spjall! √û√∫ getur n√∫ loka√∞ √æessari s√≠√∞u.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Myndaspjall />);
    </script>
</body>
</html>
