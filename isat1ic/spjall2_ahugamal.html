<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>游눫 Myndaspjall - 츼hugam치l</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
            min-height: 100vh;
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SendIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const MicIcon = ({ isRecording }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill={isRecording ? "currentColor" : "none"}
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 ${isRecording ? 'recording text-red-500' : ''}`}
            >
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const SpeakerIcon = ({ isSpeaking }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 transition-colors ${
                    isSpeaking ? 'text-red-500 animate-pulse' : 'text-green-600'
                }`}
            >
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        );

        async function callOpenAI(messages, max_tokens = 400, model = 'gpt-4o-mini', temperature = 0.3) {
            const r = await fetch('/.netlify/functions/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    max_tokens: max_tokens,
                    temperature: temperature
                }),
            });
            const data = await r.json();
            if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
            return data.content;
        }

        async function playAudio(text, setSpeakingCallback) {
            setSpeakingCallback(true);

            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: text }),
                });

                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa 칤 hlj칩칧kalli:", data.error);
                    setSpeakingCallback(false);
                    return;
                }

                const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                const audio = new Audio(audioUrl);
                
                audio.onended = () => setSpeakingCallback(false);
                audio.onerror = () => setSpeakingCallback(false);
                
                audio.play().catch(e => {
                    console.error("Villa vi칧 spilun:", e);
                    setSpeakingCallback(false);
                });
                
            } catch (e) {
                console.error("Tenging mist칩kst:", e);
                setSpeakingCallback(false);
            }
        }

        const Myndaspjall = () => {
            const initialMessage = { 
                role: 'assistant', 
                content: 'H칝! Sj치칧u 쬰ssa mynd me칧 fj칩rum r칬mmum. Hver rammi s칳nir 치hugam치l. Byrjum 치 efri vinstra rammanum - hva칧 s칠r칧u 쬬r? Svara칧u 칤 heilum setningum. 游땕'
            };
            
            const [messages, setMessages] = useState([initialMessage]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [speakingIndex, setSpeakingIndex] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [recognition, setRecognition] = useState(null);
            const [finished, setFinished] = useState(false);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            
            const ASSISTANT_SYSTEM_PROMPT = `
뤢 ert 칤slenskukennari 치 A1-A2 stigi.

Nemandinn sko칧ar mynd me칧 FJ칍RUM ROMMUM sem s칳nir mismunandi 치hugam치l:

EFRI VINSTRI RAMMI (1): Ma칧ur 칤 sundlaug. Hann er me칧 bl치an sundhettu og er a칧 synda. Hann er 칤 sundlauginni og l칤tur hamingjusamur 칰t. Vatni칧 er bl치tt.

EFRI H칁GRI RAMMI (2): Tv칬 ungmenni a칧 spila f칩tbolta 치 gr칝nu grasi. St칰lka me칧 d칬kkt s칤tt h치r 칤 bl치um gallabuxum og hv칤tri bol er a칧 sparka f칩tbolta. Str치kur 칤 gr칝nu stuttermabol og stuttbuxum er me칧 hana. 료u eru a칧 hlaupa og l칤ta gl칬칧 칰t. Markmi칧 s칠st 칤 bakgrunni.

NE칋RI VINSTRI RAMMI (3): Fj칬lskylda a칧 ganga saman 칰ti 칤 gar칧i e칧a 칤 almenningsgar칧i. Ma칧ur 칤 hj칩last칩l, tv칝r konur og st칰lka. 료u eru me칧 tvo hunda - einn gylltan retriever og einn hv칤tan l칤tinn hund. Tr칠 sj치st 칤 bakgrunni. Allir l칤ta hamingjusamir 칰t.

NE칋RI H칁GRI RAMMI (4): r칤r einstaklingar sitja 칤 s칩fa a칧 lesa b칝kur. Kona me칧 blondu h치ri til vinstri, ungur str치kur 칤 mi칧junni, og unglingur me칧 gr칝nt h치r til h칝gri. Allir eru me칧 opnar b칝kur og l칤ta einbeittir 칰t. Gluggi s칠st 칤 bakgrunni.

VERKEFNI:
1. Leiddu nemandann 칤 gegnum alla fj칩ra rammana - einn 칤 einu
2. Byrja칧u 치 rammi 1 (sundlaug)
3. Spyr칧u hva칧 nemandinn s칠r
4. Hr칩sa칧u nemandanum fyrir allt sem hann s칠r r칠tt
5. Ef nemandinn gleymir einhverju mikilv칝gu, minntu hann 치 쬬칧 me칧 spurningum eins og "S칠r칧u eitthva칧 meira?" e칧a "Hva칧a lit er..."
6. 룐gar b칰i칧 a칧 tala um ramm 1, f칝r칧u 쬴g 치 ramm 2, s칤칧an 3, s칤칧an 4
7. Eftir a칧 hafa fari칧 yfir alla fj칩ra rammana, spyr칧u nemandann um hva칧 hann sj치lfur hafi 치huga 치
8. 룐gar 쮂 ert b칰in/n a칧 tala um 칬ll 치hugam치lin og spurt nemandann um hans/hennar 치hugam치l, seg칧u: "Fr치b칝rt spjall! 뤢 getur n칰 loka칧 쬰ssari s칤칧u."

REGLUR:
- Nota칧u alltaf einfalda 칤slensku (A1-A2)
- Vertu hvetjandi og j치kv칝칧/j치kv칝칧ur
- ALDREI segja "gott starf" - seg칧u frekar "vel gert", "fr치b칝rt", "mj칬g gott"
- Spyr칧u einfaldar spurningar
- Lei칧r칠tta칧u bl칤칧lega ef nemandinn segir eitthva칧 rangt
- Byrja칧u 치 rammi 1, s칤칧an 2, 3, og loks 4
- Loka칧u samtali eftir a칧 hafa fari칧 yfir alla rammana
- Hvetur nemendur a칧 svara 칤 heilum setningum, ekki bara st칬kum or칧um

MIKILV칁GT: 룐gar 쮂 s칠r칧 a칧 nemandinn hefur l칳st 칬llum fj칩rum rommum og 쬴칧 hafi칧 spjalla칧 um 치hugam치l nemandans, seg칧u N츼KV칁MLEGA: "Fr치b칝rt spjall! 뤢 getur n칰 loka칧 쬰ssari s칤칧u."
`.trim();

            useEffect(() => {
                if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
                    const recognitionInstance = new window.webkitSpeechRecognition();
                    recognitionInstance.lang = 'is-IS';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;

                    recognitionInstance.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInput(transcript);
                        setIsRecording(false);
                    };

                    recognitionInstance.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsRecording(false);
                    };

                    recognitionInstance.onend = () => {
                        setIsRecording(false);
                    };

                    setRecognition(recognitionInstance);
                }
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const toggleRecording = () => {
                if (!recognition) {
                    alert('Talgreining er ekki studd 칤 쬰ssum vafra. Pr칩fa칧u Chrome.');
                    return;
                }

                if (isRecording) {
                    recognition.stop();
                    setIsRecording(false);
                } else {
                    setInput('');
                    recognition.start();
                    setIsRecording(true);
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || loading) return;

                const userMessage = { role: 'user', content: input.trim() };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setLoading(true);

                try {
                    const conversationForAPI = [
                        { role: 'system', content: ASSISTANT_SYSTEM_PROMPT },
                        ...updatedMessages.filter(m => m.role === 'user' || m.role === 'assistant')
                    ];

                    const assistantReply = await callOpenAI(conversationForAPI);
                    
                    const newMessages = [...updatedMessages, { role: 'assistant', content: assistantReply }];
                    setMessages(newMessages);

                    if (assistantReply.includes('Fr치b칝rt spjall! 뤢 getur n칰 loka칧 쬰ssari s칤칧u.')) {
                        setFinished(true);
                    }

                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...updatedMessages, { 
                        role: 'assistant', 
                        content: '칔ps! Eitthva칧 f칩r 칰rskei칧is. Reyndu aftur.' 
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white shadow-sm py-4 px-6">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-2xl font-light text-gray-800">游눫 Myndaspjall - 츼hugam치l</h1>
                            <p className="text-sm text-gray-600 font-light mt-1">Tala칧 samtal 췅 A1-A2</p>
                        </div>
                    </header>

                    <main className="flex-1 max-w-4xl w-full mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-sm mb-4 overflow-hidden" style={{ maxWidth: '600px', margin: '0 auto' }}>
                            <img 
                                src="./media/ahugamal.jpg" 
                                alt="Fj칩rir rammar me칧 mismunandi 치hugam치lum" 
                                className="w-full h-auto"
                            />
                        </div>

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-4" style={{ minHeight: '400px', maxHeight: '500px', overflowY: 'auto' }}>
                            <div className="space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className="flex items-start gap-2 max-w-[80%]">
                                            {msg.role === 'assistant' ? (
                                                <button
                                                    onClick={() => {
                                                        if (speakingIndex === idx) return;
                                                        playAudio(msg.content, (speaking) => {
                                                            setSpeakingIndex(speaking ? idx : null);
                                                        });
                                                    }}
                                                    disabled={speakingIndex !== null}
                                                    className="mt-1 p-3 rounded-full bg-green-100 hover:bg-green-200 transition-colors disabled:opacity-50"
                                                    title="Smelltu til a칧 hlusta"
                                                >
                                                    <SpeakerIcon isSpeaking={speakingIndex === idx} />
                                                </button>
                                            ) : (
                                                <div className="px-4 py-3 rounded-2xl font-light bg-blue-500 text-white">
                                                    {msg.content}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="bg-gray-100 px-4 py-3 rounded-2xl">
                                            <div className="flex gap-1">
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {!finished && (
                            <div className="bg-white rounded-lg shadow-sm p-4">
                                <div className="flex gap-2">
                                    <button
                                        onClick={toggleRecording}
                                        disabled={loading}
                                        className={`p-3 rounded-lg transition-colors ${
                                            isRecording 
                                                ? 'bg-red-500 text-white' 
                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                        } disabled:opacity-50`}
                                    >
                                        <MicIcon isRecording={isRecording} />
                                    </button>
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        disabled={loading}
                                        placeholder={isRecording ? "Hlustar..." : "Skrifa칧u skilabo칧..."}
                                        className="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 font-light disabled:bg-gray-50"
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!input.trim() || loading}
                                        className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <SendIcon />
                                    </button>
                                </div>
                                {isRecording && (
                                    <p className="text-sm text-red-500 mt-2 font-light">游댮 A칧 hlusta... tala칧u n칰na!</p>
                                )}
                            </div>
                        )}

                        {finished && (
                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-center">
                                <p className="text-2xl mb-2">游꿀</p>
                                <p className="text-gray-800 font-light text-lg">Fr치b칝rt spjall! 뤢 getur n칰 loka칧 쬰ssari s칤칧u.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Myndaspjall />);
    </script>
</body>
</html>
