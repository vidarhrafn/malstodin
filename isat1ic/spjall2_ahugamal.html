<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>💬 Myndaspjall - Áhugamál</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
            min-height: 100vh;
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SendIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const MicIcon = ({ isRecording }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill={isRecording ? "currentColor" : "none"}
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 ${isRecording ? 'recording text-red-500' : ''}`}
            >
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const SpeakerIcon = ({ isSpeaking }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-5 h-5 transition-colors ${
                    isSpeaking ? 'text-red-500 animate-pulse' : 'text-green-600'
                }`}
            >
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        );

        async function callOpenAI(messages, max_tokens = 400, model = 'gpt-4o-mini', temperature = 0.3) {
            const r = await fetch('/.netlify/functions/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    max_tokens: max_tokens,
                    temperature: temperature
                }),
            });
            const data = await r.json();
            if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
            return data.content;
        }

        async function playAudio(text, setSpeakingCallback) {
            setSpeakingCallback(true);

            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: text }),
                });

                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa í hljóðkalli:", data.error);
                    setSpeakingCallback(false);
                    return;
                }

                const audioUrl = `data:audio/mp3;base64,${data.audio_base64}`;
                const audio = new Audio(audioUrl);
                
                audio.onended = () => setSpeakingCallback(false);
                audio.onerror = () => setSpeakingCallback(false);
                
                audio.play().catch(e => {
                    console.error("Villa við spilun:", e);
                    setSpeakingCallback(false);
                });
                
            } catch (e) {
                console.error("Tenging mistókst:", e);
                setSpeakingCallback(false);
            }
        }

        const Myndaspjall = () => {
            const initialMessage = { 
                role: 'assistant', 
                content: 'Hæ! Sjáðu þessa mynd með fjórum römmum. Hver rammi sýnir áhugamál. Byrjum á efri vinstra rammanum - hvað sérðu þar? Svaraðu í heilum setningum. 😊'
            };
            
            const [messages, setMessages] = useState([initialMessage]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [speakingIndex, setSpeakingIndex] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [recognition, setRecognition] = useState(null);
            const [finished, setFinished] = useState(false);
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            
            const ASSISTANT_SYSTEM_PROMPT = `
Þú ert íslenskukennari á A1-A2 stigi.

Nemandinn skoðar mynd með FJÓRUM ROMMUM sem sýnir mismunandi áhugamál:

EFRI VINSTRI RAMMI (1): Maður í sundlaug. Hann er með bláan sundhettu og er að synda. Hann er í sundlauginni og lítur hamingjusamur út. Vatnið er blátt.

EFRI HÆGRI RAMMI (2): Tvö ungmenni að spila fótbolta á grænu grasi. Stúlka með dökkt sítt hár í bláum gallabuxum og hvítri bol er að sparka fótbolta. Strákur í grænu stuttermabol og stuttbuxum er með hana. Þau eru að hlaupa og líta glöð út. Markmið sést í bakgrunni.

NEÐRI VINSTRI RAMMI (3): Fjölskylda að ganga saman úti í garði eða í almenningsgarði. Maður í hjólastól, tvær konur og stúlka. Þau eru með tvo hunda - einn gylltan retriever og einn hvítan lítinn hund. Tré sjást í bakgrunni. Allir líta hamingjusamir út.

NEÐRI HÆGRI RAMMI (4): Þrír einstaklingar sitja í sófa að lesa bækur. Kona með blondu hári til vinstri, ungur strákur í miðjunni, og unglingur með grænt hár til hægri. Allir eru með opnar bækur og líta einbeittir út. Gluggi sést í bakgrunni.

VERKEFNI:
1. Leiddu nemandann í gegnum alla fjóra rammana - einn í einu
2. Byrjaðu á rammi 1 (sundlaug)
3. Spyrðu hvað nemandinn sér
4. Hrósaðu nemandanum fyrir allt sem hann sér rétt
5. Ef nemandinn gleymir einhverju mikilvægu, minntu hann á það með spurningum eins og "Sérðu eitthvað meira?" eða "Hvaða lit er..."
6. Þegar búið að tala um ramm 1, færðu þig á ramm 2, síðan 3, síðan 4
7. Eftir að hafa farið yfir alla fjóra rammana, spyrðu nemandann um hvað hann sjálfur hafi áhuga á
8. Þegar þú ert búin/n að tala um öll áhugamálin og spurt nemandann um hans/hennar áhugamál, segðu: "Frábært spjall! Þú getur nú lokað þessari síðu."

REGLUR:
- Notaðu alltaf einfalda íslensku (A1-A2)
- Vertu hvetjandi og jákvæð/jákvæður
- ALDREI segja "gott starf" - segðu frekar "vel gert", "frábært", "mjög gott"
- Spyrðu einfaldar spurningar
- Leiðréttaðu blíðlega ef nemandinn segir eitthvað rangt
- Byrjaðu á rammi 1, síðan 2, 3, og loks 4
- Lokaðu samtali eftir að hafa farið yfir alla rammana
- Hvetur nemendur að svara í heilum setningum, ekki bara stökum orðum

MIKILVÆGT: Þegar þú sérð að nemandinn hefur lýst öllum fjórum rommum og þið hafið spjallað um áhugamál nemandans, segðu NÁKVÆMLEGA: "Frábært spjall! Þú getur nú lokað þessari síðu."
`.trim();

            useEffect(() => {
                if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
                    const recognitionInstance = new window.webkitSpeechRecognition();
                    recognitionInstance.lang = 'is-IS';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;

                    recognitionInstance.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInput(transcript);
                        setIsRecording(false);
                    };

                    recognitionInstance.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsRecording(false);
                    };

                    recognitionInstance.onend = () => {
                        setIsRecording(false);
                    };

                    setRecognition(recognitionInstance);
                }
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const toggleRecording = () => {
                if (!recognition) {
                    alert('Talgreining er ekki studd í þessum vafra. Prófaðu Chrome.');
                    return;
                }

                if (isRecording) {
                    recognition.stop();
                    setIsRecording(false);
                } else {
                    setInput('');
                    recognition.start();
                    setIsRecording(true);
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || loading) return;

                const userMessage = { role: 'user', content: input.trim() };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setInput('');
                setLoading(true);

                try {
                    const conversationForAPI = [
                        { role: 'system', content: ASSISTANT_SYSTEM_PROMPT },
                        ...updatedMessages.filter(m => m.role === 'user' || m.role === 'assistant')
                    ];

                    const assistantReply = await callOpenAI(conversationForAPI);
                    
                    const newMessages = [...updatedMessages, { role: 'assistant', content: assistantReply }];
                    setMessages(newMessages);

                    if (assistantReply.includes('Frábært spjall! Þú getur nú lokað þessari síðu.')) {
                        setFinished(true);
                    }

                } catch (error) {
                    console.error('Error:', error);
                    setMessages([...updatedMessages, { 
                        role: 'assistant', 
                        content: 'Úps! Eitthvað fór úrskeiðis. Reyndu aftur.' 
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white shadow-sm py-4 px-6">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-2xl font-light text-gray-800">💬 Myndaspjall - Áhugamál</h1>
                            <p className="text-sm text-gray-600 font-light mt-1">Talað samtal · A1-A2</p>
                        </div>
                    </header>

                    <main className="flex-1 max-w-4xl w-full mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-sm mb-4 overflow-hidden" style={{ maxWidth: '600px', margin: '0 auto' }}>
                            <img 
                                src="./media/ahugamal.jpg" 
                                alt="Fjórir rammar með mismunandi áhugamálum" 
                                className="w-full h-auto"
                            />
                        </div>

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-4" style={{ minHeight: '400px', maxHeight: '500px', overflowY: 'auto' }}>
                            <div className="space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className="flex items-start gap-2 max-w-[80%]">
                                            {msg.role === 'assistant' ? (
                                                <button
                                                    onClick={() => {
                                                        if (speakingIndex === idx) return;
                                                        playAudio(msg.content, (speaking) => {
                                                            setSpeakingIndex(speaking ? idx : null);
                                                        });
                                                    }}
                                                    disabled={speakingIndex !== null}
                                                    className="mt-1 p-3 rounded-full bg-green-100 hover:bg-green-200 transition-colors disabled:opacity-50"
                                                    title="Smelltu til að hlusta"
                                                >
                                                    <SpeakerIcon isSpeaking={speakingIndex === idx} />
                                                </button>
                                            ) : (
                                                <div className="px-4 py-3 rounded-2xl font-light bg-blue-500 text-white">
                                                    {msg.content}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="bg-gray-100 px-4 py-3 rounded-2xl">
                                            <div className="flex gap-1">
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {!finished && (
                            <div className="bg-white rounded-lg shadow-sm p-4">
                                <div className="flex gap-2">
                                    <button
                                        onClick={toggleRecording}
                                        disabled={loading}
                                        className={`p-3 rounded-lg transition-colors ${
                                            isRecording 
                                                ? 'bg-red-500 text-white' 
                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                        } disabled:opacity-50`}
                                    >
                                        <MicIcon isRecording={isRecording} />
                                    </button>
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        disabled={loading}
                                        placeholder={isRecording ? "Hlustar..." : "Skrifaðu skilaboð..."}
                                        className="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 font-light disabled:bg-gray-50"
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!input.trim() || loading}
                                        className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <SendIcon />
                                    </button>
                                </div>
                                {isRecording && (
                                    <p className="text-sm text-red-500 mt-2 font-light">🔴 Að hlusta... talaðu núna!</p>
                                )}
                            </div>
                        )}

                        {finished && (
                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-center">
                                <p className="text-2xl mb-2">🎉</p>
                                <p className="text-gray-800 font-light text-lg">Frábært spjall! Þú getur nú lokað þessari síðu.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Myndaspjall />);
    </script>
</body>
</html>
