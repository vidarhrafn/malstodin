<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spjall Test</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .chat-container {
      max-height: 400px;
      overflow-y: auto;
    }
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .chat-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    const READING_TEXT = `Harpa og EirÃ­kur Ã¦tla aÃ° koma IngibjÃ¶rgu mÃ¶mmu HÃ¶rpu Ã¡ Ã³vart. IngibjÃ¶rg eldar yfirleitt en Ã­ kvÃ¶ld Ã¦tla Harpa og EirÃ­kur aÃ° elda uppÃ¡halds mat mÃ¶mmu HÃ¶rpu. ÃžaÃ° er kjÃºklingur Ã­ ofni, en Harpa er grÃ¦nmetisÃ¦ta og Ã¾ess vegna Ã¦tla Ã¾au aÃ° hafa tvÃ­rÃ©ttaÃ°. KjÃºkling Ã­ ofni, og kjÃºklingabaunarÃ©tt meÃ° grÃ¦nmeti. MeÃ°lÃ¦tiÃ° verÃ°ur hrÃ­sgrjÃ³n, sÃ³sa og salat. Ãžau Ã¦tla aÃ° fara Ã­ bÃºÃ°ina og kaupa Ã¾aÃ° sem vantar Ã­ kvÃ¶ldmatinn og fleira. Ãžau fara Ã­ BÃ³nus og kaupa Ã¾ar heilan kjÃºkling, hrÃ­sgrjÃ³n, sÃ³su, papriku, lauk, hvÃ­tlauk, blÃ³mkÃ¡l og kÃ³kosmjÃ³lk. Svo kaupa Ã¾au lÃ­ka mjÃ³lk, ost, brauÃ°, flatkÃ¶kur, nÃºÃ°lusÃºpur og jÃ³gÃºrt. Ãžegar Ã¾au eru aÃ° labba Ãºt Ãºr bÃºÃ°inni fatta Ã¾au aÃ° Ã¾au gleymdu aÃ° kaupa kjÃºklingabaunir og eitthvaÃ° aÃ° drekka meÃ° matnum. Harpa drÃ­fur sig aftur inn Ã­ bÃºÃ°ina og finnur kjÃºklingabaunirnar og svo kaupa Ã¾au sÃ³davatn meÃ° sÃ­trÃ³nubragÃ°i. Ã meÃ°an setur EirÃ­kur vÃ¶rurnar Ã­ poka. Ãžegar Ã¾au koma heim byrja Ã¾au strax aÃ° elda. Ãžau Ã¦tla aÃ° hafa matinn tilbÃºinn Ã¾egar IngibjÃ¶rg kemur heim Ãºr vinnunni.`;

    const DISCUSSION_QUESTIONS = [
      "HvaÃ° finnst Ã¾Ã©r um aÃ° koma fÃ³lki Ã¡ Ã³vart?",
      "HvaÃ° finnst Ã¾Ã©r um aÃ° vera grÃ¦nmetisÃ¦ta?",
      "HvaÃ° finnst Ã¾Ã©r um aÃ° elda?"
    ];

    const SpjallTest = () => {
      const [conversations, setConversations] = useState([[], [], []]);
      const [currentInputs, setCurrentInputs] = useState(['', '', '']);
      const [loadingStates, setLoadingStates] = useState([false, false, false]);
      const [messageCount, setMessageCount] = useState([0, 0, 0]);
      
      const chatRefs = [useRef(null), useRef(null), useRef(null)];

      const scrollToBottom = (index) => {
        setTimeout(() => {
          if (chatRefs[index].current) {
            chatRefs[index].current.scrollTop = chatRefs[index].current.scrollHeight;
          }
        }, 100);
      };

      const handleInputChange = (index, value) => {
        const newInputs = [...currentInputs];
        newInputs[index] = value;
        setCurrentInputs(newInputs);
      };

      const sendMessage = async (questionIndex) => {
        const message = currentInputs[questionIndex].trim();
        if (!message) return;

        const newConversations = [...conversations];
        newConversations[questionIndex] = [
          ...newConversations[questionIndex],
          { role: 'user', content: message }
        ];
        setConversations(newConversations);

        // Update message count
        const newMessageCount = [...messageCount];
        newMessageCount[questionIndex] = newMessageCount[questionIndex] + 1;
        setMessageCount(newMessageCount);

        const newInputs = [...currentInputs];
        newInputs[questionIndex] = '';
        setCurrentInputs(newInputs);

        const newLoading = [...loadingStates];
        newLoading[questionIndex] = true;
        setLoadingStates(newLoading);

        scrollToBottom(questionIndex);

        try {
          const question = DISCUSSION_QUESTIONS[questionIndex];
          const isFirstMessage = newConversations[questionIndex].filter(m => m.role === 'user').length === 1;
          const userMessageCount = newMessageCount[questionIndex];
          const shouldClose = userMessageCount >= 3;

          const systemPrompt = `ÃžÃº ert vingjarnlegur Ã­slenskukennari sem rÃ¦Ã°ir viÃ° A1-A2 nemanda um matargerÃ° og innkaup.

TEXTINN SEM NEMANDINN LAS:
"${READING_TEXT}"

UPPRUNALEGA SPURNINGIN:
"${question}"

VERKEFNI:
${isFirstMessage ? `1. Lestu fyrsta svar nemandans og gefÃ°u hvetjandi, jÃ¡kvÃ¦Ã°a endurgjÃ¶f
2. KommentaÃ°u Ã¡ efninu - hvaÃ° er Ã¡hugavert?
3. SpyrÃ°u einfalda follow-up spurningu til aÃ° dÃ½pka umrÃ¦Ã°una` : 
shouldClose ? `1. SvaraÃ°u spurningum nemandans Ã¡ nÃ¡ttÃºrulegan hÃ¡tt
2. GefÃ°u jÃ¡kvÃ¦Ã°a og hvetjandi endurgjÃ¶f
3. KlÃ¡raÃ°u samtaliÃ° Ã¡ eÃ°lilegan hÃ¡tt (t.d. "FrÃ¡bÃ¦rt aÃ° spjalla viÃ° Ã¾ig um Ã¾etta! ðŸ˜Š" eÃ°a "Takk fyrir gÃ³Ã°a umrÃ¦Ã°u!")
4. EKKI spyrja fleiri spurninga - Ã¾etta er lokun` : 
`1. Haltu Ã¡fram samtali viÃ° nemandann Ã¡ nÃ¡ttÃºrulegan hÃ¡tt
2. SvaraÃ°u spurningum hans
3. Vertu hvetjandi og spyrÃ°u follow-up ef Ã¾aÃ° Ã¡ viÃ°`}

REGLUR:
- Vertu ALLTAF jÃ¡kvÃ¦Ã°ur og hvetjandi
- Haltu Ã¾vÃ­ stuttu (2-4 setningar)
- NotaÃ°u einfalda Ã­slensku (A1-A2 stig)
- NotaÃ°u bara Ã­slensku
- ALDREI gefa einkunn
${shouldClose ? '- Ãžetta er LOKUN - klÃ¡raÃ°u samtaliÃ° Ã¡ vingjarnlegan hÃ¡tt' : ''}

SVARAÃU MEÃ JSON Ã ÃžESSU FORMI:
{
  "grammar": "MÃ¡lfarsendurgjÃ¶f BARA ef Ã¾aÃ° eru GRÃ“FAR villur (beygingarvillur, rangt orÃ°val). Vertu mjÃ¶g mild og hvetjandi (1-2 setningar). Ef ekkert athugavert, settu null.",
  "response": "AÃ°al svariÃ° Ã¾itt hÃ©r"
}`;

          const messages = [
            { role: 'system', content: systemPrompt },
            ...newConversations[questionIndex]
              .filter(msg => msg.role === 'user' || msg.role === 'assistant')
              .map(msg => ({
                role: msg.role,
                content: msg.role === 'assistant' ? msg.content : msg.content
              }))
          ];

          const response = await callOpenAI({
            model: 'gpt-4o',
            temperature: 0.7,
            max_tokens: 300,
            messages: messages
          });

          let cleanResult = response.trim();
          if (cleanResult.startsWith('```')) {
            cleanResult = cleanResult.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          }
          
          const parsed = JSON.parse(cleanResult);

          let currentConversations = [...newConversations];
          if (parsed.grammar) {
            currentConversations[questionIndex] = [
              ...currentConversations[questionIndex],
              { role: 'grammar', content: parsed.grammar }
            ];
            setConversations(currentConversations);
            scrollToBottom(questionIndex);
            
            await new Promise(resolve => setTimeout(resolve, 400));
          }

          const updatedConversations = [...currentConversations];
          updatedConversations[questionIndex] = [
            ...updatedConversations[questionIndex],
            { role: 'assistant', content: parsed.response }
          ];
          setConversations(updatedConversations);
          
          scrollToBottom(questionIndex);

        } catch (e) {
          console.error('Chat error:', e);
          alert('Villa viÃ° aÃ° senda skilaboÃ°. Reyndu aftur.');
          
          const rollbackConversations = [...conversations];
          rollbackConversations[questionIndex] = newConversations[questionIndex].slice(0, -1);
          setConversations(rollbackConversations);
          
          // Rollback message count
          const rollbackCount = [...messageCount];
          rollbackCount[questionIndex] = rollbackCount[questionIndex] - 1;
          setMessageCount(rollbackCount);
        } finally {
          const newLoading = [...loadingStates];
          newLoading[questionIndex] = false;
          setLoadingStates(newLoading);
        }
      };

      const handleKeyPress = (e, questionIndex) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(questionIndex);
        }
      };

      return (
        <div className="max-w-5xl mx-auto">
          <h1 className="text-2xl font-bold mb-6">Spjall Test - ÃžrÃ­r gluggar</h1>
          
          <div className="space-y-6">
            {DISCUSSION_QUESTIONS.map((question, index) => (
              <div key={index} className="bg-white rounded-lg shadow p-6">
                <p className="font-semibold text-gray-800 mb-4 text-lg">
                  {index + 1}. {question}
                </p>
                <p className="text-sm text-gray-500 mb-4">
                  SkilaboÃ° frÃ¡ nemanda: {messageCount[index]}
                </p>

                <div 
                  ref={chatRefs[index]}
                  className="chat-container mb-4 space-y-3 min-h-[100px]"
                >
                  {conversations[index].map((msg, msgIndex) => (
                    <div key={msgIndex}>
                      {msg.role === 'user' ? (
                        <div className="flex justify-end">
                          <div className="bg-blue-50 rounded-lg p-3 max-w-[80%]">
                            <p className="text-gray-800">{msg.content}</p>
                          </div>
                        </div>
                      ) : msg.role === 'grammar' ? (
                        <div className="flex justify-center">
                          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 max-w-[85%]">
                            <div className="flex items-start gap-2">
                              <span className="text-lg">ðŸ“š</span>
                              <p className="text-sm text-gray-700">
                                <span className="font-semibold">MÃ¡lfar:</span> {msg.content}
                              </p>
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div className="flex justify-start">
                          <div className="bg-green-50 border border-green-200 rounded-lg p-3 max-w-[80%]">
                            <div className="flex items-start gap-2">
                              <span className="text-xl">âœ¨</span>
                              <p className="text-gray-800">{msg.content}</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                  
                  {loadingStates[index] && (
                    <div className="flex justify-start">
                      <div className="bg-gray-100 rounded-lg p-3">
                        <p className="text-gray-500">BÃ­Ã°...</p>
                      </div>
                    </div>
                  )}
                </div>

                <div className="flex gap-2">
                  <textarea
                    value={currentInputs[index]}
                    onChange={(e) => handleInputChange(index, e.target.value)}
                    onKeyPress={(e) => handleKeyPress(e, index)}
                    disabled={loadingStates[index]}
                    className="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none disabled:bg-gray-50"
                    rows="2"
                    placeholder="SkrifaÃ°u hÃ©r..."
                  />
                  <button
                    onClick={() => sendMessage(index)}
                    disabled={loadingStates[index] || !currentInputs[index].trim()}
                    className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors self-end"
                  >
                    Senda
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<SpjallTest />);
  </script>
</body>
</html>
