<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OrÃ°aleikur â€“ MÃ¡lstÃ¶Ã°in</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.4s ease both; }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.3); }
      70% { box-shadow: 0 0 0 12px rgba(37, 99, 235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    .pulse-ring { animation: pulse-ring 1.5s ease-out infinite; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useCallback } = React;

// â”€â”€ OrÃ°alisti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ORDALISTINN = [
  { ord: "hestur",      flokkur: "dÃ½r",       stig: "A1" },
  { ord: "hundur",      flokkur: "dÃ½r",       stig: "A1" },
  { ord: "kÃ¶ttur",      flokkur: "dÃ½r",       stig: "A1" },
  { ord: "fugl",        flokkur: "dÃ½r",       stig: "A1" },
  { ord: "fiskur",      flokkur: "dÃ½r",       stig: "A1" },
  { ord: "bÃ³k",         flokkur: "hlutir",    stig: "A1" },
  { ord: "stÃ³ll",       flokkur: "hÃºsgÃ¶gn",   stig: "A1" },
  { ord: "borÃ°",        flokkur: "hÃºsgÃ¶gn",   stig: "A1" },
  { ord: "gluggi",      flokkur: "hÃ­bÃ½li",    stig: "A1" },
  { ord: "dyra",        flokkur: "hÃ­bÃ½li",    stig: "A1" },
  { ord: "sÃ³lskin",     flokkur: "veÃ°ur",     stig: "A2" },
  { ord: "rigning",     flokkur: "veÃ°ur",     stig: "A2" },
  { ord: "snjÃ³r",       flokkur: "veÃ°ur",     stig: "A2" },
  { ord: "skÃ³gur",      flokkur: "nÃ¡ttÃºra",   stig: "A2" },
  { ord: "fjall",       flokkur: "nÃ¡ttÃºra",   stig: "A2" },
  { ord: "sjÃ³r",        flokkur: "nÃ¡ttÃºra",   stig: "A2" },
  { ord: "brauÃ°",       flokkur: "matur",     stig: "A1" },
  { ord: "mjÃ³lk",       flokkur: "matur",     stig: "A1" },
  { ord: "epli",        flokkur: "matur",     stig: "A1" },
  { ord: "kaffi",       flokkur: "drykkir",   stig: "A1" },
  { ord: "kertaljÃ³s",   flokkur: "hlutir",    stig: "A2" },
  { ord: "regnhlÃ­f",    flokkur: "klÃ¦Ã°naÃ°ur", stig: "A2" },
  { ord: "sjÃ³nvarp",    flokkur: "tÃ¦kni",     stig: "A2" },
  { ord: "sÃ­minn",      flokkur: "tÃ¦kni",     stig: "A2" },
  { ord: "tÃ¶lva",       flokkur: "tÃ¦kni",     stig: "A2" },
  { ord: "strÃ¦tÃ³",      flokkur: "samgÃ¶ngur", stig: "A2" },
  { ord: "flugvÃ©l",     flokkur: "samgÃ¶ngur", stig: "A2" },
  { ord: "hjÃ³l",        flokkur: "samgÃ¶ngur", stig: "A2" },
  { ord: "bÃ­ll",        flokkur: "samgÃ¶ngur", stig: "A1" },
  { ord: "kennari",     flokkur: "stÃ¶rf",     stig: "A2" },
  { ord: "lÃ¦knir",      flokkur: "stÃ¶rf",     stig: "A2" },
  { ord: "kokkur",      flokkur: "stÃ¶rf",     stig: "A2" },
  { ord: "lÃ¶gregla",    flokkur: "stÃ¶rf",     stig: "B1" },
  { ord: "hÃºsnÃ¦Ã°i",     flokkur: "hÃ­bÃ½li",    stig: "B1" },
  { ord: "samband",     flokkur: "samfÃ©lag",  stig: "B1" },
  { ord: "umhverfi",    flokkur: "nÃ¡ttÃºra",   stig: "B1" },
  { ord: "menning",     flokkur: "samfÃ©lag",  stig: "B1" },
  { ord: "Ã¾jÃ³Ã°lÃ­f",    flokkur: "samfÃ©lag",  stig: "B1" },
  { ord: "framtÃ­Ã°",     flokkur: "tÃ­mi",      stig: "B1" },
  { ord: "fortÃ­Ã°",      flokkur: "tÃ­mi",      stig: "B1" },
  { ord: "sigur",       flokkur: "tilfinningar", stig: "B1" },
  { ord: "gleÃ°i",       flokkur: "tilfinningar", stig: "A2" },
  { ord: "sorg",        flokkur: "tilfinningar", stig: "B1" },
  { ord: "Ã³tti",        flokkur: "tilfinningar", stig: "B1" },
  { ord: "kÃ¦rleikur",   flokkur: "tilfinningar", stig: "B1" },
  { ord: "Ã¾olinmÃ¦Ã°i",   flokkur: "eiginleikar", stig: "B2" },
  { ord: "hugrekki",    flokkur: "eiginleikar", stig: "B2" },
  { ord: "Ã¾jÃ³Ã°saga",    flokkur: "menning",   stig: "B2" },
  { ord: "nÃ¡ttÃºruvernĞ´",flokkur: "nÃ¡ttÃºra",   stig: "B2" },
  { ord: "sjÃ¡lfbÃ¦rni",  flokkur: "samfÃ©lag",  stig: "B2" },
];

// â”€â”€ API fÃ¶ll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callOpenAI(messages, max_tokens = 400, temperature = 0.5) {
  const r = await fetch('/.netlify/functions/openai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, max_tokens, model: 'gpt-4o-mini', temperature })
  });
  const data = await r.json();
  if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
  return data.content;
}

async function playAudio(text, onEnd) {
  try {
    const r = await fetch('/.netlify/functions/speak', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text_to_speak: text })
    });
    const data = await r.json();
    if (!r.ok || data.error || !data.audio_base64) { onEnd && onEnd(); return; }
    const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
    audio.onended = () => onEnd && onEnd();
    audio.onerror = () => onEnd && onEnd();
    await audio.play().catch(() => onEnd && onEnd());
    return audio;
  } catch (e) {
    console.error(e);
    onEnd && onEnd();
  }
}

// â”€â”€ HjÃ¡lparfÃ¶ll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function veljaOrÃ°(fjoldi = 8) {
  return shuffleArray(ORDALISTINN).slice(0, fjoldi);
}

// â”€â”€ Ãhlutir â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ListenPill = ({ onClick, speaking, label }) => (
  <button onClick={onClick}
    className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border transition-all ${
      speaking ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200'
    }`}>
    <span className="opacity-70">ğŸ§</span>
    <span className="font-light">{label || 'HlustaÃ°u'}</span>
    <span className={`text-green-600 ${speaking ? 'animate-pulse' : ''}`}>ğŸ”Š</span>
  </button>
);

// â”€â”€ ForsÃ­Ã°a â€“ veldu hlutverk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ModeSelection({ onSelect }) {
  return (
    <div className="fade-in max-w-2xl mx-auto px-6 py-12">
      <div className="text-center mb-10">
        <div className="text-5xl mb-4">ğŸ“</div>
        <h2 className="text-2xl font-light text-gray-800 mb-2">Veldu hlutverk</h2>
        <p className="text-gray-500 font-light text-sm">Hvort vilt Ã¾Ãº lÃ½sa orÃ°um eÃ°a giska?</p>
      </div>
      <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <button onClick={() => onSelect('nemandi-lysir')}
          className="bg-white border border-gray-100 rounded-xl shadow-sm p-6 text-left hover:shadow-md hover:border-blue-200 transition-all group">
          <div className="text-3xl mb-3">ğŸ—£ï¸</div>
          <h3 className="text-lg font-medium text-gray-800 mb-2 group-hover:text-blue-700 transition-colors">
            Ã‰g lÃ½si â€“ AI giskar
          </h3>
          <p className="text-sm text-gray-500 font-light leading-relaxed">
            ÃÃº fÃ¦rÃ° leynilegt orÃ° og lÃ½sir Ã¾vÃ­ Ã¡ Ã­slensku. Gervigreindin reynir aÃ° giska Ã¡ hvaÃ° Ã¾Ãº ert aÃ° lÃ½sa!
          </p>
          <div className="mt-4 flex gap-2 flex-wrap">
            <span className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-lg font-light">Talar Ã­slensku</span>
            <span className="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded-lg font-light">Ã†fir tjÃ¡ningu</span>
          </div>
        </button>

        <button onClick={() => onSelect('ai-lysir')}
          className="bg-white border border-gray-100 rounded-xl shadow-sm p-6 text-left hover:shadow-md hover:border-green-200 transition-all group">
          <div className="text-3xl mb-3">ğŸ¤–</div>
          <h3 className="text-lg font-medium text-gray-800 mb-2 group-hover:text-green-700 transition-colors">
            AI lÃ½sir â€“ Ã©g giska
          </h3>
          <p className="text-sm text-gray-500 font-light leading-relaxed">
            Gervigreindin lÃ½sir leynilegu orÃ°i Ã¡ Ã­slensku og Ã¾Ãº reynir aÃ° giska hvaÃ° Ã¾aÃ° er!
          </p>
          <div className="mt-4 flex gap-2 flex-wrap">
            <span className="text-xs bg-green-50 text-green-600 px-2 py-1 rounded-lg font-light">Hlustun</span>
            <span className="text-xs bg-amber-50 text-amber-600 px-2 py-1 rounded-lg font-light">Skilningur</span>
          </div>
        </button>
      </div>
    </div>
  );
}

// â”€â”€ Hamur 1: Nemandi lÃ½sir, AI giskar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NemAndiLysir({ ordaListi, onDone }) {
  const [index, setIndex] = useState(0);
  const [lysing, setLysing] = useState('');
  const [loading, setLoading] = useState(false);
  const [aiSvar, setAiSvar] = useState(null);   // { gisk, rett, endurgjof }
  const [speaking, setSpeaking] = useState(false);
  const [scores, setScores] = useState([]);
  const [stig, setStig] = useState(null);

  const ord = ordaListi[index];
  const eftir = ordaListi.length - index - 1;

  const senda = async () => {
    if (!lysing.trim() || loading) return;
    setLoading(true);
    setAiSvar(null);
    setStig(null);
    try {
      const result = await callOpenAI([
        {
          role: 'system',
          content: `ÃÃº ert leikmaÃ°ur Ã­ orÃ°alÃ½singaleik Ã¡ Ã­slensku. Nemandi lÃ½sir orÃ°i Ã¡ Ã­slensku (Ã¡n Ã¾ess aÃ° segja orÃ°iÃ° sjÃ¡lft) og Ã¾Ãº Ã¡tt aÃ° giska.
LeyniorÃ°iÃ° er: "${ord.ord}" (flokkur: ${ord.flokkur}).

Lestu lÃ½singuna vandlega. SvaraÃ°u EINUNGIS Ã¡ Ã¾essu formi:
GISK: [eitt orÃ° â€“ giskurinn Ã¾inn Ã¡ Ã­slensku]
RÃ‰TT: [JÃ eÃ°a NEI]
STIG: [0-5 â€“ 5 ef lÃ½singin var mjÃ¶g gÃ³Ã° og skÃ½r Ã¡ Ã­slensku, 0 ef engin lÃ½sing]
ENDURGJÃ–F: [ein stutt vinaleg setning Ã¡ Ã­slensku um lÃ½singuna]`
        },
        { role: 'user', content: `LÃ½sing nemanda: "${lysing}"` }
      ], 200, 0.2);

      const giskMatch = result.match(/GISK:\s*(.+)/i);
      const rettMatch = result.match(/RÃ‰TT:\s*(JÃ|NEI)/i);
      const stigMatch = result.match(/STIG:\s*(\d)/i);
      const endurgjofMatch = result.match(/ENDURGJÃ–F:\s*(.+)/i);

      const gisk = giskMatch ? giskMatch[1].trim() : '?';
      const rett = rettMatch ? rettMatch[1].toUpperCase() === 'JÃ' : gisk.toLowerCase() === ord.ord.toLowerCase();
      const s = stigMatch ? parseInt(stigMatch[1]) : 3;
      const endurgjof = endurgjofMatch ? endurgjofMatch[1].trim() : 'Gott!';

      setAiSvar({ gisk, rett, endurgjof });
      setStig(s);
      setScores(prev => [...prev, { ord: ord.ord, stig: s, rett, lysing }]);

      // Les upp gisk AI
      setSpeaking(true);
      await playAudio(`${gisk}. ${endurgjof}`, () => setSpeaking(false));

    } catch (e) {
      setAiSvar({ gisk: '?', rett: false, endurgjof: 'Villa kom upp. Reyndu aftur.' });
    }
    setLoading(false);
  };

  const naesta = () => {
    if (index + 1 >= ordaListi.length) {
      onDone(scores);
    } else {
      setIndex(i => i + 1);
      setLysing('');
      setAiSvar(null);
      setStig(null);
    }
  };

  const handleKey = (e) => {
    if (e.key === 'Enter' && !e.shiftKey && !aiSvar) {
      e.preventDefault();
      senda();
    }
  };

  return (
    <div className="fade-in max-w-2xl mx-auto px-6 py-8">
      {/* FramvindusÃ­a */}
      <div className="flex items-center gap-2 mb-6">
        {ordaListi.map((_, i) => (
          <div key={i} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${
            i < index ? 'bg-green-500' : i === index ? 'bg-blue-400' : 'bg-gray-200'
          }`} />
        ))}
        <span className="text-xs text-gray-400 font-light whitespace-nowrap">{index + 1}/{ordaListi.length}</span>
      </div>

      {/* LeyniorÃ°iÃ° */}
      <div className="bg-white border border-gray-100 rounded-xl shadow-sm p-6 mb-4">
        <div className="flex items-center justify-between mb-1">
          <span className="text-xs text-gray-400 font-light uppercase tracking-wider">LeyniorÃ°iÃ° Ã¾itt</span>
          <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-lg font-light">{ord.flokkur}</span>
        </div>
        <div className="text-4xl font-light text-blue-700 tracking-wide mt-2 mb-1">{ord.ord}</div>
        <p className="text-xs text-gray-400 font-light">LÃ½stu Ã¾essu orÃ°i Ã¡n Ã¾ess aÃ° segja Ã¾aÃ°! ğŸ¤«</p>
      </div>

      {/* LÃ½singareitur */}
      <div className="bg-white border border-gray-100 rounded-xl shadow-sm p-5 mb-4">
        <label className="block text-sm text-gray-600 font-light mb-2">
          LÃ½stu orÃ°inu Ã¡ Ã­slensku:
        </label>
        <textarea
          value={lysing}
          onChange={e => setLysing(e.target.value)}
          onKeyDown={handleKey}
          disabled={!!aiSvar || loading}
          rows={3}
          placeholder="Ãetta er eitthvaÃ° sem... / Ãetta er stÃ³r/lÃ­till... / ÃÃº notar Ã¾etta til aÃ°..."
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-400 font-light resize-none disabled:bg-gray-50 text-gray-800"
        />
        {!aiSvar && (
          <button
            onClick={senda}
            disabled={!lysing.trim() || loading}
            className="mt-3 w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light flex items-center justify-center gap-2">
            {loading ? (
              <>
                <svg className="spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full" viewBox="0 0 24 24"/>
                <span>AI er aÃ° giska...</span>
              </>
            ) : 'Senda lÃ½singu â†’'}
          </button>
        )}
      </div>

      {/* Svar AI */}
      {aiSvar && (
        <div className={`fade-in bg-white border-2 rounded-xl shadow-sm p-5 mb-4 ${
          aiSvar.rett ? 'border-green-200' : 'border-amber-200'
        }`}>
          <div className="flex items-start justify-between mb-3">
            <div>
              <div className="text-xs text-gray-400 font-light mb-1">AI giskaÃ°i:</div>
              <div className={`text-2xl font-medium ${aiSvar.rett ? 'text-green-700' : 'text-amber-700'}`}>
                {aiSvar.gisk} {aiSvar.rett ? 'âœ“' : 'âœ—'}
              </div>
            </div>
            <ListenPill
              onClick={() => {
                setSpeaking(true);
                playAudio(`${aiSvar.gisk}. ${aiSvar.endurgjof}`, () => setSpeaking(false));
              }}
              speaking={speaking}
              label="HlustaÃ°u"
            />
          </div>
          {!aiSvar.rett && (
            <div className="text-sm text-gray-600 font-light mb-2">
              RÃ©tta svariÃ° var: <span className="font-medium text-gray-800">{ord.ord}</span>
            </div>
          )}
          <div className={`p-3 rounded-lg text-sm font-light ${
            aiSvar.rett ? 'bg-green-50 text-green-700' : 'bg-amber-50 text-amber-700'
          }`}>
            <span className="font-medium">Stig: {stig}/5 Â· </span>{aiSvar.endurgjof}
          </div>
          <button onClick={naesta}
            className="mt-4 w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-light">
            {eftir > 0 ? 'NÃ¦sta orÃ° â†’' : 'SjÃ¡ niÃ°urstÃ¶Ã°ur â†’'}
          </button>
        </div>
      )}
    </div>
  );
}

// â”€â”€ Hamur 2: AI lÃ½sir, nemandi giskar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AiLysir({ ordaListi, onDone }) {
  const [index, setIndex] = useState(0);
  const [lysing, setLysing] = useState('');
  const [loadingLysing, setLoadingLysing] = useState(false);
  const [lysingTexti, setLysingTexti] = useState('');
  const [gisk, setGisk] = useState('');
  const [niÃ°urstaÃ°a, setNiÃ°urstaÃ°a] = useState(null);
  const [speaking, setSpeaking] = useState(false);
  const [scores, setScores] = useState([]);
  const audioRef = useRef(null);

  const ord = ordaListi[index];
  const eftir = ordaListi.length - index - 1;

  // SÃ¦kja lÃ½singu frÃ¡ AI
  const saekjaLysingu = useCallback(async () => {
    setLoadingLysing(true);
    setLysingTexti('');
    setNiÃ°urstaÃ°a(null);
    setGisk('');
    try {
      const result = await callOpenAI([
        {
          role: 'system',
          content: `ÃÃº ert leikstjÃ³ri Ã­ orÃ°alÃ½singaleik Ã¡ Ã­slensku. LÃ½stu orÃ°inu Ã¡ einfalda og skemmtilega Ã­slensku, ALDREI nota orÃ°iÃ° sjÃ¡lft eÃ°a beina Ã¾Ã½Ã°ingu Ã¾ess. Nota 2-3 setningar. Stig nemandans (${ord.stig}) â€“ aÃ°laga erfiÃ°leikastig aÃ° Ã¾essu.`
        },
        { role: 'user', content: `LÃ½stu Ã¾essu orÃ°i: "${ord.ord}" (flokkur: ${ord.flokkur}). Mundu: EKKI nota orÃ°iÃ° sjÃ¡lft!` }
      ], 150, 0.7);
      setLysingTexti(result.trim());
      // Les upp lÃ½singuna
      setSpeaking(true);
      audioRef.current = await playAudio(result.trim(), () => setSpeaking(false));
    } catch (e) {
      setLysingTexti('Villa kom upp. Reyndu aftur.');
    }
    setLoadingLysing(false);
  }, [ord]);

  // HlÃ¶Ã°um lÃ½singu Ã¾egar index breytist
  React.useEffect(() => {
    saekjaLysingu();
  }, [index]);

  const athugaGisk = async () => {
    if (!gisk.trim() || niÃ°urstaÃ°a) return;
    const rett = gisk.trim().toLowerCase() === ord.ord.toLowerCase();
    // Nota AI til aÃ° meta ef ekki nÃ¡kvÃ¦mlega rÃ©tt
    let s = 0;
    let endurgjof = '';
    try {
      const result = await callOpenAI([
        {
          role: 'system',
          content: `ÃÃº metur hvort giskur nemanda samsvari leyniorÃ°inu Ã­ orÃ°alÃ½singaleik Ã¡ Ã­slensku.
LeyniorÃ°iÃ° er: "${ord.ord}"
Nemandi giskaÃ°i: "${gisk.trim()}"
SvaraÃ°u EINUNGIS:
STIG: [0-5, Ã¾ar sem 5=nÃ¡kvÃ¦mlega rÃ©tt eÃ°a mjÃ¶g nÃ¡lÃ¦gt, 3=svipaÃ° hugtak, 0=rangt]
ENDURGJÃ–F: [ein stutt vinaleg setning Ã¡ Ã­slensku]`
        },
        { role: 'user', content: `LeyniorÃ°: "${ord.ord}" â€“ Giskur: "${gisk.trim()}"` }
      ], 100, 0.2);
      const stigMatch = result.match(/STIG:\s*(\d)/i);
      const endurgjofMatch = result.match(/ENDURGJÃ–F:\s*(.+)/i);
      s = stigMatch ? parseInt(stigMatch[1]) : (rett ? 5 : 0);
      endurgjof = endurgjofMatch ? endurgjofMatch[1].trim() : (rett ? 'RÃ©tt!' : 'Reyndu aftur!');
    } catch {
      s = rett ? 5 : 0;
      endurgjof = rett ? 'FrÃ¡bÃ¦rt, rÃ©tt svar!' : `LeyniorÃ°iÃ° var: ${ord.ord}`;
    }

    const rettNg = s >= 3;
    setNiÃ°urstaÃ°a({ rett: rettNg, stig: s, endurgjof });
    setScores(prev => [...prev, { ord: ord.ord, stig: s, rett: rettNg, gisk: gisk.trim() }]);
    setSpeaking(true);
    await playAudio(endurgjof, () => setSpeaking(false));
  };

  const naesta = () => {
    if (index + 1 >= ordaListi.length) {
      onDone(scores);
    } else {
      setIndex(i => i + 1);
      setGisk('');
      setNiÃ°urstaÃ°a(null);
      setLysingTexti('');
    }
  };

  const handleKey = (e) => {
    if (e.key === 'Enter' && !niÃ°urstaÃ°a) {
      e.preventDefault();
      athugaGisk();
    }
  };

  return (
    <div className="fade-in max-w-2xl mx-auto px-6 py-8">
      {/* FramvindusÃ­a */}
      <div className="flex items-center gap-2 mb-6">
        {ordaListi.map((_, i) => (
          <div key={i} className={`h-1.5 flex-1 rounded-full transition-all duration-500 ${
            i < index ? 'bg-green-500' : i === index ? 'bg-green-400' : 'bg-gray-200'
          }`} />
        ))}
        <span className="text-xs text-gray-400 font-light whitespace-nowrap">{index + 1}/{ordaListi.length}</span>
      </div>

      {/* LÃ½sing AI */}
      <div className="bg-white border border-gray-100 rounded-xl shadow-sm p-6 mb-4">
        <div className="flex items-center justify-between mb-3">
          <span className="text-xs text-gray-400 font-light uppercase tracking-wider">AI lÃ½sirâ€¦</span>
          <div className="flex items-center gap-2">
            {lysingTexti && (
              <ListenPill
                onClick={() => {
                  setSpeaking(true);
                  playAudio(lysingTexti, () => setSpeaking(false));
                }}
                speaking={speaking}
                label="HlustaÃ°u aftur"
              />
            )}
          </div>
        </div>

        {loadingLysing ? (
          <div className="flex items-center gap-3 py-4 text-gray-400">
            <svg className="spinner w-5 h-5 border-2 border-gray-300 border-t-green-500 rounded-full" viewBox="0 0 24 24"/>
            <span className="font-light text-sm">AI er aÃ° setja saman lÃ½singuâ€¦</span>
          </div>
        ) : (
          <p className="text-gray-800 font-light leading-relaxed text-base">{lysingTexti}</p>
        )}
        <div className="mt-3 flex gap-2 flex-wrap">
          <span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-lg font-light">{ord.flokkur}</span>
          <span className="text-xs bg-blue-50 text-blue-500 px-2 py-0.5 rounded-lg font-light">{ord.stig}</span>
        </div>
      </div>

      {/* Giskingareitur */}
      <div className="bg-white border border-gray-100 rounded-xl shadow-sm p-5 mb-4">
        <label className="block text-sm text-gray-600 font-light mb-2">
          HvaÃ° er AI aÃ° lÃ½sa?
        </label>
        <input
          type="text"
          value={gisk}
          onChange={e => setGisk(e.target.value)}
          onKeyDown={handleKey}
          disabled={!!niÃ°urstaÃ°a || loadingLysing}
          placeholder="SkrifaÃ°u giskinn Ã¾inn hÃ©râ€¦"
          className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 font-light disabled:bg-gray-50 text-gray-800"
        />
        {!niÃ°urstaÃ°a && (
          <button
            onClick={athugaGisk}
            disabled={!gisk.trim() || loadingLysing}
            className="mt-3 w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-light">
            Giska â†’
          </button>
        )}
      </div>

      {/* NiÃ°urstaÃ°a */}
      {niÃ°urstaÃ°a && (
        <div className={`fade-in bg-white border-2 rounded-xl shadow-sm p-5 mb-4 ${
          niÃ°urstaÃ°a.rett ? 'border-green-200' : 'border-amber-200'
        }`}>
          <div className="flex items-center gap-2 mb-2">
            <span className="text-2xl">{niÃ°urstaÃ°a.rett ? 'ğŸ‰' : 'ğŸ’¡'}</span>
            <div>
              <div className="text-sm font-light text-gray-500">RÃ©tta svariÃ° var:</div>
              <div className="text-xl font-medium text-gray-800">{ord.ord}</div>
            </div>
          </div>
          <div className={`p-3 rounded-lg text-sm font-light ${
            niÃ°urstaÃ°a.rett ? 'bg-green-50 text-green-700' : 'bg-amber-50 text-amber-700'
          }`}>
            <span className="font-medium">Stig: {niÃ°urstaÃ°a.stig}/5 Â· </span>{niÃ°urstaÃ°a.endurgjof}
          </div>
          <button onClick={naesta}
            className="mt-4 w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-light">
            {eftir > 0 ? 'NÃ¦sta orÃ° â†’' : 'SjÃ¡ niÃ°urstÃ¶Ã°ur â†’'}
          </button>
        </div>
      )}
    </div>
  );
}

// â”€â”€ NiÃ°urstÃ¶Ã°ur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NiÃ°urstÃ¶Ã°ur({ scores, mode, onRestart }) {
  const total = scores.reduce((s, x) => s + x.stig, 0);
  const maxTotal = scores.length * 5;
  const hlutfall = Math.round((total / maxTotal) * 100);

  const color = hlutfall >= 80 ? 'green' : hlutfall >= 50 ? 'amber' : 'red';
  const colorClasses = {
    green: 'bg-green-50 border-green-200 text-green-700',
    amber: 'bg-amber-50 border-amber-200 text-amber-700',
    red: 'bg-red-50 border-red-200 text-red-700'
  };
  const emoji = hlutfall >= 80 ? 'ğŸ†' : hlutfall >= 50 ? 'ğŸ‘' : 'ğŸ’ª';

  return (
    <div className="fade-in max-w-2xl mx-auto px-6 py-10">
      <div className="bg-white border border-gray-100 rounded-xl shadow-sm p-8 text-center mb-6">
        <div className="text-5xl mb-4">{emoji}</div>
        <h2 className="text-2xl font-light text-gray-800 mb-1">Leiknum lokiÃ°!</h2>
        <p className="text-gray-500 font-light text-sm mb-4">
          {mode === 'nemandi-lysir' ? 'ÃÃº lÃ½stir â€“ AI giskaÃ°i' : 'AI lÃ½sti â€“ Ã¾Ãº gissaÃ°ir'}
        </p>
        <div className={`inline-block px-6 py-3 rounded-xl border text-lg font-medium ${colorClasses[color]}`}>
          {total} / {maxTotal} stig Â· {hlutfall}%
        </div>
      </div>

      {/* Per-orÃ° yfirlit */}
      <div className="space-y-3 mb-6">
        {scores.map((s, i) => (
          <div key={i} className="bg-white border border-gray-100 rounded-xl shadow-sm px-5 py-4 flex items-center justify-between">
            <div>
              <span className="font-medium text-gray-800">{s.ord}</span>
              {mode === 'nemandi-lysir' && s.lysing && (
                <p className="text-xs text-gray-400 font-light mt-0.5 italic">â€{s.lysing.slice(0, 60)}{s.lysing.length > 60 ? 'â€¦' : ''}"</p>
              )}
              {mode === 'ai-lysir' && s.gisk && (
                <p className="text-xs text-gray-400 font-light mt-0.5">GissaÃ°: <span className="text-gray-600">{s.gisk}</span></p>
              )}
            </div>
            <div className="flex items-center gap-3">
              <div className="text-right">
                <div className={`text-sm font-medium ${s.rett ? 'text-green-600' : 'text-amber-600'}`}>
                  {s.stig}/5
                </div>
              </div>
              <span className="text-lg">{s.rett ? 'âœ…' : 'ğŸ”¸'}</span>
            </div>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-2 gap-3">
        <button onClick={onRestart}
          className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-light">
          Spila aftur ğŸ”„
        </button>
        <button onClick={() => window.history.back()}
          className="px-6 py-3 border-2 border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-light text-sm">
          Til baka
        </button>
      </div>
    </div>
  );
}

// â”€â”€ AÃ°alforrit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [screen, setScreen] = useState('mode');   // mode | spila | niÃ°urstÃ¶Ã°ur
  const [mode, setMode] = useState(null);
  const [ordaListi, setOrdaListi] = useState([]);
  const [scores, setScores] = useState([]);

  const veljaHam = (valinn) => {
    setMode(valinn);
    setOrdaListi(veljaOrÃ°(8));
    setScreen('spila');
  };

  const handleDone = (s) => {
    setScores(s);
    setScreen('niÃ°urstÃ¶Ã°ur');
  };

  const restart = () => {
    setScreen('mode');
    setMode(null);
    setScores([]);
  };

  return (
    <div className="min-h-screen">
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-4xl mx-auto px-6 py-8">
          <button onClick={() => screen === 'spila' ? setScreen('mode') : window.history.back()}
            className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light">
            â† {screen === 'spila' ? 'Velja hlutverk' : 'Til baka'}
          </button>
          <h1 className="text-3xl font-light text-gray-800 mb-2">OrÃ°aleikur</h1>
          <p className="text-gray-500 text-sm font-light">
            {mode === 'nemandi-lysir'
              ? 'ÃÃº lÃ½sir â€“ AI giskar'
              : mode === 'ai-lysir'
              ? 'AI lÃ½sir â€“ Ã¾Ãº giskar'
              : 'LÃ½stu orÃ°um Ã¡n Ã¾ess aÃ° segja Ã¾au!'}
          </p>
        </div>
      </header>

      {/* Innihald */}
      <main>
        {screen === 'mode' && <ModeSelection onSelect={veljaHam} />}
        {screen === 'spila' && mode === 'nemandi-lysir' && (
          <NemAndiLysir ordaListi={ordaListi} onDone={handleDone} />
        )}
        {screen === 'spila' && mode === 'ai-lysir' && (
          <AiLysir ordaListi={ordaListi} onDone={handleDone} />
        )}
        {screen === 'niÃ°urstÃ¶Ã°ur' && (
          <NiÃ°urstÃ¶Ã°ur scores={scores} mode={mode} onRestart={restart} />
        )}
      </main>

      <footer className="text-center py-8 text-gray-400 text-xs font-light">
        Â© 2025 MÃ¡lstÃ¶Ã°in
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
