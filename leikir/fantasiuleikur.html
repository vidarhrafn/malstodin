<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fantasíuleikur – Málstöðin</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      margin: 0;
      background: #0f0a1a;
      overflow-x: hidden;
    }

    .story-font { font-family: 'Crimson Pro', Georgia, serif; }

    .game-bg {
      background: linear-gradient(175deg, #0f0a1a 0%, #1a1030 20%, #2d1b4e 40%, #3d2766 55%, #1a1030 85%, #0f0a1a 100%);
      min-height: 100vh;
      position: relative;
    }

    .game-bg::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(1.5px 1.5px at 12% 8%, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 25% 18%, rgba(200,180,255,0.6), transparent),
        radial-gradient(1.5px 1.5px at 55% 5%, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 72% 22%, rgba(200,180,255,0.5), transparent),
        radial-gradient(2px 2px at 88% 12%, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 35% 30%, rgba(255,255,255,0.4), transparent),
        radial-gradient(1.5px 1.5px at 65% 15%, rgba(200,180,255,0.5), transparent),
        radial-gradient(1px 1px at 8% 25%, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 45% 10%, rgba(255,220,255,0.6), transparent),
        radial-gradient(1.5px 1.5px at 92% 28%, rgba(200,180,255,0.4), transparent);
      pointer-events: none;
      z-index: 0;
      animation: twinkle 5s ease-in-out infinite alternate;
    }

    @keyframes twinkle {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
      50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .fade-in-up { animation: fadeInUp 0.6s ease both; }
    .fade-in { animation: fadeIn 0.5s ease both; }

    .mountain-silhouette {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 200px;
      z-index: 0;
      pointer-events: none;
    }

    .glow-line {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139,92,246,0.4), transparent);
      margin: 1.5rem 0;
    }

    .choice-btn {
      background: rgba(30, 20, 50, 0.7);
      border: 1px solid rgba(139, 92, 246, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .choice-btn:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.6);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      transform: translateY(-2px);
    }
    .choice-btn:active { transform: translateY(0); }

    .speaking-wave {
      display: inline-flex;
      gap: 2px;
      align-items: center;
      height: 16px;
    }
    .speaking-wave span {
      display: block;
      width: 3px;
      background: #a78bfa;
      border-radius: 2px;
      animation: wave 0.8s ease-in-out infinite;
    }
    .speaking-wave span:nth-child(2) { animation-delay: 0.1s; }
    .speaking-wave span:nth-child(3) { animation-delay: 0.2s; }
    .speaking-wave span:nth-child(4) { animation-delay: 0.3s; }

    @keyframes wave {
      0%, 100% { height: 4px; }
      50% { height: 14px; }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.3); border-radius: 3px; }

    .magic-input:focus {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

async function callOpenAI(messages, max_tokens = 600, model = 'gpt-4o-mini', temperature = 0.5) {
  const r = await fetch('/.netlify/functions/openai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, max_tokens, model, temperature })
  });
  const data = await r.json();
  if (!r.ok || data.error) throw new Error(data.error || 'HTTP ' + r.status);
  return data.content;
}

async function playAudio(text, onEnd) {
  try {
    const r = await fetch('/.netlify/functions/speak', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text_to_speak: text })
    });
    const data = await r.json();
    if (!r.ok || data.error || !data.audio_base64) { onEnd && onEnd(); return null; }
    const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
    audio.onended = function() { onEnd && onEnd(); };
    audio.onerror = function() { onEnd && onEnd(); };
    await audio.play().catch(function() { onEnd && onEnd(); });
    return audio;
  } catch (e) {
    console.error('TTS villa:', e);
    onEnd && onEnd();
    return null;
  }
}

var SYSTEM_PROMPT = 'HLUTVERK: \u00DE\u00FA ert s\u00F6guma\u00F0ur \u00ED \u00EDslenskum fantas\u00EDuleik fyrir nemendur sem eru a\u00F0 l\u00E6ra \u00EDslensku \u00E1 A1-A2 stigi. \u00DE\u00FA skrifar allt \u00E1 \u00EDslensku.\n\nM\u00C1LF\u00C6RI \u2013 MIKILV\u00C6GAST:\n\u00CDslenska \u00FE\u00EDn ver\u00F0ur a\u00F0 vera m\u00E1lfr\u00E6\u00F0ilega fullkomin. \u00DEetta er kennsluefni og nemendur l\u00E6ra af \u00FEv\u00ED sem \u00FEeir sj\u00E1.\n- Kynbeyging l\u00FDsingaror\u00F0a: br\u00FA (kvenkyns) \u2192 g\u00F6mul br\u00FA, \u00FEr\u00F6ng br\u00FA. \u00DEoka (kvenkyns) \u2192 \u00FEykk \u00FEoka. Loft (hvorugkyn) \u2192 kalt loft. Dalur (karlkyns) \u2192 dj\u00FApur dalur.\n- Fallbeyging: nefnifall, \u00FEolfall, \u00FE\u00E1gufall, eignarfall \u2013 alltaf r\u00E9tt.\n- Pers\u00F3nuforn\u00F6fn \u00ED r\u00E9ttu falli: "m\u00E9r l\u00ED\u00F0ur vel", "m\u00E9r er kalt", "hj\u00E1lpa\u00F0u m\u00E9r".\n- Sagnbeyging: "hva\u00F0 gerir \u00FE\u00FA" ekki "hva\u00F0 gerir \u00FE\u00E9r".\n- FOR\u00D0ASTU or\u00F0i\u00F0 "hall\u00F3" \u2013 nota\u00F0u "g\u00F3\u00F0an dag", "s\u00E6ll" e\u00F0a "h\u00E6" \u00ED sta\u00F0inn.\n- Lestu yfir texta \u00FEinn \u00E1\u00F0ur en \u00FE\u00FA skilar honum og lei\u00F0r\u00E9ttu allar villur.\n\nTUNGUM\u00C1LASTIG: Stuttar einfaldar setningar. Algengur or\u00F0afor\u00F0i sem hentar A1-A2. Engar fl\u00F3knar m\u00E1lsgreinar.\n\nS\u00D6GU\u00DER\u00C1\u00D0UR: \u00DE\u00FA manst hva\u00F0 ger\u00F0ist \u00E1 fyrri hn\u00FAtum. \u00C1kvar\u00F0anir leikmannsins hafa raunveruleg \u00E1hrif \u00E1 framvinduna. \u00DE\u00FA gefur alltaf n\u00E1kv\u00E6mlega 2-3 valkosti \u00E1 hverjum hn\u00FAt, n\u00FAmeraða A, B, C.\n\nPERS\u00D3NUR:\n- Ormur: gamall ma\u00F0ur me\u00F0 langt hv\u00EDtt skegg og br\u00FAna skikkju. Vitur og vinalegur. Birtist \u00E1 br\u00FAnni (hn\u00FAtur 1) og kemur aftur \u00ED lok s\u00F6gunnar.\n- Dr\u00EDfa: drottning fjallsins. H\u00FAn ger\u00F0i himininn fj\u00F3lubl\u00E1an. B\u00FDr \u00ED turninum. Ekki endilega vond \u2013 leikma\u00F0urinn getur tala\u00F0 vi\u00F0 hana.\n- S\u00EDmon: l\u00EDtill str\u00E1kur me\u00F0 rau\u00F0an hatt. Birtist \u00E1 lei\u00F0inni upp \u00E1 fjalli\u00F0. Gla\u00F0ur og hj\u00E1lpsamur.\n- Lykillinn: opnar himininn aftur. Hann er \u00ED turninum.\n\nS\u00D6GUUPPBYGGING (7 hn\u00FAtar):\n1. Br\u00FAin \u2013 leikma\u00F0ur vaknar, hittir Orm, kynnir sig\n2. Velja lei\u00F0 \u2013 sk\u00F3gur e\u00F0a fjallsvegur\n3. Hittir S\u00EDmon e\u00F0a \u00E1skorun \u00E1 lei\u00F0inni\n4. Kominn n\u00E6r turninum \u2013 \u00E1skorun e\u00F0a r\u00E1\u00F0g\u00E1ta\n5. \u00CD turninum \u2013 hittir Dr\u00EDfu\n6. \u00C1kv\u00F6r\u00F0un \u2013 hva\u00F0 gerir leikma\u00F0ur vi\u00F0 lykilinn og Dr\u00EDfu?\n7. Ending \u2013 mismunandi eftir valkostum. Ormur kemur aftur.\n\nSVARA ALLTAF \u00C1 \u00DEESSU JSON FORMI OG ENGU \u00D6\u00D0RU:\n{\n  "hn\u00FAtur": [n\u00FAmer 1-7],\n  "saga": "[Stutt l\u00FDsing, 2-4 setningar]",\n  "pers\u00F3na": "[Hva\u00F0 pers\u00F3na segir \u2013 e\u00F0a null ef engin talar]",\n  "pers\u00F3na_nafn": "[Nafn \u00FEess sem talar \u2013 e\u00F0a null]",\n  "valkostir": ["A) ...", "B) ...", "C) ..."],\n  "frj\u00E1lst_svar": [true ef leikma\u00F0ur \u00E1 a\u00F0 skrifa eigia svar, annars false],\n  "ending": [true ef hn\u00FAtur 7, annars false]\n}\n\n\u00DEEGAR LEIKMA\u00D0UR SKRIFAR EIGID SVAR: Bregstu vi\u00F0 \u00FEv\u00ED n\u00E1tt\u00FArulega \u00ED s\u00F6gunni og haltu \u00E1fram \u00E1 n\u00E6sta hn\u00FAt.\nMIKILV\u00C6GT: Svara\u00F0u A\u00D0EINS me\u00F0 JSON. Ekkert anna\u00F0 utan JSON.';

const MountainSilhouette = () => (
  <svg className="mountain-silhouette" viewBox="0 0 1440 200" preserveAspectRatio="none" fill="none">
    <path d="M0,200 L0,140 L120,90 L240,120 L360,60 L480,100 L560,40 L640,80 L720,20 L800,70 L880,30 L960,90 L1040,50 L1120,80 L1200,45 L1320,100 L1440,60 L1440,200 Z"
      fill="url(#mGrad)" />
    <rect x="710" y="5" width="8" height="18" fill="#1a1030" opacity="0.8" />
    <rect x="706" y="3" width="16" height="4" fill="#1a1030" opacity="0.8" />
    <defs>
      <linearGradient id="mGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stopColor="#1a1030" />
        <stop offset="100%" stopColor="#0f0a1a" />
      </linearGradient>
    </defs>
  </svg>
);

const SpeakingWave = () => (
  <span className="speaking-wave">
    <span></span><span></span><span></span><span></span>
  </span>
);

const ListenBtn = ({ text, label }) => {
  const [speaking, setSpeaking] = useState(false);
  const audioRef = useRef(null);

  const handlePlay = async () => {
    if (speaking && audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
      setSpeaking(false);
      return;
    }
    setSpeaking(true);
    audioRef.current = await playAudio(text, () => setSpeaking(false));
  };

  return (
    <button onClick={handlePlay}
      className={'inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border transition-all ' +
        (speaking
          ? 'bg-purple-500/20 text-purple-300 border-purple-400/40'
          : 'bg-white/5 text-gray-400 border-white/10 hover:bg-white/10 hover:text-purple-300')}>
      {speaking ? <SpeakingWave /> : <span className="text-sm">&#x1F50A;</span>}
      <span className="font-light">{label || 'Hlusta\u00F0u'}</span>
    </button>
  );
};

const ProgressNodes = ({ current, total }) => (
  <div className="flex items-center gap-1 justify-center">
    {Array.from({ length: total }).map((_, i) => (
      <React.Fragment key={i}>
        <div className={'w-3 h-3 rounded-full transition-all duration-500 ' + (
          i < current ? 'bg-purple-400 shadow-sm shadow-purple-400/50'
            : i === current ? 'bg-purple-500 ring-2 ring-purple-400/50 ring-offset-1 ring-offset-transparent'
            : 'bg-white/10'
        )} />
        {i < total - 1 && (
          <div className={'w-5 h-0.5 transition-all duration-500 ' + (
            i < current ? 'bg-purple-400/40' : 'bg-white/5'
          )} />
        )}
      </React.Fragment>
    ))}
  </div>
);

var charEmoji = function(name) {
  if (!name) return '\u{1F4AC}';
  var n = name.toLowerCase();
  if (n.indexOf('ormur') !== -1) return '\u{1F9D9}';
  if (n.indexOf('s\u00EDmon') !== -1) return '\u{1F9D2}';
  if (n.indexOf('dr\u00EDfa') !== -1) return '\u{1F451}';
  return '\u{1F4AC}';
};

function App() {
  const [gameState, setGameState] = useState('intro');
  const [storyNodes, setStoryNodes] = useState([]);
  const [messages, setMessages] = useState([{ role: 'system', content: SYSTEM_PROMPT }]);
  const [freeText, setFreeText] = useState('');
  const [error, setError] = useState(null);
  const [autoPlayed, setAutoPlayed] = useState(new Set());
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) {
      setTimeout(function() { scrollRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 200);
    }
  }, [storyNodes, gameState]);

  const parseResponse = (text) => {
    try {
      var cleaned = text.trim();
      var backtick = String.fromCharCode(96);
      var fence = backtick + backtick + backtick;
      if (cleaned.indexOf(fence) === 0) {
        cleaned = cleaned.slice(cleaned.indexOf('\n') + 1);
        var lastFence = cleaned.lastIndexOf(fence);
        if (lastFence !== -1) {
          cleaned = cleaned.slice(0, lastFence);
        }
      }
      return JSON.parse(cleaned.trim());
    } catch (e) {
      console.error('JSON parse villa:', e, 'Svar:', text);
      return null;
    }
  };

  const autoPlayDialogue = useCallback(async (node, nodeIndex) => {
    if (node['\u0070ers\u00F3na'] && node['\u0070ers\u00F3na_nafn'] && !autoPlayed.has(nodeIndex)) {
      setAutoPlayed(function(prev) { return new Set(prev).add(nodeIndex); });
      await new Promise(function(r) { setTimeout(r, 1000); });
      await playAudio(node['\u0070ers\u00F3na'], function() {});
    }
  }, [autoPlayed]);

  const sendToAI = async (userContent) => {
    setGameState('loading');
    setError(null);
    var userMsg = { role: 'user', content: userContent };
    var newMessages = messages.concat([userMsg]);
    try {
      var response = await callOpenAI(newMessages, 600, 'gpt-4o-mini', 0.5);
      var node = parseResponse(response);
      if (!node) {
        setError('S\u00F6guma\u00F0urinn sveitaðist... Reyndu aftur.');
        setGameState(storyNodes.length > 0 ? 'playing' : 'intro');
        return;
      }
      var assistantMsg = { role: 'assistant', content: response };
      setMessages(newMessages.concat([assistantMsg]));
      var newNodes = storyNodes.concat([node]);
      setStoryNodes(newNodes);
      setGameState(node.ending ? 'ended' : 'playing');
      setFreeText('');
      autoPlayDialogue(node, newNodes.length - 1);
    } catch (e) {
      console.error(e);
      setError('Villa \u00ED tengingu. Reyndu aftur.');
      setGameState(storyNodes.length > 0 ? 'playing' : 'intro');
    }
  };

  const startGame = () => {
    sendToAI('Byrja\u00F0u leikinn. Hn\u00FAtur 1: Leikma\u00F0urinn vaknar \u00E1 gamalli steinbr\u00FA. Himinninn er fj\u00F3lubl\u00E1r en \u00FEa\u00F0 er dagur. Ormur gamli stendur \u00FEar og spyr hva\u00F0 leikma\u00F0urinn heitir. Leikma\u00F0urinn \u00E1 a\u00F0 skrifa eigia svar (nafni\u00F0 sitt).');
  };

  const makeChoice = (choiceText) => {
    sendToAI('Leikma\u00F0urinn velur: ' + choiceText);
  };

  const handleFreeSubmit = (e) => {
    e.preventDefault();
    if (freeText.trim()) sendToAI(freeText.trim());
  };

  const resetGame = () => {
    setGameState('intro');
    setStoryNodes([]);
    setMessages([{ role: 'system', content: SYSTEM_PROMPT }]);
    setAutoPlayed(new Set());
    setError(null);
    setFreeText('');
  };

  if (gameState === 'intro') {
    return (
      <div className="game-bg flex items-center justify-center px-4">
        <MountainSilhouette />
        <div className="relative z-10 text-center max-w-lg fade-in-up">
          <div className="mb-8">
            <div className="text-6xl mb-4">&#x1F3D4;&#xFE0F;</div>
            <h1 className="story-font text-4xl md:text-5xl font-light text-white mb-3 tracking-wide">
              Fj&#x00F3;lubl&#x00E1;i himinninn
            </h1>
            <p className="text-purple-300/70 font-light text-sm tracking-widest uppercase">
              Fantas&#x00ED;uleikur &#x2013; M&#x00E1;lst&#x00F6;&#x00F0;in
            </p>
          </div>
          <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 mb-8">
            <p className="story-font text-xl text-purple-100/90 font-light leading-relaxed mb-4">
              &#x00DE;&#x00FA; vaknar &#x00E1; gamalli br&#x00FA;. Himinninn er fj&#x00F3;lubl&#x00E1;r.
              Gamall ma&#x00F0;ur stendur fyrir framan &#x00FE;ig...
            </p>
            <p className="text-purple-300/50 text-sm font-light">
              &#x00CD;slensku&#x00E6;fing &#x00E1; A1&#x2013;A2 stigi &#x00B7; 7 kaflar &#x00B7; &#x00DE;&#x00FA; velur s&#x00F6;guna
            </p>
          </div>
          <button onClick={startGame}
            className="px-10 py-4 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-light text-lg transition-all hover:shadow-lg hover:shadow-purple-500/30 hover:-translate-y-0.5 active:translate-y-0"
            style={{ animation: 'pulseGlow 3s ease-in-out infinite' }}>
            Byrja leikinn &#x2728;
          </button>
          {error && <p className="mt-4 text-red-400 text-sm font-light">{error}</p>}
        </div>
      </div>
    );
  }

  if (gameState === 'loading' && storyNodes.length === 0) {
    return (
      <div className="game-bg flex items-center justify-center px-4">
        <MountainSilhouette />
        <div className="relative z-10 text-center fade-in">
          <div className="flex gap-2 justify-center mb-4">
            {[0,1,2].map(function(i) { return (
              <div key={i} className="w-3 h-3 rounded-full bg-purple-400"
                style={{ animation: 'breathe 1.2s ease-in-out infinite', animationDelay: (i * 0.2) + 's' }} />
            ); })}
          </div>
          <p className="story-font text-xl text-purple-200/70 font-light italic">
            S&#x00F6;guma&#x00F0;urinn opnar b&#x00F3;kina...
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="game-bg">
      <MountainSilhouette />
      <header className="sticky top-0 z-20 border-b border-white/10 bg-black/40 backdrop-blur-md">
        <div className="max-w-2xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between mb-2.5">
            <div className="flex items-center gap-2.5">
              <span className="text-lg">&#x1F3D4;&#xFE0F;</span>
              <div>
                <h1 className="story-font text-base text-white font-light leading-tight">Fj&#x00F3;lubl&#x00E1;i himinninn</h1>
                <p className="text-purple-400/50 text-xs font-light">Fantas&#x00ED;uleikur</p>
              </div>
            </div>
            <div className="text-purple-300/50 text-xs font-light">
              Kafli {storyNodes.length} / 7
            </div>
          </div>
          <ProgressNodes current={storyNodes.length} total={7} />
        </div>
      </header>

      <main className="relative z-10 max-w-2xl mx-auto px-4 py-6 pb-40">
        {storyNodes.map(function(node, idx) {
          var isLast = idx === storyNodes.length - 1;
          return (
            <div key={idx} className={'mb-8 ' + (isLast ? 'fade-in-up' : '')}>
              <div className="flex items-center gap-2 mb-3">
                <span className="w-6 h-6 rounded-full bg-purple-500/30 text-purple-300 text-xs flex items-center justify-center font-medium border border-purple-400/30">
                  {node['hn\u00FAtur'] || idx + 1}
                </span>
                <div className="flex-1 h-px bg-purple-400/10"></div>
              </div>
              <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-5 border border-white/10 mb-3">
                <p className="story-font text-lg text-purple-50/90 font-light leading-relaxed whitespace-pre-line">
                  {node.saga}
                </p>
                {node['pers\u00F3na'] && (
                  <div className="mt-4 pl-4 border-l-2 border-purple-400/40">
                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                      <span className="text-base">{charEmoji(node['pers\u00F3na_nafn'])}</span>
                      <span className="text-purple-300 text-sm font-medium story-font">
                        {node['pers\u00F3na_nafn'] || 'Pers\u00F3na'}
                      </span>
                      <ListenBtn text={node['pers\u00F3na']} label="Hlusta\u00F0u" />
                    </div>
                    <p className="story-font text-lg text-purple-100 font-light italic leading-relaxed">
                      "{node['pers\u00F3na']}"
                    </p>
                  </div>
                )}
              </div>
              <div className="flex justify-end mb-3">
                <ListenBtn text={node.saga + (node['pers\u00F3na'] ? ' ' + node['pers\u00F3na'] : '')} label="Hlusta\u00F0u \u00E1 kafla" />
              </div>
              {isLast && !node.ending && gameState === 'playing' && (
                <div className="space-y-3 fade-in" style={{ animationDelay: '0.4s' }}>
                  {node.valkostir && node.valkostir.map(function(choice, ci) { return (
                    <button key={ci}
                      onClick={function() { makeChoice(choice); }}
                      className="choice-btn w-full text-left px-5 py-4 rounded-xl text-purple-100/90 font-light story-font text-base leading-relaxed">
                      {choice}
                    </button>
                  ); })}
                  {node['frj\u00E1lst_svar'] && (
                    <form onSubmit={handleFreeSubmit} className="mt-3">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={freeText}
                          onChange={function(e) { setFreeText(e.target.value); }}
                          placeholder="Skrifa\u00F0u svari\u00F0 \u00FEitt..."
                          className="magic-input flex-1 px-4 py-3 bg-white/5 border border-white/15 rounded-xl text-purple-100 placeholder-purple-300/30 font-light focus:outline-none focus:border-purple-400/50 transition-all"
                          autoFocus
                        />
                        <button type="submit"
                          disabled={!freeText.trim()}
                          className="px-5 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-light transition-all disabled:bg-white/5 disabled:text-white/20 disabled:cursor-not-allowed">
                          Senda
                        </button>
                      </div>
                    </form>
                  )}
                </div>
              )}
              {!isLast && <div className="glow-line"></div>}
            </div>
          );
        })}

        {gameState === 'loading' && storyNodes.length > 0 && (
          <div className="flex items-center justify-center gap-3 py-12 fade-in">
            <div className="flex gap-1.5">
              {[0,1,2].map(function(i) { return (
                <div key={i} className="w-2.5 h-2.5 rounded-full bg-purple-400"
                  style={{ animation: 'breathe 1.2s ease-in-out infinite', animationDelay: (i * 0.2) + 's' }} />
              ); })}
            </div>
            <span className="text-purple-300/50 text-sm font-light story-font italic">
              S&#x00F6;guma&#x00F0;urinn hugsar...
            </span>
          </div>
        )}

        {gameState === 'ended' && (
          <div className="text-center py-8 fade-in-up" style={{ animationDelay: '0.3s' }}>
            <div className="glow-line mb-6"></div>
            <div className="text-4xl mb-4">&#x2728;</div>
            <h2 className="story-font text-2xl text-white font-light mb-2">S&#x00F6;gunni er loki&#x00F0;</h2>
            <p className="text-purple-300/60 font-light text-sm mb-6">Vel gert! &#x00DE;&#x00FA; kl&#x00E1;ra&#x00F0;ir fantas&#x00ED;uleikinn.</p>
            <div className="flex gap-3 justify-center flex-wrap">
              <button onClick={resetGame}
                className="px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-light transition-all hover:shadow-lg hover:shadow-purple-500/30">
                Spila aftur &#x1F504;
              </button>
              <button onClick={function() { window.history.back(); }}
                className="px-8 py-3 border border-white/15 text-purple-200/70 rounded-xl font-light hover:bg-white/5 transition-all">
                &#x2190; Til baka
              </button>
            </div>
          </div>
        )}

        {error && (
          <div className="bg-red-500/10 border border-red-400/30 rounded-xl p-4 mt-4 fade-in">
            <p className="text-red-300 text-sm font-light">{error}</p>
            <button onClick={function() { setError(null); }}
              className="text-red-400/60 text-xs mt-2 hover:text-red-300 transition-colors">
              Loka &#x2715;
            </button>
          </div>
        )}

        <div ref={scrollRef}></div>
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

</body>
</html>
