<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fantas√≠uleikur ‚Äì M√°lst√∂√∞in</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      margin: 0;
      background: #0f0a1a;
      overflow-x: hidden;
    }

    .story-font { font-family: 'Crimson Pro', Georgia, serif; }

    .game-bg {
      background: linear-gradient(175deg, #0f0a1a 0%, #1a1030 20%, #2d1b4e 40%, #3d2766 55%, #1a1030 85%, #0f0a1a 100%);
      min-height: 100vh;
      position: relative;
    }

    .game-bg::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(1.5px 1.5px at 12% 8%, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 25% 18%, rgba(200,180,255,0.6), transparent),
        radial-gradient(1.5px 1.5px at 55% 5%, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 72% 22%, rgba(200,180,255,0.5), transparent),
        radial-gradient(2px 2px at 88% 12%, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 35% 30%, rgba(255,255,255,0.4), transparent),
        radial-gradient(1.5px 1.5px at 65% 15%, rgba(200,180,255,0.5), transparent),
        radial-gradient(1px 1px at 8% 25%, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 45% 10%, rgba(255,220,255,0.6), transparent),
        radial-gradient(1.5px 1.5px at 92% 28%, rgba(200,180,255,0.4), transparent);
      pointer-events: none;
      z-index: 0;
      animation: twinkle 5s ease-in-out infinite alternate;
    }

    @keyframes twinkle {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
      50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .fade-in-up { animation: fadeInUp 0.6s ease both; }
    .fade-in { animation: fadeIn 0.5s ease both; }

    .mountain-silhouette {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 200px;
      z-index: 0;
      pointer-events: none;
    }

    .glow-line {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139,92,246,0.4), transparent);
      margin: 1.5rem 0;
    }

    .choice-btn {
      background: rgba(30, 20, 50, 0.7);
      border: 1px solid rgba(139, 92, 246, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    .choice-btn:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.6);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      transform: translateY(-2px);
    }
    .choice-btn:active { transform: translateY(0); }

    .speaking-wave {
      display: inline-flex;
      gap: 2px;
      align-items: center;
      height: 16px;
    }
    .speaking-wave span {
      display: block;
      width: 3px;
      background: #a78bfa;
      border-radius: 2px;
      animation: wave 0.8s ease-in-out infinite;
    }
    .speaking-wave span:nth-child(2) { animation-delay: 0.1s; }
    .speaking-wave span:nth-child(3) { animation-delay: 0.2s; }
    .speaking-wave span:nth-child(4) { animation-delay: 0.3s; }

    @keyframes wave {
      0%, 100% { height: 4px; }
      50% { height: 14px; }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.3); border-radius: 3px; }

    .magic-input:focus {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ============================================================
// API TENGINGAR ‚Äì M√°lst√∂√∞in
// ============================================================

async function callOpenAI(messages, max_tokens = 600, model = 'gpt-4o-mini', temperature = 0.5) {
  const r = await fetch('/.netlify/functions/openai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages, max_tokens, model, temperature })
  });
  const data = await r.json();
  if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
  return data.content;
}

async function playAudio(text, onEnd) {
  try {
    const r = await fetch('/.netlify/functions/speak', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text_to_speak: text })
    });
    const data = await r.json();
    if (!r.ok || data.error || !data.audio_base64) { onEnd && onEnd(); return null; }
    const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
    audio.onended = () => onEnd && onEnd();
    audio.onerror = () => onEnd && onEnd();
    await audio.play().catch(() => onEnd && onEnd());
    return audio;
  } catch (e) {
    console.error('TTS villa:', e);
    onEnd && onEnd();
    return null;
  }
}

// ============================================================
// SYSTEM PROMPT ‚Äì S√∂guma√∞urinn
// ============================================================

const SYSTEM_PROMPT = `HLUTVERK: √û√∫ ert s√∂guma√∞ur √≠ √≠slenskum fantas√≠uleik fyrir nemendur sem eru a√∞ l√¶ra √≠slensku √° A1-A2 stigi. √û√∫ skrifar allt √° √≠slensku.

M√ÅLFAR ‚Äì MIKILV√ÜGAST:
√çslenska √æ√≠n ver√∞ur a√∞ vera m√°lfr√¶√∞ilega fullkomin. √ûetta er kennsluefni og nemendur l√¶ra af √æv√≠ sem √æeir sj√°.
- Kynbeyging l√Ωsingaror√∞a: br√∫ (kvenkyns) ‚Üí g√∂mul br√∫, √ær√∂ng br√∫. √ûoka (kvenkyns) ‚Üí √æykk √æoka. Loft (hvorugkyn) ‚Üí kalt loft. Dalur (karlkyns) ‚Üí dj√∫pur dalur.
- Fallbeyging: nefnifall, √æolfall, √æ√°gufall, eignarfall ‚Äì alltaf r√©tt.
- Pers√≥nuforn√∂fn √≠ r√©ttu falli: "m√©r l√≠√∞ur vel", "m√©r er kalt", "hj√°lpa√∞u m√©r".
- Sagnbeyging: "hva√∞ gerir √æ√∫" ekki "hva√∞ gerir √æ√©r".
- Lestu yfir texta √æinn √°√∞ur en √æ√∫ skilar honum og lei√∞r√©ttu allar villur.

TUNGUM√ÅLASTIG: Stuttar einfaldar setningar. Algengur or√∞afor√∞i sem hentar A1-A2. Engar fl√≥knar m√°lsgreinar.

S√ñGU√ûR√Å√êUR: √û√∫ manst hva√∞ ger√∞ist √° fyrri hn√∫tum. √Åkvar√∞anir leikmannsins hafa raunveruleg √°hrif √° framvinduna. √û√∫ gefur alltaf n√°kv√¶mlega 2-3 valkosti √° hverjum hn√∫t, n√∫mera√∞a A, B, C.

PERS√ìNUR:
- Ormur: gamall ma√∞ur me√∞ langt hv√≠tt skegg og br√∫na skikkju. Vitur og vinalegur. Birtist √° br√∫nni (hn√∫tur 1) og kemur aftur √≠ lok s√∂gunnar.
- Drifa: drottning fjallsins. H√∫n ger√∞i himininn fj√≥lubl√°an. B√Ωr √≠ turninum. Ekki endilega vond ‚Äì leikma√∞urinn getur tala√∞ vi√∞ hana.
- S√≠mon: l√≠till str√°kur me√∞ rau√∞an hatt. Birtist √° lei√∞inni upp √° fjalli√∞. Gla√∞ur og hj√°lpsamur.
- Lykillinn: opnar himininn aftur. Hann er √≠ turninum.

S√ñGUUPPBYGGING (7 hn√∫tar):
1. Br√∫in ‚Äì leikma√∞ur vaknar, hittir Orm, kynnir sig
2. Velja lei√∞ ‚Äì sk√≥gur e√∞a fjallsvegur
3. Hittir S√≠mon e√∞a √°skorun √° lei√∞inni
4. Kominn n√¶r turninum ‚Äì √°skorun e√∞a r√°√∞g√°ta
5. √ç turninum ‚Äì hittir Drifu
6. √Åkvar√∞anin ‚Äì hva√∞ gerir leikma√∞ur vi√∞ lykilinn og Drifu?
7. Ending ‚Äì mismunandi eftir valkostum. Ormur kemur aftur.

SVARA ALLTAF √Å √ûESSU JSON FORMI OG ENGU √ñ√êRU:
{
  "hn√∫tur": [n√∫mer 1-7],
  "saga": "[Stutt l√Ωsing, 2-4 setningar]",
  "pers√≥na": "[Hva√∞ pers√≥na segir ‚Äì e√∞a null ef engin talar]",
  "pers√≥na_nafn": "[Nafn √æess sem talar ‚Äì e√∞a null]",
  "valkostir": ["A) ...", "B) ...", "C) ..."],
  "frj√°lst_svar": [true ef leikma√∞ur √° a√∞ skrifa eigi√∞ svar, annars false],
  "ending": [true ef hn√∫tur 7, annars false]
}

√ûEGAR LEIKMA√êUR SKRIFAR EIGI√ê SVAR: Bregstu vi√∞ √æv√≠ n√°tt√∫rulega √≠ s√∂gunni og haltu √°fram √° n√¶sta hn√∫t.
MIKILV√ÜGT: Svara√∞u A√êEINS me√∞ JSON. Ekkert anna√∞ utan JSON.`;

// ============================================================
// √çHLUTIR
// ============================================================

const MountainSilhouette = () => (
  <svg className="mountain-silhouette" viewBox="0 0 1440 200" preserveAspectRatio="none" fill="none">
    <path d="M0,200 L0,140 L120,90 L240,120 L360,60 L480,100 L560,40 L640,80 L720,20 L800,70 L880,30 L960,90 L1040,50 L1120,80 L1200,45 L1320,100 L1440,60 L1440,200 Z"
      fill="url(#mGrad)" />
    <rect x="710" y="5" width="8" height="18" fill="#1a1030" opacity="0.8" />
    <rect x="706" y="3" width="16" height="4" fill="#1a1030" opacity="0.8" />
    <defs>
      <linearGradient id="mGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stopColor="#1a1030" />
        <stop offset="100%" stopColor="#0f0a1a" />
      </linearGradient>
    </defs>
  </svg>
);

const SpeakingWave = () => (
  <span className="speaking-wave">
    <span></span><span></span><span></span><span></span>
  </span>
);

const ListenBtn = ({ text, label }) => {
  const [speaking, setSpeaking] = useState(false);
  const audioRef = useRef(null);

  const handlePlay = async () => {
    if (speaking && audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
      setSpeaking(false);
      return;
    }
    setSpeaking(true);
    audioRef.current = await playAudio(text, () => setSpeaking(false));
  };

  return (
    <button onClick={handlePlay}
      className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-sm border transition-all
        ${speaking
          ? 'bg-purple-500/20 text-purple-300 border-purple-400/40'
          : 'bg-white/5 text-gray-400 border-white/10 hover:bg-white/10 hover:text-purple-300'}`}>
      {speaking ? <SpeakingWave /> : <span className="text-sm">üîä</span>}
      <span className="font-light">{label || 'Hlusta√∞u'}</span>
    </button>
  );
};

const ProgressNodes = ({ current, total }) => (
  <div className="flex items-center gap-1 justify-center">
    {Array.from({ length: total }).map((_, i) => (
      <React.Fragment key={i}>
        <div className={`w-3 h-3 rounded-full transition-all duration-500 ${
          i < current ? 'bg-purple-400 shadow-sm shadow-purple-400/50'
            : i === current ? 'bg-purple-500 ring-2 ring-purple-400/50 ring-offset-1 ring-offset-transparent'
            : 'bg-white/10'
        }`} />
        {i < total - 1 && (
          <div className={`w-5 h-0.5 transition-all duration-500 ${
            i < current ? 'bg-purple-400/40' : 'bg-white/5'
          }`} />
        )}
      </React.Fragment>
    ))}
  </div>
);

// Character emoji
const charEmoji = (name) => {
  if (!name) return 'üí¨';
  const n = name.toLowerCase();
  if (n.includes('ormur')) return 'üßô';
  if (n.includes('s√≠mon')) return 'üßí';
  if (n.includes('drifa')) return 'üëë';
  return 'üí¨';
};

// ============================================================
// A√êALFORRIT
// ============================================================

function App() {
  const [gameState, setGameState] = useState('intro');
  const [storyNodes, setStoryNodes] = useState([]);
  const [messages, setMessages] = useState([{ role: 'system', content: SYSTEM_PROMPT }]);
  const [freeText, setFreeText] = useState('');
  const [error, setError] = useState(null);
  const [autoPlayed, setAutoPlayed] = useState(new Set());
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) {
      setTimeout(() => scrollRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' }), 200);
    }
  }, [storyNodes, gameState]);

  const parseResponse = (text) => {
    try {
      let cleaned = text.trim();
      if (cleaned.startsWith('```')) {
        cleaned = cleaned.replace(/^```json?\n?/, '').replace(/\n?```$/, '');
      }
      return JSON.parse(cleaned);
    } catch (e) {
      console.error('JSON parse villa:', e, 'Svar:', text);
      return null;
    }
  };

  // Auto-play TTS when character speaks
  const autoPlayDialogue = useCallback(async (node, nodeIndex) => {
    if (node.pers√≥na && node.pers√≥na_nafn && !autoPlayed.has(nodeIndex)) {
      setAutoPlayed(prev => new Set(prev).add(nodeIndex));
      await new Promise(r => setTimeout(r, 1000));
      await playAudio(node.pers√≥na, () => {});
    }
  }, [autoPlayed]);

  const sendToAI = async (userContent) => {
    setGameState('loading');
    setError(null);

    const userMsg = { role: 'user', content: userContent };
    const newMessages = [...messages, userMsg];

    try {
      const response = await callOpenAI(newMessages, 600, 'gpt-4o-mini', 0.5);
      const node = parseResponse(response);

      if (!node) {
        setError('S√∂guma√∞urinn sveita√∞ist... Reyndu aftur.');
        setGameState(storyNodes.length > 0 ? 'playing' : 'intro');
        return;
      }

      const assistantMsg = { role: 'assistant', content: response };
      setMessages([...newMessages, assistantMsg]);

      const newNodes = [...storyNodes, node];
      setStoryNodes(newNodes);
      setGameState(node.ending ? 'ended' : 'playing');
      setFreeText('');

      autoPlayDialogue(node, newNodes.length - 1);
    } catch (e) {
      console.error(e);
      setError('Villa √≠ tengingu. Reyndu aftur.');
      setGameState(storyNodes.length > 0 ? 'playing' : 'intro');
    }
  };

  const startGame = () => {
    sendToAI('Byrja√∞u leikinn. Hn√∫tur 1: Leikma√∞urinn vaknar √° gamalli steinbr√∫. Himinninn er fj√≥lubl√°r en √æa√∞ er dagur. Ormur gamli stendur √æar og spyr hva√∞ leikma√∞urinn heitir. Leikma√∞urinn √° a√∞ skrifa eigi√∞ svar (nafni√∞ sitt).');
  };

  const makeChoice = (choiceText) => {
    sendToAI(`Leikma√∞urinn velur: ${choiceText}`);
  };

  const handleFreeSubmit = (e) => {
    e.preventDefault();
    if (freeText.trim()) {
      sendToAI(freeText.trim());
    }
  };

  const resetGame = () => {
    setGameState('intro');
    setStoryNodes([]);
    setMessages([{ role: 'system', content: SYSTEM_PROMPT }]);
    setAutoPlayed(new Set());
    setError(null);
    setFreeText('');
  };

  // ===== INTRO =====
  if (gameState === 'intro') {
    return (
      <div className="game-bg flex items-center justify-center px-4">
        <MountainSilhouette />
        <div className="relative z-10 text-center max-w-lg fade-in-up">
          <div className="mb-8">
            <div className="text-6xl mb-4">üèîÔ∏è</div>
            <h1 className="story-font text-4xl md:text-5xl font-light text-white mb-3 tracking-wide">
              Fj√≥lubl√°i himinninn
            </h1>
            <p className="text-purple-300/70 font-light text-sm tracking-widest uppercase">
              Fantas√≠uleikur ‚Äì M√°lst√∂√∞in
            </p>
          </div>

          <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 mb-8">
            <p className="story-font text-xl text-purple-100/90 font-light leading-relaxed mb-4">
              √û√∫ vaknar √° gamalli br√∫. Himinninn er fj√≥lubl√°r.
              Gamall ma√∞ur stendur fyrir framan √æig...
            </p>
            <p className="text-purple-300/50 text-sm font-light">
              √çslensku√¶fing √° A1‚ÄìA2 stigi ¬∑ 7 kaflar ¬∑ √û√∫ velur s√∂guna
            </p>
          </div>

          <button onClick={startGame}
            className="px-10 py-4 bg-purple-600 hover:bg-purple-500 text-white rounded-xl
              font-light text-lg transition-all hover:shadow-lg hover:shadow-purple-500/30
              hover:-translate-y-0.5 active:translate-y-0"
            style={{ animation: 'pulseGlow 3s ease-in-out infinite' }}>
            Byrja leikinn ‚ú®
          </button>

          {error && <p className="mt-4 text-red-400 text-sm font-light">{error}</p>}
        </div>
      </div>
    );
  }

  // ===== LOADING (first node) =====
  if (gameState === 'loading' && storyNodes.length === 0) {
    return (
      <div className="game-bg flex items-center justify-center px-4">
        <MountainSilhouette />
        <div className="relative z-10 text-center fade-in">
          <div className="flex gap-2 justify-center mb-4">
            {[0,1,2].map(i => (
              <div key={i} className="w-3 h-3 rounded-full bg-purple-400"
                style={{ animation: 'breathe 1.2s ease-in-out infinite', animationDelay: `${i * 0.2}s` }} />
            ))}
          </div>
          <p className="story-font text-xl text-purple-200/70 font-light italic">
            S√∂guma√∞urinn opnar b√≥kina...
          </p>
        </div>
      </div>
    );
  }

  // ===== GAME SCREEN =====
  return (
    <div className="game-bg">
      <MountainSilhouette />

      {/* Header */}
      <header className="sticky top-0 z-20 border-b border-white/10 bg-black/40 backdrop-blur-md">
        <div className="max-w-2xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between mb-2.5">
            <div className="flex items-center gap-2.5">
              <span className="text-lg">üèîÔ∏è</span>
              <div>
                <h1 className="story-font text-base text-white font-light leading-tight">Fj√≥lubl√°i himinninn</h1>
                <p className="text-purple-400/50 text-xs font-light">Fantas√≠uleikur</p>
              </div>
            </div>
            <div className="text-purple-300/50 text-xs font-light">
              Kafli {storyNodes.length} / 7
            </div>
          </div>
          <ProgressNodes current={storyNodes.length} total={7} />
        </div>
      </header>

      {/* Story */}
      <main className="relative z-10 max-w-2xl mx-auto px-4 py-6 pb-40">
        {storyNodes.map((node, idx) => {
          const isLast = idx === storyNodes.length - 1;
          return (
            <div key={idx} className={`mb-8 ${isLast ? 'fade-in-up' : ''}`}>

              {/* Hn√∫tur badge */}
              <div className="flex items-center gap-2 mb-3">
                <span className="w-6 h-6 rounded-full bg-purple-500/30 text-purple-300 text-xs
                  flex items-center justify-center font-medium border border-purple-400/30">
                  {node.hn√∫tur || idx + 1}
                </span>
                <div className="flex-1 h-px bg-purple-400/10"></div>
              </div>

              {/* Saga texti */}
              <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-5 border border-white/10 mb-3">
                <p className="story-font text-lg text-purple-50/90 font-light leading-relaxed whitespace-pre-line">
                  {node.saga}
                </p>

                {/* Pers√≥na talar */}
                {node.pers√≥na && (
                  <div className="mt-4 pl-4 border-l-2 border-purple-400/40">
                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                      <span className="text-base">{charEmoji(node.pers√≥na_nafn)}</span>
                      <span className="text-purple-300 text-sm font-medium story-font">
                        {node.pers√≥na_nafn || 'Pers√≥na'}
                      </span>
                      <ListenBtn text={node.pers√≥na} label="Hlusta√∞u" />
                    </div>
                    <p className="story-font text-lg text-purple-100 font-light italic leading-relaxed">
                      ‚Äû{node.pers√≥na}"
                    </p>
                  </div>
                )}
              </div>

              {/* Hlusta √° s√∂guna */}
              <div className="flex justify-end mb-3">
                <ListenBtn text={node.saga + (node.pers√≥na ? ' ' + node.pers√≥na : '')} label="Hlusta√∞u √° kafla" />
              </div>

              {/* Valkostir ‚Äì a√∞eins √° s√≠√∞asta hn√∫t og ef ekki ending */}
              {isLast && !node.ending && gameState === 'playing' && (
                <div className="space-y-3 fade-in" style={{ animationDelay: '0.4s' }}>
                  {node.valkostir && node.valkostir.map((choice, ci) => (
                    <button key={ci}
                      onClick={() => makeChoice(choice)}
                      className="choice-btn w-full text-left px-5 py-4 rounded-xl text-purple-100/90
                        font-light story-font text-base leading-relaxed">
                      {choice}
                    </button>
                  ))}

                  {node.frj√°lst_svar && (
                    <form onSubmit={handleFreeSubmit} className="mt-3">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={freeText}
                          onChange={(e) => setFreeText(e.target.value)}
                          placeholder="Skrifa√∞u svari√∞ √æitt..."
                          className="magic-input flex-1 px-4 py-3 bg-white/5 border border-white/15
                            rounded-xl text-purple-100 placeholder-purple-300/30 font-light
                            focus:outline-none focus:border-purple-400/50 transition-all"
                          autoFocus
                        />
                        <button type="submit"
                          disabled={!freeText.trim()}
                          className="px-5 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl
                            font-light transition-all disabled:bg-white/5 disabled:text-white/20
                            disabled:cursor-not-allowed">
                          Senda
                        </button>
                      </div>
                    </form>
                  )}
                </div>
              )}

              {/* Divider */}
              {!isLast && <div className="glow-line"></div>}
            </div>
          );
        })}

        {/* Loading */}
        {gameState === 'loading' && storyNodes.length > 0 && (
          <div className="flex items-center justify-center gap-3 py-12 fade-in">
            <div className="flex gap-1.5">
              {[0,1,2].map(i => (
                <div key={i} className="w-2.5 h-2.5 rounded-full bg-purple-400"
                  style={{ animation: 'breathe 1.2s ease-in-out infinite', animationDelay: `${i * 0.2}s` }} />
              ))}
            </div>
            <span className="text-purple-300/50 text-sm font-light story-font italic">
              S√∂guma√∞urinn hugsar...
            </span>
          </div>
        )}

        {/* Ending */}
        {gameState === 'ended' && (
          <div className="text-center py-8 fade-in-up" style={{ animationDelay: '0.3s' }}>
            <div className="glow-line mb-6"></div>
            <div className="text-4xl mb-4">‚ú®</div>
            <h2 className="story-font text-2xl text-white font-light mb-2">
              S√∂gunni er loki√∞
            </h2>
            <p className="text-purple-300/60 font-light text-sm mb-6">
              Vel gert! √û√∫ kl√°ra√∞ir fantas√≠uleikinn.
            </p>
            <div className="flex gap-3 justify-center flex-wrap">
              <button onClick={resetGame}
                className="px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl
                  font-light transition-all hover:shadow-lg hover:shadow-purple-500/30">
                Spila aftur üîÑ
              </button>
              <button onClick={() => window.history.back()}
                className="px-8 py-3 border border-white/15 text-purple-200/70 rounded-xl
                  font-light hover:bg-white/5 transition-all">
                ‚Üê Til baka
              </button>
            </div>
          </div>
        )}

        {/* Error */}
        {error && (
          <div className="bg-red-500/10 border border-red-400/30 rounded-xl p-4 mt-4 fade-in">
            <p className="text-red-300 text-sm font-light">{error}</p>
            <button onClick={() => setError(null)}
              className="text-red-400/60 text-xs mt-2 hover:text-red-300 transition-colors">
              Loka ‚úï
            </button>
          </div>
        )}

        <div ref={scrollRef}></div>
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

</body>
</html>
