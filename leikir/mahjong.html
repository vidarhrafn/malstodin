<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mahjong Lj√≥√∞aleikur</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Source+Sans+3:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }
        .poem-font {
            font-family: 'Cormorant Garamond', Georgia, serif;
        }
        
        /* Mahjong fl√≠sar */
        .mahjong-tile {
            width: 52px;
            height: 68px;
            background: linear-gradient(145deg, #fefefe 0%, #e8e4dc 100%);
            border-radius: 6px;
            box-shadow: 
                0 4px 0 #b8b4a8,
                0 6px 8px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: absolute;
            user-select: none;
            font-size: 11px;
            font-weight: 500;
            color: #2d3748;
            text-align: center;
            padding: 4px;
            line-height: 1.2;
            word-break: break-word;
        }
        .mahjong-tile:hover:not(.blocked):not(.matched) {
            transform: translateY(-4px);
            box-shadow: 
                0 8px 0 #b8b4a8,
                0 12px 16px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .mahjong-tile.selected {
            background: linear-gradient(145deg, #ffd700 0%, #ffb347 100%);
            box-shadow: 
                0 4px 0 #c9a227,
                0 6px 12px rgba(255,215,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .mahjong-tile.blocked {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .mahjong-tile.matched {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .mahjong-tile.hint {
            animation: hint-pulse 0.8s ease-in-out infinite;
        }
        @keyframes hint-pulse {
            0%, 100% { box-shadow: 0 4px 0 #b8b4a8, 0 6px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.8); }
            50% { box-shadow: 0 4px 0 #b8b4a8, 0 6px 20px rgba(100,200,255,0.8), inset 0 1px 0 rgba(255,255,255,0.8); }
        }
        
        /* Flj√∫gandi or√∞ animation */
        .flying-word {
            position: fixed;
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 24px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.8);
            pointer-events: none;
            z-index: 1000;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Lj√≥√∞asv√¶√∞i */
        .poem-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            padding: 32px;
            min-height: 200px;
        }
        .poem-word {
            display: inline;
            transition: all 0.5s ease;
        }
        .poem-word.hidden {
            color: rgba(255,255,255,0.15);
        }
        .poem-word.revealed {
            color: #f0e6d3;
            text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        .poem-word.just-revealed {
            animation: word-glow 1s ease-out;
        }
        @keyframes word-glow {
            0% { color: #ffd700; text-shadow: 0 0 30px rgba(255,215,0,1); transform: scale(1.2); }
            100% { color: #f0e6d3; text-shadow: 0 0 10px rgba(255,215,0,0.3); transform: scale(1); }
        }
        
        /* Sigurst√≠ll */
        .victory-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fade-in 0.5s ease;
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .victory-content {
            text-align: center;
            color: #f0e6d3;
            max-width: 600px;
            padding: 40px;
            animation: scale-in 0.5s ease;
        }
        @keyframes scale-in {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Stj√∂rnur bakgrunnur */
        .stars {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Spilahnappur */
        .play-button {
            background: linear-gradient(145deg, #4a9079 0%, #2d6a5a 100%);
            border: none;
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        .play-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Lj√≥√∞i√∞
        const POEM = {
            title: "Tv√¶r stj√∂rnur",
            author: "Megas",
            verses: [
                "T√≠minn l√≠√∞ur √°fram og hann teymir mig √° eftir s√©r og ekki f√¶ √©g miklu r√°√∞i√∞ um √æa√∞ hvert hann fer.",
                "En √©g vona bara hann hugsi soldi√∞ hl√Ωlega til m√≠n og lei√∞i mig √° endanum aftur til √æ√≠n.",
                "√âg gaf √æ√©r for√∞um ke√∞ju √∫r gulli um h√°lsinn √æinn, svo gleymdir √æ√∫ m√©r ekki √≠ dagsins amstri nokkurt sinn.",
                "√ç augunum √æ√≠num sv√∂rtu horfi √©g √° sj√°lfan mig um hr√≠√∞ og √©g vona√∞i a√∞ √©g fengi bara a√∞ vera √æa√∞ alla t√≠√∞."
            ]
        };

        // Finna √∂ll einst√∂k or√∞
        const getAllUniqueWords = () => {
            const fullText = POEM.verses.join(' ');
            const words = fullText.split(/\s+/).filter(w => w.length > 0);
            const seen = new Set();
            const uniqueWords = [];
            
            words.forEach(word => {
                const normalized = word.toLowerCase();
                if (!seen.has(normalized)) {
                    seen.add(normalized);
                    uniqueWords.push(word);
                }
            });
            
            return uniqueWords;
        };

        // B√∫a til Mahjong skipulag (turtle/pyramid)
        const createTileLayout = (words) => {
            const tiles = [];
            const pairs = [...words, ...words]; // Tv√∂falda fyrir p√∂r
            
            // Stokka
            for (let i = pairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
            }
            
            // Pyramid skipulag - 4 l√∂g
            const layouts = [
                // Lag 0 (ne√∞st) - 8x6 = 48 fl√≠sar
                { cols: 8, rows: 6, offsetX: 0, offsetY: 0, z: 0 },
                // Lag 1 - 6x4 = 24 fl√≠sar
                { cols: 6, rows: 4, offsetX: 1, offsetY: 1, z: 1 },
                // Lag 2 - 4x2 = 8 fl√≠sar
                { cols: 4, rows: 2, offsetX: 2, offsetY: 2, z: 2 },
                // Lag 3 (efst) - 2x1 = 2 fl√≠sar
                { cols: 2, rows: 1, offsetX: 3, offsetY: 2.5, z: 3 },
            ];
            
            let pairIndex = 0;
            const tileWidth = 56;
            const tileHeight = 72;
            const layerOffset = 4;
            
            layouts.forEach(layer => {
                for (let row = 0; row < layer.rows && pairIndex < pairs.length; row++) {
                    for (let col = 0; col < layer.cols && pairIndex < pairs.length; col++) {
                        tiles.push({
                            id: pairIndex,
                            word: pairs[pairIndex],
                            x: (col + layer.offsetX) * tileWidth - layer.z * layerOffset,
                            y: (row + layer.offsetY) * tileHeight - layer.z * layerOffset,
                            z: layer.z,
                            row: row + layer.offsetY,
                            col: col + layer.offsetX,
                            matched: false
                        });
                        pairIndex++;
                    }
                }
            });
            
            return tiles;
        };

        // Athuga hvort fl√≠s s√© opin (h√¶gt a√∞ velja)
        const isTileOpen = (tile, allTiles) => {
            if (tile.matched) return false;
            
            const activeTiles = allTiles.filter(t => !t.matched);
            
            // Athuga hvort fl√≠s s√© √° sama sta√∞ e√∞a h√¶rra
            const hasBlockingTileAbove = activeTiles.some(t => 
                t.id !== tile.id &&
                t.z > tile.z &&
                Math.abs(t.col - tile.col) < 1 &&
                Math.abs(t.row - tile.row) < 1
            );
            
            if (hasBlockingTileAbove) return false;
            
            // Athuga hvort b√¶√∞i hli√∞ar s√©u loka√∞ar √° sama lagi
            const sameLevelTiles = activeTiles.filter(t => t.z === tile.z && t.id !== tile.id);
            
            const hasLeftNeighbor = sameLevelTiles.some(t => 
                Math.abs(t.row - tile.row) < 0.6 && 
                t.col >= tile.col - 1.1 && 
                t.col < tile.col
            );
            
            const hasRightNeighbor = sameLevelTiles.some(t => 
                Math.abs(t.row - tile.row) < 0.6 && 
                t.col <= tile.col + 1.1 && 
                t.col > tile.col
            );
            
            return !(hasLeftNeighbor && hasRightNeighbor);
        };

        // TTS fall
        const playAudio = async (text, onEnd) => {
            try {
                const r = await fetch('/.netlify/functions/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text_to_speak: text }),
                });
                const data = await r.json();
                
                if (!r.ok || data.error || !data.audio_base64) {
                    console.error("Villa √≠ hlj√≥√∞kalli:", data.error);
                    onEnd && onEnd();
                    return;
                }
                
                const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
                audio.onended = () => onEnd && onEnd();
                audio.onerror = () => onEnd && onEnd();
                audio.play().catch(() => onEnd && onEnd());
            } catch (e) {
                console.error("TTS villa:", e);
                onEnd && onEnd();
            }
        };

        // Stj√∂rnur
        const Stars = () => {
            const stars = Array.from({ length: 50 }, (_, i) => ({
                id: i,
                left: Math.random() * 100,
                top: Math.random() * 100,
                delay: Math.random() * 3,
                size: Math.random() * 2 + 1
            }));
            
            return (
                <div className="stars">
                    {stars.map(star => (
                        <div
                            key={star.id}
                            className="star"
                            style={{
                                left: `${star.left}%`,
                                top: `${star.top}%`,
                                width: star.size,
                                height: star.size,
                                animationDelay: `${star.delay}s`
                            }}
                        />
                    ))}
                </div>
            );
        };

        // Mahjong fl√≠s component
        const MahjongTile = ({ tile, isOpen, isSelected, onClick }) => {
            const tileRef = useRef(null);
            
            return (
                <div
                    ref={tileRef}
                    className={`mahjong-tile ${tile.matched ? 'matched' : ''} ${!isOpen ? 'blocked' : ''} ${isSelected ? 'selected' : ''}`}
                    style={{
                        left: tile.x,
                        top: tile.y,
                        zIndex: tile.z * 100 + tile.row * 10 + tile.col
                    }}
                    onClick={() => isOpen && !tile.matched && onClick(tile, tileRef)}
                    data-word={tile.word}
                >
                    {tile.word}
                </div>
            );
        };

        // Lj√≥√∞al√≠na
        const PoemDisplay = ({ revealedWords }) => {
            const fullText = POEM.verses.join(' ');
            const words = fullText.split(/\s+/);
            
            return (
                <div className="poem-container">
                    <div className="poem-font text-xl leading-relaxed">
                        {words.map((word, idx) => {
                            const normalized = word.toLowerCase();
                            const isRevealed = revealedWords.has(normalized);
                            const justRevealed = revealedWords.get(normalized) === 'just';
                            
                            return (
                                <span key={idx}>
                                    <span 
                                        className={`poem-word ${isRevealed ? 'revealed' : 'hidden'} ${justRevealed ? 'just-revealed' : ''}`}
                                    >
                                        {word}
                                    </span>
                                    {' '}
                                </span>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // Sigurgluggi
        const VictoryScreen = ({ onPlayAgain, onReadPoem, isReading }) => (
            <div className="victory-overlay">
                <div className="victory-content">
                    <h2 className="poem-font text-4xl mb-8 text-amber-300">‚ú® Til hamingju! ‚ú®</h2>
                    
                    <div className="poem-container mb-8">
                        <div className="poem-font text-lg leading-relaxed text-left">
                            {POEM.verses.map((verse, idx) => (
                                <p key={idx} className="mb-4">{verse}</p>
                            ))}
                        </div>
                        <div className="mt-6 pt-4 border-t border-white/20">
                            <p className="poem-font text-xl italic text-amber-200">‚Äû{POEM.title}"</p>
                            <p className="poem-font text-lg text-white/70">‚Äî {POEM.author}</p>
                        </div>
                    </div>
                    
                    <div className="flex gap-4 justify-center">
                        <button 
                            onClick={onReadPoem}
                            disabled={isReading}
                            className="play-button"
                        >
                            {isReading ? 'üîä Les...' : 'üîä Hlusta √° lj√≥√∞i√∞'}
                        </button>
                        <button 
                            onClick={onPlayAgain}
                            className="play-button"
                        >
                            üîÑ Spila aftur
                        </button>
                    </div>
                </div>
            </div>
        );

        // Flj√∫gandi or√∞ animation
        const FlyingWord = ({ word, startPos, endPos, onComplete }) => {
            const [style, setStyle] = useState({
                left: startPos.x,
                top: startPos.y,
                opacity: 1,
                transform: 'scale(1)'
            });
            
            useEffect(() => {
                requestAnimationFrame(() => {
                    setStyle({
                        left: endPos.x,
                        top: endPos.y,
                        opacity: 0,
                        transform: 'scale(0.5)'
                    });
                });
                
                const timer = setTimeout(onComplete, 800);
                return () => clearTimeout(timer);
            }, []);
            
            return (
                <div className="flying-word" style={style}>
                    {word}
                </div>
            );
        };

        // A√∞al component
        const MahjongGame = () => {
            const [tiles, setTiles] = useState([]);
            const [selectedTile, setSelectedTile] = useState(null);
            const [selectedRef, setSelectedRef] = useState(null);
            const [revealedWords, setRevealedWords] = useState(new Map());
            const [flyingWords, setFlyingWords] = useState([]);
            const [gameWon, setGameWon] = useState(false);
            const [isReading, setIsReading] = useState(false);
            const [matchCount, setMatchCount] = useState(0);
            const poemContainerRef = useRef(null);
            
            const uniqueWords = getAllUniqueWords();
            const totalPairs = uniqueWords.length;

            // Byrja leik
            useEffect(() => {
                startNewGame();
            }, []);

            const startNewGame = () => {
                const words = getAllUniqueWords();
                const newTiles = createTileLayout(words);
                setTiles(newTiles);
                setSelectedTile(null);
                setSelectedRef(null);
                setRevealedWords(new Map());
                setFlyingWords([]);
                setGameWon(false);
                setMatchCount(0);
            };

            // Hreinsa "just-revealed" st√∂√∞u
            useEffect(() => {
                const justRevealedWords = [...revealedWords.entries()].filter(([_, v]) => v === 'just');
                if (justRevealedWords.length > 0) {
                    const timer = setTimeout(() => {
                        setRevealedWords(prev => {
                            const next = new Map(prev);
                            justRevealedWords.forEach(([word]) => next.set(word, true));
                            return next;
                        });
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [revealedWords]);

            // Athuga sigurst√∂√∞u
            useEffect(() => {
                if (matchCount > 0 && matchCount === totalPairs) {
                    setTimeout(() => setGameWon(true), 500);
                }
            }, [matchCount, totalPairs]);

            const handleTileClick = (tile, tileRef) => {
                if (selectedTile && selectedTile.id === tile.id) {
                    setSelectedTile(null);
                    setSelectedRef(null);
                    return;
                }

                if (!selectedTile) {
                    setSelectedTile(tile);
                    setSelectedRef(tileRef);
                    return;
                }

                // Athuga hvort or√∞ passa
                if (selectedTile.word.toLowerCase() === tile.word.toLowerCase()) {
                    // Match fundinn!
                    const word = tile.word;
                    
                    // Finna sta√∞setningu √≠ lj√≥√∞asv√¶√∞i
                    const poemRect = poemContainerRef.current?.getBoundingClientRect();
                    const tile1Rect = selectedRef?.current?.getBoundingClientRect();
                    const tile2Rect = tileRef?.current?.getBoundingClientRect();
                    
                    const endPos = poemRect ? {
                        x: poemRect.left + poemRect.width / 2,
                        y: poemRect.top + poemRect.height / 2
                    } : { x: window.innerWidth / 2, y: 100 };

                    // B√¶ta vi√∞ flj√∫gandi or√∞um
                    if (tile1Rect) {
                        setFlyingWords(prev => [...prev, {
                            id: `${tile.id}-1`,
                            word,
                            startPos: { x: tile1Rect.left, y: tile1Rect.top },
                            endPos
                        }]);
                    }
                    if (tile2Rect) {
                        setFlyingWords(prev => [...prev, {
                            id: `${tile.id}-2`,
                            word,
                            startPos: { x: tile2Rect.left, y: tile2Rect.top },
                            endPos
                        }]);
                    }

                    // Uppf√¶ra tiles
                    setTiles(prev => prev.map(t => 
                        (t.id === selectedTile.id || t.id === tile.id) 
                            ? { ...t, matched: true } 
                            : t
                    ));

                    // Uppf√¶ra revealed words
                    setRevealedWords(prev => {
                        const next = new Map(prev);
                        next.set(word.toLowerCase(), 'just');
                        return next;
                    });

                    setMatchCount(prev => prev + 1);
                }

                setSelectedTile(null);
                setSelectedRef(null);
            };

            const removeFlyingWord = (id) => {
                setFlyingWords(prev => prev.filter(fw => fw.id !== id));
            };

            const handleReadPoem = () => {
                setIsReading(true);
                const fullText = POEM.verses.join(' ');
                playAudio(fullText, () => setIsReading(false));
            };

            // Reikna leiksv√¶√∞i st√¶r√∞
            const gameAreaWidth = 8 * 56 + 100;
            const gameAreaHeight = 6 * 72 + 100;

            return (
                <div className="min-h-screen pb-12 relative">
                    <Stars />
                    
                    <header className="bg-white/5 backdrop-blur-sm border-b border-white/10 relative z-10">
                        <div className="max-w-6xl mx-auto px-6 py-6">
                            <button 
                                onClick={() => window.history.back()} 
                                className="text-sm text-white/50 hover:text-white/80 mb-2 inline-block font-light transition-colors"
                            >
                                ‚Üê Til baka
                            </button>
                            <h1 className="text-3xl font-light text-white/90 mb-1 poem-font">Mahjong Lj√≥√∞aleikur</h1>
                            <p className="text-white/50 text-sm font-light">Finndu p√∂rin og lj√≥√∞i√∞ birtist</p>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-6 mt-8 relative z-10">
                        {/* Lj√≥√∞asv√¶√∞i */}
                        <div ref={poemContainerRef} className="mb-8">
                            <PoemDisplay revealedWords={revealedWords} />
                            <div className="mt-4 text-center text-white/50 text-sm">
                                P√∂r fundin: {matchCount} / {totalPairs}
                            </div>
                        </div>

                        {/* Leiksv√¶√∞i */}
                        <div className="flex justify-center">
                            <div 
                                className="relative"
                                style={{ 
                                    width: gameAreaWidth, 
                                    height: gameAreaHeight
                                }}
                            >
                                {tiles.map(tile => (
                                    <MahjongTile
                                        key={tile.id}
                                        tile={tile}
                                        isOpen={isTileOpen(tile, tiles)}
                                        isSelected={selectedTile?.id === tile.id}
                                        onClick={handleTileClick}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* N√Ωr leikur hnappur */}
                        <div className="mt-8 text-center">
                            <button onClick={startNewGame} className="play-button">
                                üîÑ N√Ωr leikur
                            </button>
                        </div>
                    </main>

                    {/* Flj√∫gandi or√∞ */}
                    {flyingWords.map(fw => (
                        <FlyingWord
                            key={fw.id}
                            word={fw.word}
                            startPos={fw.startPos}
                            endPos={fw.endPos}
                            onComplete={() => removeFlyingWord(fw.id)}
                        />
                    ))}

                    {/* Sigurskj√°r */}
                    {gameWon && (
                        <VictoryScreen 
                            onPlayAgain={startNewGame}
                            onReadPoem={handleReadPoem}
                            isReading={isReading}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<MahjongGame />);
    </script>
</body>
</html>
