<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>游꿉 N치msr치칧gj칬f</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(to bottom, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            margin: 0;
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        .playing {
            animation: playPulse 0.6s ease-in-out infinite;
        }
        @keyframes playPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===== ICONS =====
        const SendIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const MicIcon = ({ isRecording }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                fill={isRecording ? "currentColor" : "none"}
                stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                className={`w-8 h-8 ${isRecording ? 'recording text-red-500' : ''}`}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const SpeakerIcon = ({ isPlaying }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                className={`w-8 h-8 ${isPlaying ? 'playing text-blue-600' : 'text-blue-500'}`}>
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
            </svg>
        );

        const HelpIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-6 h-6">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const CopyIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-6 h-6">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-6 h-6">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        // ===== API FUNCTIONS =====
        async function callOpenAI(messages, max_tokens = 500, model = 'gpt-4o-mini', temperature = 0.4) {
            const r = await fetch('/.netlify/functions/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model, messages, max_tokens, temperature }),
            });
            const data = await r.json();
            if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
            return data.content;
        }

        async function fetchAudio(text) {
            const r = await fetch('/.netlify/functions/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_to_speak: text }),
            });
            const data = await r.json();
            if (!r.ok || data.error || !data.audio_base64) throw new Error(data.error || 'Audio error');
            return `data:audio/mp3;base64,${data.audio_base64}`;
        }

        // ===== SYSTEM PROMPTS =====
        const ADVISOR_SYSTEM_PROMPT = `
뤢 ert vingjarnlegur n치msr치칧gjafi 칤 framhaldssk칩la 치 칈slandi. 뤢 talar vi칧 nemendur sem eru a칧 l칝ra 칤slensku 치 A1-A2 stigi. 뤢 heitir Krist칤n.

## TUNGUM츼L
- Tala칧u EINUNGIS 칤slensku
- Nota칧u stuttar og einfaldar setningar
- Vertu hl칳 og hvetjandi
- Lei칧r칠ttu 칩beint me칧 쭀칤 a칧 endurtaka r칠tt (t.d. ef nemandi segir "m칠r finnst gaman t칩nlist" svara칧u "Fr치b칝rt, 쮂r finnst gaman a칧 hlusta 치 t칩nlist!")

## EF NEMANDI TALAR ANNA칋 TUNGUM츼L
Svara칧u: "Afsaka칧u, 칠g skil ekki. Getur칧u sagt 쬰tta 치 칤slensku?" og hj치lpa칧u me칧 d칝mi.

## HJ츼LP
Ef nemandi bi칧ur um hj치lp 치 칬칧ru tungum치li:
1. Svara칧u 치 SAMA tungum치li
2. Gef칧u 칤slenska setninguna
3. Haltu s칤칧an 치fram 치 칤slensku

## 츼HUGASVI칋SPR칍FI칋 - FIMM SPURNINGAR

Spyr칧u EINUNGIS EINA spurningu 칤 einu. B칤ddu eftir svari 치칧ur en 쮂 heldur 치fram.

### Spurning 1: FR칈T칈MI
"Hva칧 finnst 쮂r gaman a칧 gera 칤 fr칤t칤ma 쮂셡um? Finnst 쮂r gaman a칧 vinna me칧 h칬ndunum, e칧a k칳st 쮂 frekar a칧 vera me칧 f칩lki... e칧a eitthva칧 anna칧?"

### Spurning 2: STARF
"Hva칧 langar 쬴g a칧 ver칧a? 룣kir 쮂r til d칝mis gaman a칧 hj치lpa 칬칧rum, e칧a langar 쬴g frekar a칧 vinna me칧 t칝kni... e칧a eitthva칧 anna칧?"

### Spurning 3: VINNULAG
"Hvernig vinnur 쮂 best? Vinnur 쮂 best ein/n, e칧a me칧 칬칧rum... e칧a eitthva칧 anna칧?"

### Spurning 4: N츼MSGREINAR
"Hva칧a f칬g finnast 쮂r skemmtilegust? L칤kar 쮂r betur 칤 n치tt칰rufr칝칧i og st칝r칧fr칝칧i, e칧a 칤 tungum치lum og listum... e칧a eitthva칧 anna칧?"

### Spurning 5: FRAMT칈칋
"Hvernig s칠r칧 쮂 쬴g eftir t칤u 치r? Ert 쮂 a칧 vinna me칧 f칩lki, e칧a a칧 b칰a eitthva칧 til... e칧a eitthva칧 anna칧?"

## EFTIR ALLAR FIMM SPURNINGAR
료kka칧u nemandanum og gef칧u ni칧urst칬칧urnar:
- M칝l me칧 2-3 st칬rfum sem passa vi칧 sv칬rin (nota칧u starfsheiti 칰r 칤slensku eins og: kennari, lei칧s칬guma칧ur, t칝knima칧ur, m치lari, m칰rari, h치rsnyrtir, snyrtifr칝칧ingur, kokkur, hj칰krunarfr칝칧ingur, leiksk칩lakennari, atvinnut칩nlistarma칧ur, jar칧fr칝칧ingur)
- 칔tsk칳r칧u STUTTLEGA af hverju hvert starf passar (1 setning fyrir hvert)
- Spyr칧u svo: "Langar 쬴g a칧 f치 쬰ssar ni칧urst칬칧ur 치 쮂셡u eigin tungum치li?"

Ef nemandi vill 쬬칧 - spyr칧u: "Hva칧a tungum치l talar 쮂?" og 쮂쪇du ni칧urst칬칧urnar.

룐gar 쮂 ert b칰in/n a칧 gefa ni칧urst칬칧urnar (og 쮂쫚쌀ngu ef be칧i칧), b칝ttu N츼KV칁MLEGA vi칧 칤 lok skilabo칧anna: [R츼칋GJ칐F LOKI칋]

## MIKILV칁GT
- Spyr칧u BARA EINA spurningu 칤 einu
- Vertu hl칳 og j치kv칝칧
- Nota칧u or칧afor칧a 칰r kaflanum: langar 쬴g a칧 ver칧a, m칠r finnst gaman a칧, 칠g er g칩칧(ur) 칤, 치hugasvi칧, framt칤칧ar치form, vinna me칧 sk칩la
- EKKI fara 칤 n칝stu spurningu fyrr en nemandi hefur svara칧
`.trim();

        const FEEDBACK_SYSTEM_PROMPT = `
뤢 ert 칤slenskukennari. Gef칧u nemanda hr칩s 치 칤slensku eftir 치hugasvi칧ssamtal vi칧 n치msr치칧gjafa.

Skrifa칧u 치 칤slensku (A1-A2 stig):
- Hr칩sa칧u nemandanum (2-3 setningar)
- Nefndu 2-3 setningar e칧a or칧 sem nemandinn nota칧i vel
- Vertu hvetjandi og hl칳

Vertu stuttur og einf칬ldur. Nemandinn er 치 A1-A2 stigi.
`.trim();

        // ===== MAIN COMPONENT =====
        const Namsradgjof = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [recognition, setRecognition] = useState(null);
            const [playingIndex, setPlayingIndex] = useState(null);
            const [audioCache, setAudioCache] = useState({});
            const [showHelp, setShowHelp] = useState(false);
            const [helpInput, setHelpInput] = useState('');
            const [helpResponse, setHelpResponse] = useState('');
            const [helpLoading, setHelpLoading] = useState(false);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [started, setStarted] = useState(false);
            const [copied, setCopied] = useState(false);
            const messagesEndRef = useRef(null);
            const currentAudioRef = useRef(null);

            useEffect(() => {
                if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
                    const rec = new window.webkitSpeechRecognition();
                    rec.lang = 'is-IS';
                    rec.continuous = false;
                    rec.interimResults = false;
                    rec.onresult = (e) => { setInput(e.results[0][0].transcript); setIsRecording(false); };
                    rec.onerror = () => setIsRecording(false);
                    rec.onend = () => setIsRecording(false);
                    setRecognition(rec);
                }
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const playAudio = async (index, text) => {
                if (currentAudioRef.current) { currentAudioRef.current.pause(); currentAudioRef.current = null; }
                setPlayingIndex(index);
                try {
                    let audioUrl = audioCache[index];
                    if (!audioUrl) {
                        audioUrl = await fetchAudio(text);
                        setAudioCache(prev => ({ ...prev, [index]: audioUrl }));
                    }
                    const audio = new Audio(audioUrl);
                    currentAudioRef.current = audio;
                    audio.onended = () => { setPlayingIndex(null); currentAudioRef.current = null; };
                    audio.onerror = () => { setPlayingIndex(null); currentAudioRef.current = null; };
                    await audio.play();
                } catch (e) { setPlayingIndex(null); }
            };

            const copyFeedback = async () => {
                try { await navigator.clipboard.writeText(feedback); setCopied(true); setTimeout(() => setCopied(false), 2000); }
                catch (e) { console.error(e); }
            };

            const startConversation = async () => {
                setStarted(true);
                setLoading(true);
                try {
                    const apiMessages = [
                        { role: 'system', content: ADVISOR_SYSTEM_PROMPT },
                        { role: 'user', content: '[Nemandi kemur inn 치 skrifstofu n치msr치칧gjafans]' }
                    ];
                    const response = await callOpenAI(apiMessages);
                    setMessages([{ role: 'assistant', content: response }]);
                } catch (e) { console.error(e); }
                finally { setLoading(false); }
            };

            const sendMessage = async () => {
                if (!input.trim() || loading) return;
                const userMessage = input.trim();
                setInput('');
                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);
                setLoading(true);
                try {
                    const apiMessages = [
                        { role: 'system', content: ADVISOR_SYSTEM_PROMPT },
                        { role: 'user', content: '[Nemandi kemur inn 치 skrifstofu n치msr치칧gjafans]' },
                        ...newMessages.map(m => ({ role: m.role, content: m.content }))
                    ];
                    const response = await callOpenAI(apiMessages);

                    if (response.includes('[R츼칋GJ칐F LOKI칋]')) {
                        const cleanResponse = response.replace('[R츼칋GJ칐F LOKI칋]', '').trim();
                        const allMessages = [...newMessages, { role: 'assistant', content: cleanResponse }];
                        setMessages(allMessages);

                        const feedbackMsgs = [
                            { role: 'system', content: FEEDBACK_SYSTEM_PROMPT },
                            { role: 'user', content: `Samtali칧:\n${allMessages.map(m => `${m.role === 'user' ? 'Nemandi' : 'N치msr치칧gjafi'}: ${m.content}`).join('\n')}` }
                        ];
                        const feedbackText = await callOpenAI(feedbackMsgs, 400);
                        setFeedback(feedbackText);
                        setFinished(true);
                    } else {
                        setMessages([...newMessages, { role: 'assistant', content: response }]);
                    }
                } catch (e) { console.error(e); }
                finally { setLoading(false); }
            };

            const toggleRecording = () => {
                if (!recognition) { alert('Talgreining er ekki studd 칤 쬰ssum vafra. Pr칩fa칧u Chrome.'); return; }
                if (isRecording) { recognition.stop(); }
                else { setInput(''); recognition.start(); setIsRecording(true); }
            };

            const askForHelp = async () => {
                if (!helpInput.trim() || helpLoading) return;
                setHelpLoading(true);
                try {
                    const helpMessages = [
                        { role: 'system', content: 'Hj치lpa칧u nemanda 칤 samtali vi칧 n치msr치칧gjafa. Svara칧u 치 SAMA tungum치li og nemandinn skrifar. Gef칧u 칤slenska setninguna sem hann 쬬rf. Vertu stuttur.' },
                        { role: 'user', content: helpInput }
                    ];
                    const response = await callOpenAI(helpMessages, 200);
                    setHelpResponse(response);
                } catch (e) { setHelpResponse('Villa. Reyndu aftur.'); }
                finally { setHelpLoading(false); }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            };

            const getAssistantNumber = (index) => {
                let count = 0;
                for (let i = 0; i <= index; i++) { if (messages[i].role === 'assistant') count++; }
                return count;
            };

            return (
                <div className="min-h-screen flex flex-col" style={{ maxHeight: '100vh' }}>
                    {/* Header */}
                    <header className="bg-white shadow-sm py-4 px-5">
                        <div className="flex items-center gap-4">
                            <span className="text-4xl">游꿉</span>
                            <div>
                                <h1 className="text-2xl font-medium text-gray-800">N치msr치칧gj칬fin</h1>
                                <p className="text-base text-gray-500">Hlutverkaleikur 췅 Kafli 2 췅 A1-A2</p>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col overflow-hidden p-4">

                        {/* Start screen */}
                        {!started && (
                            <div className="flex-1 flex flex-col items-center justify-center text-center p-8">
                                <div className="text-8xl mb-6">游꿉</div>
                                <h2 className="text-3xl font-light text-gray-800 mb-3">Velkomin 칤 n치msr치칧gj칬fina!</h2>
                                <p className="text-xl text-gray-600 font-light mb-3">뤢 ert a칧 fara 칤 fund me칧 n치msr치칧gjafa.</p>
                                <p className="text-lg text-gray-500 font-light mb-8">H칰n spyr 쬴g um 치hugam치l og framt칤칧ardraumar og m칝lir me칧 n치mi.</p>
                                <button
                                    onClick={startConversation}
                                    className="px-10 py-5 bg-indigo-500 text-white text-2xl rounded-2xl hover:bg-indigo-600 transition-colors font-light"
                                >
                                    Byrja fund
                                </button>
                            </div>
                        )}

                        {/* Conversation */}
                        {started && !finished && (
                            <>
                                <div className="flex-1 overflow-y-auto bg-white rounded-2xl shadow-sm p-5 mb-4">
                                    <div className="space-y-5">
                                        {messages.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                {msg.role === 'assistant' ? (
                                                    <button
                                                        onClick={() => playAudio(idx, msg.content)}
                                                        disabled={playingIndex !== null && playingIndex !== idx}
                                                        className={`flex items-center gap-4 px-6 py-4 rounded-full transition-colors ${
                                                            playingIndex === idx
                                                                ? 'bg-indigo-100 border-indigo-400'
                                                                : 'bg-gray-100 hover:bg-indigo-50 border-transparent'
                                                        } disabled:opacity-50`}
                                                        style={{ borderWidth: '3px', borderStyle: 'solid' }}
                                                    >
                                                        <SpeakerIcon isPlaying={playingIndex === idx} />
                                                        <span className="text-2xl font-medium text-gray-700">{getAssistantNumber(idx)}</span>
                                                    </button>
                                                ) : (
                                                    <div className="px-6 py-4 rounded-2xl bg-indigo-500 text-white text-lg font-light max-w-[85%]">
                                                        {msg.content}
                                                    </div>
                                                )}
                                            </div>
                                        ))}

                                        {loading && (
                                            <div className="flex justify-start">
                                                <div className="px-6 py-4 rounded-full bg-gray-100">
                                                    <div className="flex gap-2">
                                                        <div className="w-4 h-4 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                        <div className="w-4 h-4 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                        <div className="w-4 h-4 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                </div>

                                {/* Input */}
                                <div className="bg-white rounded-2xl shadow-sm p-4">
                                    <div className="flex gap-3 mb-3">
                                        <button
                                            onClick={toggleRecording}
                                            disabled={loading}
                                            className={`p-5 rounded-2xl transition-colors ${
                                                isRecording ? 'bg-red-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                            } disabled:opacity-50`}
                                        >
                                            <MicIcon isRecording={isRecording} />
                                        </button>
                                        <input
                                            type="text"
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            disabled={loading}
                                            placeholder={isRecording ? "Hlustar..." : "Skrifa칧u h칠r..."}
                                            className="flex-1 px-5 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-indigo-500 text-lg font-light"
                                        />
                                        <button
                                            onClick={sendMessage}
                                            disabled={!input.trim() || loading}
                                            className="px-6 py-4 bg-indigo-500 text-white rounded-2xl hover:bg-indigo-600 disabled:bg-gray-300 transition-colors"
                                        >
                                            <SendIcon />
                                        </button>
                                    </div>

                                    {isRecording && (
                                        <p className="text-base text-red-500 mb-3 font-medium">游댮 Tala칧u n칰na...</p>
                                    )}

                                    {/* Help */}
                                    <button
                                        onClick={() => setShowHelp(!showHelp)}
                                        className="flex items-center gap-2 text-base text-gray-500 hover:text-gray-700 py-2"
                                    >
                                        <HelpIcon />
                                        <span>Hj치lp 치 쮂셡u m치li</span>
                                    </button>

                                    {showHelp && (
                                        <div className="mt-4 p-4 bg-yellow-50 rounded-2xl border-2 border-yellow-200">
                                            <div className="flex gap-3">
                                                <input
                                                    type="text"
                                                    value={helpInput}
                                                    onChange={(e) => setHelpInput(e.target.value)}
                                                    onKeyPress={(e) => e.key === 'Enter' && askForHelp()}
                                                    placeholder="How do I say...?"
                                                    className="flex-1 px-4 py-3 border-2 border-yellow-300 rounded-xl text-base"
                                                />
                                                <button
                                                    onClick={askForHelp}
                                                    disabled={helpLoading}
                                                    className="px-5 py-3 bg-yellow-500 text-white rounded-xl text-lg font-medium"
                                                >
                                                    {helpLoading ? '...' : '?'}
                                                </button>
                                            </div>
                                            {helpResponse && (
                                                <p className="mt-4 text-base text-gray-700 bg-white p-4 rounded-xl">{helpResponse}</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* Finished */}
                        {finished && (
                            <div className="flex-1 flex flex-col bg-white rounded-2xl shadow-sm p-6 overflow-y-auto">
                                <div className="text-center mb-5">
                                    <div className="text-7xl mb-3">游</div>
                                    <h2 className="text-3xl font-light text-gray-800">Vel gert!</h2>
                                </div>
                                <div className="flex-1 bg-indigo-50 rounded-2xl p-5 mb-5 overflow-y-auto">
                                    <p className="text-lg text-gray-700 font-light whitespace-pre-wrap leading-relaxed">{feedback}</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={copyFeedback}
                                        className="flex-1 py-5 bg-indigo-500 text-white rounded-2xl hover:bg-indigo-600 text-xl font-light flex items-center justify-center gap-3 transition-colors"
                                    >
                                        {copied ? <CheckIcon /> : <CopyIcon />}
                                        {copied ? 'Afrita칧!' : 'Afrita'}
                                    </button>
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="flex-1 py-5 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 text-xl font-light transition-colors"
                                    >
                                        Reyna aftur
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Namsradgjof />);
    </script>
</body>
</html>
