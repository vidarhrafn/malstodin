<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üçΩÔ∏è Veitingasta√∞urinn</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
            min-height: 100vh;
            margin: 0;
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        .playing {
            animation: playPulse 0.6s ease-in-out infinite;
        }
        @keyframes playPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===== ICONS =====
        const SendIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const MicIcon = ({ isRecording }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill={isRecording ? "currentColor" : "none"}
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-7 h-7 ${isRecording ? 'recording text-red-500' : ''}`}
            >
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const SpeakerIcon = ({ isPlaying }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={`w-7 h-7 ${isPlaying ? 'playing text-blue-600' : 'text-blue-500'}`}
            >
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
            </svg>
        );

        const HelpIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        // ===== API FUNCTIONS =====
        async function callOpenAI(messages, max_tokens = 500, model = 'gpt-4o-mini', temperature = 0.4) {
            const r = await fetch('/.netlify/functions/openai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    max_tokens: max_tokens,
                    temperature: temperature
                }),
            });
            const data = await r.json();
            if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
            return data.content;
        }

        async function fetchAudio(text) {
            const r = await fetch('/.netlify/functions/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_to_speak: text }),
            });

            const data = await r.json();
            
            if (!r.ok || data.error || !data.audio_base64) {
                throw new Error(data.error || 'Audio error');
            }

            return `data:audio/mp3;base64,${data.audio_base64}`;
        }

        // ===== SYSTEM PROMPT =====
        const WAITER_SYSTEM_PROMPT = `
√û√∫ ert vingjarnlegur og √æolinm√≥√∞ur √æj√≥nn √° veitingasta√∞ √° √çslandi. √û√∫ talar vi√∞ nemendur sem eru a√∞ l√¶ra √≠slensku √° A1-A2 stigi.

## TUNGUM√ÅL
- Tala√∞u EINUNGIS √≠slensku (nema √æegar nemandi bi√∞ur um hj√°lp)
- Nota√∞u stuttar og sk√Ωrar setningar
- Vertu √æolinm√≥√∞ur ef nemandi gerir m√°lfr√¶√∞ivillur
- Lei√∞r√©ttu √≥beint me√∞ √æv√≠ a√∞ endurtaka r√©tt (t.d. ef nemandi segir "√âg vil fiska" svara√∞u "Fr√°b√¶rt, √æ√∫ pantar fiskinn")
- MIKILV√ÜGT: Seg√∞u "G√≥√∞an daginn" √≠ sta√∞ "Hall√≥"

## EF NEMANDI TALAR ANNA√ê TUNGUM√ÅL
Ef nemandi skrifar √° √∂√∞ru tungum√°li en √≠slensku (og bi√∞ur EKKI um hj√°lp), svara√∞u:
"Afsaki√∞, √©g skil ekki. Getur√∞u sagt √æetta √° √≠slensku?"
Og hj√°lpa√∞u me√∞ d√¶mi.

## HJ√ÅLP
Ef nemandi bi√∞ur um hj√°lp (t.d. "How do I say...", "Jak powiedzieƒá..."):
1. Svara√∞u √° SAMA tungum√°li og nemandinn spur√∞i √°
2. Gef√∞u √≠slenska setninguna/or√∞i√∞
3. Haltu s√≠√∞an √°fram √° √≠slensku

## SAMTALSFERLI√ê

### 1. BYRJUN (fyrsta skilabo√∞)
- Heilsa√∞u: "G√≥√∞an daginn! Velkomin √° veitingah√∫si√∞ okkar!"
- Spyr√∞u hvort nemandi hafi panta√∞ bor√∞

### 2. BOR√êP√ñNTUN
- Ef ekki panta√∞: "Ekkert m√°l! Fyrir hve marga?"
- √ûegar b√∫i√∞: "Komdu me√∞ m√©r" / "H√©r er bor√∞i√∞"

### 3. MATSE√êILL OG DRYKKIR
- Bj√≥ddu matse√∞ilinn
- Spyr√∞u hva√∞ vi√∞skiptavinur vill drekka

### 4. MATARP√ñNTUN
- Spyr√∞u hvort tilb√∫i√∞ a√∞ panta
- Ef nemandi spyr um r√°√∞leggingar: m√¶ltu me√∞ einhverju
- Spyr√∞u um forr√©tt/eftirr√©tt

### 5. OFN√ÜMI
- Spyr√∞u: "Ert √æ√∫ me√∞ ofn√¶mi fyrir einhverju?"
- Ef j√°: "√âg skal athuga hj√° kokknum til √∂ryggis"

### 6. B√ç√ê OG MATUR
- Seg√∞u a√∞ maturinn komi eftir 15 m√≠n√∫tur
- √ûegar kemur a√∞ √æv√≠: "Gj√∂ri√∞ svo vel! Nj√≥ti√∞ vel!"
- Spyr√∞u hvort maturinn brag√∞ist vel

### 7. REIKNINGUR
- Reikna√∞u heildarver√∞
- Spyr√∞u hvort borga saman e√∞a sitt √≠ hvoru lagi
- Bj√≥ddu kvittun
- √ûakka√∞u fyrir komuna

## VER√êLISTI
FORR√âTTUR: S√∫pa 1.400kr, Salat 1.600kr
A√êALR√âTTUR: Fiskur 3.200kr, Lambahryggur 3.800kr, Kj√∫klingavefja 2.800kr, Hamborgari 2.400kr, Gr√¶nmetisr√©ttur 2.600kr
EFTIRR√âTTUR: S√∫kkula√∞ikaka 1.300kr, √çs 900kr, √Åvextir 1.000kr
DRYKKIR: Vatn 0kr, Gos 500kr, Kaffi/Te 400kr, Safi 600kr

## √ûEGAR SAMTALI L√ùKUR
Eftir a√∞ nemandi hefur borga√∞ og √æ√∫ hefur √æakka√∞, b√¶ttu vi√∞ N√ÅKV√ÜMLEGA:
[SAMTALI LOKI√ê]

## MIKILV√ÜGT
- Haltu sv√∂rum STUTTUM (1-3 setningar)
- Vertu n√°tt√∫rulegur og vingjarnlegur
`.trim();

        const FEEDBACK_SYSTEM_PROMPT = `
√û√∫ ert √≠slenskukennari. Gef√∞u nemanda hr√≥s eftir hlutverkaleik √° veitingasta√∞.

1. FYRST √° √≠slensku (3-4 setningar):
- Hr√≥sa√∞u
- Nefndu 2-3 setningar/or√∞ sem nemandinn nota√∞i vel

2. S√ç√êAN √° m√≥√∞urm√°li nemandans (greindu √æa√∞ √∫r samtalinu):
- √û√Ωddu hr√≥si√∞
- Gef√∞u 1-2 r√°√∞

Vertu hvetjandi. Nemandinn er √° A1-A2 stigi.
`.trim();

        // ===== MAIN COMPONENT =====
        const Veitingastadur = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [recognition, setRecognition] = useState(null);
            const [playingIndex, setPlayingIndex] = useState(null);
            const [audioCache, setAudioCache] = useState({});
            const [showHelp, setShowHelp] = useState(false);
            const [helpInput, setHelpInput] = useState('');
            const [helpResponse, setHelpResponse] = useState('');
            const [helpLoading, setHelpLoading] = useState(false);
            const [finished, setFinished] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [started, setStarted] = useState(false);
            const messagesEndRef = useRef(null);
            const currentAudioRef = useRef(null);

            // Initialize speech recognition
            useEffect(() => {
                if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
                    const recognitionInstance = new window.webkitSpeechRecognition();
                    recognitionInstance.lang = 'is-IS';
                    recognitionInstance.continuous = false;
                    recognitionInstance.interimResults = false;

                    recognitionInstance.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        setInput(transcript);
                        setIsRecording(false);
                    };

                    recognitionInstance.onerror = () => setIsRecording(false);
                    recognitionInstance.onend = () => setIsRecording(false);

                    setRecognition(recognitionInstance);
                }
            }, []);

            // Scroll to bottom
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Play audio
            const playAudio = async (index, text) => {
                // Stop current audio if playing
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                }

                setPlayingIndex(index);

                try {
                    let audioUrl = audioCache[index];
                    
                    if (!audioUrl) {
                        audioUrl = await fetchAudio(text);
                        setAudioCache(prev => ({ ...prev, [index]: audioUrl }));
                    }

                    const audio = new Audio(audioUrl);
                    currentAudioRef.current = audio;
                    
                    audio.onended = () => {
                        setPlayingIndex(null);
                        currentAudioRef.current = null;
                    };
                    audio.onerror = () => {
                        setPlayingIndex(null);
                        currentAudioRef.current = null;
                    };
                    
                    await audio.play();
                } catch (e) {
                    console.error('Audio error:', e);
                    setPlayingIndex(null);
                }
            };

            // Start conversation
            const startConversation = async () => {
                setStarted(true);
                setLoading(true);

                try {
                    const apiMessages = [
                        { role: 'system', content: WAITER_SYSTEM_PROMPT },
                        { role: 'user', content: '[Vi√∞skiptavinur kemur inn √° veitingasta√∞inn]' }
                    ];

                    const response = await callOpenAI(apiMessages);
                    setMessages([{ role: 'assistant', content: response }]);

                } catch (error) {
                    console.error('Error:', error);
                } finally {
                    setLoading(false);
                }
            };

            // Send message
            const sendMessage = async () => {
                if (!input.trim() || loading) return;

                const userMessage = input.trim();
                setInput('');
                
                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);
                setLoading(true);

                try {
                    const apiMessages = [
                        { role: 'system', content: WAITER_SYSTEM_PROMPT },
                        { role: 'user', content: '[Vi√∞skiptavinur kemur inn]' },
                        ...newMessages.map(m => ({ role: m.role, content: m.content }))
                    ];

                    const response = await callOpenAI(apiMessages);
                    
                    // Check if finished
                    if (response.includes('[SAMTALI LOKI√ê]')) {
                        const cleanResponse = response.replace('[SAMTALI LOKI√ê]', '').trim();
                        setMessages([...newMessages, { role: 'assistant', content: cleanResponse }]);
                        
                        // Get feedback
                        const allMessages = [...newMessages, { role: 'assistant', content: cleanResponse }];
                        const feedbackMsgs = [
                            { role: 'system', content: FEEDBACK_SYSTEM_PROMPT },
                            { role: 'user', content: `Samtali√∞:\n${allMessages.map(m => `${m.role === 'user' ? 'Nemandi' : '√ûj√≥nn'}: ${m.content}`).join('\n')}` }
                        ];
                        
                        const feedbackText = await callOpenAI(feedbackMsgs, 500);
                        setFeedback(feedbackText);
                        setFinished(true);
                    } else {
                        setMessages([...newMessages, { role: 'assistant', content: response }]);
                    }

                } catch (error) {
                    console.error('Error:', error);
                } finally {
                    setLoading(false);
                }
            };

            // Toggle recording
            const toggleRecording = () => {
                if (!recognition) {
                    alert('Talgreining er ekki studd √≠ √æessum vafra. Pr√≥fa√∞u Chrome.');
                    return;
                }

                if (isRecording) {
                    recognition.stop();
                } else {
                    setInput('');
                    recognition.start();
                    setIsRecording(true);
                }
            };

            // Help
            const askForHelp = async () => {
                if (!helpInput.trim() || helpLoading) return;
                setHelpLoading(true);
                
                try {
                    const helpMessages = [
                        { 
                            role: 'system', 
                            content: `Hj√°lpa√∞u nemanda √≠ veitingasta√∞ar-hlutverkaleik. Svara√∞u √° SAMA tungum√°li og nemandinn skrifar. Gef√∞u √≠slenska setninguna sem hann √æarf.`
                        },
                        { role: 'user', content: helpInput }
                    ];

                    const response = await callOpenAI(helpMessages, 200);
                    setHelpResponse(response);
                } catch (e) {
                    setHelpResponse('Villa. Reyndu aftur.');
                } finally {
                    setHelpLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            // Get assistant message number
            const getAssistantNumber = (index) => {
                let count = 0;
                for (let i = 0; i <= index; i++) {
                    if (messages[i].role === 'assistant') count++;
                }
                return count;
            };

            return (
                <div className="min-h-screen flex flex-col" style={{ maxHeight: '100vh' }}>
                    {/* Header */}
                    <header className="bg-white shadow-sm py-3 px-4">
                        <div className="flex items-center gap-3">
                            <span className="text-3xl">üçΩÔ∏è</span>
                            <div>
                                <h1 className="text-xl font-medium text-gray-800">Veitingasta√∞urinn</h1>
                                <p className="text-sm text-gray-500">Hlutverkaleikur ¬∑ A1-A2</p>
                            </div>
                        </div>
                    </header>

                    {/* Main */}
                    <main className="flex-1 flex flex-col overflow-hidden p-3">
                        
                        {/* Start screen */}
                        {!started && (
                            <div className="flex-1 flex flex-col items-center justify-center text-center p-6">
                                <div className="text-6xl mb-4">üçΩÔ∏è</div>
                                <h2 className="text-2xl font-light text-gray-800 mb-2">Velkomin √° veitingasta√∞inn!</h2>
                                <p className="text-base text-gray-600 font-light mb-6">√û√∫ √¶tlar a√∞ panta mat. Tala√∞u vi√∞ √æj√≥ninn.</p>
                                <button
                                    onClick={startConversation}
                                    className="px-8 py-4 bg-blue-500 text-white text-lg rounded-xl hover:bg-blue-600 transition-colors font-light"
                                >
                                    Byrja
                                </button>
                            </div>
                        )}

                        {/* Conversation */}
                        {started && !finished && (
                            <>
                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto bg-white rounded-xl shadow-sm p-4 mb-3">
                                    <div className="space-y-4">
                                        {messages.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                {msg.role === 'assistant' ? (
                                                    <button
                                                        onClick={() => playAudio(idx, msg.content)}
                                                        disabled={playingIndex !== null && playingIndex !== idx}
                                                        className={`flex items-center gap-3 px-5 py-3 rounded-full transition-colors ${
                                                            playingIndex === idx 
                                                                ? 'bg-blue-100 border-2 border-blue-400' 
                                                                : 'bg-gray-100 hover:bg-blue-50 border-2 border-transparent'
                                                        } disabled:opacity-50`}
                                                    >
                                                        <SpeakerIcon isPlaying={playingIndex === idx} />
                                                        <span className="text-lg font-medium text-gray-700">
                                                            {getAssistantNumber(idx)}
                                                        </span>
                                                    </button>
                                                ) : (
                                                    <div className="px-5 py-3 rounded-2xl bg-blue-500 text-white text-base font-light max-w-[85%]">
                                                        {msg.content}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        
                                        {loading && (
                                            <div className="flex justify-start">
                                                <div className="px-5 py-3 rounded-full bg-gray-100">
                                                    <div className="flex gap-1">
                                                        <div className="w-3 h-3 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                        <div className="w-3 h-3 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                        <div className="w-3 h-3 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                </div>

                                {/* Input */}
                                <div className="bg-white rounded-xl shadow-sm p-3">
                                    <div className="flex gap-3 mb-3">
                                        <button
                                            onClick={toggleRecording}
                                            disabled={loading}
                                            className={`p-4 rounded-xl transition-colors ${
                                                isRecording 
                                                    ? 'bg-red-500 text-white' 
                                                    : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                            } disabled:opacity-50`}
                                        >
                                            <MicIcon isRecording={isRecording} />
                                        </button>
                                        <input
                                            type="text"
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            disabled={loading}
                                            placeholder={isRecording ? "Hlustar..." : "Skrifa√∞u h√©r..."}
                                            className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 text-base font-light"
                                        />
                                        <button
                                            onClick={sendMessage}
                                            disabled={!input.trim() || loading}
                                            className="px-5 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:bg-gray-300 transition-colors"
                                        >
                                            <SendIcon />
                                        </button>
                                    </div>
                                    
                                    {isRecording && (
                                        <p className="text-sm text-red-500 mb-3">üî¥ Tala√∞u n√∫na...</p>
                                    )}

                                    {/* Help */}
                                    <button
                                        onClick={() => setShowHelp(!showHelp)}
                                        className="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 py-1"
                                    >
                                        <HelpIcon />
                                        <span>Hj√°lp √° √æ√≠nu m√°li</span>
                                    </button>

                                    {showHelp && (
                                        <div className="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    value={helpInput}
                                                    onChange={(e) => setHelpInput(e.target.value)}
                                                    onKeyPress={(e) => e.key === 'Enter' && askForHelp()}
                                                    placeholder="How do I say...?"
                                                    className="flex-1 px-3 py-2 border border-yellow-300 rounded-lg text-sm"
                                                />
                                                <button
                                                    onClick={askForHelp}
                                                    disabled={helpLoading}
                                                    className="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-medium"
                                                >
                                                    {helpLoading ? '...' : '?'}
                                                </button>
                                            </div>
                                            {helpResponse && (
                                                <p className="mt-3 text-sm text-gray-700 bg-white p-3 rounded-lg">{helpResponse}</p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {/* Finished */}
                        {finished && (
                            <div className="flex-1 flex flex-col bg-white rounded-xl shadow-sm p-5 overflow-y-auto">
                                <div className="text-center mb-4">
                                    <div className="text-5xl mb-2">üéâ</div>
                                    <h2 className="text-2xl font-light text-gray-800">Vel gert!</h2>
                                </div>
                                <div className="flex-1 bg-green-50 rounded-xl p-4 mb-4 overflow-y-auto">
                                    <p className="text-base text-gray-700 font-light whitespace-pre-wrap">{feedback}</p>
                                </div>
                                <button
                                    onClick={() => window.location.reload()}
                                    className="w-full py-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600 text-lg font-light"
                                >
                                    Reyna aftur
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Veitingastadur />);
    </script>
</body>
</html>
