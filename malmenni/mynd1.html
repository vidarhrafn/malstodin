<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing (sk√≥lastofa)</title>
  <!-- React + Babel + Tailwind (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Japandi-ish look */
    :root {
      --bg-grad-start: #f8f7f4;
      --bg-grad-end: #e8e6e1;
      --ink: #2d2d2d;
      --muted: #6b7280;
      --ok: #4caf50; --ok-100: #e8f5e9;
      --sel: #2196f3; --sel-100: #e3f2fd;
      --err: #f44336; --err-100: #ffebee;
    }
    body { background: linear-gradient(to bottom, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
    .card { background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .bubble-user { background: #eef6ff; }
    .bubble-bot { background: #e6f3ea; }
    .bubble-grammar { background: #e8f0fe; }
  </style>
</head>
<body class="min-h-screen text-[15px] text-[color:var(--ink)]">
  <div id="app" class="mx-auto max-w-5xl px-6 py-8"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    /**
     * OpenAI integration
     * Expects a Netlify function at '/.netlify/functions/openai' that returns
     * { content: string } where content is a JSON string we can parse.
     */
    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Helper: robust JSON fence cleanup (```json ... ```)
    function parseJSONSafe(raw) {
      let clean = (raw || '').trim();
      if (clean.startsWith('```')) {
        clean = clean.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }
      try { return JSON.parse(clean); } catch(e) { return { grammar: null, response: clean }; }
    }

    /** System prompt for one-question-at-a-time classroom talk **/
    const SYSTEM_PROMPT = `√û√∫ ert vingjarnlegur √≠slenskukennari sem r√¶√∞ir vi√∞ A1‚ÄìA2 nemanda um mynd.
REGLUR:
- Spyr√∞u A√êEINS eina spurningu √≠ einu, stutta og sk√Ωra (1 setning).
- Byrja√∞u √° hl√Ωlegri, stuttri sta√∞festingu e√∞a hr√≥si (1 l√≠na).
- Nota√∞u einfaldan or√∞afor√∞a (A1‚ÄìA2) og v√≠sa√∞u √≠ atri√∞i √∫r MYNDAL√ùSINGU ef √æarf.
- Ef nemandi spyr: "Er √æetta r√©tt?", "Eru √æau X?", e√∞a gerir sta√∞h√¶fingu me√∞ t√∂lum/litum/hlutum: 
  ‚Ä¢ Svara√∞u fyrst sk√Ωrt me√∞ J√Å / NEI / N√ÜRRI-√ûV√ç og seg√∞u r√©ttu t√∂luna e√∞a sta√∞reyndina √≠ s√∂mu setningu.
  ‚Ä¢ √ötsk√Ωr√∞u √≠ 1 stuttri aukasetningu (t.d. "√ûa√∞ eru 9 b√∂rn: 4 vi√∞ bor√∞i√∞, 4 aftast og 1 a√∞ m√°la.").
- Gef√∞u MJ√öKA, STUTTA m√°lfarsendurgj√∂f a√∞eins ef gr√≥f villa er √≠ svari nemanda. Aldrei um greinarmerki e√∞a sm√°villur.
- Aldrei gefa einkunnir.
SVARA√êU A√êEINS ME√ê JSON:
{
  "grammar": "M√°lfarsendurgj√∂f BARA ef gr√≥far villur. Ef ekkert athugavert: null.",
  "response": "Hl√Ω sta√∞festing + (ef vi√∞ √°) sk√Ωrt J√Å/NEI me√∞ r√©ttri sta√∞reynd + ein n√Ω spurning."
}`;

    // Seed image description for grounding
    const IMAGE_CONTEXT = `
MYND: Litr√≠k grunnsk√≥lastofa.
HEILDARFJ√ñLDI BARNA: 9 (n√≠u).
UPPSETNING OG ATRI√êI:
- Vinstri fremri kantur: Drengur √≠ hv√≠tum svuntu m√°lar √° striga √° tr√∂num. √Å striganum er bl√°tt d√Ωr (l√≠kt hesti) me√∞ gulum s√≥lpunktum og gr√¶nu tr√©. Vi√∞ hli√∞ina eru litad√≥tar: 3 litad√≥sa og krukkur me√∞ penslum.
- Mi√∞jubor√∞ (st√≥rt, lj√≥sbr√∫nt): Fj√∂gur b√∂rn sitja √æar.
  ‚Ä¢ Stelpa √≠ hv√≠tum bol og fj√≥lubluxum teiknar me√∞ t√∫sspenna.
  ‚Ä¢ Drengur √≠ gr√¶num bol sker papp√≠r me√∞ sk√¶rum.
  ‚Ä¢ Stelpa me√∞ tv√¶r hnakka (svartar kollar) √≠ bl√°um peysu me√∞ fi√∞rildi l√≠mir/ra√∞ar papp√≠rsstrimlum.
  ‚Ä¢ Drengur √≠ appels√≠nugulum bol l√≠mir fj√≥lubl√° form √° bl√°an papp√≠r.
  √Å bor√∞inu sj√°st: sk√¶ri (minnst tv√∂ p√∂r), l√≠mflaska, st√≠f l√≠m (glue stick), litir/t√∫ssar, bl√Ωantar, reglustika, b√≥k/st√≠lab√≥k, papp√≠rsstrimlar. Rau√∞ir st√≥lar √≠ kring.
- Aftast h√¶gra megin: H√≥pur fj√∂gurra barna stendur og spjallar (blond stelpa √≠ bleikum bol, rau√∞h√¶r√∞ stelpa me√∞ gleraugu, drengur √≠ bl√°um bol, annar drengur √≠ fj√≥lubl√≠kum bol).
- Kennarinn: Fullor√∞in kona √≠ bl√°rri k√°pu/treyju heldur √° gr√¶nni m√∂ppu h√¶gra megin n√°l√¶gt t√∂flunni og dyrunum.
- Tafla: Stafr√≥fsr√∂nd "Aa‚ÄìBb‚ÄìCe‚Äì..." og t√∂lur 1‚Äì5. Bandar√≠ski f√°ninn hangir vi√∞ t√∂fluna.
- T√¶ki og r√Ωmi: Klukka yfir dyrum, hangandi sj√≥nvarp/loftt√¶ki, hur√∞ me√∞ gulu gleri, kennarabor√∞ me√∞ bor√∞l√≠mmi√∞a/klemmu (tape-dispenser).
- Vinstri bakgrunnur: St√≥rir gluggar me√∞ gr√¶num trj√°m og t√∫num fyrir utan. Vaskur me√∞ s√°pu (SOAP 30 oz) og papp√≠rs√æurrkuboxi √° vegg.
- Stemning: Gl√∂√∞, virk og samvinnufull.
SANNREYNDINGARSTA√êREYNDIR (nota √≠ sv√∂rum):
- B√∂rn √° mynd: 9.
- B√∂rn vi√∞ mi√∞jubor√∞: 4.
- B√∂rn sem standa aftast: 4.
- Barn sem m√°lar √° striga: 1.
- Kennari: 1 (kona).
- T√∂lur √° t√∂flu: 1 til 5.
- Helstu hlutir: sk√¶ri, l√≠m (flaska og l√≠mstift), reglustika, litir, b√≥k, papp√≠r, tr√∂nur, penslar, m√°lningard√≥sir, sj√≥nvarp, vaskur, s√°pa, papp√≠rs√æurrkur.
`;

    function App() {
      const [messages, setMessages] = useState([]); // {role: 'user'|'bot'|'grammar', text}
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const scrollerRef = useRef(null);

      // QUIZ state
      const [quizQ, setQuizQ] = useState(null); // {question, options:[{text, correct}], explanation}
      const [quizAnswered, setQuizAnswered] = useState(false);
      const [quizScore, setQuizScore] = useState({correct:0, total:0});

      // helpers
      const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
      const shuffle = (arr) => arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(({v})=>v);

      const questionBank = [
        {
          question: 'Hversu m√∂rg b√∂rn eru √° myndinni?',
          options: [
            { text: '7', correct: false },
            { text: '8', correct: false },
            { text: '9', correct: true },
            { text: '10', correct: false },
          ],
          explanation: '√ûa√∞ eru 9 b√∂rn: 4 vi√∞ bor√∞i√∞, 4 aftast og 1 a√∞ m√°la.'
        },
        {
          question: 'Hversu m√∂rg b√∂rn sitja vi√∞ st√≥ra bor√∞i√∞?',
          options: [
            { text: '2', correct: false },
            { text: '3', correct: false },
            { text: '4', correct: true },
            { text: '5', correct: false },
          ],
          explanation: 'Fj√∂gur b√∂rn sitja vi√∞ bor√∞i√∞.'
        },
        {
          question: 'Hva√∞ s√©r√∞u √° t√∂flunni?',
          options: [
            { text: 'T√∂lurnar 1‚Äì5 og stafr√≥f', correct: true },
            { text: 'D√Ωr og tr√©', correct: false },
            { text: 'Ekkert', correct: false },
            { text: 'J√∂fnur √≠ algebru', correct: false },
          ],
          explanation: '√Å t√∂flunni sj√°st t√∂lurnar 1‚Äì5 og stafr√≥fsr√∂nd.'
        },
        {
          question: 'Er bandar√≠ski f√°ninn √° myndinni?',
          options: [
            { text: 'J√°', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'J√°, hann hangir vi√∞ t√∂fluna h√¶gra megin.'
        },
        {
          question: 'Hva√∞ er barni√∞ √° tr√∂nunum a√∞ gera?',
          options: [
            { text: 'M√°lar bl√°tt d√Ωr og tr√©', correct: true },
            { text: 'Les b√≥k', correct: false },
            { text: 'Spilar √° g√≠tar', correct: false },
            { text: 'Reiknar d√¶mi', correct: false },
          ],
          explanation: 'Barni√∞ m√°lar bl√°tt d√Ωr (l√≠kt hesti), s√≥l og tr√©.'
        },
        {
          question: 'Hvar stendur kennarinn?',
          options: [
            { text: 'H√¶gra megin n√°l√¶gt t√∂flunni og dyrunum', correct: true },
            { text: 'Vi√∞ gluggana vinstra megin', correct: false },
            { text: 'Vi√∞ vaskinn', correct: false },
            { text: 'Utan vi√∞ stofuna', correct: false },
          ],
          explanation: 'Kennarinn stendur h√¶gra megin me√∞ gr√¶na m√∂ppu.'
        },
        {
          question: 'Hva√∞a verkf√¶ri og efni eru √° bor√∞inu?',
          options: [
            { text: 'Sk√¶ri, l√≠m, reglustika, litir og papp√≠r', correct: true },
            { text: 'Hamar og naglar', correct: false },
            { text: 'Skyr og rj√≥mi', correct: false },
            { text: 'H√°rbl√°sari og grei√∞a', correct: false },
          ],
          explanation: '√Å bor√∞inu eru sk√¶ri, l√≠m (flaska + l√≠mstift), reglustika, litir og papp√≠r.'
        },
        {
          question: 'Eru fj√∂gur b√∂rn a√∞ standa aftast og spjalla?',
          options: [
            { text: 'J√°', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'J√°, fj√∂gur b√∂rn standa aftast √≠ h√≥p.'
        },
        {
          question: 'Er sj√≥nvarp/loftt√¶ki hangandi √° veggnum?',
          options: [
            { text: 'J√°', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'J√°, hangandi skj√°r/t√¶ki er √° veggnum.'
        },
        {
          question: 'Er vaskur me√∞ s√°pu vinstra megin?',
          options: [
            { text: 'J√°', correct: true },
            { text: 'Nei', correct: false },
          ],
          explanation: 'J√°, vaskur og s√°pa eru undir gluggunum.'
        },
      ];

      function askRandomQuestion(){
        const q = { ...pick(questionBank) };
        q.options = shuffle(q.options);
        setQuizQ(q);
        setQuizAnswered(false);
      }

      function answerOption(idx){
        if (!quizQ || quizAnswered) return;
        const correct = quizQ.options[idx].correct;
        setQuizAnswered(true);
        setQuizScore(s=>({correct: s.correct + (correct?1:0), total: s.total + 1}));
      }

      // Auto scroll to bottom
      useEffect(() => {
        if (scrollerRef.current) {
          scrollerRef.current.scrollTop = scrollerRef.current.scrollHeight;
        }
      }, [messages, loading]);

      // Kick off with a friendly opener
      useEffect(() => {
        setMessages([
          { role: 'bot', text: 'H√¶! Sko√∞um myndina saman. Hva√∞ heldur √æ√∫ a√∞ √æau s√©u a√∞ l√¶ra?' }
        ]);
      }, []);

      async function send() {
        if (!input.trim() || loading) return;
        const userText = input.trim();
        setInput('');
        setMessages(prev => [...prev, { role: 'user', text: userText }]);
        setLoading(true);
        try {
          const history = messages
            .filter(m => m.role !== 'grammar')
            .map(m => `${m.role === 'user' ? 'Nemandi' : 'Kennari'}: ${m.text}`)
            .join('
');

          const userPrompt = `MYNDAL√ùSING:
${IMAGE_CONTEXT}

SAMTAL HINGA√ê TIL:
${history}

S√ç√êASTA SVAR NEMANDA:
${userText}

Ger√∞u n√∫ n√¶stu *einu* spurningu (stutta) og gef√∞u a√∞eins m√°lfarsendurgj√∂f ef gr√≥f villa er √≠ svari nemanda.`;

          const content = await callOpenAI({
            model: 'gpt-4o',
            temperature: 0.7,
            max_tokens: 300,
            messages: [
              { role: 'system', content: SYSTEM_PROMPT },
              { role: 'user', content: userPrompt }
            ]
          });

          const parsed = parseJSONSafe(content);

          if (parsed.grammar && parsed.grammar !== 'null') {
            setMessages(prev => [...prev, { role: 'grammar', text: parsed.grammar }]);
          }
          setMessages(prev => [...prev, { role: 'bot', text: parsed.response || 'Fr√°b√¶rt! Hva√∞ s√©r√∞u meira √° myndinni?' }]);
        } catch (e) {
          setMessages(prev => [...prev, { role: 'bot', text: '√öbbs! √ûa√∞ kom upp villa. Reyndu aftur.' }]);
          console.error(e);
        } finally {
          setLoading(false);
        }
      }

      function onKey(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } }

      return (
        <main className="space-y-6">
          <header className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-normal tracking-tight">M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing</h1>
              <p className="text-[color:var(--muted)]">Stig: A1‚ÄìA2 ¬∑ √û√∫ f√¶r√∞ eina spurningu √≠ einu og mj√∫ka m√°lfarsendurgj√∂f ef √æarf.</p>
            </div>
            <span className="text-2xl" title="√Üfing um sk√≥lastofu">üè´</span>
          </header>

          <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Image card */}
            <div className="card rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 className="font-normal">Mynd</h2>
                <span className="text-[13px] text-[color:var(--muted)]">L√Ωstu √æv√≠ sem √æ√∫ s√©r√∞</span>
              </div>
              <div className="p-4">
                <!-- REPLACE src WITH YOUR HOSTED IMAGE PATH -->
                <img src="classroom.jpg" alt="Sk√≥lastofa me√∞ b√∂rnum a√∞ vinna list og handverk" className="w-full rounded-xl border border-gray-200" />
                <p className="mt-3 text-[color:var(--muted)] text-sm">V√≠sbendingar: t√∂lur √° t√∂flu, bor√∞ me√∞ sk√¶rum og l√≠mi, barn a√∞ m√°la √° striga, kennari til hli√∞ar.</p>
              </div>
            </div>

            {/* Chat card */}
            <div className="card rounded-2xl flex flex-col max-h-[70vh]">
              <div className="p-4 border-b border-gray-200 flex items-center gap-2">
                <h2 className="font-normal">Samtal</h2>
                <span className="text-[12px] text-[color:var(--muted)]">Eina spurningu √≠ einu ‚ú®</span>
              </div>

              <div ref={scrollerRef} className="flex-1 overflow-y-auto p-4 space-y-3">
                {messages.map((m, i) => (
                  <div key={i} className={
                    m.role === 'user' ? 'ml-auto max-w-[85%] bubble-user rounded-2xl px-3 py-2 shadow-sm' :
                    m.role === 'grammar' ? 'mx-auto max-w-[85%] bubble-grammar rounded-2xl px-3 py-2 shadow-sm text-sm' :
                    'mr-auto max-w-[85%] bubble-bot rounded-2xl px-3 py-2 shadow-sm'
                  }>
                    <div className="text-[13px] text-[color:var(--muted)] mb-1">
                      {m.role === 'user' ? '√û√∫' : m.role === 'grammar' ? 'üìö M√°lfar' : 'M√≠mi'}
                    </div>
                    <div className="leading-relaxed whitespace-pre-wrap">{m.text}</div>
                  </div>
                ))}
                {loading && (
                  <div className="mr-auto max-w-[60%] bubble-bot rounded-2xl px-3 py-2 shadow-sm text-[14px]">...
                  </div>
                )}
              </div>

              <div className="border-t border-gray-200 p-3">
                <div className="flex items-end gap-2">
                  <textarea
                    className="flex-1 resize-none h-12 rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--sel)]"
                    placeholder="Skrifa√∞u svari√∞ √æitt h√©r og √Ωttu √° Enter..."
                    value={input}
                    onChange={(e)=>setInput(e.target.value)}
                    onKeyDown={onKey}
                  />
                  <button onClick={send} disabled={loading || !input.trim()}
                    className="rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white disabled:opacity-50 hover:opacity-90 transition">
                    {loading ? 'Sendi‚Ä¶' : 'Senda'}
                  </button>
                </div>
                <p className="text-[12px] text-[color:var(--muted)] mt-2">V√≠sbending: √û√∫ getur svara√∞ t.d. ‚Äû√âg held a√∞ √æau l√¶ri st√¶r√∞fr√¶√∞i af √æv√≠ a√∞ t√∂lur eru √° t√∂flunni.‚Äú</p>
              </div>
            </div>
                      {/* Quiz card */}
            <div className=\"card rounded-2xl p-4 md:col-span-2\">
              <div className=\"flex items-center justify-between border-b border-gray-200 pb-3 mb-3\">
                <h2 className=\"font-normal\">Quiz ‚Äì Sta√∞reyndir um myndina</h2>
                <div className=\"text-sm text-[color:var(--muted)]\">Stig: {quizScore.correct}/{quizScore.total}</div>
              </div>
              <div className=\"space-y-3\">
                {!quizQ && (
                  <button onClick={askRandomQuestion} className=\"rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white hover:opacity-90 transition\">Spyrja um myndina</button>
                )}
                {quizQ && (
                  <div className=\"space-y-3\">
                    <p className=\"text-[15px]\"><strong>Spurning:</strong> {quizQ.question}</p>
                    <div className=\"grid sm:grid-cols-2 gap-2\">
                      {quizQ.options.map((op,idx)=>{
                        const base = 'rounded-xl px-3 py-2 border transition text-left';
                        const idle = 'border-gray-200 hover:bg-[color:var(--sel-100)]';
                        const good = 'border-[color:var(--ok)] bg-[color:var(--ok-100)]';
                        const bad  = 'border-[color:var(--err)] bg-[color:var(--err-100)]';
                        const cls = !quizAnswered ? `${base} ${idle}` : `${base} ${op.correct?good:bad}`;
                        return (
                          <button key={idx} onClick={()=>answerOption(idx)} disabled={quizAnswered} className={cls}>
                            {op.text}
                          </button>
                        );})}
                    </div>
                    {quizAnswered && (
                      <div className=\"text-sm text-[color:var(--muted)]\">{quizQ.explanation}</div>
                    )}
                    <div className=\"pt-1\">
                      <button onClick={()=>{ setQuizQ(null); }} className=\"rounded-xl px-4 py-2 border border-gray-300 hover:bg-gray-50\">N√¶sta spurning</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </section>

          <footer className="pt-4 text-[13px] text-[color:var(--muted)]">
            <p>Gervigreind: gpt-4o ¬∑ hitastig 0.7 ¬∑ max 300 tokens. M√°lfarsendurgj√∂f er v√¶g og birtist √≠ bl√°rri bobblu.</p>
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
