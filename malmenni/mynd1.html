<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing (sk√≥lastofa)</title>
  <!-- React + Babel + Tailwind (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Japandi-ish look */
    :root {
      --bg-grad-start: #f8f7f4;
      --bg-grad-end: #e8e6e1;
      --ink: #2d2d2d;
      --muted: #6b7280;
      --ok: #4caf50; --ok-100: #e8f5e9;
      --sel: #2196f3; --sel-100: #e3f2fd;
      --err: #f44336; --err-100: #ffebee;
    }
    body { background: linear-gradient(to bottom, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }
    .card { background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .bubble-user { background: #eef6ff; }
    .bubble-bot { background: #e6f3ea; }
    .bubble-grammar { background: #e8f0fe; }
  </style>
</head>
<body class="min-h-screen text-[15px] text-[color:var(--ink)]">
  <div id="app" class="mx-auto max-w-5xl px-6 py-8"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    /**
     * OpenAI integration
     * Expects a Netlify function at '/.netlify/functions/openai' that returns
     * { content: string } where content is a JSON string we can parse.
     */
    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Helper: robust JSON fence cleanup (```json ... ```)
    function parseJSONSafe(raw) {
      let clean = (raw || '').trim();
      if (clean.startsWith('```')) {
        clean = clean.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }
      try { return JSON.parse(clean); } catch(e) { return { grammar: null, response: clean }; }
    }

    /** System prompt for one-question-at-a-time classroom talk **/
    const SYSTEM_PROMPT = `√û√∫ ert vingjarnlegur √≠slenskukennari sem r√¶√∞ir vi√∞ A1‚ÄìA2 nemanda um mynd.
REGLUR:
- Spyr√∞u A√êEINS eina spurningu √≠ einu, stutta og sk√Ωra (1 setning).
- Byrja√∞u √° hl√Ωlegri, stuttri sta√∞festingu e√∞a hr√≥si (1 l√≠na).
- Nota√∞u einfaldan or√∞afor√∞a (A1‚ÄìA2) og v√≠sa√∞u √≠ atri√∞i √∫r MYNDAL√ùSINGU ef √æarf.
- Ef nemandi spyr: "Er √æetta r√©tt?", "Eru √æau X?", e√∞a gerir sta√∞h√¶fingu me√∞ t√∂lum/litum/hlutum: 
  ‚Ä¢ Svara√∞u fyrst sk√Ωrt me√∞ J√Å / NEI / N√ÜRRI-√ûV√ç og seg√∞u r√©ttu t√∂luna e√∞a sta√∞reyndina √≠ s√∂mu setningu.
  ‚Ä¢ √ötsk√Ωr√∞u √≠ 1 stuttri aukasetningu (t.d. "√ûa√∞ eru 9 b√∂rn: 4 vi√∞ bor√∞i√∞, 4 aftast og 1 a√∞ m√°la.").
- Gef√∞u MJ√öKA, STUTTA m√°lfarsendurgj√∂f a√∞eins ef gr√≥f villa er √≠ svari nemanda. Aldrei um greinarmerki e√∞a sm√°villur.
- Aldrei gefa einkunnir.
SVARA√êU A√êEINS ME√ê JSON:
{
  "grammar": "M√°lfarsendurgj√∂f BARA ef gr√≥far villur. Ef ekkert athugavert: null.",
  "response": "Hl√Ω sta√∞festing + (ef vi√∞ √°) sk√Ωrt J√Å/NEI me√∞ r√©ttri sta√∞reynd + ein n√Ω spurning."
}`;

    // Seed image description for grounding
    const IMAGE_CONTEXT = `
MYND: Litr√≠k grunnsk√≥lastofa.
HEILDARFJ√ñLDI BARNA: 9 (n√≠u).
UPPSETNING OG ATRI√êI:
- Vinstri fremri kantur: Drengur √≠ hv√≠tum svuntu m√°lar √° striga √° tr√∂num. √Å striganum er bl√°tt d√Ωr (l√≠kt hesti) me√∞ gulum s√≥lpunktum og gr√¶nu tr√©. Vi√∞ hli√∞ina eru litad√≥tar: 3 litad√≥sa og krukkur me√∞ penslum.
- Mi√∞jubor√∞ (st√≥rt, lj√≥sbr√∫nt): Fj√∂gur b√∂rn sitja √æar.
  ‚Ä¢ Stelpa √≠ hv√≠tum bol og fj√≥lubluxum teiknar me√∞ t√∫sspenna.
  ‚Ä¢ Drengur √≠ gr√¶num bol sker papp√≠r me√∞ sk√¶rum.
  ‚Ä¢ Stelpa me√∞ tv√¶r hnakka (svartar kollar) √≠ bl√°um peysu me√∞ fi√∞rildi l√≠mir/ra√∞ar papp√≠rsstrimlum.
  ‚Ä¢ Drengur √≠ appels√≠nugulum bol l√≠mir fj√≥lubl√° form √° bl√°an papp√≠r.
  √Å bor√∞inu sj√°st: sk√¶ri (minnst tv√∂ p√∂r), l√≠mflaska, st√≠f l√≠m (glue stick), litir/t√∫ssar, bl√Ωantar, reglustika, b√≥k/st√≠lab√≥k, papp√≠rsstrimlar. Rau√∞ir st√≥lar √≠ kring.
- Aftast h√¶gra megin: H√≥pur fj√∂gurra barna stendur og spjallar (blond stelpa √≠ bleikum bol, rau√∞h√¶r√∞ stelpa me√∞ gleraugu, drengur √≠ bl√°um bol, annar drengur √≠ fj√≥lubl√≠kum bol).
- Kennarinn: Fullor√∞in kona √≠ bl√°rri k√°pu/treyju heldur √° gr√¶nni m√∂ppu h√¶gra megin n√°l√¶gt t√∂flunni og dyrunum.
- Tafla: Stafr√≥fsr√∂nd "Aa‚ÄìBb‚ÄìCe‚Äì..." og t√∂lur 1‚Äì5. Bandar√≠ski f√°ninn hangir vi√∞ t√∂fluna.
- T√¶ki og r√Ωmi: Klukka yfir dyrum, hangandi sj√≥nvarp/loftt√¶ki, hur√∞ me√∞ gulu gleri, kennarabor√∞ me√∞ bor√∞l√≠mmi√∞a/klemmu (tape-dispenser).
- Vinstri bakgrunnur: St√≥rir gluggar me√∞ gr√¶num trj√°m og t√∫num fyrir utan. Vaskur me√∞ s√°pu (SOAP 30 oz) og papp√≠rs√æurrkuboxi √° vegg.
- Stemning: Gl√∂√∞, virk og samvinnufull.
SANNREYNDINGARSTA√êREYNDIR (nota √≠ sv√∂rum):
- B√∂rn √° mynd: 9.
- B√∂rn vi√∞ mi√∞jubor√∞: 4.
- B√∂rn sem standa aftast: 4.
- Barn sem m√°lar √° striga: 1.
- Kennari: 1 (kona).
- T√∂lur √° t√∂flu: 1 til 5.
- Helstu hlutir: sk√¶ri, l√≠m (flaska og l√≠mstift), reglustika, litir, b√≥k, papp√≠r, tr√∂nur, penslar, m√°lningard√≥sir, sj√≥nvarp, vaskur, s√°pa, papp√≠rs√æurrkur.
`;

    function App() {\n      const [messages, setMessages] = useState([]); // {role: 'user'|'bot'|'grammar', text}\n      const [input, setInput] = useState('');\n      const [loading, setLoading] = useState(false);\n      const scrollerRef = useRef(null);\n\n      // QUIZ state\n      const [quizQ, setQuizQ] = useState(null); // {question, options:[{text, correct}], explanation}\n      const [quizAnswered, setQuizAnswered] = useState(false);\n      const [quizScore, setQuizScore] = useState({correct:0, total:0});\n\n      // helpers\n      const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];\n      const shuffle = (arr) => arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(({v})=>v);\n\n      const questionBank = [\n        {\n          question: 'Hversu m√∂rg b√∂rn eru √° myndinni?',\n          options: [\n            { text: '7', correct: false },\n            { text: '8', correct: false },\n            { text: '9', correct: true },\n            { text: '10', correct: false },\n          ],\n          explanation: '√ûa√∞ eru 9 b√∂rn: 4 vi√∞ bor√∞i√∞, 4 aftast og 1 a√∞ m√°la.'\n        },\n        {\n          question: 'Hversu m√∂rg b√∂rn sitja vi√∞ st√≥ra bor√∞i√∞?',\n          options: [\n            { text: '2', correct: false },\n            { text: '3', correct: false },\n            { text: '4', correct: true },\n            { text: '5', correct: false },\n          ],\n          explanation: 'Fj√∂gur b√∂rn sitja vi√∞ bor√∞i√∞.'\n        },\n        {\n          question: 'Hva√∞ s√©r√∞u √° t√∂flunni?',\n          options: [\n            { text: 'T√∂lurnar 1‚Äì5 og stafr√≥f', correct: true },\n            { text: 'D√Ωr og tr√©', correct: false },\n            { text: 'Ekkert', correct: false },\n            { text: 'J√∂fnur √≠ algebru', correct: false },\n          ],\n          explanation: '√Å t√∂flunni sj√°st t√∂lurnar 1‚Äì5 og stafr√≥fsr√∂nd.'\n        },\n        {\n          question: 'Er bandar√≠ski f√°ninn √° myndinni?',\n          options: [\n            { text: 'J√°', correct: true },\n            { text: 'Nei', correct: false },\n          ],\n          explanation: 'J√°, hann hangir vi√∞ t√∂fluna h√¶gra megin.'\n        },\n        {\n          question: 'Hva√∞ er barni√∞ √° tr√∂nunum a√∞ gera?',\n          options: [\n            { text: 'M√°lar bl√°tt d√Ωr og tr√©', correct: true },\n            { text: 'Les b√≥k', correct: false },\n            { text: 'Spilar √° g√≠tar', correct: false },\n            { text: 'Reiknar d√¶mi', correct: false },\n          ],\n          explanation: 'Barni√∞ m√°lar bl√°tt d√Ωr (l√≠kt hesti), s√≥l og tr√©.'\n        },\n        {\n          question: 'Hva√∞ stendur kennarinn?',\n          options: [\n            { text: 'H√¶gra megin n√°l√¶gt t√∂flunni og dyrunum', correct: true },\n            { text: 'Vi√∞ gluggana vinstra megin', correct: false },\n            { text: 'Vi√∞ vaskinn', correct: false },\n            { text: 'Utan vi√∞ stofuna', correct: false },\n          ],\n          explanation: 'Kennarinn stendur h√¶gra megin me√∞ gr√¶na m√∂ppu.'\n        },\n        {\n          question: 'Hva√∞a verkf√¶ri og efni eru √° bor√∞inu?',\n          options: [\n            { text: 'Sk√¶ri, l√≠m, reglustika, litir og papp√≠r', correct: true },\n            { text: 'Hamar og naglar', correct: false },\n            { text: 'Skyr og rj√≥mi', correct: false },\n            { text: 'H√°rbl√°sari og grei√∞a', correct: false },\n          ],\n          explanation: '√Å bor√∞inu eru sk√¶ri, l√≠m (flaska + l√≠mstift), reglustika, litir og papp√≠r.'\n        },\n        {\n          question: 'Eru fj√∂gur b√∂rn a√∞ standa aftast og spjalla?',\n          options: [\n            { text: 'J√°', correct: true },\n            { text: 'Nei', correct: false },\n          ],\n          explanation: 'J√°, fj√∂gur b√∂rn standa aftast √≠ h√≥p.'\n        },\n        {\n          question: 'Er sj√≥nvarp/loftt√¶ki hangandi √° veggnum?',\n          options: [\n            { text: 'J√°', correct: true },\n            { text: 'Nei', correct: false },\n          ],\n          explanation: 'J√°, hangandi skj√°r/t√¶ki er √° veggnum.'\n        },\n        {\n          question: 'Er vaskur me√∞ s√°pu vinstra megin?',\n          options: [\n            { text: 'J√°', correct: true },\n            { text: 'Nei', correct: false },\n          ],\n          explanation: 'J√°, vaskur og s√°pa eru undir gluggunum.'\n        },\n      ];\n\n      function askRandomQuestion(){\n        const q = { ...pick(questionBank) };\n        q.options = shuffle(q.options);\n        setQuizQ(q);\n        setQuizAnswered(false);\n      }\n\n      function answerOption(idx){\n        if (!quizQ || quizAnswered) return;\n        const correct = quizQ.options[idx].correct;\n        setQuizAnswered(true);\n        setQuizScore(s=>({correct: s.correct + (correct?1:0), total: s.total + 1}));\n      }\n\n      // Auto scroll to bottom\n      useEffect(() => {\n        if (scrollerRef.current) {\n          scrollerRef.current.scrollTop = scrollerRef.current.scrollHeight;\n        }\n      }, [messages, loading]);\n\n      // Kick off with a friendly opener\n      useEffect(() => {\n        setMessages([\n          { role: 'bot', text: 'H√¶! Sko√∞um myndina saman. Hva√∞ heldur √æ√∫ a√∞ √æau s√©u a√∞ l√¶ra?' }\n        ]);\n      }, []);\n\n      async function send() {\n        if (!input.trim() || loading) return;\n        const userText = input.trim();\n        setInput('');\n        setMessages(prev => [...prev, { role: 'user', text: userText }]);\n        setLoading(true);\n        try {\n          const history = messages\n            .filter(m => m.role !== 'grammar')\n            .map(m => `${m.role === 'user' ? 'Nemandi' : 'Kennari'}: ${m.text}`)\n            .join('\n');\n\n          const userPrompt = `MYNDAL√ùSING:\n${IMAGE_CONTEXT}\n\nSAMTAL HINGA√ê TIL:\n${history}\n\nS√ç√êASTA SVAR NEMANDA:\n${userText}\n\nGer√∞u n√∫ n√¶stu *einu* spurningu (stutta) og gef√∞u a√∞eins m√°lfarsendurgj√∂f ef gr√≥f villa er √≠ svari nemanda.`;\n\n          const content = await callOpenAI({\n            model: 'gpt-4o',\n            temperature: 0.7,\n            max_tokens: 300,\n            messages: [\n              { role: 'system', content: SYSTEM_PROMPT },\n              { role: 'user', content: userPrompt }\n            ]\n          });\n\n          const parsed = parseJSONSafe(content);\n\n          if (parsed.grammar && parsed.grammar !== 'null') {\n            setMessages(prev => [...prev, { role: 'grammar', text: parsed.grammar }]);\n          }\n          setMessages(prev => [...prev, { role: 'bot', text: parsed.response || 'Fr√°b√¶rt! Hva√∞ s√©r√∞u meira √° myndinni?' }]);\n        } catch (e) {\n          setMessages(prev => [...prev, { role: 'bot', text: '√öbbs! √ûa√∞ kom upp villa. Reyndu aftur.' }]);\n          console.error(e);\n        } finally {\n          setLoading(false);\n        }\n      }\n\n      function onKey(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } }\n\n      return (
        <main className="space-y-6">
          <header className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-normal tracking-tight">M√°lst√∂√∞in ‚Äì Mynd + spjall√¶fing</h1>
              <p className="text-[color:var(--muted)]">Stig: A1‚ÄìA2 ¬∑ √û√∫ f√¶r√∞ eina spurningu √≠ einu og mj√∫ka m√°lfarsendurgj√∂f ef √æarf.</p>
            </div>
            <span className="text-2xl" title="√Üfing um sk√≥lastofu">üè´</span>
          </header>

          <section className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Image card */}
            <div className="card rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 className="font-normal">Mynd</h2>
                <span className="text-[13px] text-[color:var(--muted)]">L√Ωstu √æv√≠ sem √æ√∫ s√©r√∞</span>
              </div>
              <div className="p-4">
                <!-- REPLACE src WITH YOUR HOSTED IMAGE PATH -->
                <img src="classroom.jpg" alt="Sk√≥lastofa me√∞ b√∂rnum a√∞ vinna list og handverk" className="w-full rounded-xl border border-gray-200" />
                <p className="mt-3 text-[color:var(--muted)] text-sm">V√≠sbendingar: t√∂lur √° t√∂flu, bor√∞ me√∞ sk√¶rum og l√≠mi, barn a√∞ m√°la √° striga, kennari til hli√∞ar.</p>
              </div>
            </div>

            {/* Chat card */}
            <div className="card rounded-2xl flex flex-col max-h-[70vh]">
              <div className="p-4 border-b border-gray-200 flex items-center gap-2">
                <h2 className="font-normal">Samtal</h2>
                <span className="text-[12px] text-[color:var(--muted)]">Eina spurningu √≠ einu ‚ú®</span>
              </div>

              <div ref={scrollerRef} className="flex-1 overflow-y-auto p-4 space-y-3">
                {messages.map((m, i) => (
                  <div key={i} className={
                    m.role === 'user' ? 'ml-auto max-w-[85%] bubble-user rounded-2xl px-3 py-2 shadow-sm' :
                    m.role === 'grammar' ? 'mx-auto max-w-[85%] bubble-grammar rounded-2xl px-3 py-2 shadow-sm text-sm' :
                    'mr-auto max-w-[85%] bubble-bot rounded-2xl px-3 py-2 shadow-sm'
                  }>
                    <div className="text-[13px] text-[color:var(--muted)] mb-1">
                      {m.role === 'user' ? '√û√∫' : m.role === 'grammar' ? 'üìö M√°lfar' : 'M√≠mi'}
                    </div>
                    <div className="leading-relaxed whitespace-pre-wrap">{m.text}</div>
                  </div>
                ))}
                {loading && (
                  <div className="mr-auto max-w-[60%] bubble-bot rounded-2xl px-3 py-2 shadow-sm text-[14px]">...
                  </div>
                )}
              </div>

              <div className="border-t border-gray-200 p-3">
                <div className="flex items-end gap-2">
                  <textarea
                    className="flex-1 resize-none h-12 rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[color:var(--sel)]"
                    placeholder="Skrifa√∞u svari√∞ √æitt h√©r og √Ωttu √° Enter..."
                    value={input}
                    onChange={(e)=>setInput(e.target.value)}
                    onKeyDown={onKey}
                  />
                  <button onClick={send} disabled={loading || !input.trim()}
                    className="rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white disabled:opacity-50 hover:opacity-90 transition">
                    {loading ? 'Sendi‚Ä¶' : 'Senda'}
                  </button>
                </div>
                <p className="text-[12px] text-[color:var(--muted)] mt-2">V√≠sbending: √û√∫ getur svara√∞ t.d. ‚Äû√âg held a√∞ √æau l√¶ri st√¶r√∞fr√¶√∞i af √æv√≠ a√∞ t√∂lur eru √° t√∂flunni.‚Äú</p>
              </div>
            </div>
                      {/* Quiz card */}\n            <div className=\"card rounded-2xl p-4 md:col-span-2\">\n              <div className=\"flex items-center justify-between border-b border-gray-200 pb-3 mb-3\">\n                <h2 className=\"font-normal\">Quiz ‚Äì Sta√∞reyndir um myndina</h2>\n                <div className=\"text-sm text-[color:var(--muted)]\">Stig: {quizScore.correct}/{quizScore.total}</div>\n              </div>\n              <div className=\"space-y-3\">\n                {!quizQ && (\n                  <button onClick={askRandomQuestion} className=\"rounded-xl px-4 py-2 bg-[color:var(--sel)] text-white hover:opacity-90 transition\">Spyrja um myndina</button>\n                )}\n                {quizQ && (\n                  <div className=\"space-y-3\">\n                    <p className=\"text-[15px]\"><strong>Spurning:</strong> {quizQ.question}</p>\n                    <div className=\"grid sm:grid-cols-2 gap-2\">\n                      {quizQ.options.map((op,idx)=>{\n                        const base = 'rounded-xl px-3 py-2 border transition text-left';\n                        const idle = 'border-gray-200 hover:bg-[color:var(--sel-100)]';\n                        const good = 'border-[color:var(--ok)] bg-[color:var(--ok-100)]';\n                        const bad  = 'border-[color:var(--err)] bg-[color:var(--err-100)]';\n                        const cls = !quizAnswered ? `${base} ${idle}` : `${base} ${op.correct?good:bad}`;\n                        return (\n                          <button key={idx} onClick={()=>answerOption(idx)} disabled={quizAnswered} className={cls}>\n                            {op.text}\n                          </button>\n                        );})}\n                    </div>\n                    {quizAnswered && (\n                      <div className=\"text-sm text-[color:var(--muted)]\">{quizQ.explanation}</div>\n                    )}\n                    <div className=\"pt-1\">\n                      <button onClick={()=>{ setQuizQ(null); }} className=\"rounded-xl px-4 py-2 border border-gray-300 hover:bg-gray-50\">N√¶sta spurning</button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </section>

          <footer className="pt-4 text-[13px] text-[color:var(--muted)]">
            <p>Gervigreind: gpt-4o ¬∑ hitastig 0.7 ¬∑ max 300 tokens. M√°lfarsendurgj√∂f er v√¶g og birtist √≠ bl√°rri bobblu.</p>
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
