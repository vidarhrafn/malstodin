<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Sj√°lfspr√≥f ‚Äì M√°lst√∂√∞in</title>
  <script src="lesson-config.js"></script>
  <script src="lesson-navigation.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
    .answer-option {
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
      cursor: pointer;
    }
    .answer-option:hover:not(.disabled) {
      border-color: #2196f3;
      background: #e3f2fd;
    }
    .answer-option.selected {
      border-color: #2196f3;
      background: #e3f2fd;
    }
    .answer-option.correct {
      border-color: #4caf50;
      background: #e8f5e9;
    }
    .answer-option.incorrect {
      border-color: #f44336;
      background: #ffebee;
    }
    .answer-option.disabled {
      cursor: default;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    async function callOpenAI(payload) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    // Pre-defined translations for TOP 5 languages
    const SUPPORTED_LANGUAGES = {
      'English': {
        questionTemplates: {
          'meaning': 'What does "{word}" mean?',
          'fillBlank': 'Fill in the blank',
          'listening': 'What did you hear?',
          'reading': 'Read the text and answer',
          'translate': 'Translate to {language}'
        },
        vocabulary: {
          'heita': { correct: 'to be called', wrong: ['to live', 'to work', 'to speak'] },
          'b√∫a': { correct: 'to live', wrong: ['to work', 'to speak', 'to eat'] },
          'vinna': { correct: 'to work', wrong: ['to win', 'to live', 'to speak'] },
          'elska': { correct: 'to love', wrong: ['to hate', 'to like', 'to eat'] },
          'tala': { correct: 'to speak', wrong: ['to work', 'to listen', 'to write'] }
        },
        readingOptions: {
          q1: ['Iceland', 'Sweden', 'Denmark', 'Norway'],
          q2: ['office', 'preschool', 'school', 'hospital'],
          q3: ['works', 'sleeps', 'goes into nature', 'watches TV']
        }
      },
      'Spanish': {
        questionTemplates: {
          'meaning': '¬øQu√© significa "{word}"?',
          'fillBlank': 'Completa el espacio',
          'listening': '¬øQu√© escuchaste?',
          'reading': 'Lee el texto y responde',
          'translate': 'Traduce a {language}'
        },
        vocabulary: {
          'heita': { correct: 'llamarse', wrong: ['vivir', 'trabajar', 'hablar'] },
          'b√∫a': { correct: 'vivir', wrong: ['trabajar', 'hablar', 'comer'] },
          'vinna': { correct: 'trabajar', wrong: ['ganar', 'vivir', 'hablar'] },
          'elska': { correct: 'amar', wrong: ['odiar', 'gustar', 'comer'] },
          'tala': { correct: 'hablar', wrong: ['trabajar', 'escuchar', 'escribir'] }
        },
        readingOptions: {
          q1: ['Islandia', 'Suecia', 'Dinamarca', 'Noruega'],
          q2: ['oficina', 'guarder√≠a', 'escuela', 'hospital'],
          q3: ['trabaja', 'duerme', 'va a la naturaleza', 've la televisi√≥n']
        }
      },
      'Vietnamese': {
        questionTemplates: {
          'meaning': '"{word}" c√≥ nghƒ©a l√† g√¨?',
          'fillBlank': 'ƒêi·ªÅn v√†o ch·ªó tr·ªëng',
          'listening': 'B·∫°n nghe ƒë∆∞·ª£c g√¨?',
          'reading': 'ƒê·ªçc ƒëo·∫°n vƒÉn v√† tr·∫£ l·ªùi',
          'translate': 'D·ªãch sang {language}'
        },
        vocabulary: {
          'heita': { correct: 't√™n l√†', wrong: ['s·ªëng', 'l√†m vi·ªác', 'n√≥i'] },
          'b√∫a': { correct: 's·ªëng', wrong: ['l√†m vi·ªác', 'n√≥i', 'ƒÉn'] },
          'vinna': { correct: 'l√†m vi·ªác', wrong: ['th·∫Øng', 's·ªëng', 'n√≥i'] },
          'elska': { correct: 'y√™u', wrong: ['gh√©t', 'th√≠ch', 'ƒÉn'] },
          'tala': { correct: 'n√≥i', wrong: ['l√†m vi·ªác', 'nghe', 'vi·∫øt'] }
        },
        readingOptions: {
          q1: ['Iceland', 'Th·ª•y ƒêi·ªÉn', 'ƒêan M·∫°ch', 'Na Uy'],
          q2: ['vƒÉn ph√≤ng', 'm·∫´u gi√°o', 'tr∆∞·ªùng h·ªçc', 'b·ªánh vi·ªán'],
          q3: ['l√†m vi·ªác', 'ng·ªß', 'ƒëi v√†o thi√™n nhi√™n', 'xem TV']
        }
      },
      'Ukrainian': {
        questionTemplates: {
          'meaning': '–©–æ –æ–∑–Ω–∞—á–∞—î "{word}"?',
          'fillBlank': '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø—Ä–æ–ø—É—Å–∫',
          'listening': '–©–æ —Ç–∏ –ø–æ—á—É–≤?',
          'reading': '–ü—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç —ñ –¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å',
          'translate': '–ü–µ—Ä–µ–∫–ª–∞–¥—ñ—Ç—å –Ω–∞ {language}'
        },
        vocabulary: {
          'heita': { correct: '–∑–≤–∞—Ç–∏', wrong: ['–∂–∏—Ç–∏', '–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', '–≥–æ–≤–æ—Ä–∏—Ç–∏'] },
          'b√∫a': { correct: '–∂–∏—Ç–∏', wrong: ['–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', '–≥–æ–≤–æ—Ä–∏—Ç–∏', '—ó—Å—Ç–∏'] },
          'vinna': { correct: '–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', wrong: ['–ø–µ—Ä–µ–º–∞–≥–∞—Ç–∏', '–∂–∏—Ç–∏', '–≥–æ–≤–æ—Ä–∏—Ç–∏'] },
          'elska': { correct: '–ª—é–±–∏—Ç–∏', wrong: ['–Ω–µ–Ω–∞–≤–∏–¥—ñ—Ç–∏', '–ø–æ–¥–æ–±–∞—Ç–∏—Å—è', '—ó—Å—Ç–∏'] },
          'tala': { correct: '–≥–æ–≤–æ—Ä–∏—Ç–∏', wrong: ['–ø—Ä–∞—Ü—é–≤–∞—Ç–∏', '—Å–ª—É—Ö–∞—Ç–∏', '–ø–∏—Å–∞—Ç–∏'] }
        },
        readingOptions: {
          q1: ['–Ü—Å–ª–∞–Ω–¥—ñ—è', '–®–≤–µ—Ü—ñ—è', '–î–∞–Ω—ñ—è', '–ù–æ—Ä–≤–µ–≥—ñ—è'],
          q2: ['–æ—Ñ—ñ—Å', '–¥–∏—Ç—Å–∞–¥–æ–∫', '—à–∫–æ–ª–∞', '–ª—ñ–∫–∞—Ä–Ω—è'],
          q3: ['–ø—Ä–∞—Ü—é—î', '—Å–ø–∏—Ç—å', '–≤–∏—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–∏—Ä–æ–¥—É', '–¥–∏–≤–∏—Ç—å—Å—è —Ç–µ–ª–µ–≤—ñ–∑–æ—Ä']
        }
      },
      'Arabic': {
        questionTemplates: {
          'meaning': 'ŸÖÿß ŸÖÿπŸÜŸâ "{word}"ÿü',
          'fillBlank': 'ÿßŸÖŸÑÿ£ ÿßŸÑŸÅÿ±ÿßÿ∫',
          'listening': 'ŸÖÿßÿ∞ÿß ÿ≥ŸÖÿπÿ™ÿü',
          'reading': 'ÿßŸÇÿ±ÿ£ ÿßŸÑŸÜÿµ Ÿàÿ£ÿ¨ÿ®',
          'translate': 'ÿ™ÿ±ÿ¨ŸÖ ÿ•ŸÑŸâ {language}'
        },
        vocabulary: {
          'heita': { correct: 'ŸäŸèÿØÿπŸâ', wrong: ['ŸäÿπŸäÿ¥', 'ŸäÿπŸÖŸÑ', 'Ÿäÿ™ŸÉŸÑŸÖ'] },
          'b√∫a': { correct: 'ŸäÿπŸäÿ¥', wrong: ['ŸäÿπŸÖŸÑ', 'Ÿäÿ™ŸÉŸÑŸÖ', 'Ÿäÿ£ŸÉŸÑ'] },
          'vinna': { correct: 'ŸäÿπŸÖŸÑ', wrong: ['ŸäŸÅŸàÿ≤', 'ŸäÿπŸäÿ¥', 'Ÿäÿ™ŸÉŸÑŸÖ'] },
          'elska': { correct: 'Ÿäÿ≠ÿ®', wrong: ['ŸäŸÉÿ±Ÿá', 'Ÿäÿπÿ¨ÿ®', 'Ÿäÿ£ŸÉŸÑ'] },
          'tala': { correct: 'Ÿäÿ™ŸÉŸÑŸÖ', wrong: ['ŸäÿπŸÖŸÑ', 'Ÿäÿ≥ŸÖÿπ', 'ŸäŸÉÿ™ÿ®'] }
        },
        readingOptions: {
          q1: ['ÿ¢Ÿäÿ≥ŸÑŸÜÿØÿß', 'ÿßŸÑÿ≥ŸàŸäÿØ', 'ÿßŸÑÿØŸÜŸÖÿßÿ±ŸÉ', 'ÿßŸÑŸÜÿ±ŸàŸäÿ¨'],
          q2: ['ŸÖŸÉÿ™ÿ®', 'ÿ±Ÿàÿ∂ÿ© ÿ£ÿ∑ŸÅÿßŸÑ', 'ŸÖÿØÿ±ÿ≥ÿ©', 'ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ'],
          q3: ['ŸäÿπŸÖŸÑ', 'ŸäŸÜÿßŸÖ', 'Ÿäÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑÿ∑ÿ®Ÿäÿπÿ©', 'Ÿäÿ¥ÿßŸáÿØ ÿßŸÑÿ™ŸÑŸÅÿ≤ŸäŸàŸÜ']
        }
      }
    };

    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function getTranslatedVocabQuestion(word, userLanguage) {
      if (SUPPORTED_LANGUAGES[userLanguage]) {
        const data = SUPPORTED_LANGUAGES[userLanguage];
        const question = data.questionTemplates.meaning.replace('{word}', word);
        const vocab = data.vocabulary[word];
        
        const allOptions = shuffle([vocab.correct, ...vocab.wrong]);
        const correctIndex = allOptions.indexOf(vocab.correct);
        
        return {
          question: question,
          options: allOptions,
          correct: correctIndex
        };
      }
      
      // Fallback to OpenAI
      const englishMeaning = SUPPORTED_LANGUAGES['English'].vocabulary[word].correct;
      const sys = `
You are a translation expert.

TASK: Translate this Icelandic vocabulary test question to ${userLanguage}.

ICELANDIC WORD: "${word}"
CORRECT MEANING IN ENGLISH: "${englishMeaning}"

CREATE:
1. Question in ${userLanguage} asking "What does '${word}' mean?"
2. 4 answer options in ${userLanguage} (1 correct + 3 plausible wrong answers)
3. Wrong answers should be similar verbs (good distractors)

RETURN JSON ONLY (NO MARKDOWN):
{
  "question": "translated question",
  "options": ["option1", "option2", "option3", "option4"],
  "correct": 0
}

Randomize the position of the correct answer!
`;

      const response = await callOpenAI({
        model: 'gpt-4o',
        temperature: 0.3,
        max_tokens: 300,
        messages: [
          { role: 'system', content: sys },
          { role: 'user', content: 'Translate question' }
        ]
      });

      let cleaned = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').replace(/^[^{]*/g, '').replace(/[^}]*$/g, '').trim();
      return JSON.parse(cleaned);
    }

    async function getTranslatedTemplate(templateKey, userLanguage, vars = {}) {
      if (SUPPORTED_LANGUAGES[userLanguage]) {
        let template = SUPPORTED_LANGUAGES[userLanguage].questionTemplates[templateKey];
        Object.keys(vars).forEach(key => {
          template = template.replace(`{${key}}`, vars[key]);
        });
        return template;
      }
      
      // Fallback to OpenAI
      const englishTemplate = SUPPORTED_LANGUAGES['English'].questionTemplates[templateKey];
      const sys = `Translate this test instruction from English to ${userLanguage}: "${englishTemplate}"
Only return the translated text, nothing else.`;

      const response = await callOpenAI({
        model: 'gpt-4o',
        temperature: 0.2,
        max_tokens: 100,
        messages: [
          { role: 'system', content: sys },
          { role: 'user', content: 'Translate' }
        ]
      });

      return response.trim().replace(/^["']|["']$/g, '');
    }

    async function getTranslatedReadingOptions(questionKey, userLanguage) {
      if (SUPPORTED_LANGUAGES[userLanguage]) {
        return SUPPORTED_LANGUAGES[userLanguage].readingOptions[questionKey];
      }
      
      // Fallback to OpenAI
      const englishOptions = SUPPORTED_LANGUAGES['English'].readingOptions[questionKey];
      const sys = `Translate these answer options from English to ${userLanguage}: ${JSON.stringify(englishOptions)}
Return ONLY a JSON array with the translations in the SAME ORDER: ["option1", "option2", "option3", "option4"]`;

      const response = await callOpenAI({
        model: 'gpt-4o',
        temperature: 0.2,
        max_tokens: 150,
        messages: [
          { role: 'system', content: sys },
          { role: 'user', content: 'Translate' }
        ]
      });

      let cleaned = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      return JSON.parse(cleaned);
    }

    const Sjalfsprof = () => {
      const [view, setView] = useState('intro');
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [answers, setAnswers] = useState({});
      const [showReview, setShowReview] = useState(false);
      const [questions, setQuestions] = useState([]);
      const [loading, setLoading] = useState(false);
      const [userLanguage, setUserLanguage] = useState('English');
      const [lessonInfo, setLessonInfo] = useState(null);

      useEffect(() => {
        const info = getLessonInfo('sjalfsprof');
        setLessonInfo(info);
        
        const saved = localStorage.getItem('userLanguage') || 'English';
        setUserLanguage(saved);
      }, []);

      const startQuiz = async () => {
        setLoading(true);
        setView('loading');
        
        try {
          const quizQuestions = await generateQuestions(userLanguage);
          setQuestions(quizQuestions);
          setView('quiz');
          setCurrentQuestion(0);
          setAnswers({});
        } catch (e) {
          console.error('Error generating quiz:', e);
          alert('Villa vi√∞ a√∞ b√∫a til pr√≥f. Reyndu aftur.');
          setView('intro');
        } finally {
          setLoading(false);
        }
      };

      const generateQuestions = async (lang) => {
        const qs = [];

        // 1. Vocabulary questions (5)
        const vocabWords = ['heita', 'b√∫a', 'vinna', 'elska', 'tala'];
        for (const word of vocabWords) {
          const q = await getTranslatedVocabQuestion(word, lang);
          qs.push({
            type: 'vocab',
            ...q
          });
        }

        // 2. Grammar fill-in-the-blank (3)
        const fillBlankLabel = await getTranslatedTemplate('fillBlank', lang);
        qs.push({
          type: 'grammar',
          question: fillBlankLabel,
          sentence: '√âg _____ Anna.',
          options: ['heiti', 'heitir', 'heita', 'heitum'],
          correct: 0
        });
        qs.push({
          type: 'grammar',
          question: fillBlankLabel,
          sentence: '√âg _____ fr√° √ökra√≠nu.',
          options: ['eru', 'ert', 'er', 'erum'],
          correct: 2
        });
        qs.push({
          type: 'grammar',
          question: fillBlankLabel,
          sentence: '√âg _____ √≠ Reykjav√≠k.',
          options: ['b√Ωr', 'b√Ω', 'b√∫a', 'b√∫um'],
          correct: 1
        });

        // 3. Listening (3) - Using TTS
        const listeningLabel = await getTranslatedTemplate('listening', lang);
        qs.push({
          type: 'listening',
          question: listeningLabel,
          audio: '√âg tala √≠slensku og ensku',
          options: ['√âg tala sp√¶nsku og ensku', '√âg tala √≠slensku og √æ√Ωsku', '√âg tala √≠slensku og ensku', '√âg tala ensku og r√∫ssnesku'],
          correct: 2
        });
        qs.push({
          type: 'listening',
          question: listeningLabel,
          audio: '√Å morgnana drekk √©g kaffi',
          options: ['Te', 'Kaffi', 'Vatn', 'Mj√≥lk'],
          correct: 1,
          subQuestion: 'Hva√∞ drekkur pers√≥nan √° morgnana?'
        });
        qs.push({
          type: 'listening',
          question: listeningLabel,
          audio: 'Eftir vinnu fer √©g √≠ l√≠kamsr√¶kt',
          options: ['Fer heim', 'Fer √≠ b√≠√≥', 'Fer √≠ l√≠kamsr√¶kt', 'Fer a√∞ sofa'],
          correct: 2,
          subQuestion: 'Hva√∞ gerir pers√≥nan eftir vinnu?'
        });

        // 4. Reading comprehension (3)
        const readingLabel = await getTranslatedTemplate('reading', lang);
        const readingOpts1 = await getTranslatedReadingOptions('q1', lang);
        const readingOpts2 = await getTranslatedReadingOptions('q2', lang);
        const readingOpts3 = await getTranslatedReadingOptions('q3', lang);

        qs.push({
          type: 'reading',
          question: readingLabel,
          text: '√âg heiti J√≥n. √âg er fr√° Danm√∂rku. √âg b√Ω √≠ Reykjav√≠k n√∫na.',
          subQuestion: 'Hva√∞an er J√≥n?',
          options: readingOpts1,
          correct: 2
        });
        qs.push({
          type: 'reading',
          question: readingLabel,
          text: 'Anna vinnur √° leiksk√≥la. H√∫n elskar starfi√∞ sitt.',
          subQuestion: 'Hvar vinnur Anna?',
          options: readingOpts2,
          correct: 1
        });
        qs.push({
          type: 'reading',
          question: readingLabel,
          text: 'Um helgar fer √©g √∫t √≠ n√°tt√∫runa. √âg elska a√∞ taka myndir.',
          subQuestion: 'Hva√∞ gerir pers√≥nan um helgar?',
          options: readingOpts3,
          correct: 2
        });

        // 5. Translation (2)
        const translateLabel = await getTranslatedTemplate('translate', lang, { language: lang });
        qs.push({
          type: 'translation',
          question: translateLabel,
          icelandic: '√âg b√Ω √≠ Reykjav√≠k',
          userAnswer: ''
        });
        qs.push({
          type: 'translation',
          question: translateLabel,
          icelandic: '√âg tala √≠slensku',
          userAnswer: ''
        });

        return qs;
      };

      const handleAnswer = (answer) => {
        setAnswers({ ...answers, [currentQuestion]: answer });
      };

      const nextQuestion = () => {
        if (currentQuestion < questions.length - 1) {
          setCurrentQuestion(currentQuestion + 1);
        } else {
          finishQuiz();
        }
      };

      const prevQuestion = () => {
        if (currentQuestion > 0) {
          setCurrentQuestion(currentQuestion - 1);
        }
      };

      const finishQuiz = async () => {
        setLoading(true);
        
        // Evaluate translation questions with OpenAI
        const finalAnswers = { ...answers };
        
        for (let i = 0; i < questions.length; i++) {
          if (questions[i].type === 'translation' && answers[i]) {
            try {
              const result = await evaluateTranslation(questions[i].icelandic, answers[i], userLanguage);
              finalAnswers[i] = { text: answers[i], correct: result.correct };
            } catch (e) {
              console.error('Translation evaluation error:', e);
              finalAnswers[i] = { text: answers[i], correct: false };
            }
          }
        }
        
        setAnswers(finalAnswers);
        setLoading(false);
        setShowReview(true);
        setView('results');
      };

      const evaluateTranslation = async (icelandic, translation, lang) => {
        const sys = `
You are evaluating an Icelandic to ${lang} translation by a beginner student.

ICELANDIC: "${icelandic}"
STUDENT TRANSLATION: "${translation}"

Accept translations that:
- Have the correct meaning (even if wording varies)
- Have minor grammar errors in ${lang} (we're testing Icelandic comprehension!)
- Omit minor words like articles if the meaning is clear

Reject if:
- Major parts are missing
- Meaning is wrong
- Student clearly didn't understand

RETURN JSON ONLY:
{
  "correct": boolean
}
`;

        const response = await callOpenAI({
          model: 'gpt-4o',
          temperature: 0.2,
          max_tokens: 100,
          messages: [
            { role: 'system', content: sys },
            { role: 'user', content: 'Evaluate' }
          ]
        });

        let cleaned = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').replace(/^[^{]*/g, '').replace(/[^}]*$/g, '').trim();
        return JSON.parse(cleaned);
      };

      const calculateScore = () => {
        let correct = 0;
        questions.forEach((q, i) => {
          if (q.type === 'translation') {
            if (answers[i]?.correct) correct++;
          } else {
            if (answers[i] === q.correct) correct++;
          }
        });
        return Math.round((correct / questions.length) * 100);
      };

      const getBreakdown = () => {
        const breakdown = {
          vocab: { correct: 0, total: 0 },
          grammar: { correct: 0, total: 0 },
          listening: { correct: 0, total: 0 },
          reading: { correct: 0, total: 0 },
          translation: { correct: 0, total: 0 }
        };

        questions.forEach((q, i) => {
          breakdown[q.type].total++;
          if (q.type === 'translation') {
            if (answers[i]?.correct) breakdown[q.type].correct++;
          } else {
            if (answers[i] === q.correct) breakdown[q.type].correct++;
          }
        });

        return breakdown;
      };

      const resetQuiz = () => {
        setView('intro');
        setCurrentQuestion(0);
        setAnswers({});
        setShowReview(false);
        setQuestions([]);
      };

      const playAudio = (text) => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'is-IS';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
      };

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button 
                onClick={() => window.history.back()} 
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Sj√°lfspr√≥f</h1>
              <p className="text-gray-500 text-sm font-light">Pr√≥fa√∞u hva√∞ √æ√∫ hefur l√¶rt ¬∑ A1</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            {view === 'intro' && (
              <IntroView onStart={startQuiz} userLanguage={userLanguage} />
            )}

            {view === 'loading' && (
              <LoadingView />
            )}

            {view === 'quiz' && questions.length > 0 && (
              <QuizView
                question={questions[currentQuestion]}
                questionNumber={currentQuestion + 1}
                totalQuestions={questions.length}
                answer={answers[currentQuestion]}
                onAnswer={handleAnswer}
                onNext={nextQuestion}
                onPrev={prevQuestion}
                canGoNext={answers[currentQuestion] !== undefined}
                canGoPrev={currentQuestion > 0}
                playAudio={playAudio}
              />
            )}

            {view === 'results' && (
              <ResultsView
                score={calculateScore()}
                breakdown={getBreakdown()}
                questions={questions}
                answers={answers}
                onReset={resetQuiz}
                onReview={() => setShowReview(!showReview)}
                showReview={showReview}
                userLanguage={userLanguage}
              />
            )}

            {view === 'intro' && lessonInfo && (
              <>
                <div className="flex justify-between gap-4 mt-8 mb-6">
                  {lessonInfo.prev ? (
                    <a 
                      href={lessonInfo.prev.url}
                      className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                    >
                      ‚Üê {lessonInfo.prev.name}
                    </a>
                  ) : (
                    <a 
                      href="byrjun.html"
                      className="flex-1 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 hover:text-blue-600 transition-all text-center font-light"
                    >
                      ‚Üê Til baka
                    </a>
                  )}
                  
                  {lessonInfo.next ? (
                    <a 
                      href={lessonInfo.next.url}
                      className="flex-1 px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all text-center font-light"
                    >
                      {lessonInfo.next.name} ‚Üí
                    </a>
                  ) : (
                    <a 
                      href="byrjun.html"
                      className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all text-center font-light"
                    >
                      üéâ Kl√°ra√∞!
                    </a>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                  <div className="flex justify-between items-center mb-3">
                    <span className="text-sm text-gray-600 font-light">
                      Skref {lessonInfo.index + 1} af {lessonInfo.total}
                    </span>
                    <span className="text-lg text-blue-600 font-medium">
                      {Math.round(((lessonInfo.index + 1) / lessonInfo.total) * 100)}%
                    </span>
                  </div>
                  <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
                    <div 
                      className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-500"
                      style={{ width: `${((lessonInfo.index + 1) / lessonInfo.total) * 100}%` }}
                    ></div>
                  </div>
                  <div className="flex gap-2 mb-3">
                    {LESSON_CONFIG.lessons.map((lesson, i) => (
                      <div 
                        key={lesson.id}
                        className={`flex-1 h-3 rounded-full transition-all ${
                          i < lessonInfo.index ? 'bg-green-500' :
                          i === lessonInfo.index ? 'bg-blue-500' :
                          'bg-gray-200'
                        }`}
                      ></div>
                    ))}
                  </div>
                  <div className="flex flex-wrap gap-2 text-xs text-gray-500">
                    {LESSON_CONFIG.lessons.map((lesson, i) => (
                      <React.Fragment key={lesson.id}>
                        <span className={`${
                          i < lessonInfo.index ? 'text-green-600 font-medium' :
                          i === lessonInfo.index ? 'text-blue-600 font-semibold' :
                          'text-gray-400'
                        }`}>
                          {lesson.icon} {lesson.name}
                        </span>
                        {i < LESSON_CONFIG.lessons.length - 1 && <span className="text-gray-300">‚Üí</span>}
                      </React.Fragment>
                    ))}
                  </div>
                </div>
              </>
            )}
          </main>
        </div>
      );
    };

    const IntroView = ({ onStart, userLanguage }) => (
      <div className="bg-white rounded-lg shadow-sm p-8">
        <div className="text-center mb-8">
          <div className="text-6xl mb-4">üìä</div>
          <h2 className="text-2xl font-light text-gray-800 mb-4">Sj√°lfspr√≥f</h2>
          <p className="text-gray-600 font-light mb-6">
            Pr√≥fa√∞u hva√∞ √æ√∫ hefur l√¶rt √≠ Byrjun!
          </p>
          
          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6 max-w-md mx-auto">
            <div className="text-left space-y-3">
              <p className="text-sm text-gray-700 font-light">
                <strong>üìù 15 spurningar</strong>
              </p>
              <p className="text-sm text-gray-700 font-light">
                <strong>üéØ 5 tegundir:</strong> Or√∞afor√∞i, M√°lfr√¶√∞i, Hlustun, Lesskilningur, √û√Ω√∞ing
              </p>
              <p className="text-sm text-gray-700 font-light">
                <strong>‚úÖ 70% til a√∞ standast</strong>
              </p>
              <p className="text-sm text-gray-700 font-light">
                <strong>üåç M√≥√∞urm√°l:</strong> {userLanguage}
              </p>
            </div>
          </div>

          <button
            onClick={onStart}
            className="bg-gray-800 text-white px-8 py-3 rounded-md hover:bg-gray-700 transition-colors font-light text-lg"
          >
            Byrja pr√≥f
          </button>
        </div>
      </div>
    );

    const LoadingView = () => (
      <div className="bg-white rounded-lg shadow-sm p-8">
        <div className="text-center">
          <div className="text-6xl mb-4">‚è≥</div>
          <h2 className="text-2xl font-light text-gray-800 mb-4">B√Ωr til pr√≥f...</h2>
          <p className="text-gray-600 font-light">Augnablik...</p>
        </div>
      </div>
    );

    const QuizView = ({ question, questionNumber, totalQuestions, answer, onAnswer, onNext, onPrev, canGoNext, canGoPrev, playAudio }) => {
      const progress = (questionNumber / totalQuestions) * 100;

      return (
        <div className="bg-white rounded-lg shadow-sm p-8">
          <div className="mb-6">
            <div className="flex justify-between items-center mb-3">
              <span className="text-sm text-gray-600 font-light">
                Spurning {questionNumber} af {totalQuestions}
              </span>
              <span className="text-sm text-gray-600 font-light">
                {Math.round(progress)}%
              </span>
            </div>
            <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className="h-full bg-blue-500 rounded-full transition-all duration-300"
                style={{ width: `${progress}%` }}
              ></div>
            </div>
          </div>

          {question.type === 'vocab' && (
            <VocabQuestion question={question} answer={answer} onAnswer={onAnswer} />
          )}

          {question.type === 'grammar' && (
            <GrammarQuestion question={question} answer={answer} onAnswer={onAnswer} />
          )}

          {question.type === 'listening' && (
            <ListeningQuestion question={question} answer={answer} onAnswer={onAnswer} playAudio={playAudio} />
          )}

          {question.type === 'reading' && (
            <ReadingQuestion question={question} answer={answer} onAnswer={onAnswer} />
          )}

          {question.type === 'translation' && (
            <TranslationQuestion question={question} answer={answer} onAnswer={onAnswer} />
          )}

          <div className="flex justify-between mt-8">
            <button
              onClick={onPrev}
              disabled={!canGoPrev}
              className="px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-light"
            >
              ‚Üê Fyrri
            </button>
            <button
              onClick={onNext}
              disabled={!canGoNext}
              className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-light"
            >
              {questionNumber === totalQuestions ? 'Lj√∫ka' : 'N√¶sta'} ‚Üí
            </button>
          </div>
        </div>
      );
    };

    const VocabQuestion = ({ question, answer, onAnswer }) => (
      <div>
        <h3 className="text-xl font-normal text-gray-800 mb-6">{question.question}</h3>
        <div className="space-y-3">
          {question.options.map((option, i) => (
            <div
              key={i}
              onClick={() => onAnswer(i)}
              className={`answer-option p-4 rounded-lg ${answer === i ? 'selected' : ''}`}
            >
              <div className="flex items-center gap-3">
                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                  answer === i ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                }`}>
                  {answer === i && <div className="w-2 h-2 bg-white rounded-full"></div>}
                </div>
                <span className="font-light">{option}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );

    const GrammarQuestion = ({ question, answer, onAnswer }) => (
      <div>
        <h3 className="text-xl font-normal text-gray-800 mb-6">{question.question}</h3>
        <div className="bg-gray-50 p-4 rounded-lg mb-6">
          <p className="text-lg text-gray-800 font-light">{question.sentence}</p>
        </div>
        <div className="space-y-3">
          {question.options.map((option, i) => (
            <div
              key={i}
              onClick={() => onAnswer(i)}
              className={`answer-option p-4 rounded-lg ${answer === i ? 'selected' : ''}`}
            >
              <div className="flex items-center gap-3">
                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                  answer === i ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                }`}>
                  {answer === i && <div className="w-2 h-2 bg-white rounded-full"></div>}
                </div>
                <span className="font-light">{option}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );

    const ListeningQuestion = ({ question, answer, onAnswer, playAudio }) => (
      <div>
        <h3 className="text-xl font-normal text-gray-800 mb-6">{question.question}</h3>
        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6 text-center">
          <button
            onClick={() => playAudio(question.audio)}
            className="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-light"
          >
            üîä Spila hlj√≥√∞
          </button>
          <p className="text-sm text-gray-600 mt-3 font-light">
            √û√∫ getur hlusta√∞ eins oft og √æ√∫ vilt
          </p>
        </div>
        {question.subQuestion && (
          <p className="text-lg text-gray-700 mb-4 font-light">{question.subQuestion}</p>
        )}
        <div className="space-y-3">
          {question.options.map((option, i) => (
            <div
              key={i}
              onClick={() => onAnswer(i)}
              className={`answer-option p-4 rounded-lg ${answer === i ? 'selected' : ''}`}
            >
              <div className="flex items-center gap-3">
                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                  answer === i ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                }`}>
                  {answer === i && <div className="w-2 h-2 bg-white rounded-full"></div>}
                </div>
                <span className="font-light">{option}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );

    const ReadingQuestion = ({ question, answer, onAnswer }) => (
      <div>
        <h3 className="text-xl font-normal text-gray-800 mb-6">{question.question}</h3>
        <div className="bg-gray-50 p-6 rounded-lg mb-6">
          <p className="text-lg text-gray-800 font-light leading-relaxed">{question.text}</p>
        </div>
        <p className="text-lg text-gray-700 mb-4 font-light">{question.subQuestion}</p>
        <div className="space-y-3">
          {question.options.map((option, i) => (
            <div
              key={i}
              onClick={() => onAnswer(i)}
              className={`answer-option p-4 rounded-lg ${answer === i ? 'selected' : ''}`}
            >
              <div className="flex items-center gap-3">
                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                  answer === i ? 'border-blue-500 bg-blue-500' : 'border-gray-300'
                }`}>
                  {answer === i && <div className="w-2 h-2 bg-white rounded-full"></div>}
                </div>
                <span className="font-light">{option}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );

    const TranslationQuestion = ({ question, answer, onAnswer }) => (
      <div>
        <h3 className="text-xl font-normal text-gray-800 mb-6">{question.question}</h3>
        <div className="bg-gray-50 p-4 rounded-lg mb-6">
          <p className="text-lg text-gray-800 font-light">{question.icelandic}</p>
        </div>
        <textarea
          value={answer || ''}
          onChange={(e) => onAnswer(e.target.value)}
          className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none font-light text-lg"
          rows="3"
          placeholder="Skrifa√∞u √æ√Ω√∞inguna h√©r..."
        />
      </div>
    );

    const ResultsView = ({ score, breakdown, questions, answers, onReset, onReview, showReview, userLanguage }) => {
      const passed = score >= 70;

      return (
        <div className="bg-white rounded-lg shadow-sm p-8">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">{passed ? 'üéâ' : 'üí™'}</div>
            <h2 className="text-2xl font-light text-gray-800 mb-4">
              {passed ? 'Til hamingju!' : 'G√≥√∞ tilraun!'}
            </h2>
            <div className="text-5xl font-light text-gray-800 mb-6">
              {score}%
            </div>
            <div className={`inline-block px-6 py-3 rounded-lg ${
              passed ? 'bg-green-50 border-2 border-green-200 text-green-700' : 'bg-red-50 border-2 border-red-200 text-red-700'
            }`}>
              <p className="font-normal">
                {passed ? '‚úÖ √û√∫ hefur sta√∞ist!' : '‚ùå √û√∫ √æarft a√∞ endurtaka'}
              </p>
            </div>
          </div>

          <div className="max-w-md mx-auto mb-8">
            <h3 className="font-normal text-gray-800 mb-4">Sundurli√∞un:</h3>
            <div className="space-y-2">
              <BreakdownItem label="Or√∞afor√∞i" correct={breakdown.vocab.correct} total={breakdown.vocab.total} />
              <BreakdownItem label="M√°lfr√¶√∞i" correct={breakdown.grammar.correct} total={breakdown.grammar.total} />
              <BreakdownItem label="Hlustun" correct={breakdown.listening.correct} total={breakdown.listening.total} />
              <BreakdownItem label="Lesskilningur" correct={breakdown.reading.correct} total={breakdown.reading.total} />
              <BreakdownItem label="√û√Ω√∞ing" correct={breakdown.translation.correct} total={breakdown.translation.total} />
            </div>
          </div>

          <div className="flex flex-col gap-3 max-w-md mx-auto mb-6">
            <button
              onClick={onReview}
              className="px-6 py-3 bg-white border-2 border-gray-200 rounded-lg text-gray-700 hover:border-blue-500 transition-all font-light"
            >
              {showReview ? 'Fela sv√∂r' : 'Sko√∞a sv√∂r'}
            </button>
            <button
              onClick={onReset}
              className="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all font-light"
            >
              Pr√≥fa aftur
            </button>
            {passed ? (
              <a
                href="byrjun.html"
                className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all text-center font-light"
              >
                üéâ √Åfram √≠ n√¶sta unit
              </a>
            ) : (
              <a
                href="innlogn.html"
                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-center font-light"
              >
                Fara til baka √≠ Innl√∂gn
              </a>
            )}
          </div>

          {showReview && (
            <ReviewSection questions={questions} answers={answers} />
          )}
        </div>
      );
    };

    const BreakdownItem = ({ label, correct, total }) => {
      const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
      const isPerfect = correct === total;

      return (
        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <span className="font-light text-gray-700">{label}</span>
          <div className="flex items-center gap-3">
            <span className="text-sm font-light text-gray-600">{correct}/{total}</span>
            <span className={`text-sm font-medium ${isPerfect ? 'text-green-600' : 'text-gray-600'}`}>
              {percentage}% {isPerfect && '‚úÖ'}
            </span>
          </div>
        </div>
      );
    };

    const ReviewSection = ({ questions, answers }) => (
      <div className="border-t-2 border-gray-200 pt-8 mt-8">
        <h3 className="text-xl font-normal text-gray-800 mb-6">Yfirlit yfir sv√∂r:</h3>
        <div className="space-y-6">
          {questions.map((q, i) => {
            const userAnswer = answers[i];
            let isCorrect = false;
            
            if (q.type === 'translation') {
              isCorrect = userAnswer?.correct || false;
            } else {
              isCorrect = userAnswer === q.correct;
            }

            return (
              <div key={i} className={`p-4 rounded-lg border-2 ${
                isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
              }`}>
                <div className="flex items-start gap-3 mb-3">
                  <span className="text-2xl">{isCorrect ? '‚úÖ' : '‚ùå'}</span>
                  <div className="flex-1">
                    <p className="font-normal text-gray-800 mb-2">
                      {i + 1}. {q.question}
                    </p>
                    {q.type === 'translation' ? (
                      <div>
                        <p className="text-sm text-gray-600 mb-1"><strong>√çslenska:</strong> {q.icelandic}</p>
                        <p className="text-sm text-gray-600"><strong>√û√≠n √æ√Ω√∞ing:</strong> {userAnswer?.text || '(ekkert svar)'}</p>
                      </div>
                    ) : (
                      <div>
                        {q.sentence && <p className="text-sm text-gray-600 mb-2">{q.sentence}</p>}
                        {q.text && <p className="text-sm text-gray-600 mb-2 italic">{q.text}</p>}
                        {q.subQuestion && <p className="text-sm text-gray-600 mb-2">{q.subQuestion}</p>}
                        <p className="text-sm text-gray-700">
                          <strong>√ûitt svar:</strong> {q.options[userAnswer]} {isCorrect && '‚úì'}
                        </p>
                        {!isCorrect && (
                          <p className="text-sm text-green-700 mt-1">
                            <strong>R√©tt svar:</strong> {q.options[q.correct]}
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );

    ReactDOM.createRoot(document.getElementById('root')).render(<Sjalfsprof />);
  </script>
</body>
</html>
