<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Bulk Generator - Kafli 1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üéôÔ∏è TTS Bulk Generator</h1>
            <p class="text-gray-600 mb-6">Kafli 1: Heimilishlutirnir - 26 spurningar</p>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800">
                    <strong>Athugi√∞:</strong> √ûessi s√≠√∞a notar Azure TTS √≠ gegnum Netlify function. 
                    H√∫n b√Ωr til 26 mp3 skr√°r og pakkar √æeim √≠ zip skr√°.
                </p>
            </div>

            <button 
                id="generateBtn"
                class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
            >
                üöÄ B√∫a til allar hlj√≥√∞skr√°r
            </button>

            <div id="progress" class="mt-6 hidden">
                <div class="mb-2 flex justify-between text-sm">
                    <span class="text-gray-700 font-medium">Framvinda:</span>
                    <span id="progressText" class="text-gray-600">0 / 26</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div 
                        id="progressBar" 
                        class="bg-blue-600 h-4 transition-all duration-300 rounded-full"
                        style="width: 0%"
                    ></div>
                </div>
            </div>

            <div id="log" class="mt-6 bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto hidden">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Atvikalog:</h3>
                <div id="logContent" class="text-xs text-gray-600 space-y-1 font-mono"></div>
            </div>

            <div id="result" class="mt-6 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <div class="text-green-600 text-5xl mb-3">‚úÖ</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Loki√∞!</h3>
                    <p class="text-green-700 mb-4">Allar 26 hlj√≥√∞skr√°r hafa veri√∞ b√∫nar til</p>
                    <button 
                        id="downloadBtn"
                        class="bg-green-600 text-white py-3 px-8 rounded-lg hover:bg-green-700 transition-colors font-semibold"
                    >
                        üì• Hla√∞a ni√∞ur ZIP skr√°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sentences = [
            "√ûetta er rafmagnst√¶ki sem √æv√¶r f√∂t.",
            "√ûetta er √æegar √æ√∫ fer√∞ √≠ b√∫√∞ og f√¶r√∞ mat og hluti fyrir heimili√∞.",
            "√ûetta er rafmagnst√¶ki sem hreinsar g√≥lf ef √æau eru √≥hrein.",
            "√ûetta er √æegar √æ√∫ hreinsar diska og gl√∂s eftir matinn.",
            "√ûetta er rafmagnst√¶ki sem √æv√¶r diska og gl√∂s.",
            "√ûetta er √æegar √æ√∫ hreinsar kl√≥sett, sturtu og vask.",
            "√ûetta er √≠ eldh√∫si og √æ√∫ bakar og eldar mat √≠ √æessu.",
            "√ûetta er √æegar √æ√∫ gerir herbergi snyrtilegra og setur hluti √≠ r√©tta sta√∞i.",
            "√ûetta er √æegar √æ√∫ hreinsar f√∂t √≠ √ævottav√©l.",
            "√ûetta er √æegar √æ√∫ b√Ωr√∞ til eitthva√∞ a√∞ bor√∞a.",
            "√ûetta er √æegar √æ√∫ hreinsar g√≥lfi√∞ vel me√∞ bursta og vatni.",
            "√ûetta er herbergi √æar sem er r√∫m.",
            "√ûetta er herbergi √æar sem fj√∂lskyldan situr saman og horfir √° sj√≥nvarp.",
            "√ûetta er herbergi √æar sem √æ√∫ b√Ωr√∞ til mat.",
            "√ûetta er herbergi me√∞ sturtu og kl√≥setti.",
            "√ûetta er √æegar √æ√∫ gerir hluti hreina me√∞ vatni.",
            "√ûetta er √æegar √æ√∫ setur f√∂t √≠ √ævottav√©l og hreinsar √æau.",
            "√ûetta er t√¶ki sem gerir f√∂t sl√©tt.",
            "√ûetta er √æegar √æ√∫ gerir f√∂t sl√©tt me√∞ heitu j√°rni.",
            "√ûetta er st√≥r kassi √≠ eldh√∫si sem heldur mat k√∂ldum.",
            "√ûetta er √æegar √æ√∫ setur hluti √° r√©tta sta√∞i og gerir snyrtilegt.",
            "√ûetta er √æegar f√∂t eru blaut og √æ√∫ gerir √æau √æurr.",
            "√ûetta er herbergi √æar sem fj√∂lskyldan bor√∞ar mat saman.",
            "√ûetta er √æegar √æ√∫ gerir r√∫mi√∞ snyrtilegra √° morgnana.",
            "√ûetta er √æegar √æ√∫ hreinsar ryk af bor√∞um og hillum me√∞ kl√∫t.",
            "√ûetta er √æegar √æ√∫ hreinsar g√≥lf me√∞ tusku og vatni."
        ];

        let zipBlob = null;

        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const logDiv = document.getElementById('log');
            logDiv.classList.remove('hidden');
            
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('is-IS');
            
            const colors = {
                'info': 'text-gray-600',
                'success': 'text-green-600',
                'error': 'text-red-600'
            };
            
            entry.className = colors[type] || colors['info'];
            entry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateProgress(current, total) {
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.classList.remove('hidden');
            const percentage = (current / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${current} / ${total}`;
        }

        async function generateAudio(text) {
            const response = await fetch('/.netlify/functions/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_to_speak: text })
            });

            const data = await response.json();
            
            if (!response.ok || data.error || !data.audio_base64) {
                throw new Error(data.error || 'Villa √≠ TTS');
            }

            return data.audio_base64;
        }

        function base64ToBlob(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type: 'audio/mp3' });
        }

        async function generateAllAudio() {
            const generateBtn = document.getElementById('generateBtn');
            const resultDiv = document.getElementById('result');
            
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Vinnsla √≠ gangi...';
            resultDiv.classList.add('hidden');
            
            addLog('Byrja a√∞ b√∫a til hlj√≥√∞skr√°r...', 'info');
            
            const zip = new JSZip();
            
            for (let i = 0; i < sentences.length; i++) {
                const questionNum = i + 1; // Einfaldlega 1, 2, 3, ... 26
                const sentence = sentences[i];
                const filename = `kafli1_spurning${String(questionNum).padStart(2, '0')}.mp3`;
                
                try {
                    addLog(`B√Ωr til ${filename}...`, 'info');
                    const audioBase64 = await generateAudio(sentence);
                    const audioBlob = base64ToBlob(audioBase64);
                    zip.file(filename, audioBlob);
                    
                    updateProgress(i + 1, sentences.length);
                    addLog(`‚úì ${filename} tilb√∫in`, 'success');
                    
                    // Sm√° t√∂f til a√∞ for√∞ast rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    addLog(`‚úó Villa √≠ ${filename}: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            addLog('Pakka skr√°m √≠ ZIP...', 'info');
            zipBlob = await zip.generateAsync({ type: 'blob' });
            addLog('‚úì ZIP skr√° tilb√∫in!', 'success');
            
            resultDiv.classList.remove('hidden');
            generateBtn.textContent = '‚úÖ Loki√∞!';
        }

        document.getElementById('generateBtn').addEventListener('click', async () => {
            try {
                await generateAllAudio();
            } catch (error) {
                alert('Villa kom upp: ' + error.message);
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'üöÄ B√∫a til allar hlj√≥√∞skr√°r';
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!zipBlob) {
                alert('Engin ZIP skr√° tilb√∫in!');
                return;
            }
            
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kafli1_spurningar.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('‚úì ZIP skr√° hla√∞in ni√∞ur!', 'success');
        });
    </script>
</body>
</html>
