<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è TTS Generator - M√°lst√∂√∞in</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        .tab-button.active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-5xl mx-auto p-8">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6">
                <h1 class="text-3xl font-bold mb-2">üéôÔ∏è TTS Generator</h1>
                <p class="text-blue-100">Azure Text-to-Speech fyrir M√°lst√∂√∞ina</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button class="tab-button active px-6 py-4 font-medium text-gray-700 hover:text-blue-600 transition-colors" data-tab="tab1">
                    üìù Stuttar setningar
                </button>
                <button class="tab-button px-6 py-4 font-medium text-gray-700 hover:text-blue-600 transition-colors" data-tab="tab2">
                    üìñ Langur texti
                </button>
                <button class="tab-button px-6 py-4 font-medium text-gray-700 hover:text-blue-600 transition-colors" data-tab="tab3">
                    üí¨ Samtal
                </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                
                <!-- TAB 1: Stuttar setningar -->
                <div id="tab1" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Stuttar setningar</h2>
                        <button onclick="refreshTab('tab1')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                            üîÑ Hreinsa
                        </button>
                    </div>
                    <p class="text-gray-600 mb-6">L√≠mdu inn margar setningar (ein per l√≠nu) og f√°√∞u ZIP skr√° me√∞ mp3 fyrir hverja setningu.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kaflaheiti:</label>
                            <input type="text" id="tab1-prefix" value="kafli01" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Setningaheiti:</label>
                            <input type="text" id="tab1-suffix" value="spurning" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">R√∂dd:</label>
                            <select id="tab1-voice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="is-IS-GudrunNeural">Gu√∞r√∫n (kona)</option>
                                <option value="is-IS-GunnarNeural">Gunnar (karl)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hra√∞i:</label>
                            <select id="tab1-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="medium">Venjulegur</option>
                                <option value="0.8">H√¶gur (80%)</option>
                                <option value="0.6">Mj√∂g h√¶gur (60%)</option>
                                <option value="1.2">Hra√∞ur (120%)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Setningar (ein per l√≠nu):</label>
                        <textarea id="tab1-text" rows="12" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                            placeholder="√ûetta er fyrsta setningin.
√ûetta er √∂nnur setningin.
√ûetta er √æri√∞ja setningin."></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm text-gray-500">D√¶mi um skr√°arnafn: <code class="bg-gray-100 px-2 py-1 rounded">kafli01_spurning01.mp3</code></p>
                            <p id="tab1-cost" class="text-sm font-semibold text-blue-600">üìä Kostna√∞ur: 0 kr</p>
                        </div>
                    </div>

                    <button id="tab1-generate" 
                        class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">
                        üöÄ B√∫a til hlj√≥√∞skr√°r
                    </button>

                    <div id="tab1-progress" class="mt-6 hidden"></div>
                    <div id="tab1-log" class="mt-6 hidden"></div>
                    <div id="tab1-result" class="mt-6 hidden"></div>
                </div>

                <!-- TAB 2: Langur texti -->
                <div id="tab2" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Langur texti</h2>
                        <button onclick="refreshTab('tab2')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                            üîÑ Hreinsa
                        </button>
                    </div>
                    <p class="text-gray-600 mb-6">L√≠mdu inn langan samfeldan texta og f√°√∞u eina mp3 skr√°.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Skr√°arnafn:</label>
                            <input type="text" id="tab2-filename" value="frasogn01" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">R√∂dd:</label>
                            <select id="tab2-voice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="is-IS-GudrunNeural">Gu√∞r√∫n (kona)</option>
                                <option value="is-IS-GunnarNeural">Gunnar (karl)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hra√∞i:</label>
                            <select id="tab2-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="medium">Venjulegur</option>
                                <option value="0.8">H√¶gur (80%)</option>
                                <option value="0.6">Mj√∂g h√¶gur (60%)</option>
                                <option value="1.2">Hra√∞ur (120%)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Texti:</label>
                        <textarea id="tab2-text" rows="15" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                            placeholder="L√≠mdu inn langan texta h√©r...

Azure TTS getur lesi√∞ allt a√∞ ~5000 stafi √≠ einu."></textarea>
                        <div class="flex justify-end items-center mt-2">
                            <p id="tab2-cost" class="text-sm font-semibold text-blue-600">üìä Kostna√∞ur: 0 kr</p>
                        </div>
                    </div>

                    <button id="tab2-generate" 
                        class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">
                        üöÄ B√∫a til hlj√≥√∞skr√°
                    </button>

                    <div id="tab2-log" class="mt-6 hidden"></div>
                    <div id="tab2-result" class="mt-6 hidden"></div>
                </div>

                <!-- TAB 3: Samtal -->
                <div id="tab3" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Samtal</h2>
                        <button onclick="refreshTab('tab3')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                            üîÑ Hreinsa
                        </button>
                    </div>
                    <p class="text-gray-600 mb-6">B√∫√∞u til samtal me√∞ tveimur r√∂ddum. Merktu l√≠nur me√∞ A: og B:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Skr√°arnafn:</label>
                            <input type="text" id="tab3-filename" value="samtal01" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">R√∂dd A:</label>
                            <select id="tab3-voiceA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="is-IS-GudrunNeural">Gu√∞r√∫n (kona)</option>
                                <option value="is-IS-GunnarNeural">Gunnar (karl)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">R√∂dd B:</label>
                            <select id="tab3-voiceB" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="is-IS-GunnarNeural">Gunnar (karl)</option>
                                <option value="is-IS-GudrunNeural">Gu√∞r√∫n (kona)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hra√∞i:</label>
                            <select id="tab3-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="medium">Venjulegur</option>
                                <option value="0.8">H√¶gur (80%)</option>
                                <option value="0.6">Mj√∂g h√¶gur (60%)</option>
                                <option value="1.2">Hra√∞ur (120%)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Samtal (merktu me√∞ A: og B:):</label>
                        <textarea id="tab3-text" rows="15" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                            placeholder="A: G√≥√∞an daginn! Hva√∞ segir √æ√∫ gott?
B: H√¶! Allt f√≠nt, takk. En sj√°lfur?
A: Bara gott, takk fyrir a√∞ spyrja.
B: Fr√°b√¶rt a√∞ heyra!"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm text-gray-500">üí° Hver l√≠na sem byrjar √° "A:" notar r√∂dd A, og "B:" notar r√∂dd B.</p>
                            <p id="tab3-cost" class="text-sm font-semibold text-blue-600">üìä Kostna√∞ur: 0 kr</p>
                        </div>
                    </div>

                    <button id="tab3-generate" 
                        class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">
                        üöÄ B√∫a til samtalshlj√≥√∞
                    </button>

                    <div id="tab3-progress" class="mt-6 hidden"></div>
                    <div id="tab3-log" class="mt-6 hidden"></div>
                    <div id="tab3-result" class="mt-6 hidden"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Azure TTS ver√∞lagning: $16 per 1M stafir fyrir Neural voices
        // Gengi: ~140 ISK/USD
        const COST_PER_CHAR_USD = 0.000016;
        const USD_TO_ISK = 140;

        function calculateCost(text) {
            const charCount = text.length;
            const costUSD = charCount * COST_PER_CHAR_USD;
            const costISK = costUSD * USD_TO_ISK;
            return {
                chars: charCount,
                usd: costUSD,
                isk: Math.ceil(costISK) // N√°munda upp
            };
        }

        function updateCostDisplay(tabId, text) {
            const cost = calculateCost(text);
            const costElement = document.getElementById(`${tabId}-cost`);
            if (cost.isk < 1) {
                costElement.textContent = `üìä Kostna√∞ur: <1 kr (${cost.chars} stafir)`;
            } else {
                costElement.textContent = `üìä Kostna√∞ur: ~${cost.isk} kr (${cost.chars} stafir)`;
            }
        }

        // Refresh tab function
        function refreshTab(tabId) {
            if (tabId === 'tab1') {
                document.getElementById('tab1-prefix').value = 'kafli01';
                document.getElementById('tab1-suffix').value = 'spurning';
                document.getElementById('tab1-voice').value = 'is-IS-GudrunNeural';
                document.getElementById('tab1-rate').value = 'medium';
                document.getElementById('tab1-text').value = '';
                document.getElementById('tab1-progress').classList.add('hidden');
                document.getElementById('tab1-log').classList.add('hidden');
                document.getElementById('tab1-result').classList.add('hidden');
                document.getElementById('tab1-generate').disabled = false;
                document.getElementById('tab1-generate').textContent = 'üöÄ B√∫a til hlj√≥√∞skr√°r';
                updateCostDisplay('tab1', '');
            } else if (tabId === 'tab2') {
                document.getElementById('tab2-filename').value = 'frasogn01';
                document.getElementById('tab2-voice').value = 'is-IS-GudrunNeural';
                document.getElementById('tab2-rate').value = 'medium';
                document.getElementById('tab2-text').value = '';
                document.getElementById('tab2-log').classList.add('hidden');
                document.getElementById('tab2-result').classList.add('hidden');
                document.getElementById('tab2-generate').disabled = false;
                document.getElementById('tab2-generate').textContent = 'üöÄ B√∫a til hlj√≥√∞skr√°';
                updateCostDisplay('tab2', '');
            } else if (tabId === 'tab3') {
                document.getElementById('tab3-filename').value = 'samtal01';
                document.getElementById('tab3-voiceA').value = 'is-IS-GudrunNeural';
                document.getElementById('tab3-voiceB').value = 'is-IS-GunnarNeural';
                document.getElementById('tab3-rate').value = 'medium';
                document.getElementById('tab3-text').value = '';
                document.getElementById('tab3-progress').classList.add('hidden');
                document.getElementById('tab3-log').classList.add('hidden');
                document.getElementById('tab3-result').classList.add('hidden');
                document.getElementById('tab3-generate').disabled = false;
                document.getElementById('tab3-generate').textContent = 'üöÄ B√∫a til samtalshlj√≥√∞';
                updateCostDisplay('tab3', '');
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
            });
        });

        // Cost calculation listeners
        document.getElementById('tab1-text').addEventListener('input', (e) => {
            updateCostDisplay('tab1', e.target.value);
        });

        document.getElementById('tab2-text').addEventListener('input', (e) => {
            updateCostDisplay('tab2', e.target.value);
        });

        document.getElementById('tab3-text').addEventListener('input', (e) => {
            updateCostDisplay('tab3', e.target.value);
        });

        // Utility functions
        function addLog(tabId, message, type = 'info') {
            const logDiv = document.getElementById(`${tabId}-log`);
            if (!logDiv.querySelector('.log-content')) {
                logDiv.innerHTML = `
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Atvikalog:</h3>
                    <div class="log-content bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto text-xs text-gray-600 space-y-1 font-mono"></div>
                `;
            }
            logDiv.classList.remove('hidden');
            
            const logContent = logDiv.querySelector('.log-content');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('is-IS');
            
            const colors = {
                'info': 'text-gray-600',
                'success': 'text-green-600',
                'error': 'text-red-600'
            };
            
            entry.className = colors[type] || colors['info'];
            entry.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateProgress(tabId, current, total) {
            const progressDiv = document.getElementById(`${tabId}-progress`);
            if (!progressDiv.querySelector('.progress-bar')) {
                progressDiv.innerHTML = `
                    <div class="mb-2 flex justify-between text-sm">
                        <span class="text-gray-700 font-medium">Framvinda:</span>
                        <span class="progress-text text-gray-600">0 / ${total}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div class="progress-bar bg-blue-600 h-4 transition-all duration-300 rounded-full" style="width: 0%"></div>
                    </div>
                `;
            }
            progressDiv.classList.remove('hidden');
            
            const progressBar = progressDiv.querySelector('.progress-bar');
            const progressText = progressDiv.querySelector('.progress-text');
            
            const percentage = (current / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${current} / ${total}`;
        }

        function buildSSML(text, voice, rate) {
            // If rate is "medium", don't wrap in prosody tag
            if (rate === 'medium') {
                return `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="is-IS">
    <voice name="${voice}">
        ${text}
    </voice>
</speak>`;
            }
            
            // Otherwise, wrap in prosody with specified rate
            return `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="is-IS">
    <voice name="${voice}">
        <prosody rate="${rate}">
            ${text}
        </prosody>
    </voice>
</speak>`;
        }

        async function generateAudio(text, voice = 'is-IS-GudrunNeural', rate = 'medium') {
            const ssml = buildSSML(text, voice, rate);
            
            const response = await fetch('/.netlify/functions/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text_to_speak: ssml,
                    voice: voice
                })
            });

            const data = await response.json();
            
            if (!response.ok || data.error || !data.audio_base64) {
                throw new Error(data.error || 'Villa √≠ TTS');
            }

            return data.audio_base64;
        }

        function base64ToBlob(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type: 'audio/mp3' });
        }

        function showResult(tabId, downloadCallback, buttonText = 'üì• Hla√∞a ni√∞ur') {
            const resultDiv = document.getElementById(`${tabId}-result`);
            resultDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <div class="text-green-600 text-5xl mb-3">‚úÖ</div>
                    <h3 class="text-xl font-bold text-green-800 mb-2">Loki√∞!</h3>
                    <p class="text-green-700 mb-4">Hlj√≥√∞skr√°(r) tilb√∫nar</p>
                    <button class="download-btn bg-green-600 text-white py-3 px-8 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        ${buttonText}
                    </button>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('.download-btn').addEventListener('click', downloadCallback);
        }

        // TAB 1: Stuttar setningar
        document.getElementById('tab1-generate').addEventListener('click', async () => {
            const button = document.getElementById('tab1-generate');
            const text = document.getElementById('tab1-text').value.trim();
            const prefix = document.getElementById('tab1-prefix').value.trim();
            const suffix = document.getElementById('tab1-suffix').value.trim();
            const voice = document.getElementById('tab1-voice').value;
            const rate = document.getElementById('tab1-rate').value;
            
            if (!text) {
                alert('Vinsamlegast l√≠mdu inn setningar!');
                return;
            }
            
            const sentences = text.split('\n').filter(s => s.trim());
            
            if (sentences.length === 0) {
                alert('Engar setningar fundust!');
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ Vinnsla √≠ gangi...';
            document.getElementById('tab1-result').classList.add('hidden');
            
            addLog('tab1', `Byrja a√∞ b√∫a til ${sentences.length} hlj√≥√∞skr√°r...`, 'info');
            
            const zip = new JSZip();
            
            try {
                for (let i = 0; i < sentences.length; i++) {
                    const num = String(i + 1).padStart(2, '0');
                    const filename = `${prefix}_${suffix}${num}.mp3`;
                    
                    addLog('tab1', `B√Ωr til ${filename}...`, 'info');
                    const audioBase64 = await generateAudio(sentences[i], voice, rate);
                    const audioBlob = base64ToBlob(audioBase64);
                    zip.file(filename, audioBlob);
                    
                    updateProgress('tab1', i + 1, sentences.length);
                    addLog('tab1', `‚úì ${filename} tilb√∫in`, 'success');
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                addLog('tab1', 'Pakka skr√°m √≠ ZIP...', 'info');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                addLog('tab1', '‚úì ZIP skr√° tilb√∫in!', 'success');
                
                showResult('tab1', () => {
                    const url = URL.createObjectURL(zipBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${prefix}_${suffix}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLog('tab1', '‚úì ZIP skr√° hla√∞in ni√∞ur!', 'success');
                }, 'üì• Hla√∞a ni√∞ur ZIP skr√°');
                
                button.textContent = '‚úÖ Loki√∞!';
                
            } catch (error) {
                addLog('tab1', `‚úó Villa: ${error.message}`, 'error');
                alert('Villa kom upp: ' + error.message);
                button.disabled = false;
                button.textContent = 'üöÄ B√∫a til hlj√≥√∞skr√°r';
            }
        });

        // TAB 2: Langur texti
        document.getElementById('tab2-generate').addEventListener('click', async () => {
            const button = document.getElementById('tab2-generate');
            const text = document.getElementById('tab2-text').value.trim();
            const filename = document.getElementById('tab2-filename').value.trim();
            const voice = document.getElementById('tab2-voice').value;
            const rate = document.getElementById('tab2-rate').value;
            
            if (!text) {
                alert('Vinsamlegast l√≠mdu inn texta!');
                return;
            }
            
            if (text.length > 5000) {
                alert('Textinn er of langur! Azure TTS takmarkar vi√∞ ~5000 stafi.');
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ Vinnsla √≠ gangi...';
            document.getElementById('tab2-result').classList.add('hidden');
            
            addLog('tab2', 'Byrja a√∞ b√∫a til hlj√≥√∞skr√°...', 'info');
            
            try {
                const audioBase64 = await generateAudio(text, voice, rate);
                const audioBlob = base64ToBlob(audioBase64);
                
                addLog('tab2', '‚úì Hlj√≥√∞skr√° tilb√∫in!', 'success');
                
                showResult('tab2', () => {
                    const url = URL.createObjectURL(audioBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLog('tab2', '‚úì MP3 skr√° hla√∞in ni√∞ur!', 'success');
                }, 'üì• Hla√∞a ni√∞ur MP3');
                
                button.textContent = '‚úÖ Loki√∞!';
                button.disabled = false;
                
            } catch (error) {
                addLog('tab2', `‚úó Villa: ${error.message}`, 'error');
                alert('Villa kom upp: ' + error.message);
                button.disabled = false;
                button.textContent = 'üöÄ B√∫a til hlj√≥√∞skr√°';
            }
        });

        // TAB 3: Samtal
        document.getElementById('tab3-generate').addEventListener('click', async () => {
            const button = document.getElementById('tab3-generate');
            const text = document.getElementById('tab3-text').value.trim();
            const filename = document.getElementById('tab3-filename').value.trim();
            const voiceA = document.getElementById('tab3-voiceA').value;
            const voiceB = document.getElementById('tab3-voiceB').value;
            const rate = document.getElementById('tab3-rate').value;
            
            if (!text) {
                alert('Vinsamlegast l√≠mdu inn samtal!');
                return;
            }
            
            const lines = text.split('\n').filter(l => l.trim());
            
            if (lines.length === 0) {
                alert('Engar l√≠nur fundust!');
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ Vinnsla √≠ gangi...';
            document.getElementById('tab3-result').classList.add('hidden');
            
            addLog('tab3', `Byrja a√∞ b√∫a til samtal me√∞ ${lines.length} l√≠num...`, 'info');
            
            try {
                const audioBlobs = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    let voice = voiceA;
                    let lineText = line;
                    
                    if (line.startsWith('A:')) {
                        voice = voiceA;
                        lineText = line.substring(2).trim();
                    } else if (line.startsWith('B:')) {
                        voice = voiceB;
                        lineText = line.substring(2).trim();
                    }
                    
                    if (!lineText) continue;
                    
                    addLog('tab3', `B√Ωr til l√≠nu ${i + 1}: "${lineText.substring(0, 30)}..."`, 'info');
                    const audioBase64 = await generateAudio(lineText, voice, rate);
                    const audioBlob = base64ToBlob(audioBase64);
                    audioBlobs.push(audioBlob);
                    
                    updateProgress('tab3', i + 1, lines.length);
                    addLog('tab3', `‚úì L√≠na ${i + 1} tilb√∫in`, 'success');
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                addLog('tab3', 'Sameina allar l√≠nur √≠ eina skr√°...', 'info');
                
                // Merge all audio blobs
                const mergedBlob = new Blob(audioBlobs, { type: 'audio/mp3' });
                
                addLog('tab3', '‚úì Samtal tilb√∫i√∞!', 'success');
                
                showResult('tab3', () => {
                    const url = URL.createObjectURL(mergedBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLog('tab3', '‚úì MP3 skr√° hla√∞in ni√∞ur!', 'success');
                }, 'üì• Hla√∞a ni√∞ur samtal');
                
                button.textContent = '‚úÖ Loki√∞!';
                button.disabled = false;
                
            } catch (error) {
                addLog('tab3', `‚úó Villa: ${error.message}`, 'error');
                alert('Villa kom upp: ' + error.message);
                button.disabled = false;
                button.textContent = 'üöÄ B√∫a til samtalshlj√≥√∞';
            }
        });
    </script>
</body>
</html>
