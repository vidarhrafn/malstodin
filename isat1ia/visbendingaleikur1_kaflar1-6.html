<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¯ Finndu orÃ°iÃ° â€“ A1 meÃ° audioâ€‘vÃ­sbendingum</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%); min-height: 100vh;}
    .recording { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------- Icons ----------
    const SpeakerIcon = ({ active=false }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`w-5 h-5 ${active?'text-red-500 animate-pulse':'text-white'}`}>
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    );

    const SendIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    );

    // ---------- Infra ----------
    async function callOpenAI(payload){
      const r = await fetch('/.netlify/functions/openai', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await r.json();
      if(!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    async function speak(text){
      try{
        const r = await fetch('/.netlify/functions/speak', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text_to_speak: text })});
        const data = await r.json();
        if(!r.ok || data.error || !data.audio_base64) throw new Error(data.error || 'No audio');
        const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
        await audio.play();
      }catch(e){ console.error('speak error:', e); }
    }

    // ---------- Kennaralisti (A1) ----------
    const DEFAULT_WORDS = [
      { word:'hjÃ³n', def:'maÃ°ur og kona sem eru gift' },
      { word:'sjÃºkrahÃºs', def:'staÃ°ur Ã¾ar sem lÃ¦knar og hjÃºkrunarfrÃ¦Ã°ingar vinna' },
      { word:'bÃºÃ°', def:'staÃ°ur Ã¾ar sem maÃ°ur kaupir mat eÃ°a hluti' },
      { word:'dÃ³ttir', def:'barn sem er stelpa' },
      { word:'elda', def:'gera mat Ã­ eldhÃºsi' },
      { word:'Ã½sa', def:'hvÃ­tur fiskur sem margir borÃ°a Ã¡ Ãslandi' },
      { word:'rasp', def:'mulinn brauÃ°massi utan Ã¡ fisk eÃ°a kjÃ¶t' },
      { word:'leikhÃºs', def:'staÃ°ur Ã¾ar sem fÃ³lk horfir Ã¡ leikrit' },
      { word:'hlÃ©', def:'stutt pÃ¡sa Ã­ miÃ°ri sÃ½ningu' },
      { word:'gos', def:'drykkur meÃ° loftbÃ³lum eins og kÃ³k eÃ°a sÃ³davatn' },
      { word:'vinkona', def:'stelpa sem er vinur' },
      { word:'krydd', def:'duft eÃ°a blÃ¶Ã° sem gera mat bragÃ°betri' },
      { word:'kÃ¦rasti', def:'strÃ¡kur sem stelpa er Ã­ sambandi meÃ°' },
      { word:'gista', def:'sofa hjÃ¡ vinum eÃ°a fjÃ¶lskyldu' },
      { word:'kÃ³sÃ­kvÃ¶ld', def:'kvÃ¶ld Ã¾egar fÃ³lk slakar Ã¡ og horfir Ã¡ bÃ­Ã³mynd' },
      { word:'hrekkjavaka', def:'hÃ¡tÃ­Ã° Ã¾ar sem krakkar fara Ã­ bÃºning og fÃ¡ nammi' },
      { word:'grasker', def:'stÃ³r appelsÃ­nugulur Ã¡vÃ¶xtur sem fÃ³lk sker Ãºt' },
      { word:'beinagrind', def:'Ã¶ll beinin Ã­ lÃ­kama manneskju' },
    ];

    // ---------- Leikur ----------
    const Game = () => {
      const [words, setWords] = useState(DEFAULT_WORDS);
      const [target, setTarget] = useState(null);
      const [desc, setDesc] = useState('');
      const [input, setInput] = useState('');
      const [messages, setMessages] = useState([]);
      const [wrong, setWrong] = useState(0);
      const [round, setRound] = useState(1);
      const [correctCount, setCorrectCount] = useState(0);
      const [speakingDesc, setSpeakingDesc] = useState(false);
      const [loading, setLoading] = useState(false);

      const newRound = async () => {
        setLoading(true);
        const pick = words[Math.floor(Math.random()*words.length)];
        setTarget(pick);
        setWrong(0);
        setMessages([]);
        setInput('');
        
        const sys = `ÃÃº hjÃ¡lpar Ã­slenskunema Ã¡ A1. LÃ½stu hlut eÃ°a hugtaki Ã¡n Ã¾ess aÃ° nefna orÃ°iÃ° sjÃ¡lft. NotaÃ°u 1â€“3 mjÃ¶g einfaldar setningar Ã¡ Ã­slensku. Ekki nota flÃ³kin orÃ°. Ekki nefna orÃ°iÃ° beint. LjÃºktu meÃ° spurningu eins og: \\"HvaÃ° er Ã¾etta?\\".`;
        const user = `OrÃ°: "${pick.word}". EinfÃ¶ld ÃºtskÃ½ring: "${pick.def}". BÃºÃ°u til A1-lÃ½singu.`;
        
        try{
          const content = await callOpenAI({ model:'gpt-4o-mini', temperature:0.3, max_tokens:120, messages:[{role:'system', content: sys},{role:'user', content: user}] });
          setDesc(content);
          setLoading(false);
        }catch(e){
          console.error(e);
          const fallback = `Ãetta er ${pick.def}. HvaÃ° er Ã¾etta?`;
          setDesc(fallback);
          setLoading(false);
        }
      };

      useEffect(()=>{ newRound(); },[]);

      const submitGuess = async () => {
        const guess = input.trim();
        if(!guess) return;
        setMessages(prev=>[...prev, { role:'user', content: guess }]);
        setInput('');

        if(!target) return;
        
        // Nota AI til aÃ° meta hvort svariÃ° sÃ© rÃ©tt
        const checkSys = `ÃÃº ert aÃ° meta hvort nemandi giskaÃ°i rÃ©tt Ã¡ orÃ°. RÃ©tta orÃ°iÃ° er "${target.word}". Nemandinn giskaÃ°i: "${guess}".

SAMÃYKKJA sem rÃ©tt:
- NÃ¡kvÃ¦mlega rÃ©tt orÃ°
- FleirtÃ¶lu (t.d. "hjÃ³n" fyrir "hjÃ³n", "krydd" fyrir "krydd")
- SmÃ¡vÃ¦gilegar stafsetningarvillur (t.d. "grasker" fyrir "grÃ¦sker")
- EintÃ¶lu/fleirtÃ¶lu form (t.d. "barn" fyrir "bÃ¶rn")
- Samsvarandi orÃ° (t.d. "leikrit" fyrir "leikhÃºs" ef Ã¾aÃ° er skynsamlegt)

HAFNA:
- Alveg rangt orÃ°
- OrÃ° sem eru of langt frÃ¡

SvaraÃ°u AÃEINS meÃ° "RÃ‰TT" eÃ°a "RANGT". Ekkert annaÃ°.`;

        try {
          const aiDecision = await callOpenAI({ 
            model:'gpt-4o-mini', 
            temperature:0.1, 
            max_tokens:10, 
            messages:[{role:'system', content: checkSys}] 
          });
          
          const isCorrect = aiDecision.trim().toUpperCase().includes('RÃ‰TT');
          
          if(isCorrect){
            const ok = `âœ… RÃ©tt! OrÃ°iÃ° var "${target.word}".`;
            setMessages(prev=>[...prev, { role:'system', content: ok }]);
            await speak(ok);
            setCorrectCount(c => c + 1);
            setTimeout(async ()=>{ setRound(r=>r+1); await newRound(); }, 900);
            return;
          }
        } catch(e) {
          console.error('AI check error:', e);
          // Fallback Ã¡ gamla kerfiÃ° ef AI mistekst
          if(guess.toLowerCase() === target.word.toLowerCase()){
            const ok = `âœ… RÃ©tt! OrÃ°iÃ° var "${target.word}".`;
            setMessages(prev=>[...prev, { role:'system', content: ok }]);
            await speak(ok);
            setCorrectCount(c => c + 1);
            setTimeout(async ()=>{ setRound(r=>r+1); await newRound(); }, 900);
            return;
          }
        }

        const wrongMsg = `âŒ Ekki rÃ©tt. PrÃ³faÃ°u aftur.`;
        setMessages(prev=>[...prev, { role:'system', content: wrongMsg }]);
        await speak(wrongMsg);

        const n = wrong + 1;
        setWrong(n);

        // VÃ­sbendingar sem hnappa Ã­ staÃ° Ã¾ess aÃ° spila Ã¾Ã¦r strax
        if(n === 2){
          const first = target.word[0].toUpperCase();
          const hintText = `VÃ­sbending: OrÃ°iÃ° byrjar Ã¡ ${first}.`;
          setMessages(prev=>[...prev, { 
            role:'hint', 
            content: 'ğŸ’¡ VÃ­sbending 1',
            hintText: hintText
          }]);
        } else if(n === 4){
          const hintText = `Ã–nnur vÃ­sbending: OrÃ°iÃ° hefur ${target.word.length} stafi.`;
          setMessages(prev=>[...prev, { 
            role:'hint', 
            content: 'ğŸ’¡ VÃ­sbending 2',
            hintText: hintText
          }]);
        } else if(n === 6){
          const ending = mkEnding(target.word);
          const hintText = `SÃ­Ã°asta vÃ­sbending: OrÃ°iÃ° endar Ã¡ ${ending}.`;
          setMessages(prev=>[...prev, { 
            role:'hint', 
            content: 'ğŸ’¡ VÃ­sbending 3',
            hintText: hintText
          }]);
        } else if(n >= 7){
          await speak(`RÃ©tt svar er: ${target.word}. PrÃ³fum nÃ½tt orÃ°!`);
          setMessages(prev=>[...prev, { role:'system', content: `RÃ©tt svar var: ${target.word}` }]);
          setTimeout(async ()=>{ setRound(r=>r+1); await newRound(); }, 700);
        }
      };

      const playHint = async (hintText) => {
        await speak(hintText);
      };

      function mkEnding(w){
        if(w.length <= 2) return w;
        if(w.length <= 4) return w.slice(-2);
        return w.slice(-3);
      }

      const replaceList = () => {
        const raw = prompt('LÃ­mdu inn nÃ½jan lista â€“ eitt orÃ° Ã¡ lÃ­nu (form: orÃ° - einfÃ¶ld ÃºtskÃ½ring).\nDÃ¦mi:\nhjÃ³n - maÃ°ur og kona sem eru gift');
        if(!raw) return;
        const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
        const parsed = [];
        for(const line of lines){
          const [w, d] = line.split(/\s*-\s*/);
          if(w && d) parsed.push({ word:w, def:d });
        }
        if(parsed.length){
          setWords(parsed);
          speak('NÃ½r orÃ°alisti kominn!');
          setTimeout(()=>{ newRound(); }, 300);
        }else{
          alert('TÃ³kst ekki aÃ° lesa nÃ½jan lista. GÃ¦ttu aÃ° forminu: "orÃ° - ÃºtskÃ½ring"');
        }
      };

      const replayDesc = async () => {
        if(desc){ 
          setSpeakingDesc(true);
          await speak(desc); 
          setSpeakingDesc(false);
        }
      };

      const resetGame = () => {
        setRound(1);
        setCorrectCount(0);
        newRound();
      };

      return (
        <div className="min-h-screen pb-12">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-3xl mx-auto px-6 py-8">
              <button onClick={()=>window.history.back()} className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light">â† Til baka</button>
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-3xl font-light text-gray-800 mb-1">Finndu orÃ°iÃ°</h1>
                  <p className="text-gray-500 text-sm font-light">A1 Â· Audioâ€‘vÃ­sbendingar aÃ°eins</p>
                  <p className="text-gray-400 text-xs font-light mt-1">UmferÃ° {round} Â· RÃ©tt: {correctCount}</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={resetGame} className="px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50 font-light">ğŸ”„ Byrja upp Ã¡ nÃ½tt</button>
                  <button onClick={replaceList} className="px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50 font-light">âš™ï¸ OrÃ°alisti</button>
                </div>
              </div>
            </div>
          </header>

          <main className="max-w-3xl mx-auto px-6 mt-8">
            <div className="bg-white rounded-lg shadow-sm overflow-hidden">
              <div className="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center justify-between">
                <span className="text-sm text-gray-600 font-light">ğŸ§ HlustaÃ°u Ã¡ lÃ½singuna og giskaÃ°u Ã¡ orÃ°iÃ°</span>
                {loading && <span className="text-xs font-light text-blue-600">â³ AI er aÃ° hugsa...</span>}
              </div>

              {!loading && desc && (
                <div className="bg-blue-50 border-b border-blue-200 px-6 py-4">
                  <button 
                    onClick={replayDesc} 
                    disabled={speakingDesc}
                    className="flex items-center gap-2 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-light disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    <SpeakerIcon active={speakingDesc} />
                    <span>{speakingDesc ? 'ğŸ”Š Spilar...' : 'ğŸ§ Spila lÃ½singu'}</span>
                  </button>
                </div>
              )}

              <div className="p-6 space-y-3 min-h-[260px]">
                {messages.map((m,i)=> (
                  <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                    {m.role === 'hint' ? (
                      <button
                        onClick={() => playHint(m.hintText)}
                        className="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 px-4 py-2 rounded-lg font-light shadow-sm hover:bg-yellow-200 transition-colors flex items-center gap-2"
                      >
                        <SpeakerIcon />
                        <span>{m.content}</span>
                      </button>
                    ) : (
                      <div className={`max-w-lg px-4 py-2 rounded-lg font-light shadow-sm ${
                        m.role==='user'
                          ?'bg-gray-800 text-white'
                          : m.role==='system'
                          ? 'bg-blue-100 text-blue-800 text-sm'
                          : 'bg-gray-100 text-gray-800'
                      }`}>
                        {m.content}
                      </div>
                    )}
                  </div>
                ))}
                {messages.length === 0 && !loading && (
                  <p className="text-center text-gray-400 font-light py-8">Smelltu Ã¡ hnappin hÃ©r aÃ° ofan til aÃ° byrja ğŸ‘†</p>
                )}
              </div>

              <div className="border-t p-4 bg-white">
                <div className="flex gap-2">
                  <input 
                    type="text" 
                    value={input} 
                    onChange={e=>setInput(e.target.value)} 
                    onKeyDown={e=>e.key==='Enter'&&submitGuess()} 
                    placeholder="SkrifaÃ°u giskâ€¦" 
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400 font-light" 
                    disabled={loading || !desc} 
                  />
                  <button 
                    onClick={submitGuess} 
                    className="bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors font-light disabled:bg-gray-400 disabled:cursor-not-allowed" 
                    disabled={loading || !desc}
                  >
                    <SendIcon/>
                  </button>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Game/>);
  </script>
</body>
</html>
