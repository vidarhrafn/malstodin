<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barnaleikir</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .message { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const MicIcon = ({ isRecording }) => (
      <svg className={`w-5 h-5 ${isRecording ? 'animate-pulse' : ''}`} fill="currentColor" viewBox="0 0 20 20">
        <path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clipRule="evenodd" />
      </svg>
    );

    const SpjallLeikir = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [finished, setFinished] = useState(false);
      const [isRecording, setIsRecording] = useState(false);
      const [audioURL, setAudioURL] = useState(null);
      const mediaRecorderRef = useRef(null);
      const audioChunksRef = useRef([]);
      const messagesEndRef = useRef(null);

      const questions = [
        { q: "H√¶! Getur √æ√∫ sagt m√©r fr√° leik sem √æ√∫ l√©kst √æegar √æ√∫ varst barn?", type: "kynning" },
        { q: "sta√∞festing", type: "sta√∞festing" }, // AI sta√∞festir leikinn
        { q: "Veistu hvort √æessi leikur er l√≠ka √æekktur √° √çslandi?", type: "island" },
        { q: "Hvernig leikur ma√∞ur √æennan leik? Getur√∞u √∫tsk√Ωrt reglurnar?", type: "reglur" },
        { q: "Hvar l√©kst √æ√∫ hann? √öti e√∞a inni?", type: "stadsetning" },
        { q: "Me√∞ hverjum l√©kst √æ√∫? Vinir, systkini e√∞a fj√∂lskylda?", type: "med_hverjum" },
        { q: "Hvernig var √æa√∞? Var √æetta skemmtilegt?", type: "tilfinningar" },
        { q: "Hversu oft l√©kst √æ√∫ √æennan leik? Oft e√∞a sjaldan?", type: "tidni" },
        { q: "Leikur √æ√∫ enn √æennan leik stundum?", type: "nuna" }
      ];

      useEffect(() => {
        if (messages.length === 0) {
          addMessage('assistant', questions[0].q);
        }
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const addMessage = (role, content, grammar = null) => {
        setMessages(prev => [...prev, { role, content, grammar }]);
      };

      const playAudio = async (text) => {
        try {
          const response = await fetch('/.netlify/functions/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, voice: 'nova' })
          });
          const audioBlob = await response.blob();
          const url = URL.createObjectURL(audioBlob);
          const audio = new Audio(url);
          audio.play();
        } catch (error) {
          console.error('Villa vi√∞ hlj√≥√∞spilun:', error);
        }
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];

          mediaRecorderRef.current.ondataavailable = (event) => {
            audioChunksRef.current.push(event.data);
          };

          mediaRecorderRef.current.onstop = async () => {
            const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
              const base64Audio = reader.result.split(',')[1];
              await transcribeAudio(base64Audio);
            };
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorderRef.current.start();
          setIsRecording(true);
        } catch (error) {
          console.error('Villa vi√∞ uppt√∂ku:', error);
          alert('Gat ekki byrja√∞ uppt√∂ku. Athuga√∞u hvort vafri hefur a√∞gang a√∞ hlj√≥√∞nema.');
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
          mediaRecorderRef.current.stop();
          setIsRecording(false);
        }
      };

      const transcribeAudio = async (base64Audio) => {
        setLoading(true);
        try {
          const response = await fetch('/.netlify/functions/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ audio: base64Audio })
          });
          const data = await response.json();
          if (data.text) {
            setInput(data.text);
          }
        } catch (error) {
          console.error('Villa vi√∞ umritun:', error);
        }
        setLoading(false);
      };

      const sendMessage = async () => {
        if (!input.trim()) return;

        const userMessage = input;
        setInput('');
        addMessage('user', userMessage);
        setLoading(true);

        try {
          const conversationHistory = messages.map(m => ({
            role: m.role,
            content: m.content
          }));

          const systemPrompt = `√û√∫ ert hj√°lplegur kennari sem talar vi√∞ nemanda √° √≠slensku um barnaleiki.

N√∫verandi spurning er ${currentQuestion + 1} af ${questions.length}.

MIKILV√ÜGT:
- Kommenta√∞u √° svari nemandans me√∞ stuttum athugasemdum eins og "J√° √©g skil", "√Åhugavert!", "Flottur leikur!", "Gaman a√∞ heyra", "Skemmtilegt" o.s.frv.
- Vertu n√°tt√∫rulegur og vinalegur
- Ef √æetta er spurning 2 (sta√∞festing), √æ√°:
  * Ef √æ√∫ √æekkir leikinn: "Ah, [leikur]! √ûa√∞ er [stutt l√Ωsing], r√©tt?"
  * Ef √æ√∫ √æekkir ekki leikinn: "√Åhugavert! Fr√° hva√∞a landi er √æessi leikur?"

M√ÅLFARSENDURGJ√ñF:
- Gef√∞u m√°lfarsendurgj√∂f √≠ JSON sni√∞i: {"grammar": "textinn h√©r"}
- Einbl√≠ndu √° eina m√°lfarsvillu √≠ einu
- Vertu hvetjandi og j√°kv√¶√∞
- Nefndu hva√∞ nemandinn ger√∞i VEL
- D√¶mi: "Vel gert! √û√∫ nota√∞ir r√©tta beygingarform. En vi√∞ segjum frekar '√©g l√©k' √≠ sta√∞ '√©g leika√∞i'."

Svara√∞u me√∞ JSON sni√∞i:
{
  "response": "svar √æitt me√∞ athugasemd h√©r",
  "grammar": "m√°lfarsendurgj√∂f ef vi√∞ √°"
}`;

          const response = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [
                { role: 'system', content: systemPrompt },
                ...conversationHistory,
                { role: 'user', content: userMessage }
              ]
            })
          });

          const data = await response.json();
          let aiResponse = data.response;
          let grammarFeedback = null;

          try {
            const parsed = JSON.parse(aiResponse);
            aiResponse = parsed.response;
            grammarFeedback = parsed.grammar;
          } catch (e) {
            // Ekki JSON, notum bara textann
          }

          addMessage('assistant', aiResponse, grammarFeedback);
          playAudio(aiResponse);

          // Fara √≠ n√¶stu spurningu
          if (currentQuestion < questions.length - 1) {
            setTimeout(() => {
              const nextQ = currentQuestion + 1;
              setCurrentQuestion(nextQ);

              // Sleppa sta√∞festingarspurningu (h√∫n kemur √≠ AI svarinu)
              if (questions[nextQ].type === "sta√∞festing") {
                if (nextQ + 1 < questions.length) {
                  setTimeout(() => {
                    setCurrentQuestion(nextQ + 1);
                    addMessage('assistant', questions[nextQ + 1].q);
                    playAudio(questions[nextQ + 1].q);
                  }, 1000);
                }
              } else {
                addMessage('assistant', questions[nextQ].q);
                playAudio(questions[nextQ].q);
              }
            }, 1500);
          } else {
            // Kl√°ra√∞ - b√∫a til s√∫mmeru
            setTimeout(async () => {
              const summaryPrompt = `Taktu saman samtali√∞ okkar um barnaleikinn. Hva√∞ ger√∞i nemandinn vel? Nefndu 2-3 j√°kv√¶√∞a hluti um m√°lfar og frams√∂gn. Vertu hvetjandi.`;

              const summaryResponse = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  messages: [
                    ...conversationHistory,
                    { role: 'user', content: userMessage },
                    { role: 'user', content: summaryPrompt }
                  ]
                })
              });

              const summaryData = await summaryResponse.json();
              addMessage('assistant', `üìù **Samantekt:**\n\n${summaryData.response}`);
              playAudio(summaryData.response);
              setFinished(true);
            }, 2000);
          }
        } catch (error) {
          console.error('Villa:', error);
          addMessage('assistant', '√ûv√≠ mi√∞ur kom upp villa. Reyndu aftur.');
        }

        setLoading(false);
      };

      return (
        <div className="min-h-screen flex flex-col">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button
                onClick={() => window.history.back()}
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Barnaleikir</h1>
              <p className="text-gray-500 text-sm font-light">T√∂lum saman</p>
            </div>
          </header>

          <main className="flex-1 max-w-4xl mx-auto w-full p-4">
            <section className="bg-white rounded-lg shadow-lg overflow-hidden">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 border-b">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="text-3xl">üéÆ</div>
                    <div>
                      <h2 className="text-xl font-normal text-gray-800">Spjall um barnaleiki</h2>
                      <p className="text-sm text-gray-600 font-light">üìç Spurning {currentQuestion + 1} af {questions.length}</p>
                    </div>
                  </div>
                  <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-light">A1-A2</span>
                </div>
              </div>

              <div className="p-6 space-y-4 max-h-[500px] overflow-y-auto">
                {messages.map((msg, idx) => (
                  <div key={idx} className="message">
                    {msg.role === 'assistant' ? (
                      <div className="flex gap-3">
                        <div className="text-2xl">üéß</div>
                        <div className="flex-1 bg-blue-50 rounded-lg p-4">
                          <p className="text-gray-800 font-light whitespace-pre-line">{msg.content}</p>
                          {msg.grammar && (
                            <div className="mt-3 bg-red-50 border border-red-200 rounded p-3">
                              <p className="text-sm text-red-800"><strong>üìö M√°lfar:</strong> {msg.grammar}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    ) : (
                      <div className="flex gap-3 justify-end">
                        <div className="bg-gray-100 rounded-lg p-4 max-w-md">
                          <p className="text-gray-800 font-light">{msg.content}</p>
                        </div>
                        <div className="text-2xl">üë§</div>
                      </div>
                    )}
                  </div>
                ))}
                {loading && (
                  <div className="flex gap-3">
                    <div className="text-2xl">üéß</div>
                    <div className="bg-blue-50 rounded-lg p-4">
                      <div className="flex gap-1">
                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {!finished && (
                <div className="border-t p-6 space-y-3">
                  <div className="flex justify-center">
                    <button
                      onMouseDown={startRecording}
                      onMouseUp={stopRecording}
                      onTouchStart={startRecording}
                      onTouchEnd={stopRecording}
                      className={`flex items-center gap-2 px-6 py-3 rounded-lg font-normal transition-colors ${
                        isRecording
                          ? 'bg-red-600 text-white hover:bg-red-700'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                      disabled={loading}
                    >
                      <MicIcon isRecording={isRecording} />
                      <span>{isRecording ? '‚èπÔ∏è H√¶tta uppt√∂ku' : 'üé§ Haltu til a√∞ tala'}</span>
                    </button>
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                      placeholder="Skrifa e√∞a laga tal‚Ä¶"
                      className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-light"
                    />
                    <button
                      onClick={sendMessage}
                      disabled={!input.trim() || loading}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-normal"
                    >
                      Senda
                    </button>
                  </div>
                </div>
              )}

              {finished && (
                <div className="border-t p-6 bg-green-50 text-center">
                  <div className="text-4xl mb-3">üéâ</div>
                  <h3 className="text-xl font-normal text-gray-800 mb-2">Vel gert!</h3>
                  <p className="text-gray-600 font-light">√û√∫ hefur kl√°ra√∞ spjalli√∞!</p>
                </div>
              )}
            </section>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<SpjallLeikir />);
  </script>
</body>
</html>
