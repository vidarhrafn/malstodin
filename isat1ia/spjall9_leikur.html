<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barnaleikir</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    async function callOpenAI(messages, max_tokens = 300, model = 'gpt-4o-mini', temperature = 0.3) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, max_tokens, model, temperature })
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    async function playAudio(text, setSpeakingCallback) {
      setSpeakingCallback(true);
      try {
        const r = await fetch('/.netlify/functions/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text_to_speak: text })
        });
        const data = await r.json();
        if (!r.ok || data.error || !data.audio_base64) {
          console.error('Villa √≠ hlj√≥√∞kalli:', data?.error);
          setSpeakingCallback(false);
          return;
        }
        const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
        audio.onended = () => setSpeakingCallback(false);
        audio.onerror = () => setSpeakingCallback(false);
        await audio.play().catch(() => setSpeakingCallback(false));
      } catch (e) {
        console.error('Tenging mist√≥kst:', e);
        setSpeakingCallback(false);
      }
    }

    const MicIcon = ({ isRecording }) => (
      <svg className={`w-5 h-5 ${isRecording ? 'animate-pulse' : ''}`} fill="currentColor" viewBox="0 0 20 20">
        <path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clipRule="evenodd" />
      </svg>
    );

    const ListenPill = ({ onClick, speaking }) => (
      <button onClick={onClick} className={`inline-flex items-center gap-2 px-3 py-1 rounded-xl text-sm border ${speaking ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-100 text-gray-700 border-gray-200'}`}>
        <span className="opacity-70">üéß</span>
        <span className="font-light">Hlusta√∞u:</span>
        <span className={`text-green-600 ${speaking ? 'animate-pulse' : ''}`}>üîä</span>
      </button>
    );

    const SpjallLeikir = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [finished, setFinished] = useState(false);
      const [isRecording, setIsRecording] = useState(false);
      const [recognition, setRecognition] = useState(null);
      const [speakingIndex, setSpeakingIndex] = useState(null);
      const mediaRecorderRef = useRef(null);
      const audioChunksRef = useRef([]);
      const messagesEndRef = useRef(null);

      const FIRST_Q = "H√¶! Getur √æ√∫ sagt m√©r fr√° leik sem √æ√∫ l√©kst √æegar √æ√∫ varst barn?";

      const questions = [
        FIRST_Q,
        "Veistu hvort √æessi leikur er l√≠ka √æekktur √° √çslandi?",
        "Hvernig leikur ma√∞ur √æennan leik? Getur√∞u √∫tsk√Ωrt reglurnar?",
        "Hvar l√©kst √æ√∫ hann? √öti e√∞a inni?",
        "Me√∞ hverjum l√©kst √æ√∫? Vinir, systkini e√∞a fj√∂lskylda?",
        "Hvernig var √æa√∞? Var √æetta skemmtilegt?",
        "Hversu oft l√©kst √æ√∫ √æennan leik? Oft e√∞a sjaldan?",
        "Leikur √æ√∫ enn √æennan leik stundum?"
      ];

      useEffect(() => {
        if ('webkitSpeechRecognition' in window) {
          const recog = new webkitSpeechRecognition();
          recog.lang = 'is-IS';
          recog.continuous = true;
          recog.interimResults = true;
          recog.onresult = (e) => {
            const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
            setInput(transcript);
          };
          recog.onend = () => setIsRecording(false);
          recog.onerror = () => setIsRecording(false);
          setRecognition(recog);
        }
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, loading]);

      const handleListenClick = async () => {
        if (messages.length === 0) {
          setMessages([{ role: 'assistant', content: FIRST_Q }]);
          await playAudio(FIRST_Q, () => setSpeakingIndex(null));
        } else {
          const lastIdx = messages.map((m, i) => ({ m, i })).filter(o => o.m.role === 'assistant').slice(-1)[0]?.i;
          if (lastIdx != null) await playAssistantAt(lastIdx);
        }
      };

      const playAssistantAt = async (idx) => {
        const msg = messages[idx];
        if (!msg || msg.role !== 'assistant') return;
        setSpeakingIndex(idx);
        await playAudio(msg.content, () => setSpeakingIndex(null));
      };

      const startRecording = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorderRef.current = new MediaRecorder(stream);
          audioChunksRef.current = [];

          mediaRecorderRef.current.ondataavailable = (event) => {
            audioChunksRef.current.push(event.data);
          };

          mediaRecorderRef.current.onstop = async () => {
            const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
              const base64Audio = reader.result.split(',')[1];
              await transcribeAudio(base64Audio);
            };
            stream.getTracks().forEach(track => track.stop());
          };

          mediaRecorderRef.current.start();
          setIsRecording(true);
        } catch (error) {
          console.error('Villa vi√∞ uppt√∂ku:', error);
          alert('Gat ekki byrja√∞ uppt√∂ku. Athuga√∞u hvort vafri hefur a√∞gang a√∞ hlj√≥√∞nema.');
        }
      };

      const stopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
          mediaRecorderRef.current.stop();
          setIsRecording(false);
        }
      };

      const toggleRecording = () => {
        if (!recognition) {
          alert('Vafrinn √æinn sty√∞ur ekki talgreiningu. Nota√∞u Chrome e√∞a Edge.');
          return;
        }
        if (isRecording) {
          recognition.stop();
          setIsRecording(false);
        } else {
          recognition.start();
          setIsRecording(true);
        }
      };

      const transcribeAudio = async (base64Audio) => {
        setLoading(true);
        try {
          const response = await fetch('/.netlify/functions/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ audio: base64Audio })
          });
          const data = await response.json();
          if (data.text) {
            setInput(data.text);
          }
        } catch (error) {
          console.error('Villa vi√∞ umritun:', error);
        }
        setLoading(false);
      };

      const sendMessage = async () => {
        if (!input.trim() || loading) return;

        const userMessage = input;
        setInput('');
        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setLoading(true);

        try {
          const conversationHistory = messages.map(m => ({
            role: m.role,
            content: m.content
          }));

          const systemPrompt = `√û√∫ ert hj√°lplegur kennari sem talar vi√∞ nemanda √° √≠slensku um barnaleiki.

N√∫verandi spurning er ${currentQuestion + 1} af ${questions.length}.

MIKILV√ÜGT:
- Kommenta√∞u √° svari nemandans me√∞ stuttum athugasemdum eins og "J√° √©g skil", "√Åhugavert!", "Flottur leikur!", "Gaman a√∞ heyra", "Skemmtilegt" o.s.frv.
- Vertu n√°tt√∫rulegur og vinalegur
- Ef √æetta er spurning 2, og √æ√∫ √æekkir leikinn, sta√∞festu hann: "Ah, [leikur]! √ûa√∞ er [stutt l√Ωsing], r√©tt?"

Svara√∞u BARA me√∞ stuttri athugasemd (1-2 setningar), ekkert anna√∞.`;

          const response = await callOpenAI([
            { role: 'system', content: systemPrompt },
            ...conversationHistory,
            { role: 'user', content: userMessage }
          ], 150, 'gpt-4o-mini', 0.3);

          if (response) {
            setMessages(prev => [...prev, { role: 'assistant', content: response }]);
            await playAudio(response, () => setSpeakingIndex(null));
          }

          // N√¶sta spurning
          if (currentQuestion < questions.length - 1) {
            setTimeout(() => {
              const nextQ = currentQuestion + 1;
              setCurrentQuestion(nextQ);
              const nextQuestion = questions[nextQ];
              setMessages(prev => [...prev, { role: 'assistant', content: nextQuestion }]);
              playAudio(nextQuestion, () => setSpeakingIndex(null));
            }, 1500);
          } else {
            // Kl√°ra√∞
            setTimeout(async () => {
              const summaryPrompt = `Taktu saman samtali√∞ okkar um barnaleikinn. Hva√∞ ger√∞i nemandinn vel? Nefndu 2-3 j√°kv√¶√∞a hluti. Vertu hvetjandi.`;

              const summaryResponse = await callOpenAI([
                ...conversationHistory,
                { role: 'user', content: userMessage },
                { role: 'user', content: summaryPrompt }
              ], 200, 'gpt-4o-mini', 0.3);

              setMessages(prev => [...prev, { role: 'summary', content: `üìù Samantekt:\n\n${summaryResponse}` }]);
              playAudio(summaryResponse, () => setSpeakingIndex(null));
              setFinished(true);
            }, 2000);
          }
        } catch (error) {
          console.error('Villa:', error);
          setMessages(prev => [...prev, { role: 'assistant', content: '√ûv√≠ mi√∞ur kom upp villa. Reyndu aftur.' }]);
        }

        setLoading(false);
      };

      const finishConversation = async () => {
        if (messages.length === 0) return;
        setLoading(true);

        try {
          const conversationHistory = messages.map(m => ({
            role: m.role,
            content: m.content
          }));

          const summaryPrompt = `Taktu saman samtali√∞ okkar um barnaleikinn. Hva√∞ ger√∞i nemandinn vel? Nefndu 2-3 j√°kv√¶√∞a hluti um m√°lfar og frams√∂gn. Vertu hvetjandi.`;

          const summaryResponse = await callOpenAI([
            ...conversationHistory,
            { role: 'user', content: summaryPrompt }
          ], 200, 'gpt-4o-mini', 0.3);

          setMessages(prev => [...prev, { role: 'summary', content: `üìù Samantekt:\n\n${summaryResponse}` }]);
          await playAudio(summaryResponse, () => setSpeakingIndex(null));
          setFinished(true);
        } catch (error) {
          console.error('Villa:', error);
        }

        setLoading(false);
      };

      return (
        <div className="min-h-screen flex flex-col">
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button
                onClick={() => window.history.back()}
                className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light"
              >
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">Barnaleikir</h1>
              <p className="text-gray-500 text-sm font-light">T√∂lum saman</p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
              <p className="text-blue-800 font-light text-center">
                üí° <span className="font-normal">√Åbending:</span> Seg√∞u m√©r fr√° leik sem √æ√∫ l√©kst √æegar √æ√∫ varst barn!
              </p>
            </div>

            <section className="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col" style={{ minHeight: '400px' }}>
              <div className="flex items-center gap-2 px-6 py-3 border-b bg-gray-50">
                <ListenPill onClick={handleListenClick} speaking={speakingIndex !== null} />
              </div>

              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : msg.role === 'summary' ? 'justify-center' : 'justify-start'}`}>
                    <div className={`max-w-lg px-4 py-2 rounded-xl font-light ${
                      msg.role === 'user' ? 'bg-blue-600 text-white' :
                      msg.role === 'summary' ? 'bg-green-50 text-green-900 border-2 border-green-300' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {msg.role === 'assistant' && (
                        <div className="text-xs text-gray-500 italic flex items-center gap-2 mb-1">
                          <span>Hlusta√∞u:</span>
                          <button onClick={() => playAssistantAt(idx)} className={`px-2 py-0.5 rounded-md border ${speakingIndex === idx ? 'border-green-300 bg-green-50 text-green-700' : 'border-gray-200 bg-white text-gray-700'}`}>
                            üîä Spila aftur
                          </button>
                        </div>
                      )}
                      <p className="whitespace-pre-wrap">{msg.content}</p>
                    </div>
                  </div>
                ))}
                {loading && <p className="text-gray-400 italic">AI hugsar‚Ä¶</p>}
                <div ref={messagesEndRef} />
              </div>

              {!finished && (
                <div className="border-t p-4 bg-white">
                  <div className="flex gap-2 mb-2">
                    <button onClick={toggleRecording} className={`px-4 py-3 rounded-lg font-normal flex items-center gap-2 transition-colors ${isRecording ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                      <MicIcon isRecording={isRecording} />
                      {isRecording ? 'H√¶tta uppt√∂ku' : 'Haltu til a√∞ tala'}
                    </button>
                    <button onClick={finishConversation} className="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-normal transition-colors">
                      ‚úÖ Kl√°ra samtal
                    </button>
                  </div>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={input}
                      onChange={(e) => setInput(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                      placeholder="Skrifa e√∞a laga tal‚Ä¶"
                      className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-light"
                    />
                    <button
                      onClick={sendMessage}
                      disabled={!input.trim()}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-normal transition-colors"
                    >
                      Senda
                    </button>
                  </div>
                </div>
              )}

              {finished && (
                <div className="border-t p-6 bg-green-50 text-center">
                  <div className="text-4xl mb-3">üéâ</div>
                  <h3 className="text-xl font-normal text-gray-800 mb-2">Vel gert!</h3>
                  <p className="text-gray-600 font-light">√û√∫ hefur kl√°ra√∞ spjalli√∞!</p>
                </div>
              )}
            </section>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<SpjallLeikir />);
  </script>
</body>
</html>
