<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vinna</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom, #f8f7f4 0%, #e8e6e1 100%);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ========== AI FUNCTIONS ==========
    async function callOpenAI(messages, max_tokens = 300, model = 'gpt-4o-mini', temperature = 0.3) {
      const r = await fetch('/.netlify/functions/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages, max_tokens, model, temperature })
      });
      const data = await r.json();
      if (!r.ok || data.error) throw new Error(data.error || `HTTP ${r.status}`);
      return data.content;
    }

    async function playAudio(text, setSpeaking) {
      setSpeaking(true);
      try {
        const r = await fetch('/.netlify/functions/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text_to_speak: text })
        });
        const data = await r.json();
        if (!r.ok || data.error || !data.audio_base64) {
          console.error('Villa √≠ hlj√≥√∞kalli:', data?.error);
          setSpeaking(false);
          return;
        }
        const audio = new Audio(`data:audio/mp3;base64,${data.audio_base64}`);
        audio.onended = () => setSpeaking(false);
        audio.onerror = () => setSpeaking(false);
        await audio.play().catch(() => setSpeaking(false));
      } catch (e) {
        console.error('Tenging mist√≥kst:', e);
        setSpeaking(false);
      }
    }

    const SpjallApp = () => {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isRecording, setIsRecording] = useState(false);
      const [recognition, setRecognition] = useState(null);
      const [isSpeaking, setIsSpeaking] = useState(false);
      const [speakingIndex, setSpeakingIndex] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [finished, setFinished] = useState(false);
      const [conversationState, setConversationState] = useState({
        questionIndex: 0,
        hasWorked: null,
        workplace: null,
        usePastTense: true
      });
      const messagesEndRef = useRef(null);

      // Setup speech recognition
      useEffect(() => {
        if ('webkitSpeechRecognition' in window) {
          const recog = new webkitSpeechRecognition();
          recog.lang = 'is-IS';
          recog.continuous = true;
          recog.interimResults = true;
          recog.onresult = (e) => {
            const transcript = Array.from(e.results)
              .map(r => r[0].transcript).join('');
            setInput(transcript);
          };
          recog.onend = () => setIsRecording(false);
          recog.onerror = () => setIsRecording(false);
          setRecognition(recog);
        }
      }, []);

      // Auto-scroll
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Start conversation
      useEffect(() => {
        if (messages.length === 0) {
          const firstQuestion = "H√¶. Hefur √æ√∫ veri√∞ √≠ vinnu?";
          setMessages([{ role: 'assistant', content: firstQuestion }]);
        }
      }, []);

      const toggleRecording = () => {
        if (!recognition) {
          alert('Talgreining er ekki √≠ bo√∞i √≠ √æessum vafra. Nota√∞u Chrome e√∞a Edge.');
          return;
        }
        if (isRecording) {
          recognition.stop();
          setIsRecording(false);
        } else {
          recognition.start();
          setIsRecording(true);
        }
      };

      const sendMessage = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = input.trim();
        setInput('');
        setIsRecording(false);
        if (recognition && isRecording) recognition.stop();

        // Add user message
        const newMessages = [...messages, { role: 'user', content: userMessage }];
        setMessages(newMessages);
        setIsLoading(true);

        try {
          const state = conversationState;
          let systemPrompt = '';

          if (state.questionIndex === 0) {
            // First question - determine if they've worked
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
1. Greina hvort nemandinn hefur unni√∞ √°√∞ur (j√°/nei)
2. Ef J√Å: Spyrja HVAR hann/h√∫n vann
3. Ef NEI: Spyrja HVAR honum/henni langar a√∞ vinna

D√ÜMI:
- Nemandi: "J√° √©g hef unni√∞" ‚Üí "Flott! Hvar vannst √æ√∫?"
- Nemandi: "Nei √©g hef ekki unni√∞" ‚Üí "Allt √≠ lagi! Hvar langar √æig a√∞ vinna?"
- Nemandi: "Nei" ‚Üí "√ûa√∞ er √≠ lagi! Hvar langar √æig a√∞ vinna?"

MIKILV√ÜGT:
- ALLTAF enda me√∞ spurningu
- Svara√∞u BARA √° √≠slensku
- Vertu vinaleg/ur og hvetjandi

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 1) {
            // Asked where - now ask what they did/will do
            const tense = state.usePastTense ? 'ger√∞ir' : 'myndir';
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

VINNUSTA√êURINN: "${state.workplace}"
NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
Spyrja hva√∞ nemandinn ${tense} gera √≠ vinnunni.

D√ÜMI:
${state.usePastTense ? 
  '- "Hva√∞ ger√∞ir √æ√∫ √≠ vinnunni?"' : 
  '- "Hva√∞ myndir √æ√∫ gera √≠ vinnunni?"'}

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 2) {
            // Asked what they did - now ask if hard/easy
            const tense = state.usePastTense ? 'Var' : 'V√¶ri';
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN L√ùSTI VINNUNNI: "${userMessage}"

VERKEFNI:
Spyrja hvort vinnan ${state.usePastTense ? 'var' : 'v√¶ri'} erfi√∞ e√∞a au√∞veld.

D√ÜMI:
- "${tense} √æa√∞ erfitt e√∞a au√∞velt?"

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 3) {
            // Asked if hard/easy - now ask specifics
            const tense = state.usePastTense ? 'var' : 'v√¶ri';
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
Spyrja hva√∞ ${tense} erfitt og hva√∞ ${tense} au√∞velt.

D√ÜMI:
- "Hva√∞ ${tense} erfitt? Og hva√∞ ${tense} au√∞velt?"

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 4) {
            // Asked what was hard/easy - now ask fun/boring
            const tense = state.usePastTense ? 'var' : 'v√¶ri';
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
Spyrja hva√∞ ${tense} skemmtilegt og hva√∞ ${tense} lei√∞inlegt.

D√ÜMI:
- "Hva√∞ ${tense} skemmtilegt? Og hva√∞ ${tense} lei√∞inlegt?"

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 5) {
            // Asked fun/boring - now ask what they learned
            const tense = state.usePastTense ? 'l√¶r√∞ir' : 'myndir';
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
Spyrja hva√∞ nemandinn ${tense} l√¶ra.

D√ÜMI:
${state.usePastTense ? 
  '- "Hva√∞ l√¶r√∞ir √æ√∫?"' : 
  '- "Hva√∞ myndir √æ√∫ l√¶ra?"'}

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else if (state.questionIndex === 6) {
            // Asked what learned - final question about why
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
Spyrja hvers vegna nemandinn vill vinna ${state.workplace ? `hj√°/√≠ ${state.workplace}` : ''}.

D√ÜMI:
- "Hvers vegna vilt √æ√∫ vinna √æar?"
- "Hvers vegna viltu vinna?"

SVARA√êU BARA ME√ê SPURNINGUNNI, EKKERT ANNA√ê.`;

          } else {
            // Final - thank them
            systemPrompt = `√û√∫ ert √≠slenskukennari sem talar vi√∞ nemanda um vinnu.

NEMANDINN SVARA√êI: "${userMessage}"

VERKEFNI:
√ûakka nemandanum fyrir samtali√∞.
Vera STUTT og HVETJANDI.

D√ÜMI:
- "Takk fyrir a√∞ tala vi√∞ mig um vinnuna! Gangi √æ√©r vel!"
- "Takk fyrir spjalli√∞! Vonandi f√¶r√∞u g√≥√∞a vinnu!"

EKKI enda me√∞ spurningu.
SVARA√êU BARA ME√ê √û√ñKKUM, EKKERT ANNA√ê.`;
          }

          const response = await callOpenAI([
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
          ], 150, 'gpt-4o-mini', 0.5);

          // Check for grammar feedback (mild)
          let feedbackMsg = null;
          if (userMessage.length > 10 && Math.random() > 0.7) {
            try {
              const feedbackSys = `√û√∫ ert √≠slenskukennari sem gefur MJ√ñG MILDA m√°lfarsendurgj√∂f √° A1-A2 stigi.

Nemandinn er a√∞ tala um vinnu og er a√∞ √¶fa sig a√∞ tala √≠slensku.

MIKILV√ÜGT: Vera mj√∂g VARK√ÅR me√∞ lei√∞r√©ttingar! Lei√∞r√©tta A√êEINS ef:
1. Nemandi skrifar √° √∂√∞ru tungum√°li
2. Auglj√≥sar m√°lfr√¶√∞ivillur
3. Rith√°ttarvillur √° √≠slenskum or√∞um

Gef√∞u STUTTA endurgj√∂f (1 setning):
- Byrja√∞u me√∞ hr√≥s: "Fr√°b√¶rt!" e√∞a "Gott!"
- EF villa: Lei√∞r√©ttu vinalega
- Loka√∞u j√°kv√¶tt: "Annars mj√∂g gott!"

ALDREI lei√∞r√©tta ef svari√∞ er skiljanlegt og n√¶stum r√©tt!

SKILA√êU: Anna√∞hvort endurgj√∂f E√êA "ENGIN" ef ekkert a√∞ lei√∞r√©tta.`;

              const feedbackResponse = await callOpenAI([
                { role: 'system', content: feedbackSys },
                { role: 'user', content: userMessage }
              ], 100, 'gpt-4o-mini', 0.2);

              if (feedbackResponse.trim() !== 'ENGIN' && !feedbackResponse.includes('r√©tt!')) {
                feedbackMsg = { role: 'feedback', content: feedbackResponse.trim() };
              }
            } catch (e) {
              console.error('Villa vi√∞ m√°lfarsendurgj√∂f:', e);
            }
          }

          // Update messages
          const updatedMessages = [...newMessages];
          if (feedbackMsg) updatedMessages.push(feedbackMsg);
          updatedMessages.push({ role: 'assistant', content: response });
          setMessages(updatedMessages);

          // Update conversation state
          const newState = { ...state };
          
          if (state.questionIndex === 0) {
            // Determine if they've worked
            const hasWorked = userMessage.toLowerCase().includes('j√°') || 
                             userMessage.toLowerCase().includes('vinn') ||
                             userMessage.toLowerCase().includes('hef');
            newState.hasWorked = hasWorked;
            newState.usePastTense = hasWorked;
            newState.questionIndex = 1;
          } else if (state.questionIndex === 1) {
            // Extract workplace
            newState.workplace = userMessage;
            newState.questionIndex = 2;
          } else if (state.questionIndex < 7) {
            newState.questionIndex++;
          } else {
            setFinished(true);
          }

          setConversationState(newState);

        } catch (error) {
          console.error('Villa:', error);
          setMessages([...newMessages, {
            role: 'assistant',
            content: '√öps! Eitthva√∞ f√≥r √∫rskei√∞is. Reyndu aftur.'
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const playAssistantAudio = async (index) => {
        const msg = messages[index];
        if (msg.role === 'assistant') {
          setSpeakingIndex(index);
          await playAudio(msg.content, (speaking) => {
            setIsSpeaking(speaking);
            if (!speaking) setSpeakingIndex(null);
          });
        }
      };

      const SpeakerIcon = ({ isSpeaking }) => (
        <svg className={`w-5 h-5 ${isSpeaking ? 'animate-pulse' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
      );

      const MicIcon = ({ isRecording }) => (
        <svg className={`w-5 h-5 ${isRecording ? 'animate-pulse' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
      );

      return (
        <div className="min-h-screen pb-12">
          {/* Header */}
          <header className="bg-white shadow-sm border-b border-gray-200">
            <div className="max-w-4xl mx-auto px-6 py-8">
              <button onClick={() => window.history.back()} className="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block font-light">
                ‚Üê Til baka
              </button>
              <h1 className="text-3xl font-light text-gray-800 mb-2">
                Vinna
              </h1>
              <p className="text-gray-500 text-sm font-light">
                T√∂lum saman
              </p>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 mt-8">
            {/* Image */}
            <div className="rounded-lg overflow-hidden shadow-lg mb-6 mx-auto" style={{maxWidth:'600px'}}>
              <img 
                src="media/spjall12_vinna.png" 
                alt="Ungmenni tala um vinnu" 
                className="w-full h-auto" 
              />
            </div>

            {/* Instructions */}
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
              <h2 className="text-xl font-normal text-gray-800 mb-3">üí° Lei√∞beiningar</h2>
              <ul className="space-y-2 text-gray-700 font-light">
                <li>‚Ä¢ Tala√∞u um vinnu sem √æ√∫ hefur √°tt e√∞a vilt f√°</li>
                <li>‚Ä¢ √û√∫ getur nota√∞ hlj√≥√∞nema e√∞a skrifa√∞</li>
                <li>‚Ä¢ Reyndu a√∞ svara me√∞ heilum setningum</li>
                <li>‚Ä¢ Smelltu √° üéß til a√∞ heyra spurningarnar</li>
              </ul>
            </div>

            {/* Chat Box */}
            <section className="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col" style={{minHeight:'400px'}}>
              {/* Chat header */}
              <div className="flex items-center gap-2 px-6 py-3 border-b bg-gray-50">
                <span className="text-xs text-gray-400">
                  üí¨ Spjall um vinnu
                </span>
              </div>

              {/* Messages */}
              <div className="flex-1 overflow-y-auto p-6 space-y-4" style={{maxHeight:'500px'}}>
                {messages.map((msg, i) => (
                  <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-lg px-4 py-2 rounded-xl ${
                      msg.role === 'user' 
                        ? 'bg-blue-600 text-white' 
                        : msg.role === 'feedback'
                        ? 'bg-red-50 text-red-700 border-2 border-red-200 italic'
                        : 'bg-gray-100 text-gray-800'
                    }`}>
                      {msg.role === 'feedback' && (
                        <span className="font-normal text-red-800">üìö M√°lfar: </span>
                      )}
                      
                      {msg.role !== 'assistant' && (
                        <p className="whitespace-pre-wrap font-light">{msg.content}</p>
                      )}
                      
                      {msg.role === 'assistant' && (
                        <button 
                          onClick={() => playAssistantAudio(i)}
                          disabled={isSpeaking && speakingIndex !== i}
                          className="flex items-center gap-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 rounded-md transition-colors disabled:opacity-50"
                        >
                          <SpeakerIcon isSpeaking={speakingIndex === i} />
                          <span className="text-blue-800 font-light">üéß Hlusta√∞u</span>
                        </button>
                      )}
                    </div>
                  </div>
                ))}
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-gray-100 px-4 py-2 rounded-xl">
                      <p className="text-gray-600 font-light">...</p>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input area */}
              {!finished && (
                <div className="border-t p-4 bg-white">
                  <div className="flex gap-2 mb-2">
                    <button 
                      onClick={toggleRecording}
                      className={`px-4 py-3 rounded-lg transition-colors flex items-center gap-2 ${
                        isRecording ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      <MicIcon isRecording={isRecording} />
                      <span className="font-light">{isRecording ? '‚èπÔ∏è H√¶tta uppt√∂ku' : 'üé§ Haltu til a√∞ tala'}</span>
                    </button>
                  </div>
                  <div className="flex gap-2">
                    <input 
                      type="text" 
                      value={input} 
                      onChange={(e) => setInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                      placeholder="Skrifa e√∞a laga tal..."
                      className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-light"
                      disabled={isLoading}
                    />
                    <button 
                      onClick={sendMessage}
                      disabled={!input.trim() || isLoading}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-normal transition-colors"
                    >
                      Senda
                    </button>
                  </div>
                </div>
              )}

              {finished && (
                <div className="border-t p-6 bg-gradient-to-r from-green-50 to-green-100 text-center">
                  <div className="text-6xl mb-4">üéâ</div>
                  <h2 className="text-2xl font-light text-gray-800 mb-2">Vel gert!</h2>
                  <p className="text-gray-600 font-light">Takk fyrir a√∞ tala um vinnuna!</p>
                </div>
              )}
            </section>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<SpjallApp />);
  </script>
</body>
</html>
